<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-Hans" xml:lang="zh-Hans"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>R 语言数据分析实战 - 28&nbsp; 点参考数据分析</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./analyze-areal-data.html" rel="next">
<link href="./analyze-point-pattern.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "没有结果",
    "search-matching-documents-text": "匹配的文档",
    "search-copy-link-title": "复制搜索链接",
    "search-hide-matches-text": "隐藏其它匹配结果",
    "search-more-match-text": "更多匹配结果",
    "search-more-matches-text": "更多匹配结果",
    "search-clear-button-title": "清除",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "取消",
    "search-submit-button-title": "提交",
    "search-label": "搜索"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-ZPWJBMKFL8"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-ZPWJBMKFL8', { 'anonymize_ip': true});
</script><script>
MathJax ={
  tex: {
    macros: {
      bm: ["{\\boldsymbol #1}",1],
    }
  }
};
</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="切换侧边栏导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./analyze-point-pattern.html">空间分析</a></li><li class="breadcrumb-item"><a href="./analyze-spatial-data.html"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">点参考数据分析</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="切换侧边栏导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R 语言数据分析实战</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/XiangyunHuang/data-analysis-in-action" title="源代码" class="quarto-navigation-tool px-1" aria-label="源代码"><i class="bi bi-github"></i></a>
    <a href="./_main.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="切换深色模式"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="搜索"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">欢迎</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">前言</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">介绍</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">数据准备</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling-objects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">数据对象</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling-collection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">数据获取</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling-cleaning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">数据清洗</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling-manipulation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">数据操作</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling-processing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">数据处理</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">数据探索</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-basic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">ggplot2 入门</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-intermediate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">基础图形</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-advanced.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">统计图形</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-lattice.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">lattice 入门</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-graphics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">graphics 入门</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-tikz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">TikZ 入门</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-practice.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">探索实践</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">数据交流</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interactive-graphics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">交互图形</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interactive-tables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">交互表格</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interactive-applications.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">交互应用</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./documents-html.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">HTML 文档</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./documents-latex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">PDF 文档</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./documents-office.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Office 文档</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">统计分析</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./common-statistical-tests.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">常见的统计检验</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regression-and-correlation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">回归与相关分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./categorical-data-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">分类数据的分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./power-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">统计检验的功效</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">数据建模</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-network-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">网络数据分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-text-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">文本数据分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-survival-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">生存数据分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-time-series-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">时序数据分析</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">空间分析</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-point-pattern.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">点模式数据分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-spatial-data.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">点参考数据分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-areal-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">区域数据分析</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
 <span class="menu-text">优化建模</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./statistical-computation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">统计计算</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./numerical-optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">数值优化</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./optimization-problems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">优化问题</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true">
 <span class="menu-text">贝叶斯建模</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./probabilistic-reasoning-framework.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">概率推理框架</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./generalized-linear-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">广义线性模型</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hierarchical-normal-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">分层正态模型</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mixed-effects-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">混合效应模型</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./generalized-additive-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">广义可加模型</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gaussian-processes-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">高斯过程回归</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./time-series-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">时间序列回归</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true">
 <span class="menu-text">机器学习</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./classification-problems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">分类问题</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./clustering-problems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">聚类问题</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regression-problems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">回归问题</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">参考文献</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" aria-expanded="true">
 <span class="menu-text">附录</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./notations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">数学符号</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./matrix-operations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">矩阵运算</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./git-github.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Git 和 Github</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">目录</h2>
   
  <ul>
<li><a href="#sec-rongelap-data" id="toc-sec-rongelap-data" class="nav-link active" data-scroll-target="#sec-rongelap-data"><span class="header-section-number">28.1</span> 数据说明</a></li>
  <li><a href="#sec-rongelap-exploration" id="toc-sec-rongelap-exploration" class="nav-link" data-scroll-target="#sec-rongelap-exploration"><span class="header-section-number">28.2</span> 数据探索</a></li>
  <li>
<a href="#sec-rongelap-modeling" id="toc-sec-rongelap-modeling" class="nav-link" data-scroll-target="#sec-rongelap-modeling"><span class="header-section-number">28.3</span> 数据建模</a>
  <ul class="collapse">
<li><a href="#sec-rongelap-glm" id="toc-sec-rongelap-glm" class="nav-link" data-scroll-target="#sec-rongelap-glm"><span class="header-section-number">28.3.1</span> 广义线性模型</a></li>
  <li><a href="#sec-rongelap-slmm" id="toc-sec-rongelap-slmm" class="nav-link" data-scroll-target="#sec-rongelap-slmm"><span class="header-section-number">28.3.2</span> 空间线性混合效应模型</a></li>
  <li><a href="#sec-rongelap-sglmm" id="toc-sec-rongelap-sglmm" class="nav-link" data-scroll-target="#sec-rongelap-sglmm"><span class="header-section-number">28.3.3</span> 空间广义线性混合效应模型</a></li>
  </ul>
</li>
  <li>
<a href="#sec-rongelap-predict" id="toc-sec-rongelap-predict" class="nav-link" data-scroll-target="#sec-rongelap-predict"><span class="header-section-number">28.4</span> 模型预测</a>
  <ul class="collapse">
<li><a href="#sec-rongelap-coastline" id="toc-sec-rongelap-coastline" class="nav-link" data-scroll-target="#sec-rongelap-coastline"><span class="header-section-number">28.4.1</span> 海岸线数据</a></li>
  <li><a href="#sec-rongelap-border" id="toc-sec-rongelap-border" class="nav-link" data-scroll-target="#sec-rongelap-border"><span class="header-section-number">28.4.2</span> 边界处理</a></li>
  <li><a href="#sec-rongelap-grid" id="toc-sec-rongelap-grid" class="nav-link" data-scroll-target="#sec-rongelap-grid"><span class="header-section-number">28.4.3</span> 构造网格</a></li>
  <li><a href="#sec-rongelap-pred" id="toc-sec-rongelap-pred" class="nav-link" data-scroll-target="#sec-rongelap-pred"><span class="header-section-number">28.4.4</span> 整理数据</a></li>
  <li><a href="#sec-rongelap-plot" id="toc-sec-rongelap-plot" class="nav-link" data-scroll-target="#sec-rongelap-plot"><span class="header-section-number">28.4.5</span> 展示结果</a></li>
  </ul>
</li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/XiangyunHuang/data-analysis-in-action/blob/main/analyze-spatial-data.qmd" class="toc-action"><i class="bi bi-github"></i>查看代码</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./analyze-point-pattern.html">空间分析</a></li><li class="breadcrumb-item"><a href="./analyze-spatial-data.html"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">点参考数据分析</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title"><span id="sec-nuclear-pollution-concentration" class="quarto-section-identifier"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">点参考数据分析</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>本章内容属于空间分析的范畴，空间分析的内容十分广泛，主要分三大块，分别是空间点参考数据分析、空间点模式分析和空间区域数据分析。本章仅以一个模型和一个数据简略介绍空间点参考数据分析。一个模型是空间广义线性混合效应模型，空间广义线性混合效应模型在流行病学、生态学、环境学等领域有广泛的应用，如预测某地区内的疟疾流行度分布，预测某地区 PM 2.5 污染物浓度分布等。一个数据来自生态学领域，数据集所含样本量不大，但每个样本收集成本不小，采集样本前也都有实验设计，数据采集的地点是预先设定的。下面将对真实数据分析和建模，任务是预测核辐射强度在朗格拉普岛上的分布。</p>
<section id="sec-rongelap-data" class="level2" data-number="28.1"><h2 data-number="28.1" class="anchored" data-anchor-id="sec-rongelap-data">
<span class="header-section-number">28.1</span> 数据说明</h2>
<p>在第二次世界大战的吉尔伯特及马绍尔群岛战斗中，美国占领了马绍尔群岛。战后，美国在该群岛的比基尼环礁中陆续进行了许多氢弹核试验，对该群岛造成无法弥补的环境损害。位于南太平洋的朗格拉普环礁是马绍尔群岛的一部分，其中，朗格拉普岛是朗格拉普环礁的主岛，修建有机场，在太平洋战争中是重要的军事基地。朗格拉普岛距离核爆炸的位置较近，因而被放射性尘埃笼罩了，受到严重的核辐射影响，从度假胜地变成人间炼狱，居民出现上吐下泻、皮肤灼烧、脱发等症状。即便是 1985 年以后，那里仍然无人居住，居民担心核辐射对身体健康的影响。又几十年后，一批科学家来到该岛研究生态恢复情况，评估当地居民重返家园的可行性。实际上，该岛目前仍然不适合人类居住，只有经批准的科学研究人员才能登岛。</p>
<div class="cell">
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># 从网站 https://gadm.org/ 下载国家各级行政区划数据</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co"># geodata 包返回 SpatVector 类型的数据对象</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>mhl_map_gadm <span class="ot">&lt;-</span> geodata<span class="sc">::</span><span class="fu">gadm</span>(<span class="at">country =</span> <span class="st">"MHL"</span>, <span class="at">level =</span> <span class="dv">1</span>, <span class="at">path =</span> <span class="st">"data/"</span>)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co"># SpatVector 类型转为 sf 类型</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>mhl_map_gadm <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(mhl_map_gadm)</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co"># 添加虚线框用来圈选朗格拉普岛</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>rongelap_sfp <span class="ot">&lt;-</span> <span class="fu">st_sfc</span>(<span class="fu">st_polygon</span>(<span class="at">x =</span> <span class="fu">list</span>(<span class="fu">rbind</span>(</span>
<span id="cb1-10"><a href="#cb1-10"></a>  <span class="fu">c</span>(<span class="fl">166.82</span>, <span class="fl">11.14</span>),</span>
<span id="cb1-11"><a href="#cb1-11"></a>  <span class="fu">c</span>(<span class="fl">166.82</span>, <span class="fl">11.183</span>),</span>
<span id="cb1-12"><a href="#cb1-12"></a>  <span class="fu">c</span>(<span class="fl">166.92</span>, <span class="fl">11.183</span>),</span>
<span id="cb1-13"><a href="#cb1-13"></a>  <span class="fu">c</span>(<span class="fl">166.92</span>, <span class="fl">11.14</span>),</span>
<span id="cb1-14"><a href="#cb1-14"></a>  <span class="fu">c</span>(<span class="fl">166.82</span>, <span class="fl">11.14</span>)</span>
<span id="cb1-15"><a href="#cb1-15"></a>)), <span class="at">dim =</span> <span class="st">"XY"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="co"># 文本标记</span></span>
<span id="cb1-17"><a href="#cb1-17"></a>text_df <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tribble</span>(</span>
<span id="cb1-18"><a href="#cb1-18"></a>  <span class="sc">~</span>x, <span class="sc">~</span>y, <span class="sc">~</span>text,</span>
<span id="cb1-19"><a href="#cb1-19"></a>  <span class="fl">166.75</span>, <span class="fl">11.35</span>, <span class="st">"朗格拉普环礁"</span>,</span>
<span id="cb1-20"><a href="#cb1-20"></a>  <span class="fl">166.97</span>, <span class="fl">11.16</span>, <span class="st">"朗格拉普岛"</span></span>
<span id="cb1-21"><a href="#cb1-21"></a>)</span>
<span id="cb1-22"><a href="#cb1-22"></a>text_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(text_df)</span>
<span id="cb1-23"><a href="#cb1-23"></a>text_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(text_df, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>), <span class="at">dim =</span> <span class="st">"XY"</span>, <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="co"># 朗格拉普环礁</span></span>
<span id="cb1-25"><a href="#cb1-25"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb1-26"><a href="#cb1-26"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> mhl_map_gadm) <span class="sc">+</span></span>
<span id="cb1-27"><a href="#cb1-27"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> rongelap_sfp, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="fl">0.75</span>, <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb1-28"><a href="#cb1-28"></a>  <span class="fu">geom_sf_text</span>(<span class="at">data =</span> text_sf, <span class="fu">aes</span>(<span class="at">label =</span> text), <span class="at">color =</span> <span class="st">"gray20"</span>,</span>
<span id="cb1-29"><a href="#cb1-29"></a>               <span class="at">fun.geometry =</span> sf<span class="sc">::</span>st_centroid) <span class="sc">+</span></span>
<span id="cb1-30"><a href="#cb1-30"></a>  <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="fl">166.6</span>, <span class="fl">167.1</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fl">11.14</span>, <span class="fl">11.5</span>)) <span class="sc">+</span></span>
<span id="cb1-31"><a href="#cb1-31"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb1-32"><a href="#cb1-32"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"经度"</span>, <span class="at">y =</span> <span class="st">"纬度"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-rongelap-atoll" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-rongelap-atoll-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-rongelap-atoll-1.png" class="img-fluid figure-img" width="537">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rongelap-atoll-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;28.1: 朗格拉普环礁和朗格拉普岛
</figcaption></figure>
</div>
</div>
</div>
<p><a href="https://orcid.org/0000-0002-8230-8062">Ole F. Christensen</a> 和 Paulo J. Ribeiro Jr 将 <code>rongelap</code> 数据集存放在 <a href="https://cran.r-project.org/package=geoRglm"><strong>geoRglm</strong></a><span class="citation" data-cites="Christensen2002">(<a href="references.html#ref-Christensen2002" role="doc-biblioref">Christensen 和 Ribeiro Jr. 2002</a>)</span> 包内，后来，<strong>geoRglm</strong> 不维护，已从 CRAN 移除了，笔者从他们主页下载了数据。数据集 <code>rongelap</code> 记录了 157 个测量点的伽马射线强度，即在时间间隔 <code>time</code> （秒）内放射的粒子数目 <code>counts</code>（个），测量点的横纵坐标分别为 <code>cX</code> （米）和 <code>cY</code>（米），下 <a href="#tbl-rongelap-nuclear-data" class="quarto-xref">表格&nbsp;<span>28.1</span></a> 展示部分朗格拉普岛核辐射检测数据及海岸线坐标数据。</p>
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># 加载数据</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>rongelap <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">"data/rongelap.rds"</span>)</span>
<span id="cb2-3"><a href="#cb2-3"></a>rongelap_coastline <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">"data/rongelap_coastline.rds"</span>)</span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="fu">library</span>(knitr)</span>
<span id="cb2-6"><a href="#cb2-6"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(rongelap, <span class="dv">6</span>),</span>
<span id="cb2-7"><a href="#cb2-7"></a>  <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"cX 横坐标"</span>, <span class="st">"cY 纵坐标"</span>, <span class="st">"counts 数目"</span>, <span class="st">"time 时间"</span>)</span>
<span id="cb2-8"><a href="#cb2-8"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(rongelap_coastline, <span class="dv">6</span>),</span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"cX 横坐标"</span>, <span class="st">"cY 纵坐标"</span>)</span>
<span id="cb3-3"><a href="#cb3-3"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div id="tbl-rongelap-nuclear-data" class="quarto-layout-panel anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-rongelap-nuclear-data-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表格&nbsp;28.1: 朗格拉普岛核辐射检测数据及海岸线坐标数据
</figcaption><div aria-describedby="tbl-rongelap-nuclear-data-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="tbl-rongelap-nuclear-data" style="flex-basis: 50.0%;justify-content: center;">
<div id="tbl-rongelap-nuclear-data-1" class="do-not-create-environment quarto-float anchored">
<figure class="quarto-float quarto-subfloat-tbl figure"><figcaption class="quarto-float-caption-top quarto-subfloat-caption quarto-subfloat-tbl" id="tbl-rongelap-nuclear-data-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 核辐射检测数据
</figcaption><div aria-describedby="tbl-rongelap-nuclear-data-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table id="tbl-rongelap-nuclear-data-1" class="do-not-create-environment table">
<thead><tr class="header">
<th style="text-align: right;">cX 横坐标</th>
<th style="text-align: right;">cY 纵坐标</th>
<th style="text-align: right;">counts 数目</th>
<th style="text-align: right;">time 时间</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">-6050</td>
<td style="text-align: right;">-3270</td>
<td style="text-align: right;">75</td>
<td style="text-align: right;">300</td>
</tr>
<tr class="even">
<td style="text-align: right;">-6050</td>
<td style="text-align: right;">-3165</td>
<td style="text-align: right;">371</td>
<td style="text-align: right;">300</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-5925</td>
<td style="text-align: right;">-3320</td>
<td style="text-align: right;">1931</td>
<td style="text-align: right;">300</td>
</tr>
<tr class="even">
<td style="text-align: right;">-5925</td>
<td style="text-align: right;">-3165</td>
<td style="text-align: right;">4357</td>
<td style="text-align: right;">300</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-5800</td>
<td style="text-align: right;">-3350</td>
<td style="text-align: right;">2114</td>
<td style="text-align: right;">300</td>
</tr>
<tr class="even">
<td style="text-align: right;">-5800</td>
<td style="text-align: right;">-3165</td>
<td style="text-align: right;">2318</td>
<td style="text-align: right;">300</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="tbl-rongelap-nuclear-data" style="flex-basis: 50.0%;justify-content: center;">
<div id="tbl-rongelap-nuclear-data-2" class="do-not-create-environment quarto-float anchored">
<figure class="quarto-float quarto-subfloat-tbl figure"><figcaption class="quarto-float-caption-top quarto-subfloat-caption quarto-subfloat-tbl" id="tbl-rongelap-nuclear-data-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 海岸线坐标数据
</figcaption><div aria-describedby="tbl-rongelap-nuclear-data-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table id="tbl-rongelap-nuclear-data-2" class="do-not-create-environment table">
<thead><tr class="header">
<th style="text-align: right;">cX 横坐标</th>
<th style="text-align: right;">cY 纵坐标</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">-5509.236</td>
<td style="text-align: right;">-3577.438</td>
</tr>
<tr class="even">
<td style="text-align: right;">-5544.821</td>
<td style="text-align: right;">-3582.250</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-5561.604</td>
<td style="text-align: right;">-3576.926</td>
</tr>
<tr class="even">
<td style="text-align: right;">-5580.780</td>
<td style="text-align: right;">-3574.535</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-5599.687</td>
<td style="text-align: right;">-3564.288</td>
</tr>
<tr class="even">
<td style="text-align: right;">-5605.922</td>
<td style="text-align: right;">-3560.910</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</div>
</div>
</div>
</figure>
</div>
<p>坐标原点在岛的东北，下 <a href="#fig-rongelap-location-1" class="quarto-xref">图&nbsp;<span>28.2 (a)</span></a> 右上角的位置。采样点的编号见下 <a href="#fig-rongelap-location-2" class="quarto-xref">图&nbsp;<span>28.2 (b)</span></a>，基本上按照从下（南）到上（北），从左（西）到右（东）的顺序依次测量。</p>
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> rongelap, <span class="fu">aes</span>(<span class="at">x =</span> cX, <span class="at">y =</span> cY), <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>  <span class="fu">geom_path</span>(<span class="at">data =</span> rongelap_coastline, <span class="fu">aes</span>(<span class="at">x =</span> cX, <span class="at">y =</span> cY)) <span class="sc">+</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>  <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"横坐标（米）"</span>, <span class="at">y =</span> <span class="st">"纵坐标（米）"</span>)</span>
<span id="cb4-8"><a href="#cb4-8"></a></span>
<span id="cb4-9"><a href="#cb4-9"></a>rongelap<span class="sc">$</span>dummy <span class="ot">&lt;-</span> <span class="fu">rownames</span>(rongelap)</span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="fu">ggplot</span>(rongelap, <span class="fu">aes</span>(<span class="at">x =</span> cX, <span class="at">y =</span> cY)) <span class="sc">+</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> dummy), <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb4-12"><a href="#cb4-12"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>  <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb4-14"><a href="#cb4-14"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"横坐标（米）"</span>, <span class="at">y =</span> <span class="st">"纵坐标（米）"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div id="fig-rongelap-location" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-rongelap-location-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-rongelap-location" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-rongelap-location-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-rongelap-location-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-rongelap-location-1.png" class="img-fluid figure-img" data-ref-parent="fig-rongelap-location" width="595">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-rongelap-location-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 采样分布
</figcaption></figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-rongelap-location" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-rongelap-location-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-rongelap-location-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-rongelap-location-2.png" class="img-fluid figure-img" data-ref-parent="fig-rongelap-location" width="595">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-rongelap-location-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 采样顺序
</figcaption></figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rongelap-location-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;28.2: 采样点在岛上的分布
</figcaption></figure>
</div>
</section><section id="sec-rongelap-exploration" class="level2" data-number="28.2"><h2 data-number="28.2" class="anchored" data-anchor-id="sec-rongelap-exploration">
<span class="header-section-number">28.2</span> 数据探索</h2>
<p>朗格拉普岛呈月牙形，有数千米长，但仅几百米宽，十分狭长。采样点在岛上的分布如 <a href="#fig-rongelap-location" class="quarto-xref">图&nbsp;<span>28.2</span></a> 所示，主网格以约 200 米的间隔采样，在岛屿的东北和西南方各有两个密集采样区，每个网格采样区是 <span class="math inline">\(5 \times 5\)</span> 方式排列的，上下左右间隔均为 40 米。朗格拉普岛上各个检测站点的核辐射强度如 <a href="#fig-rongelap-location-zoom" class="quarto-xref">图&nbsp;<span>28.3</span></a> 所示，越亮表示核辐射越强，四个检测区的采样阵列非常密集，通过局部放大展示了最左侧的一个检测区，它将作为后续模型比较的参照区域。</p>
<div class="cell">
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="fu">geom_path</span>(<span class="at">data =</span> rongelap_coastline, <span class="fu">aes</span>(<span class="at">x =</span> cX, <span class="at">y =</span> cY)) <span class="sc">+</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> rongelap, <span class="fu">aes</span>(<span class="at">x =</span> cX, <span class="at">y =</span> cY, <span class="at">color =</span> counts <span class="sc">/</span> time), <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">n.breaks =</span> <span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>  <span class="fu">scale_color_viridis_c</span>(<span class="at">option =</span> <span class="st">"C"</span>) <span class="sc">+</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>  <span class="fu">geom_segment</span>(</span>
<span id="cb5-7"><a href="#cb5-7"></a>    <span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="sc">-</span><span class="dv">5560</span>, <span class="at">xend =</span> <span class="sc">-</span><span class="dv">5000</span>, <span class="at">y =</span> <span class="sc">-</span><span class="dv">3000</span>, <span class="at">yend =</span> <span class="sc">-</span><span class="dv">2300</span>),</span>
<span id="cb5-8"><a href="#cb5-8"></a>    <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend),</span>
<span id="cb5-9"><a href="#cb5-9"></a>    <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.03</span>, <span class="st">"npc"</span>))</span>
<span id="cb5-10"><a href="#cb5-10"></a>  ) <span class="sc">+</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb5-12"><a href="#cb5-12"></a>  <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"横坐标（米）"</span>, <span class="at">y =</span> <span class="st">"纵坐标（米）"</span>, <span class="at">color =</span> <span class="st">"辐射强度"</span>)</span>
<span id="cb5-14"><a href="#cb5-14"></a></span>
<span id="cb5-15"><a href="#cb5-15"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb5-16"><a href="#cb5-16"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> rongelap, <span class="fu">aes</span>(<span class="at">x =</span> cX, <span class="at">y =</span> cY, <span class="at">color =</span> counts <span class="sc">/</span> time), </span>
<span id="cb5-17"><a href="#cb5-17"></a>             <span class="at">size =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>  <span class="fu">scale_color_viridis_c</span>(<span class="at">option =</span> <span class="st">"C"</span>) <span class="sc">+</span></span>
<span id="cb5-19"><a href="#cb5-19"></a>  <span class="fu">coord_fixed</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5700</span>, <span class="sc">-</span><span class="dv">5540</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3260</span>, <span class="sc">-</span><span class="dv">3100</span>)) <span class="sc">+</span></span>
<span id="cb5-20"><a href="#cb5-20"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb5-21"><a href="#cb5-21"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>)</span>
<span id="cb5-22"><a href="#cb5-22"></a></span>
<span id="cb5-23"><a href="#cb5-23"></a>p1</span>
<span id="cb5-24"><a href="#cb5-24"></a><span class="fu">print</span>(p2, <span class="at">vp =</span> grid<span class="sc">::</span><span class="fu">viewport</span>(<span class="at">x =</span> .<span class="dv">25</span>, <span class="at">y =</span> .<span class="dv">66</span>, <span class="at">width =</span> .<span class="dv">275</span>, <span class="at">height =</span> .<span class="dv">45</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-rongelap-location-zoom" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-rongelap-location-zoom-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-rongelap-location-zoom-1.png" class="img-fluid figure-img" width="595">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rongelap-location-zoom-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;28.3: 岛上各采样点的核辐射强度
</figcaption></figure>
</div>
</div>
</div>
<p><strong>ggplot2</strong> 包只能在二维平面上展示数据，对于空间数据，立体图形更加符合数据产生背景。如 <a href="#fig-rongelap-concentration" class="quarto-xref">图&nbsp;<span>28.4</span></a> 所示，以三维图形展示朗格拉普岛上采样点的位置及检测到的辐射强度。<strong>lattice</strong> 包的函数 <code>cloud()</code> 可以绘制三维的散点图，将自定义的面板函数 <code>panel.3dcoastline()</code> 传递给参数 <code>panel.3d.cloud</code> 绘制岛屿海岸线。组合点和线两种绘图元素构造出射线，线的长短表示放射性的强弱，以射线表示粒子辐射现象更加贴切。</p>
<div class="cell">
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">library</span>(lattice)</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co"># 参考 lattice 书籍的图 6.5 的绘图代码</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>panel<span class="fl">.3</span>dcoastline <span class="ot">&lt;-</span> <span class="cf">function</span>(..., rot.mat, distance, xlim, ylim, zlim,</span>
<span id="cb6-4"><a href="#cb6-4"></a>                              xlim.scaled, ylim.scaled, zlim.scaled) {</span>
<span id="cb6-5"><a href="#cb6-5"></a>  scale.vals <span class="ot">&lt;-</span> <span class="cf">function</span>(x, original, scaled) {</span>
<span id="cb6-6"><a href="#cb6-6"></a>    scaled[<span class="dv">1</span>] <span class="sc">+</span> (x <span class="sc">-</span> original[<span class="dv">1</span>]) <span class="sc">*</span> <span class="fu">diff</span>(scaled) <span class="sc">/</span> <span class="fu">diff</span>(original)</span>
<span id="cb6-7"><a href="#cb6-7"></a>  }</span>
<span id="cb6-8"><a href="#cb6-8"></a>  scaled.map <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb6-9"><a href="#cb6-9"></a>    <span class="fu">scale.vals</span>(rongelap_coastline<span class="sc">$</span>cX, xlim, xlim.scaled),</span>
<span id="cb6-10"><a href="#cb6-10"></a>    <span class="fu">scale.vals</span>(rongelap_coastline<span class="sc">$</span>cY, ylim, ylim.scaled),</span>
<span id="cb6-11"><a href="#cb6-11"></a>    zlim.scaled[<span class="dv">1</span>]</span>
<span id="cb6-12"><a href="#cb6-12"></a>  )</span>
<span id="cb6-13"><a href="#cb6-13"></a>  m <span class="ot">&lt;-</span> <span class="fu">ltransform3dto3d</span>(scaled.map, rot.mat, distance)</span>
<span id="cb6-14"><a href="#cb6-14"></a>  <span class="fu">panel.lines</span>(m[<span class="dv">1</span>, ], m[<span class="dv">2</span>, ], <span class="at">col =</span> <span class="st">"black"</span>)</span>
<span id="cb6-15"><a href="#cb6-15"></a>}</span>
<span id="cb6-16"><a href="#cb6-16"></a></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="fu">cloud</span>(counts <span class="sc">/</span> time <span class="sc">~</span> cX <span class="sc">*</span> cY,</span>
<span id="cb6-18"><a href="#cb6-18"></a>  <span class="at">data =</span> rongelap, <span class="at">col =</span> <span class="st">"black"</span>,</span>
<span id="cb6-19"><a href="#cb6-19"></a>  <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">6500</span>, <span class="dv">100</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3800</span>, <span class="dv">150</span>),</span>
<span id="cb6-20"><a href="#cb6-20"></a>  <span class="at">scales =</span> <span class="fu">list</span>(<span class="at">arrows =</span> <span class="cn">FALSE</span>, <span class="at">col =</span> <span class="st">"black"</span>),</span>
<span id="cb6-21"><a href="#cb6-21"></a>  <span class="at">aspect =</span> <span class="fu">c</span>(<span class="fl">0.75</span>, <span class="fl">0.5</span>),</span>
<span id="cb6-22"><a href="#cb6-22"></a>  <span class="at">xlab =</span> <span class="fu">list</span>(<span class="st">"横坐标（米）"</span>, <span class="at">rot =</span> <span class="dv">20</span>),</span>
<span id="cb6-23"><a href="#cb6-23"></a>  <span class="at">ylab =</span> <span class="fu">list</span>(<span class="st">"纵坐标（米）"</span>, <span class="at">rot =</span> <span class="sc">-</span><span class="dv">50</span>),</span>
<span id="cb6-24"><a href="#cb6-24"></a>  <span class="at">zlab =</span> <span class="fu">list</span>(<span class="st">"辐射强度"</span>, <span class="at">rot =</span> <span class="dv">90</span>),</span>
<span id="cb6-25"><a href="#cb6-25"></a>  <span class="at">type =</span> <span class="fu">c</span>(<span class="st">"p"</span>, <span class="st">"h"</span>), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">lwd =</span> <span class="fl">0.5</span>,</span>
<span id="cb6-26"><a href="#cb6-26"></a>  <span class="at">panel.3d.cloud =</span> <span class="cf">function</span>(...) {</span>
<span id="cb6-27"><a href="#cb6-27"></a>    <span class="fu">panel.3dcoastline</span>(...) <span class="co"># 海岸线</span></span>
<span id="cb6-28"><a href="#cb6-28"></a>    <span class="fu">panel.3dscatter</span>(...)</span>
<span id="cb6-29"><a href="#cb6-29"></a>  },</span>
<span id="cb6-30"><a href="#cb6-30"></a>  <span class="co"># 减少三维图形的边空</span></span>
<span id="cb6-31"><a href="#cb6-31"></a>  <span class="at">lattice.options =</span> <span class="fu">list</span>(</span>
<span id="cb6-32"><a href="#cb6-32"></a>    <span class="at">layout.widths =</span> <span class="fu">list</span>(</span>
<span id="cb6-33"><a href="#cb6-33"></a>      <span class="at">left.padding =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">units =</span> <span class="st">"inches"</span>),</span>
<span id="cb6-34"><a href="#cb6-34"></a>      <span class="at">right.padding =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="sc">-</span><span class="fl">1.0</span>, <span class="at">units =</span> <span class="st">"inches"</span>)</span>
<span id="cb6-35"><a href="#cb6-35"></a>    ),</span>
<span id="cb6-36"><a href="#cb6-36"></a>    <span class="at">layout.heights =</span> <span class="fu">list</span>(</span>
<span id="cb6-37"><a href="#cb6-37"></a>      <span class="at">bottom.padding =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">units =</span> <span class="st">"inches"</span>),</span>
<span id="cb6-38"><a href="#cb6-38"></a>      <span class="at">top.padding =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">units =</span> <span class="st">"inches"</span>)</span>
<span id="cb6-39"><a href="#cb6-39"></a>    )</span>
<span id="cb6-40"><a href="#cb6-40"></a>  ),</span>
<span id="cb6-41"><a href="#cb6-41"></a>  <span class="at">par.settings =</span> <span class="fu">list</span>(</span>
<span id="cb6-42"><a href="#cb6-42"></a>    <span class="co"># 移除几条内框线</span></span>
<span id="cb6-43"><a href="#cb6-43"></a>    <span class="co"># box.3d = list(col = c(1, 1, NA, NA, 1, NA, 1, 1, 1)),</span></span>
<span id="cb6-44"><a href="#cb6-44"></a>    <span class="co"># 刻度标签字体大小</span></span>
<span id="cb6-45"><a href="#cb6-45"></a>    <span class="at">axis.text =</span> <span class="fu">list</span>(<span class="at">cex =</span> <span class="fl">0.8</span>),</span>
<span id="cb6-46"><a href="#cb6-46"></a>    <span class="co"># 去掉外框线</span></span>
<span id="cb6-47"><a href="#cb6-47"></a>    <span class="at">axis.line =</span> <span class="fu">list</span>(<span class="at">col =</span> <span class="st">"transparent"</span>)</span>
<span id="cb6-48"><a href="#cb6-48"></a>  ),</span>
<span id="cb6-49"><a href="#cb6-49"></a>  <span class="co"># 设置三维图的观察方位</span></span>
<span id="cb6-50"><a href="#cb6-50"></a>  <span class="at">screen =</span> <span class="fu">list</span>(<span class="at">z =</span> <span class="dv">30</span>, <span class="at">x =</span> <span class="sc">-</span><span class="dv">65</span>, <span class="at">y =</span> <span class="dv">0</span>)</span>
<span id="cb6-51"><a href="#cb6-51"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-rongelap-concentration" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-rongelap-concentration-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-rongelap-concentration-1.png" class="img-fluid figure-img" width="499">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rongelap-concentration-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;28.4: 岛上各采样点的辐射强度
</figcaption></figure>
</div>
</div>
</div>
</section><section id="sec-rongelap-modeling" class="level2" data-number="28.3"><h2 data-number="28.3" class="anchored" data-anchor-id="sec-rongelap-modeling">
<span class="header-section-number">28.3</span> 数据建模</h2>
<section id="sec-rongelap-glm" class="level3" data-number="28.3.1"><h3 data-number="28.3.1" class="anchored" data-anchor-id="sec-rongelap-glm">
<span class="header-section-number">28.3.1</span> 广义线性模型</h3>
<p>核辐射是由放射元素衰变产生的，通常用单位时间释放出来的粒子数目表示辐射强度，因此，建立如下泊松型广义线性模型来拟合核辐射强度。</p>
<p><span class="math display">\[
\begin{aligned}
\log(\lambda_i) &amp;= \beta \\
y_i &amp; \sim \mathrm{Poisson}(t_i\lambda_i)
\end{aligned}
\]</span></p>
<p>其中，<span class="math inline">\(\lambda_i\)</span> 表示核辐射强度，<span class="math inline">\(\beta\)</span> 表示未知的截距，<span class="math inline">\(y_i\)</span> 表示观测到的粒子数目，<span class="math inline">\(t_i\)</span> 表示相应的观测时间，<span class="math inline">\(i = 1,\ldots, 157\)</span> 表示采样点的位置编号。R 软件内置的 <strong>stats</strong> 包有函数 <code><a href="https://rdrr.io/r/stats/glm.html">glm()</a></code> 可以拟合上述广义线性模型，代码如下。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>fit_rongelap_poisson <span class="ot">&lt;-</span> <span class="fu">glm</span>(counts <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>), <span class="at">offset =</span> <span class="fu">log</span>(time), <span class="at">data =</span> rongelap</span>
<span id="cb7-3"><a href="#cb7-3"></a>)</span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="fu">summary</span>(fit_rongelap_poisson)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Call:
#&gt; glm(formula = counts ~ 1, family = poisson(link = "log"), data = rongelap, 
#&gt;     offset = log(time))
#&gt; 
#&gt; Coefficients:
#&gt;             Estimate Std. Error z value Pr(&gt;|z|)    
#&gt; (Intercept) 2.013954   0.001454    1385   &lt;2e-16 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt; (Dispersion parameter for poisson family taken to be 1)
#&gt; 
#&gt;     Null deviance: 61567  on 156  degrees of freedom
#&gt; Residual deviance: 61567  on 156  degrees of freedom
#&gt; AIC: 63089
#&gt; 
#&gt; Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
<p>当 <code>family = poisson(link = "log")</code> 时，响应变量只能是正整数，所以不能放 <code>counts / time</code>。泊松广义线性模型是对辐射强度建模，辐射强度与位置 <code>cX</code> 和 <code>cY</code> 有关。当响应变量为放射出来的粒子数目 <code>counts</code> 时，为了表示辐射强度，需要设置参数 <code>offset</code>，表示与放射粒子数目对应的时间间隔 <code>time</code>。联系函数是对数函数，因此时间间隔需要取对数。</p>
<p>从辐射强度的拟合残差的空间分布 <a href="#fig-rongelap-poisson-residuals" class="quarto-xref">图&nbsp;<span>28.5</span></a> 不难看出，颜色深和颜色浅的点分别聚集在一起，且与周围点的颜色呈现层次变化，拟合残差存在明显的空间相关性。如果将位置变量 <code>cX</code> 和 <code>cY</code> 加入广义线性模型，也会达到统计意义上的显著。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>rongelap<span class="sc">$</span>poisson_residuals <span class="ot">&lt;-</span> <span class="fu">residuals</span>(fit_rongelap_poisson)</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="fu">ggplot</span>(rongelap, <span class="fu">aes</span>(<span class="at">x =</span> cX, <span class="at">y =</span> cY)) <span class="sc">+</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">colour =</span> poisson_residuals <span class="sc">/</span> time), <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>  <span class="fu">scale_color_viridis_c</span>(<span class="at">option =</span> <span class="st">"C"</span>) <span class="sc">+</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"横坐标（米）"</span>, <span class="at">y =</span> <span class="st">"纵坐标（米）"</span>, <span class="at">color =</span> <span class="st">"残差"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-rongelap-poisson-residuals" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-rongelap-poisson-residuals-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-rongelap-poisson-residuals-1.png" class="img-fluid figure-img" width="595">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rongelap-poisson-residuals-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;28.5: 残差的空间分布
</figcaption></figure>
</div>
</div>
</div>
<p><a href="#fig-poisson-residuals" class="quarto-xref">图&nbsp;<span>28.6</span></a> 描述残差的分布，从 <a href="#fig-poisson-residuals-1" class="quarto-xref">图&nbsp;<span>28.6 (a)</span></a> 发现残差存在一定的线性趋势，岛屿的东南方，残差基本为正，而在岛屿的西北方，残差基本为负，说明有一定的异方差性。从 <a href="#fig-poisson-residuals-2" class="quarto-xref">图&nbsp;<span>28.6 (b)</span></a> 发现残差在水平方向上的分布像个哑铃，说明异方差现象明显。从 <a href="#fig-poisson-residuals-3" class="quarto-xref">图&nbsp;<span>28.6 (c)</span></a> 发现残差在垂直方向上的分布像棵松树，也说明异方差现象明显。</p>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="fu">ggplot</span>(rongelap, <span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">157</span>, <span class="at">y =</span> poisson_residuals <span class="sc">/</span> time)) <span class="sc">+</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"编号"</span>, <span class="at">y =</span> <span class="st">"残差"</span>)</span>
<span id="cb10-5"><a href="#cb10-5"></a></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="fu">ggplot</span>(rongelap, <span class="fu">aes</span>(<span class="at">x =</span> cX, <span class="at">y =</span> poisson_residuals <span class="sc">/</span> time)) <span class="sc">+</span></span>
<span id="cb10-7"><a href="#cb10-7"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb10-8"><a href="#cb10-8"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb10-9"><a href="#cb10-9"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"横坐标"</span>, <span class="at">y =</span> <span class="st">"残差"</span>)</span>
<span id="cb10-10"><a href="#cb10-10"></a></span>
<span id="cb10-11"><a href="#cb10-11"></a><span class="fu">ggplot</span>(rongelap, <span class="fu">aes</span>(<span class="at">x =</span> cY, <span class="at">y =</span> poisson_residuals <span class="sc">/</span> time)) <span class="sc">+</span></span>
<span id="cb10-12"><a href="#cb10-12"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb10-13"><a href="#cb10-13"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb10-14"><a href="#cb10-14"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"纵坐标"</span>, <span class="at">y =</span> <span class="st">"残差"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-poisson-residuals" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-poisson-residuals-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-poisson-residuals" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-poisson-residuals-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-poisson-residuals-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-poisson-residuals-1.png" class="img-fluid figure-img" data-ref-parent="fig-poisson-residuals" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-poisson-residuals-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 残差与编号的关系
</figcaption></figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-poisson-residuals" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-poisson-residuals-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-poisson-residuals-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-poisson-residuals-2.png" class="img-fluid figure-img" data-ref-parent="fig-poisson-residuals" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-poisson-residuals-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 残差与横坐标的关系
</figcaption></figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-poisson-residuals" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-poisson-residuals-3" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-poisson-residuals-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-poisson-residuals-3.png" class="img-fluid figure-img" data-ref-parent="fig-poisson-residuals" width="384">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-poisson-residuals-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) 残差与纵坐标的关系
</figcaption></figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-poisson-residuals-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;28.6: 残差分布图
</figcaption></figure>
</div>
</section><section id="sec-rongelap-slmm" class="level3" data-number="28.3.2"><h3 data-number="28.3.2" class="anchored" data-anchor-id="sec-rongelap-slmm">
<span class="header-section-number">28.3.2</span> 空间线性混合效应模型</h3>
<p>从实际场景出发，也不难理解，位置信息是非常关键的。进一步，充分利用位置信息，精细建模是很有必要的。相邻位置的核辐射强度是相关的，离得近的比离得远的更相关。下面对辐射强度建模，假定随机效应之间存在相关性结构，去掉随机效应相互独立的假设，这更符合位置效应存在相互影响的实际情况。</p>
<p><span id="eq-rongelap-gaussian-slmm"><span class="math display">\[
\log\big(\lambda(x_i)\big) = \beta + S(x_{i}) + Z_{i}
\tag{28.1}\]</span></span></p>
<p>其中，<span class="math inline">\(\beta\)</span> 表示截距，相当于平均水平，<span class="math inline">\(\lambda(x_i)\)</span> 表示位置 <span class="math inline">\(x_i\)</span> 处的辐射强度，<span class="math inline">\(S(x_{i})\)</span> 表示位置 <span class="math inline">\(x_i\)</span> 处的空间效应，<span class="math inline">\(S(x),x \in \mathcal{D} \subset{\mathbb{R}^2}\)</span> 是二维平稳空间高斯过程 <span class="math inline">\(\mathcal{S}\)</span> 的具体实现。 <span class="math inline">\(\mathcal{D}\)</span> 表示研究区域，可以理解为朗格拉普岛，它是二维实平面 <span class="math inline">\(\mathbb{R}^2\)</span> 的子集。 <span class="math inline">\(Z_i\)</span> 之间相互独立同正态分布 <span class="math inline">\(\mathcal{N}(0,\tau^2)\)</span> ，<span class="math inline">\(Z_i\)</span> 表示非空间的随机效应，在空间统计中，常称之为块金效应，可以理解为测量误差、空间变差或背景辐射。值得注意，此时，块金效应和模型残差是合并在一起的。</p>
<section id="sec-covariance-function" class="level4" data-number="28.3.2.1"><h4 data-number="28.3.2.1" class="anchored" data-anchor-id="sec-covariance-function">
<span class="header-section-number">28.3.2.1</span> 自协方差函数</h4>
<p>随机过程 <span class="math inline">\(S(x)\)</span> 的自协方差函数常用的有指数型、幂二次指数型（高斯型）和梅隆型，形式如下：</p>
<p><span id="eq-matern-formula"><span class="math display">\[
\begin{aligned}
\mathsf{Cov}\{ S(x_i), S(x_j) \} &amp;= \sigma^2 \exp\big( -\frac{\|x_i -x_j\|_{2}}{\phi} \big) \\
\mathsf{Cov}\{ S(x_i), S(x_j) \} &amp;= \sigma^2 \exp\big( -\frac{\|x_i -x_j\|_{2}^{2}}{2\phi^2} \big) \\
\mathsf{Cov}\{ S(x_i), S(x_j) \} &amp;= \sigma^2 \frac{2^{1 - \nu}}{\Gamma(\nu)}
\left(\sqrt{2\nu}\frac{\|x_i -x_j\|_{2}}{\phi}\right)^{\nu}
K_{\nu}\left(\sqrt{2\nu}\frac{\|x_i -x_j\|_{2}}{\phi}\right) \\
K_{\nu}(x) &amp;= \int_{0}^{\infty}\exp(-x \cosh t) \cosh (\nu t) \mathrm{dt}
\end{aligned}
\tag{28.2}\]</span></span></p>
<p>其中，<span class="math inline">\(K_{\nu}\)</span> 表示阶数为 <span class="math inline">\(\nu\)</span> 的修正的第二类贝塞尔函数，<span class="math inline">\(\Gamma(\cdot)\)</span> 表示伽马函数，当 <span class="math inline">\(\nu = 1/2\)</span> ，梅隆型将简化为指数型，当 <span class="math inline">\(\nu = \infty\)</span> 时，梅隆型将简化为幂二次指数型。</p>
<p><span class="math display">\[
\mathsf{Cov}\{ S(x_i), S(x_j) \} = \sigma^2 \rho(u_{ij})
\]</span></p>
<p>其中，<span class="math inline">\(\rho(u_{ij})\)</span> 表示自相关函数。 <span class="math inline">\(u_{ij}\)</span> 表示位置 <span class="math inline">\(x_i\)</span> 与 <span class="math inline">\(x_j\)</span> 之间的距离，常用的有欧氏距离。梅隆型自相关函数图像如 <a href="#fig-matern-fun" class="quarto-xref">图&nbsp;<span>28.7</span></a> 所示，不难看出，<span class="math inline">\(\nu\)</span> 影响自相关函数的平滑性，控制点与点之间相关性的变化，<span class="math inline">\(\nu\)</span> 越大相关性越迅速地递减。<span class="math inline">\(\phi\)</span> 控制自相关函数的范围，<span class="math inline">\(\phi\)</span> 越大相关性辐射距离越远。对模型来说，它们都是超参数。</p>
<div class="cell">
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="co"># 参数 x 两点之间的距离，要求 x 大于 0</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="co"># 参数 sigma nu phi 分别与前述公式参数对应</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>cov_matern_nu <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">nu =</span> <span class="dv">3</span> <span class="sc">/</span> <span class="dv">2</span>, <span class="at">phi =</span> <span class="dv">5</span>) {</span>
<span id="cb11-4"><a href="#cb11-4"></a>  phi <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="dv">2</span> <span class="sc">*</span> nu) <span class="sc">*</span> x <span class="sc">/</span> phi</span>
<span id="cb11-5"><a href="#cb11-5"></a>  sigma<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> <span class="dv">2</span><span class="sc">^</span>(<span class="dv">1</span> <span class="sc">-</span> nu) <span class="sc">/</span> <span class="fu">gamma</span>(nu) <span class="sc">*</span> phi<span class="sc">^</span>nu <span class="sc">*</span> <span class="fu">besselK</span>(<span class="at">x =</span> phi, <span class="at">nu =</span> nu)</span>
<span id="cb11-6"><a href="#cb11-6"></a>}</span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb11-8"><a href="#cb11-8"></a>mesh_matern <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb11-9"><a href="#cb11-9"></a>  <span class="at">x =</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="fl">0.01</span>, <span class="at">to =</span> <span class="dv">20</span>, <span class="at">by =</span> <span class="fl">0.04</span>),</span>
<span id="cb11-10"><a href="#cb11-10"></a>  <span class="at">sigma =</span> <span class="dv">1</span>, <span class="at">nu =</span> <span class="fu">c</span>(<span class="dv">5</span> <span class="sc">/</span> <span class="dv">2</span>, <span class="dv">3</span> <span class="sc">/</span> <span class="dv">2</span>, <span class="dv">1</span> <span class="sc">/</span> <span class="dv">2</span>), <span class="at">phi =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="fl">2.5</span>)</span>
<span id="cb11-11"><a href="#cb11-11"></a>)</span>
<span id="cb11-12"><a href="#cb11-12"></a></span>
<span id="cb11-13"><a href="#cb11-13"></a>mesh_matern<span class="sc">$</span>fv <span class="ot">&lt;-</span> <span class="fu">cov_matern_nu</span>(</span>
<span id="cb11-14"><a href="#cb11-14"></a>  <span class="at">x =</span> mesh_matern<span class="sc">$</span>x, <span class="at">sigma =</span> mesh_matern<span class="sc">$</span>sigma,</span>
<span id="cb11-15"><a href="#cb11-15"></a>  <span class="at">nu =</span> mesh_matern<span class="sc">$</span>nu, <span class="at">phi =</span> mesh_matern<span class="sc">$</span>phi</span>
<span id="cb11-16"><a href="#cb11-16"></a>)</span>
<span id="cb11-17"><a href="#cb11-17"></a></span>
<span id="cb11-18"><a href="#cb11-18"></a>mesh_matern<span class="sc">$</span>nu_math <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"nu=="</span>, mesh_matern<span class="sc">$</span>nu, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb11-19"><a href="#cb11-19"></a>mesh_matern<span class="sc">$</span>phi_math <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"phi=="</span>, mesh_matern<span class="sc">$</span>phi, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb11-20"><a href="#cb11-20"></a></span>
<span id="cb11-21"><a href="#cb11-21"></a><span class="fu">ggplot</span>(<span class="at">data =</span> mesh_matern, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> fv)) <span class="sc">+</span></span>
<span id="cb11-22"><a href="#cb11-22"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> nu_math)) <span class="sc">+</span></span>
<span id="cb11-23"><a href="#cb11-23"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(phi_math), <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">labeller =</span> ggplot2<span class="sc">::</span>label_parsed) <span class="sc">+</span></span>
<span id="cb11-24"><a href="#cb11-24"></a>  <span class="fu">scale_color_viridis_d</span>(</span>
<span id="cb11-25"><a href="#cb11-25"></a>    <span class="at">labels =</span> <span class="fu">expression</span>(nu <span class="sc">==</span> <span class="fl">0.5</span>, nu <span class="sc">==</span> <span class="fl">1.5</span>, nu <span class="sc">==</span> <span class="fl">2.5</span>), </span>
<span id="cb11-26"><a href="#cb11-26"></a>    <span class="at">begin =</span> <span class="fl">0.3</span>, <span class="at">end =</span> <span class="fl">0.7</span>, <span class="at">option =</span> <span class="st">"C"</span></span>
<span id="cb11-27"><a href="#cb11-27"></a>    ) <span class="sc">+</span></span>
<span id="cb11-28"><a href="#cb11-28"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb11-29"><a href="#cb11-29"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"距离"</span>, <span class="at">y =</span> <span class="st">"相关性"</span>, <span class="at">color =</span> <span class="fu">expression</span>(nu))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-matern-fun" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-matern-fun-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-matern-fun-1.png" class="img-fluid figure-img" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-matern-fun-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;28.7: 梅隆型自相关函数曲线
</figcaption></figure>
</div>
</div>
</div>
</section><section id="sec-correlation-function" class="level4" data-number="28.3.2.2"><h4 data-number="28.3.2.2" class="anchored" data-anchor-id="sec-correlation-function">
<span class="header-section-number">28.3.2.2</span> nlme 包的自相关函数</h4>
<p><strong>nlme</strong> 包中带块金效应的指数型自相关函数设定如下：</p>
<p><span class="math display">\[
\rho(u; \phi, \tau_{rel}^2 ) = \tau_{rel}^2 + (1 - \tau_{rel}^2) \big(1 - \exp(- \frac{u}{\phi}) \big)
\]</span></p>
<p>为了方便参数估计，<strong>nlme</strong> 包对参数做了一些重参数化的操作。</p>
<p><span id="eq-reparameterization"><span class="math display">\[
\begin{aligned}
\tau_{rel}^2 &amp;= \frac{\tau^2}{\tau^2 + \sigma^2} \\
\sigma_{tol}^2 &amp;= \tau^2 + \sigma^2
\end{aligned}
\tag{28.3}\]</span></span></p>
<p>当 <span class="math inline">\(u\)</span> 趋于 0 时， <span class="math inline">\(\rho(u; \phi, \tau_{rel}^2 ) = \tau_{rel}^2\)</span> 。另外，<span class="math inline">\(\phi\)</span> 取值为正，<span class="math inline">\(\tau_{rel}^2\)</span> 取值介于 0-1 之间，在默认设置下，<span class="math inline">\(\phi\)</span> 的初始值为 <span class="math inline">\(0.1 \times \max_{i,j \in A} u_{ij}\)</span>，即所有点之间距离的最大值的 10%， <span class="math inline">\(\tau_{rel}^2\)</span> 为 0.1 ，这只是作为参考，用户可根据实际情况调整。</p>
<p>下面以一个简单示例理解自相关函数 <code>corExp()</code> 的作用，令 <span class="math inline">\(\phi = 1.2, \tau_{rel}^2 = 0.2\)</span>，则由距离矩阵和自相关函数构造的自相关矩阵如下：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">library</span>(nlme)</span>
<span id="cb12-2"><a href="#cb12-2"></a>spatDat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>) <span class="sc">/</span> <span class="dv">4</span>, <span class="at">y =</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>) <span class="sc">/</span> <span class="dv">4</span>)</span>
<span id="cb12-3"><a href="#cb12-3"></a>cs3Exp <span class="ot">&lt;-</span> <span class="fu">corExp</span>(<span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">0.2</span>), <span class="at">form =</span> <span class="sc">~</span> x <span class="sc">+</span> y, <span class="at">nugget =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-4"><a href="#cb12-4"></a>cs3Exp <span class="ot">&lt;-</span> <span class="fu">Initialize</span>(cs3Exp, spatDat)</span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="fu">corMatrix</span>(cs3Exp)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;           [,1]     [,2]     [,3]      [,4]
#&gt; [1,] 1.0000000 0.595847 0.443792 0.3305402
#&gt; [2,] 0.5958470 1.000000 0.595847 0.4437920
#&gt; [3,] 0.4437920 0.595847 1.000000 0.5958470
#&gt; [4,] 0.3305402 0.443792 0.595847 1.0000000</code></pre>
</div>
</div>
<p>自相关矩阵的初始化结果等价于如下矩阵：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">diag</span>(<span class="fl">0.2</span>, <span class="dv">4</span>) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fl">0.2</span>) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">as.matrix</span>(<span class="fu">dist</span>(spatDat)) <span class="sc">/</span> <span class="fl">1.2</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;           1        2        3         4
#&gt; 1 1.0000000 0.595847 0.443792 0.3305402
#&gt; 2 0.5958470 1.000000 0.595847 0.4437920
#&gt; 3 0.4437920 0.595847 1.000000 0.5958470
#&gt; 4 0.3305402 0.443792 0.595847 1.0000000</code></pre>
</div>
</div>
<p>除了函数 <code>corExp()</code> ，<strong>nlme</strong> 包还有好些自相关函数，如高斯自相关函数 <code>corGaus()</code> ，线性自相关函数 <code>corLin()</code> ，有理自相关函数 <code>corRatio()</code> ，球型自相关函数 <code>corSpher()</code> 等。它们的作用与函数 <code>corExp()</code> 类似，使用方式也一样，如下是高斯型自相关函数的示例，其他的不再一一举例。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>cs3Gaus <span class="ot">&lt;-</span> <span class="fu">corGaus</span>(<span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">0.2</span>), <span class="at">form =</span> <span class="sc">~</span> x <span class="sc">+</span> y, <span class="at">nugget =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-2"><a href="#cb16-2"></a>cs3Gaus <span class="ot">&lt;-</span> <span class="fu">Initialize</span>(cs3Gaus, spatDat)</span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="fu">corMatrix</span>(cs3Gaus)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;           [,1]      [,2]      [,3]      [,4]
#&gt; [1,] 1.0000000 0.7334843 0.5653186 0.3662667
#&gt; [2,] 0.7334843 1.0000000 0.7334843 0.5653186
#&gt; [3,] 0.5653186 0.7334843 1.0000000 0.7334843
#&gt; [4,] 0.3662667 0.5653186 0.7334843 1.0000000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="co"># 等价于</span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="fu">diag</span>(<span class="fl">0.2</span>, <span class="dv">4</span>) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fl">0.2</span>) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fu">as.matrix</span>(<span class="fu">dist</span>(spatDat))<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="fl">1.2</span><span class="sc">^</span><span class="dv">2</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;           1         2         3         4
#&gt; 1 1.0000000 0.7334843 0.5653186 0.3662667
#&gt; 2 0.7334843 1.0000000 0.7334843 0.5653186
#&gt; 3 0.5653186 0.7334843 1.0000000 0.7334843
#&gt; 4 0.3662667 0.5653186 0.7334843 1.0000000</code></pre>
</div>
</div>
</section><section id="sec-gls-function" class="level4" data-number="28.3.2.3"><h4 data-number="28.3.2.3" class="anchored" data-anchor-id="sec-gls-function">
<span class="header-section-number">28.3.2.3</span> nlme 包的拟合函数 <code>gls()</code>
</h4>
<p><strong>nlme</strong> 包的函数 <code>gls()</code> 实现限制极大似然估计方法，可以拟合存在异方差的一般线性模型。所谓一般线性模型，即在简单线性模型的基础上，残差不再是独立同分布的，而是存在相关性。函数 <code>gls()</code> 可以拟合具有空间自相关性的残差结构。这种线性模型又可以看作是一种带空间自相关结构的线性混合效应模型，空间随机效应的结构可以看作异方差的结构。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>fit_rongelap_gls <span class="ot">&lt;-</span> <span class="fu">gls</span>(</span>
<span id="cb20-2"><a href="#cb20-2"></a>  <span class="fu">log</span>(counts <span class="sc">/</span> time) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> rongelap,</span>
<span id="cb20-3"><a href="#cb20-3"></a>  <span class="at">correlation =</span> <span class="fu">corExp</span>(</span>
<span id="cb20-4"><a href="#cb20-4"></a>    <span class="at">value =</span> <span class="fu">c</span>(<span class="dv">200</span>, <span class="fl">0.1</span>), <span class="at">form =</span> <span class="sc">~</span> cX <span class="sc">+</span> cY, <span class="at">nugget =</span> <span class="cn">TRUE</span></span>
<span id="cb20-5"><a href="#cb20-5"></a>  )</span>
<span id="cb20-6"><a href="#cb20-6"></a>)</span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="fu">summary</span>(fit_rongelap_gls)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Generalized least squares fit by REML
#&gt;   Model: log(counts/time) ~ 1 
#&gt;   Data: rongelap 
#&gt;        AIC      BIC    logLik
#&gt;   184.4451 196.6446 -88.22257
#&gt; 
#&gt; Correlation Structure: Exponential spatial correlation
#&gt;  Formula: ~cX + cY 
#&gt;  Parameter estimate(s):
#&gt;       range      nugget 
#&gt; 169.7472087   0.1092496 
#&gt; 
#&gt; Coefficients:
#&gt;                Value Std.Error  t-value p-value
#&gt; (Intercept) 1.812914 0.1088037 16.66224       0
#&gt; 
#&gt; Standardized residuals:
#&gt;         Min          Q1         Med          Q3         Max 
#&gt; -5.57385199 -0.06909454  0.34610011  0.73852188  1.57152087 
#&gt; 
#&gt; Residual standard error: 0.5739672 
#&gt; Degrees of freedom: 157 total; 156 residual</code></pre>
</div>
</div>
<p><strong>nlme</strong> 包给出截距项 <span class="math inline">\(\beta\)</span> 、相对块金效应 <span class="math inline">\(\tau_{rel}^2\)</span> 、范围参数 <span class="math inline">\(\phi\)</span> 和残差标准差 <span class="math inline">\(\sigma_{tol}\)</span> 的估计，</p>
<p><span class="math display">\[
\begin{aligned}
\beta &amp;= 1.812914, \quad \phi  = 169.7472088 \\
\tau_{rel}^2   &amp;= 0.1092496, \quad \sigma_{tol} = 0.5739672
\end{aligned}
\]</span></p>
<p>根据前面的 <a href="#eq-reparameterization" class="quarto-xref">方程式&nbsp;<span>28.3</span></a> ，可以得到 <span class="math inline">\(\tau^2\)</span> 和 <span class="math inline">\(\sigma^2\)</span> 的估计。</p>
<p><span class="math display">\[
\begin{aligned}
\tau^2   &amp;= \tau^2_{rel} \times \sigma^2_{tol} = 0.1092496 \times 0.3294383 = 0.035991 \\
\sigma^2 &amp;= \sigma^2_{tol} - \tau^2_{rel} \times \sigma^2_{tol} = 0.5739672^2 - 0.1092496 \times 0.3294383 = 0.2934473
\end{aligned}
\]</span></p>
</section><section id="sec-semi-variogram" class="level4" data-number="28.3.2.4"><h4 data-number="28.3.2.4" class="anchored" data-anchor-id="sec-semi-variogram">
<span class="header-section-number">28.3.2.4</span> 经验半变差函数图</h4>
<p>接下来用经验半变差函数图检查空间相关性。为方便表述起见，令 <span class="math inline">\(T(x_i)\)</span> 代表 <a href="#eq-rongelap-gaussian-slmm" class="quarto-xref">方程式&nbsp;<span>28.1</span></a> 等号右侧的部分，即表示线性预测（Linear Predictor）。</p>
<p><span class="math display">\[
T(x_i) = \beta + S(x_{i}) + Z_{i}
\]</span></p>
<p>令 <span class="math inline">\(\gamma(u_{ij}) = \frac{1}{2}\mathsf{Var}\{T(x_i) - T(x_j)\}\)</span> 表示半变差函数（Semivariogram），这里 <span class="math inline">\(u_{ij}\)</span> 表示采样点 <span class="math inline">\(x_i\)</span> 与 <span class="math inline">\(x_j\)</span> 之间的距离。考虑到</p>
<p><span id="eq-semi-variogram"><span class="math display">\[
\gamma(u_{ij}) = \frac{1}{2}\mathsf{E}\big\{\big[T(x_i) - T(x_j)\big]^2\big\} = \tau^2 + \sigma^2\big(1-\rho(u_{ij})\big)
\tag{28.4}\]</span></span></p>
<p>上式第一个等号右侧期望可以用样本代入来计算，称之为经验半变差函数，第二个等号右侧为理论半变差函数。为了便于计算，将距离做一定划分，尽量使得各个距离区间的样本点对的数目接近。此时，第 <span class="math inline">\(i\)</span> 个距离区间上经验半变差函数值 <span class="math inline">\(\hat{\gamma}(h_i)\)</span> 的计算公式如下：</p>
<p><span class="math display">\[
\hat{\gamma}(h_i) = \frac{1}{2N(h_i)}\sum_{j=1}^{N(h_i)}(T(x_i)-T(x_i+h'))^2, \ \ h_{i,0} \le h' &lt; h_{i,1}
\]</span></p>
<p>其中，<span class="math inline">\([h_{i,0},h_{i,1}]\)</span> 表示第 <span class="math inline">\(i\)</span> 个距离区间，<span class="math inline">\(N(h_i)\)</span> 表示第 <span class="math inline">\(i\)</span> 个距离区间内所有样本点对的数目，只要两个点之间的距离在这个区间内，就算是一对。<code>rongelap</code> 数据集包含 157 个采样点，两两配对，共有 <span class="math inline">\((157 - 1) \times 157 / 2 = 12246\)</span> 对。下面举个例子说明函数 <code>Variogram()</code> 的作用。假设模型参数已经估计出来了，可以根据理论变差公式 <a href="#eq-semi-variogram" class="quarto-xref">方程式&nbsp;<span>28.4</span></a> 计算， 设置为 <span class="math inline">\(\phi = 200, \tau_{rel}^2 = 0.1\)</span> 。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="fl">0.1</span>  <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fl">0.1</span>) <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">exp</span>(<span class="sc">-</span> <span class="dv">40</span> <span class="sc">/</span> <span class="dv">200</span> ))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 0.2631423</code></pre>
</div>
</div>
<p>可知当距离为 40 时，半变差函数值为 0.2631423 ，当距离为 175.9570 时，半变差函数值为 0.6266151 。下面基于 <strong>nlme</strong> 包中自相关函数计算半变差函数值 ，将 rongelap 数据代入函数 <code>Variogram()</code> 可以计算每个距离对应的函数值，默认计算 50 个，如 <a href="#fig-rongelap-vario-theory" class="quarto-xref">图&nbsp;<span>28.8</span></a> 所示。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>cs <span class="ot">&lt;-</span> <span class="fu">corExp</span>(<span class="at">value =</span> <span class="fu">c</span>(<span class="dv">200</span>, <span class="fl">0.1</span>), <span class="at">form =</span> <span class="sc">~</span> cX <span class="sc">+</span> cY, <span class="at">nugget =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-2"><a href="#cb24-2"></a>cs <span class="ot">&lt;-</span> <span class="fu">Initialize</span>(cs, rongelap)</span>
<span id="cb24-3"><a href="#cb24-3"></a>vario <span class="ot">&lt;-</span> <span class="fu">Variogram</span>(cs)</span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="fu">head</span>(vario)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;      variog     dist
#&gt; 1 0.2631423  40.0000
#&gt; 2 0.6266152 175.9570
#&gt; 3 0.8107963 311.9141
#&gt; 4 0.9041256 447.8711
#&gt; 5 0.9514180 583.8282
#&gt; 6 0.9753822 719.7852</code></pre>
</div>
</div>
<p>可以看到，当距离为 40 时，计算的结果与上面是一致的，也知道了函数 <code>Variogram()</code> 的作用。</p>
<div class="cell">
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="co"># 经验半变差图</span></span>
<span id="cb26-2"><a href="#cb26-2"></a><span class="fu">plot</span>(vario,</span>
<span id="cb26-3"><a href="#cb26-3"></a>  <span class="at">col.line =</span> <span class="st">"black"</span>, <span class="at">scales =</span> <span class="fu">list</span>(</span>
<span id="cb26-4"><a href="#cb26-4"></a>    <span class="co"># 去掉图形上边、右边多余的刻度线</span></span>
<span id="cb26-5"><a href="#cb26-5"></a>    <span class="at">x =</span> <span class="fu">list</span>(<span class="at">alternating =</span> <span class="dv">1</span>, <span class="at">tck =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>)),</span>
<span id="cb26-6"><a href="#cb26-6"></a>    <span class="at">y =</span> <span class="fu">list</span>(<span class="at">alternating =</span> <span class="dv">1</span>, <span class="at">tck =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb26-7"><a href="#cb26-7"></a>  ), <span class="at">par.settings =</span> <span class="fu">list</span>(</span>
<span id="cb26-8"><a href="#cb26-8"></a>    <span class="at">plot.symbol =</span> <span class="fu">list</span>(<span class="at">pch =</span> <span class="dv">20</span>, <span class="at">col =</span> <span class="st">"black"</span>),</span>
<span id="cb26-9"><a href="#cb26-9"></a>    <span class="at">plot.line =</span> <span class="fu">list</span>(<span class="at">lwd =</span> <span class="dv">1</span>)</span>
<span id="cb26-10"><a href="#cb26-10"></a>  ),</span>
<span id="cb26-11"><a href="#cb26-11"></a>  <span class="at">xlab =</span> <span class="st">"距离（米）"</span>, <span class="at">ylab =</span> <span class="st">"半变差函数值"</span></span>
<span id="cb26-12"><a href="#cb26-12"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-rongelap-vario-theory" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-rongelap-vario-theory-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-rongelap-vario-theory-1.png" class="img-fluid figure-img" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rongelap-vario-theory-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;28.8: 理论半变差函数图
</figcaption></figure>
</div>
</div>
</div>
<p><strong>nlme</strong> 包的函数 <code>Variogram()</code> 根据函数 <code>gls()</code> 估计的参数值计算模型残差的经验半变差函数值：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>fit_rongelap_vario <span class="ot">&lt;-</span> <span class="fu">Variogram</span>(fit_rongelap_gls,</span>
<span id="cb27-2"><a href="#cb27-2"></a>  <span class="at">form =</span> <span class="sc">~</span> cX <span class="sc">+</span> cY, <span class="at">data =</span> rongelap, <span class="at">resType =</span> <span class="st">"response"</span></span>
<span id="cb27-3"><a href="#cb27-3"></a>)</span>
<span id="cb27-4"><a href="#cb27-4"></a>fit_rongelap_vario</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;        variog       dist n.pairs
#&gt; 1  0.07006716   89.44272     510
#&gt; 2  0.12719889  144.22205     601
#&gt; 3  0.17289246  252.98221     581
#&gt; 4  0.22384959  368.78178     622
#&gt; 5  0.26006395  443.84682     592
#&gt; 6  0.20694239  521.53619     616
#&gt; 7  0.41861866  718.05292     611
#&gt; 8  0.30180842 1028.20230     610
#&gt; 9  0.16717617 1493.73690     612
#&gt; 10 0.14683508 2150.08137     612
#&gt; 11 0.15149089 2993.10009     612
#&gt; 12 0.21048419 3896.79355     613
#&gt; 13 0.21372840 4600.21330     618
#&gt; 14 0.17302418 4889.68302     607
#&gt; 15 0.20205496 5065.98460     618
#&gt; 16 0.18620361 5195.76751     623
#&gt; 17 0.18613578 5293.99660     596
#&gt; 18 0.20560623 5451.82538     616
#&gt; 19 0.46457193 5604.41790     608
#&gt; 20 0.55063433 5979.95802     612</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
注释
</div>
</div>
<div class="callout-body-container callout-body">
<p>请思考 <code>fit_rongelap_vario</code> 输出的 <code>n.pairs</code> 的总对数为什么是 12090 而不是 12246？</p>
</div>
</div>
<p>结果显示，距离在 0-89.44272 米之间的坐标点有 510 对，经验半变差函数值为 0.07006716。距离在 89.44272-144.22205 米之间的坐标点有 601 对，经验半变差函数值为 0.12719889，依此类推。将距离和计算的经验半变差函数值绘制出来，即得到经验半变差图，如 <a href="#fig-rongelap-vario" class="quarto-xref">图&nbsp;<span>28.9</span></a> 所示。刚开始，半变差值很小，之后随距离增加而增大，一直到达一个平台。半变差反比于空间相关性的程度，随着距离增加，空间相关性减弱。这说明数据中确含有空间相关性，模型中添加指数型自相关空间结构是合理的。</p>
<div class="cell">
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="co"># 经验半变差图</span></span>
<span id="cb29-2"><a href="#cb29-2"></a><span class="fu">plot</span>(fit_rongelap_vario,</span>
<span id="cb29-3"><a href="#cb29-3"></a>  <span class="at">col.line =</span> <span class="st">"black"</span>, <span class="at">scales =</span> <span class="fu">list</span>(</span>
<span id="cb29-4"><a href="#cb29-4"></a>    <span class="co"># 去掉图形上边、右边多余的刻度线</span></span>
<span id="cb29-5"><a href="#cb29-5"></a>    <span class="at">x =</span> <span class="fu">list</span>(<span class="at">alternating =</span> <span class="dv">1</span>, <span class="at">tck =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>)),</span>
<span id="cb29-6"><a href="#cb29-6"></a>    <span class="at">y =</span> <span class="fu">list</span>(<span class="at">alternating =</span> <span class="dv">1</span>, <span class="at">tck =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb29-7"><a href="#cb29-7"></a>  ), <span class="at">par.settings =</span> <span class="fu">list</span>(</span>
<span id="cb29-8"><a href="#cb29-8"></a>    <span class="at">plot.symbol =</span> <span class="fu">list</span>(<span class="at">pch =</span> <span class="dv">20</span>, <span class="at">col =</span> <span class="st">"black"</span>),</span>
<span id="cb29-9"><a href="#cb29-9"></a>    <span class="at">plot.line =</span> <span class="fu">list</span>(<span class="at">lwd =</span> <span class="dv">1</span>)</span>
<span id="cb29-10"><a href="#cb29-10"></a>  ),</span>
<span id="cb29-11"><a href="#cb29-11"></a>  <span class="at">xlab =</span> <span class="st">"距离（米）"</span>, <span class="at">ylab =</span> <span class="st">"半变差函数值"</span></span>
<span id="cb29-12"><a href="#cb29-12"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-rongelap-vario" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-rongelap-vario-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-rongelap-vario-1.png" class="img-fluid figure-img" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rongelap-vario-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;28.9: 残差的经验半变差图
</figcaption></figure>
</div>
</div>
</div>
<p>如果空间相关性提取得很充分，则标准化残差的半变差图中的数据点应是围绕标准差 1 上下波动，无明显趋势，拟合线几乎是一条水平线，从 <a href="#fig-rongelap-vario-norm" class="quarto-xref">图&nbsp;<span>28.10</span></a> 来看，存在一些非均匀的波动，是采样点在空间的分布不均匀所致，岛屿狭长的中部地带采样点稀疏。如前所述，刻画空间相关性，除了指数型，还可以用其它自相关结构来拟合，留待读者练习。</p>
<div class="cell">
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>fit_rongelap_vario_norm <span class="ot">&lt;-</span> nlme<span class="sc">::</span><span class="fu">Variogram</span>(fit_rongelap_gls,</span>
<span id="cb30-2"><a href="#cb30-2"></a>  <span class="at">form =</span> <span class="sc">~</span> cX <span class="sc">+</span> cY, <span class="at">data =</span> rongelap, <span class="at">resType =</span> <span class="st">"normalized"</span></span>
<span id="cb30-3"><a href="#cb30-3"></a>)</span>
<span id="cb30-4"><a href="#cb30-4"></a><span class="co"># 经验半变差图</span></span>
<span id="cb30-5"><a href="#cb30-5"></a><span class="fu">plot</span>(fit_rongelap_vario_norm,</span>
<span id="cb30-6"><a href="#cb30-6"></a>  <span class="at">col.line =</span> <span class="st">"black"</span>, <span class="at">scales =</span> <span class="fu">list</span>(</span>
<span id="cb30-7"><a href="#cb30-7"></a>    <span class="co"># 去掉图形上边、右边多余的刻度线</span></span>
<span id="cb30-8"><a href="#cb30-8"></a>    <span class="at">x =</span> <span class="fu">list</span>(<span class="at">alternating =</span> <span class="dv">1</span>, <span class="at">tck =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>)),</span>
<span id="cb30-9"><a href="#cb30-9"></a>    <span class="at">y =</span> <span class="fu">list</span>(<span class="at">alternating =</span> <span class="dv">1</span>, <span class="at">tck =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb30-10"><a href="#cb30-10"></a>  ), <span class="at">par.settings =</span> <span class="fu">list</span>(</span>
<span id="cb30-11"><a href="#cb30-11"></a>    <span class="at">plot.symbol =</span> <span class="fu">list</span>(<span class="at">pch =</span> <span class="dv">20</span>, <span class="at">col =</span> <span class="st">"black"</span>),</span>
<span id="cb30-12"><a href="#cb30-12"></a>    <span class="at">plot.line =</span> <span class="fu">list</span>(<span class="at">lwd =</span> <span class="dv">1</span>)</span>
<span id="cb30-13"><a href="#cb30-13"></a>  ),</span>
<span id="cb30-14"><a href="#cb30-14"></a>  <span class="at">xlab =</span> <span class="st">"距离（米）"</span>, <span class="at">ylab =</span> <span class="st">"半变差函数值"</span></span>
<span id="cb30-15"><a href="#cb30-15"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-rongelap-vario-norm" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-rongelap-vario-norm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-rongelap-vario-norm-1.png" class="img-fluid figure-img" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rongelap-vario-norm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;28.10: 标准化残差的经验半变差图
</figcaption></figure>
</div>
</div>
</div>
</section></section><section id="sec-rongelap-sglmm" class="level3" data-number="28.3.3"><h3 data-number="28.3.3" class="anchored" data-anchor-id="sec-rongelap-sglmm">
<span class="header-section-number">28.3.3</span> 空间广义线性混合效应模型</h3>
<p>简单的广义线性模型并没有考虑距离相关性，它认为各个观测点的数据是相互独立的。因此，考虑采用广义线性混合效应模型，在广义线性模型的基础上添加位置相关的随机效应，用以刻画未能直接观测到的潜在影响。 <span class="math inline">\({}^{137}\mathrm{Cs}\)</span> 放出伽马射线，在 <span class="math inline">\(n=157\)</span> 个采样点，分别以时间间隔 <span class="math inline">\(t_i\)</span> 测量辐射量 <span class="math inline">\(y(x_i)\)</span>，建立泊松型空间广义线性混合效应模型。</p>
<p><span id="eq-rongelap-poisson-sglmmm"><span class="math display">\[
\begin{aligned}
\log\{\lambda(x_i)\} &amp; = \beta + S(x_{i}) + Z_{i} \\
y(x_{i}) &amp;\sim \mathrm{Poisson}\big(t_i\lambda(x_i)\big)
\end{aligned}
\tag{28.5}\]</span></span></p>
<p>模型中，放射粒子数 <span class="math inline">\(y(x_{i})\)</span> 作为响应变量服从均值为 <span class="math inline">\(t_i\lambda(x_i)\)</span> 的泊松分布，其它模型成分的说明同前。简单起见，下面不添加块金效应，即。掉模型中的 <span class="math inline">\(Z_i\)</span> 。此时，块金效应对模型预测效果的提升很有限，由于 <span class="math inline">\(\tau^2\)</span> 和 <span class="math inline">\(\sigma^2\)</span> 之间存在的可识别性问题，会显著增加参数估计的复杂度。</p>
<p><strong>nlme</strong> 包不能拟合空间广义线性混合效应模型， <strong>spaMM</strong> 包可以，它的使用语法与前面介绍的函数 <code><a href="https://rdrr.io/r/stats/glm.html">glm()</a></code> 、 <strong>nlme</strong> 包都类似，函数 <code>fitme()</code> 可以拟合从线性模型到广义线性混合效应模型的一大类模型，且使用统一的语法，输出一个 <code>HLfit</code> 类型的数据对象。 <strong>spaMM</strong> 包的函数 <code>Matern()</code> 实现了梅隆型自协方差函数，指数型和幂二次指数型是它的特例。当固定 <span class="math inline">\(\nu = 0.5\)</span> 时，梅隆型自协方差函数 <code>Matern()</code> 的形式退化为 <span class="math inline">\(\sigma^2\exp(- \alpha u)\)</span> ，其中，<span class="math inline">\(\alpha\)</span> 与范围参数关联，相当于前面出现的 <span class="math inline">\(1/\phi\)</span> 。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="fu">library</span>(spaMM)</span>
<span id="cb31-2"><a href="#cb31-2"></a>fit_rongelap_spamm <span class="ot">&lt;-</span> <span class="fu">fitme</span>(</span>
<span id="cb31-3"><a href="#cb31-3"></a>  <span class="at">formula =</span> counts <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">Matern</span>(<span class="dv">1</span> <span class="sc">|</span> cX <span class="sc">+</span> cY) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(time)),</span>
<span id="cb31-4"><a href="#cb31-4"></a>  <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>), <span class="at">data =</span> rongelap,</span>
<span id="cb31-5"><a href="#cb31-5"></a>  <span class="at">fixed =</span> <span class="fu">list</span>(<span class="at">nu =</span> <span class="fl">0.5</span>), <span class="at">method =</span> <span class="st">"REML"</span></span>
<span id="cb31-6"><a href="#cb31-6"></a>)</span>
<span id="cb31-7"><a href="#cb31-7"></a><span class="fu">summary</span>(fit_rongelap_spamm)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; formula: counts ~ 1 + Matern(1 | cX + cY) + offset(log(time))
#&gt; Estimation of corrPars and lambda by REML (p_bv approximation of restricted logL).
#&gt; Estimation of fixed effects by ML (p_v approximation of logL).
#&gt; Estimation of lambda by 'outer' REML, maximizing restricted logL.
#&gt; family: poisson( link = log ) 
#&gt;  ------------ Fixed effects (beta) ------------
#&gt;             Estimate Cond. SE t-value
#&gt; (Intercept)    1.829  0.08798   20.78
#&gt;  --------------- Random effects ---------------
#&gt; Family: gaussian( link = identity ) 
#&gt;                    --- Correlation parameters:
#&gt;        1.nu       1.rho 
#&gt; 0.500000000 0.009211756 
#&gt;            --- Variance parameters ('lambda'):
#&gt; lambda = var(u) for u ~ Gaussian; 
#&gt;    cX + cY  :  0.3069  
#&gt; # of obs: 157; # of groups: cX + cY, 157 
#&gt;  ------------- Likelihood values  -------------
#&gt;                         logLik
#&gt; logL       (p_v(h)): -1318.010
#&gt; Re.logL  (p_b,v(h)): -1319.522</code></pre>
</div>
</div>
<p>从输出结果来看，模型固定效应的截距项 <span class="math inline">\(\beta\)</span> 为 <code>1.829</code>，空间随机效应的方差 <span class="math inline">\(\sigma^2\)</span> 为 <code>0.3069</code>，对比函数 <code>Matern()</code> 实现的指数型自协方差函数公式与 <a href="#eq-matern-formula" class="quarto-xref">方程式&nbsp;<span>28.2</span></a> ，将输出结果转化一下，则 <span class="math inline">\(\phi = 1 / 0.00921 = 108.57\)</span> ，表示在这个模型的设定下，空间相关性的最大影响距离约为 108.5 米。</p>
</section></section><section id="sec-rongelap-predict" class="level2" data-number="28.4"><h2 data-number="28.4" class="anchored" data-anchor-id="sec-rongelap-predict">
<span class="header-section-number">28.4</span> 模型预测</h2>
<p>接下来，预测给定的边界（海岸线）内任意位置的核辐射强度，展示全岛的核辐射强度分布。先从点构造多边形数据，再将多边形做网格划分，继而将网格中心点作为模型输入获得核辐射强度的预测值。</p>
<section id="sec-rongelap-coastline" class="level3" data-number="28.4.1"><h3 data-number="28.4.1" class="anchored" data-anchor-id="sec-rongelap-coastline">
<span class="header-section-number">28.4.1</span> 海岸线数据</h3>
<p>海岸线上取一些点，点的数量越多，对海岸线的刻画越精确，这在转弯处体现得非常明显。海岸线的数据是以成对的坐标构成，导入 R 语言中，是以数据框的形式存储，为了方便后续的操作，引入空间数据操作的 <strong>sf</strong> 包<span class="citation" data-cites="Pebesma2018">(<a href="references.html#ref-Pebesma2018" role="doc-biblioref">Pebesma 2018</a>)</span>，将核辐射数据和海岸线数据转化为 POINT 类型的空间点数据。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb33-2"><a href="#cb33-2"></a>rongelap_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(rongelap, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"cX"</span>, <span class="st">"cY"</span>), <span class="at">dim =</span> <span class="st">"XY"</span>)</span>
<span id="cb33-3"><a href="#cb33-3"></a>rongelap_coastline_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(rongelap_coastline, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"cX"</span>, <span class="st">"cY"</span>), <span class="at">dim =</span> <span class="st">"XY"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>sf</strong> 包提供了大量操作空间数据的函数，比如函数 <code>st_bbox()</code> 计算一组空间数据的矩形边界，获得左下和右上两个点的坐标 <code>(xmin,ymin)</code> 和<code>(xmax,ymax)</code>，下面还会陆续涉及其它空间数据操作。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a><span class="fu">st_bbox</span>(rongelap_coastline_sf)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;        xmin        ymin        xmax        ymax 
#&gt; -6299.31201 -3582.25000    20.37916   103.54140</code></pre>
</div>
</div>
<p><code>rongelap_coastline_sf</code> 数据集是朗格拉普岛海岸线的采样点坐标，是一个 POINT 类型的数据，为了以海岸线为边界生成规则网格，首先连接点 POINT 构造多边形 POLYGON 对象。POINT 和 POLYGON 是 <strong>sf</strong> 包内建的基础的几何类型，其它复杂的空间类型是由它们衍生而来。函数 <code>st_geometry</code> 提取空间点数据中的几何元素，再用函数 <code>st_combine</code> 将点组合起来，最后用函数 <code>st_cast</code> 转换成 POLYGON 多边形类型。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>rongelap_coastline_sfp <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(<span class="fu">st_combine</span>(<span class="fu">st_geometry</span>(rongelap_coastline_sf)), <span class="st">"POLYGON"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#fig-point-to-polygon" class="quarto-xref">图&nbsp;<span>28.11</span></a> 上下两个子图分别展示空间点集和多边形。上图是原始的采样点数据，下图是以点带线，串联 POINT 数据构造 POLYGON 数据后的多边形。后续的数据操作将围绕这个多边形展开。</p>
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a><span class="co"># 点集</span></span>
<span id="cb37-2"><a href="#cb37-2"></a><span class="fu">ggplot</span>(rongelap_coastline_sf) <span class="sc">+</span></span>
<span id="cb37-3"><a href="#cb37-3"></a>  <span class="fu">geom_sf</span>(<span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb37-4"><a href="#cb37-4"></a>  <span class="fu">theme_void</span>()</span>
<span id="cb37-5"><a href="#cb37-5"></a><span class="co"># 多边形</span></span>
<span id="cb37-6"><a href="#cb37-6"></a><span class="fu">ggplot</span>(rongelap_coastline_sfp) <span class="sc">+</span></span>
<span id="cb37-7"><a href="#cb37-7"></a>  <span class="fu">geom_sf</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb37-8"><a href="#cb37-8"></a>  <span class="fu">theme_void</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div id="fig-point-to-polygon" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-point-to-polygon-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-point-to-polygon" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-point-to-polygon-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-point-to-polygon-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-point-to-polygon-1.png" class="img-fluid figure-img" data-ref-parent="fig-point-to-polygon" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-point-to-polygon-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 点数据
</figcaption></figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-point-to-polygon" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-point-to-polygon-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-point-to-polygon-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-point-to-polygon-2.png" class="img-fluid figure-img" data-ref-parent="fig-point-to-polygon" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-point-to-polygon-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 多边形数据
</figcaption></figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-point-to-polygon-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;28.11: 朗格拉普岛海岸线的表示
</figcaption></figure>
</div>
</section><section id="sec-rongelap-border" class="level3" data-number="28.4.2"><h3 data-number="28.4.2" class="anchored" data-anchor-id="sec-rongelap-border">
<span class="header-section-number">28.4.2</span> 边界处理</h3>
<p>为了确保覆盖整个岛，处理好边界问题，需要一点缓冲空间，就是说在给定的边界线外围再延伸一段距离，构造一个更大的多边形，这可以用函数 <code>st_buffer()</code> 实现，根据海岸线构造缓冲区，得到一个 POLYGON 类型的几何数据对象。考虑到朗格拉普岛的实际大小，缓冲距离选择 50 米。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>rongelap_coastline_buffer <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(rongelap_coastline_sfp, <span class="at">dist =</span> <span class="dv">50</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>缓冲区构造出来的效果如 <a href="#fig-rongelap-buffer" class="quarto-xref">图&nbsp;<span>28.12</span></a> 所示，为了便于与海岸线对比，图中将采样点、海岸线和缓冲区都展示出来了。</p>
<div class="cell">
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb39-2"><a href="#cb39-2"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> rongelap_sf, <span class="at">size =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb39-3"><a href="#cb39-3"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> rongelap_coastline_sfp, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">"gray30"</span>) <span class="sc">+</span></span>
<span id="cb39-4"><a href="#cb39-4"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> rongelap_coastline_buffer, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb39-5"><a href="#cb39-5"></a>  <span class="fu">theme_void</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-rongelap-buffer" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-rongelap-buffer-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-rongelap-buffer-1.png" class="img-fluid figure-img" width="595">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rongelap-buffer-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;28.12: 朗格拉普岛海岸线及其缓冲区
</figcaption></figure>
</div>
</div>
</div>
</section><section id="sec-rongelap-grid" class="level3" data-number="28.4.3"><h3 data-number="28.4.3" class="anchored" data-anchor-id="sec-rongelap-grid">
<span class="header-section-number">28.4.3</span> 构造网格</h3>
<p>接下来，利用函数 <code>st_make_grid()</code> 根据朗格拉普岛海岸缓冲线构造网格，朗格拉普岛是狭长的，因此，网格是 <span class="math inline">\(75\times 150\)</span> 的，意味着水平方向 75 行，垂直方向 150 列。网格的疏密程度是可以调整的，网格越密，格点越多，核辐射强度分布越精确，计算也越耗时。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a><span class="co"># 构造带边界约束的网格</span></span>
<span id="cb40-2"><a href="#cb40-2"></a>rongelap_coastline_grid <span class="ot">&lt;-</span> <span class="fu">st_make_grid</span>(rongelap_coastline_buffer, <span class="at">n =</span> <span class="fu">c</span>(<span class="dv">150</span>, <span class="dv">75</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>函数 <code>st_make_grid()</code> 根据 <code>rongelap_coastline_buffer</code> 的矩形边界网格化，效果如 <a href="gaussian-processes-regression.html#fig-rongelap-grid" class="quarto-xref">图&nbsp;<span>38.7</span></a> 所示，依次添加了网格、海岸线和缓冲区。实际上，网格只需要覆盖朗格拉普岛即可，岛外的部分是大海，不需要覆盖，根据现有数据和模型对岛外区域预测核辐射强度也没有意义，因此，在后续的操作中，岛外的网格都要去掉。函数 <code>st_make_grid()</code> 除了支持方形网格划分，还支持六边形网格划分。</p>
<div class="cell">
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb41-2"><a href="#cb41-2"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> rongelap_coastline_grid, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb41-3"><a href="#cb41-3"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> rongelap_coastline_sfp, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">"gray30"</span>) <span class="sc">+</span></span>
<span id="cb41-4"><a href="#cb41-4"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> rongelap_coastline_buffer, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb41-5"><a href="#cb41-5"></a>  <span class="fu">theme_void</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-rongelap-coastline-grid" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-rongelap-coastline-grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-rongelap-coastline-grid-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rongelap-coastline-grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;28.13: 朗格拉普岛规则化网格操作
</figcaption></figure>
</div>
</div>
</div>
<p>接下来，调用 <strong>sf</strong> 包函数 <code>st_intersects()</code> 将小网格落在缓冲区和岛内的筛选出来，一共 1612 个小网格，再用函数 <code>st_centroid()</code> 计算这些网格的中心点坐标。函数 <code>st_intersects()</code> 的作用是对多边形和网格取交集，包含与边界线交叉的网格，默认返回值是一个稀疏矩阵，与索引函数 <code>[.sf</code> （这是 <strong>sf</strong> 包扩展 <code>[</code> 函数的一个例子）搭配可以非常方便地过滤出目标网格。与之相关的函数 <code>st_crosses()</code> 可以获得与边界线交叉的网格。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a><span class="co"># 将 sfc 类型转化为 sf 类型</span></span>
<span id="cb42-2"><a href="#cb42-2"></a>rongelap_coastline_grid <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(rongelap_coastline_grid)</span>
<span id="cb42-3"><a href="#cb42-3"></a>rongelap_coastline_buffer <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(rongelap_coastline_buffer)</span>
<span id="cb42-4"><a href="#cb42-4"></a>rongelap_grid <span class="ot">&lt;-</span> rongelap_coastline_grid[rongelap_coastline_buffer, op <span class="ot">=</span> st_intersects]</span>
<span id="cb42-5"><a href="#cb42-5"></a><span class="co"># 计算网格中心点坐标</span></span>
<span id="cb42-6"><a href="#cb42-6"></a>rongelap_grid_centroid <span class="ot">&lt;-</span> <span class="fu">st_centroid</span>(rongelap_grid)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>过滤出来的网格如 <a href="gaussian-processes-regression.html#fig-rongelap-grid" class="quarto-xref">图&nbsp;<span>38.7</span></a> 所示，全岛网格化后，图中将朗格拉普岛海岸线、网格都展示出来了。网格的中心点将作为新的坐标数据，后续要在这些新的坐标点上预测核辐射强度。</p>
<div class="cell">
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb43-2"><a href="#cb43-2"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> rongelap_coastline_sfp, </span>
<span id="cb43-3"><a href="#cb43-3"></a>          <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">"gray30"</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb43-4"><a href="#cb43-4"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> rongelap_grid, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">"gray30"</span>) <span class="sc">+</span></span>
<span id="cb43-5"><a href="#cb43-5"></a>  <span class="fu">theme_void</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-rongelap-grid" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-rongelap-grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-rongelap-grid-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rongelap-grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;28.14: 朗格拉普岛规则网格划分结果
</figcaption></figure>
</div>
</div>
</div>
</section><section id="sec-rongelap-pred" class="level3" data-number="28.4.4"><h3 data-number="28.4.4" class="anchored" data-anchor-id="sec-rongelap-pred">
<span class="header-section-number">28.4.4</span> 整理数据</h3>
<p>函数 <code>st_coordinates()</code> 抽取网格中心点的坐标并用函数 <code><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame()</a></code> 转化为数据框类型，新数据的列名需要和训练数据保持一致，最后补充漂移项 <code>time</code>，以便输入模型中。漂移项并不影响核辐射强度，指定为 300 或 400 都可以。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>rongelap_grid_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">st_coordinates</span>(rongelap_grid_centroid))</span>
<span id="cb44-2"><a href="#cb44-2"></a><span class="fu">colnames</span>(rongelap_grid_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"cX"</span>, <span class="st">"cY"</span>)</span>
<span id="cb44-3"><a href="#cb44-3"></a>rongelap_grid_df<span class="sc">$</span>time <span class="ot">&lt;-</span> <span class="dv">1</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>将数据输入 <strong>spaMM</strong> 包拟合的模型对象 <code>fit_rongelap_spamm</code>，并将模型返回的结果整理成数据框，再与采样点数据合并。<code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> 是一个泛型函数，<strong>spaMM</strong> 包为模型对象提供了相应的预测方法。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a><span class="co"># 预测值</span></span>
<span id="cb45-2"><a href="#cb45-2"></a>rongelap_grid_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_rongelap_spamm,</span>
<span id="cb45-3"><a href="#cb45-3"></a>  <span class="at">newdata =</span> rongelap_grid_df, <span class="at">type =</span> <span class="st">"response"</span></span>
<span id="cb45-4"><a href="#cb45-4"></a>)</span>
<span id="cb45-5"><a href="#cb45-5"></a>rongelap_grid_df<span class="sc">$</span>pred_sp <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(rongelap_grid_pred)</span>
<span id="cb45-6"><a href="#cb45-6"></a><span class="co"># 线性预测的方差</span></span>
<span id="cb45-7"><a href="#cb45-7"></a>rongelap_grid_var <span class="ot">&lt;-</span> <span class="fu">get_predVar</span>(fit_rongelap_spamm,</span>
<span id="cb45-8"><a href="#cb45-8"></a>  <span class="at">newdata =</span> rongelap_grid_df, <span class="at">variances =</span> <span class="fu">list</span>(<span class="at">predVar =</span> <span class="cn">TRUE</span>), <span class="at">which =</span> <span class="st">"predVar"</span></span>
<span id="cb45-9"><a href="#cb45-9"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>#&gt; Non-identity link: predVar is on linear-predictor scale.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a>rongelap_grid_df<span class="sc">$</span>var_sp <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(rongelap_grid_var)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>在空间线性混合效应模型一节，截距 <span class="math inline">\(\beta\)</span> ，方差 <span class="math inline">\(\sigma^2\)</span> ，块金效应 <span class="math inline">\(\tau^2\)</span> 和范围参数 <span class="math inline">\(\phi\)</span> 都估计出来了。在此基础上，采用简单克里金插值方法预测，对于未采样观测的位置 <span class="math inline">\(x_0\)</span>，它的辐射强度的预测值 <span class="math inline">\(\hat{\lambda}(x_0)\)</span> 及其预测方差 <span class="math inline">\(\mathsf{Var}\{\hat{\lambda}(x_0)\}\)</span> 的计算公式如下。</p>
<p><span class="math display">\[
\begin{aligned}
\hat{\lambda}(x_0) &amp;= \beta + \boldsymbol{u}^{\top}(V + \tau^2I)^{-1}(\boldsymbol{\lambda} - \boldsymbol{1}\beta) \\
\mathsf{Var}\{\hat{\lambda}(x_0)\}  &amp;= \sigma^2 - \boldsymbol{u}^{\top}(V + \tau^2I)^{-1}\boldsymbol{u}
\end{aligned}
\]</span></p>
<p>其中，协方差矩阵 <span class="math inline">\(V\)</span> 中第 <span class="math inline">\(i\)</span> 行第 <span class="math inline">\(j\)</span> 列的元素为 <span class="math inline">\(\mathsf{Cov}\{S(x_i),S(x_j)\}\)</span> ，列向量 <span class="math inline">\(\boldsymbol{u}\)</span> 的第 <span class="math inline">\(i\)</span> 个元素为 <span class="math inline">\(\mathsf{Cov}\{S(x_i),S(x_0)\}\)</span> 。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a><span class="co"># 截距</span></span>
<span id="cb48-2"><a href="#cb48-2"></a>beta <span class="ot">&lt;-</span> <span class="fl">1.812914</span></span>
<span id="cb48-3"><a href="#cb48-3"></a><span class="co"># 范围参数</span></span>
<span id="cb48-4"><a href="#cb48-4"></a>phi <span class="ot">&lt;-</span> <span class="fl">169.7472088</span></span>
<span id="cb48-5"><a href="#cb48-5"></a><span class="co"># 方差</span></span>
<span id="cb48-6"><a href="#cb48-6"></a>sigma_sq <span class="ot">&lt;-</span> <span class="fl">0.2934473</span></span>
<span id="cb48-7"><a href="#cb48-7"></a><span class="co"># 块金效应</span></span>
<span id="cb48-8"><a href="#cb48-8"></a>tau_sq <span class="ot">&lt;-</span> <span class="fl">0.035991</span></span>
<span id="cb48-9"><a href="#cb48-9"></a><span class="co"># 自协方差函数</span></span>
<span id="cb48-10"><a href="#cb48-10"></a>cov_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(h) sigma_sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>h <span class="sc">/</span> phi)</span>
<span id="cb48-11"><a href="#cb48-11"></a><span class="co"># 观测距离矩阵</span></span>
<span id="cb48-12"><a href="#cb48-12"></a>m_obs <span class="ot">&lt;-</span> <span class="fu">cov_fun</span>(<span class="fu">st_distance</span>(<span class="at">x =</span> rongelap_sf)) <span class="sc">+</span> <span class="fu">diag</span>(tau_sq, <span class="dv">157</span>)</span>
<span id="cb48-13"><a href="#cb48-13"></a><span class="co"># 预测距离矩阵</span></span>
<span id="cb48-14"><a href="#cb48-14"></a>m_pred <span class="ot">&lt;-</span> <span class="fu">cov_fun</span>(<span class="fu">st_distance</span>(<span class="at">x =</span> rongelap_sf, <span class="at">y =</span> rongelap_grid_centroid))</span>
<span id="cb48-15"><a href="#cb48-15"></a><span class="co"># 简单克里金插值 Simple Kriging</span></span>
<span id="cb48-16"><a href="#cb48-16"></a>mean_sk <span class="ot">&lt;-</span> beta <span class="sc">+</span> <span class="fu">t</span>(m_pred) <span class="sc">%*%</span> <span class="fu">solve</span>(m_obs, <span class="fu">log</span>(rongelap_sf<span class="sc">$</span>counts <span class="sc">/</span> rongelap_sf<span class="sc">$</span>time) <span class="sc">-</span> beta)</span>
<span id="cb48-17"><a href="#cb48-17"></a><span class="co"># 辐射强度预测值</span></span>
<span id="cb48-18"><a href="#cb48-18"></a>rongelap_grid_df<span class="sc">$</span>pred_sk <span class="ot">&lt;-</span> <span class="fu">exp</span>(mean_sk)</span>
<span id="cb48-19"><a href="#cb48-19"></a><span class="co"># 辐射强度预测方差</span></span>
<span id="cb48-20"><a href="#cb48-20"></a>rongelap_grid_df<span class="sc">$</span>var_sk <span class="ot">&lt;-</span> sigma_sq <span class="sc">-</span> <span class="fu">diag</span>(<span class="fu">t</span>(m_pred) <span class="sc">%*%</span> <span class="fu">solve</span>(m_obs, m_pred))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="sec-rongelap-plot" class="level3" data-number="28.4.5"><h3 data-number="28.4.5" class="anchored" data-anchor-id="sec-rongelap-plot">
<span class="header-section-number">28.4.5</span> 展示结果</h3>
<p>将预测结果以散点图的形式呈现到图上，见下 <a href="#fig-rongelap-pred" class="quarto-xref">图&nbsp;<span>28.15</span></a> ，由于散点非常多，紧挨在一起就连成片了。上子图是 <strong>nlme</strong> 包预测的结果，下子图是 <strong>spaMM</strong> 包预测的结果，前者图像看起来会稍微平滑一些。</p>
<div class="cell">
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a><span class="co"># 数据框变形</span></span>
<span id="cb49-2"><a href="#cb49-2"></a>rongelap_grid_df2 <span class="ot">&lt;-</span> <span class="fu">reshape</span>(</span>
<span id="cb49-3"><a href="#cb49-3"></a>  <span class="at">data =</span> rongelap_grid_df, </span>
<span id="cb49-4"><a href="#cb49-4"></a>  <span class="at">varying =</span> <span class="fu">c</span>(<span class="st">"pred_sp"</span>, <span class="st">"var_sp"</span>, <span class="st">"pred_sk"</span>, <span class="st">"var_sk"</span>), </span>
<span id="cb49-5"><a href="#cb49-5"></a>  <span class="at">times =</span> <span class="fu">c</span>(<span class="st">"spaMM"</span>, <span class="st">"nlme"</span>), <span class="at">v.names =</span> <span class="fu">c</span>(<span class="st">"pred"</span>, <span class="st">"var"</span>), </span>
<span id="cb49-6"><a href="#cb49-6"></a>  <span class="at">timevar =</span> <span class="st">"method"</span>, <span class="at">idvar =</span> <span class="fu">c</span>(<span class="st">"cX"</span>, <span class="st">"cY"</span>),</span>
<span id="cb49-7"><a href="#cb49-7"></a>  <span class="at">new.row.names =</span> <span class="dv">1</span><span class="sc">:</span>(<span class="dv">2</span> <span class="sc">*</span> <span class="dv">1612</span>), <span class="at">direction =</span> <span class="st">"long"</span></span>
<span id="cb49-8"><a href="#cb49-8"></a>)</span>
<span id="cb49-9"><a href="#cb49-9"></a><span class="co"># 数据框类型转换</span></span>
<span id="cb49-10"><a href="#cb49-10"></a>rongelap_grid_sf2 <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(rongelap_grid_df2, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"cX"</span>, <span class="st">"cY"</span>), <span class="at">dim =</span> <span class="st">"XY"</span>)</span>
<span id="cb49-11"><a href="#cb49-11"></a><span class="co"># 分面展示两种预测方法</span></span>
<span id="cb49-12"><a href="#cb49-12"></a><span class="fu">ggplot</span>(<span class="at">data =</span> rongelap_grid_sf2) <span class="sc">+</span></span>
<span id="cb49-13"><a href="#cb49-13"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">color =</span> pred), <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb49-14"><a href="#cb49-14"></a>  <span class="fu">scale_color_viridis_c</span>(<span class="at">option =</span> <span class="st">"C"</span>, <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">12</span>,</span>
<span id="cb49-15"><a href="#cb49-15"></a>    <span class="at">guide =</span> <span class="fu">guide_colourbar</span>(</span>
<span id="cb49-16"><a href="#cb49-16"></a>      <span class="at">barwidth =</span> <span class="dv">1</span>, <span class="at">barheight =</span> <span class="dv">15</span></span>
<span id="cb49-17"><a href="#cb49-17"></a>    )) <span class="sc">+</span></span>
<span id="cb49-18"><a href="#cb49-18"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>method, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb49-19"><a href="#cb49-19"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb49-20"><a href="#cb49-20"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"横坐标（米）"</span>, <span class="at">y =</span> <span class="st">"纵坐标（米）"</span>, <span class="at">color =</span> <span class="st">"预测值"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-rongelap-pred" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-rongelap-pred-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-rongelap-pred-1.png" class="img-fluid figure-img" width="576">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rongelap-pred-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;28.15: 朗格拉普岛核辐射强度的分布
</figcaption></figure>
</div>
</div>
</div>
<p>从空间线性混合效应模型到空间广义线性混合效应模型的效果提升不多，差异不太明显。下 <a href="#fig-rongelap-var" class="quarto-xref">图&nbsp;<span>28.16</span></a> 展示核辐射强度预测方差的分布。越简单的模型，预测值的分布越平滑，越复杂的模型，捕捉到更多局部细节，因而，预测值的分布越曲折。</p>
<div class="cell">
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a><span class="co"># 分面展示两种预测方法</span></span>
<span id="cb50-2"><a href="#cb50-2"></a><span class="fu">ggplot</span>(<span class="at">data =</span> rongelap_grid_sf2) <span class="sc">+</span></span>
<span id="cb50-3"><a href="#cb50-3"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">color =</span> var), <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb50-4"><a href="#cb50-4"></a>  <span class="fu">scale_color_viridis_c</span>(</span>
<span id="cb50-5"><a href="#cb50-5"></a>    <span class="at">option =</span> <span class="st">"C"</span>, <span class="at">breaks =</span> <span class="fl">0.1</span> <span class="sc">*</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">16</span> <span class="sc">/</span> <span class="dv">4</span>,</span>
<span id="cb50-6"><a href="#cb50-6"></a>    <span class="at">guide =</span> <span class="fu">guide_colourbar</span>(</span>
<span id="cb50-7"><a href="#cb50-7"></a>      <span class="at">barwidth =</span> <span class="dv">1</span>, <span class="at">barheight =</span> <span class="dv">15</span></span>
<span id="cb50-8"><a href="#cb50-8"></a>    )</span>
<span id="cb50-9"><a href="#cb50-9"></a>  ) <span class="sc">+</span></span>
<span id="cb50-10"><a href="#cb50-10"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>method, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb50-11"><a href="#cb50-11"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb50-12"><a href="#cb50-12"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"横坐标（米）"</span>, <span class="at">y =</span> <span class="st">"纵坐标（米）"</span>, <span class="at">color =</span> <span class="st">"预测方差"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-rongelap-var" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-rongelap-var-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-rongelap-var-1.png" class="img-fluid figure-img" width="576">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rongelap-var-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;28.16: 核辐射强度预测方差的分布
</figcaption></figure>
</div>
</div>
</div>
<p>考虑到核辐射在全岛的分布应当是连续性的，空间连续性也是这类模型的假设，接下来绘制热力图，先用 <strong>stars</strong> 包<span class="citation" data-cites="stars2022">(<a href="references.html#ref-stars2022" role="doc-biblioref">Pebesma 2022</a>)</span>将预测数据按原网格化的精度转化成栅格对象，裁减超出朗格拉普岛海岸线以外的内容。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a><span class="fu">library</span>(abind)</span>
<span id="cb51-2"><a href="#cb51-2"></a><span class="fu">library</span>(stars)</span>
<span id="cb51-3"><a href="#cb51-3"></a>rongelap_grid_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(rongelap_grid_df, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"cX"</span>, <span class="st">"cY"</span>), <span class="at">dim =</span> <span class="st">"XY"</span>)</span>
<span id="cb51-4"><a href="#cb51-4"></a>rongelap_grid_stars <span class="ot">&lt;-</span> <span class="fu">st_rasterize</span>(rongelap_grid_sf, <span class="at">nx =</span> <span class="dv">150</span>, <span class="at">ny =</span> <span class="dv">75</span>)</span>
<span id="cb51-5"><a href="#cb51-5"></a>rongelap_stars <span class="ot">&lt;-</span> <span class="fu">st_crop</span>(<span class="at">x =</span> rongelap_grid_stars, <span class="at">y =</span> rongelap_coastline_sfp)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>除了矢量栅格化函数 <code>st_rasterize()</code> 和栅格剪裁函数 <code>st_crop()</code> ，<strong>stars</strong> 包还提供栅格数据图层 <code>geom_stars()</code>，这可以和 <strong>ggplot2</strong> 内置的图层搭配使用。下 <a href="#fig-rongelap-pred-sp" class="quarto-xref">图&nbsp;<span>28.17</span></a> 是 <strong>ggplot2</strong> 包和 <strong>grid</strong> 包一起绘制的辐射强度的热力分布图，展示 <strong>spaMM</strong> 包的预测效果。图左侧一小一大两个虚线框是放大前后的部分区域，展示朗格拉普岛核辐射强度的局部变化。</p>
<div class="cell">
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a><span class="co"># 虚线框数据</span></span>
<span id="cb52-2"><a href="#cb52-2"></a>dash_sfp <span class="ot">&lt;-</span> <span class="fu">st_polygon</span>(<span class="at">x =</span> <span class="fu">list</span>(<span class="fu">rbind</span>(</span>
<span id="cb52-3"><a href="#cb52-3"></a>  <span class="fu">c</span>(<span class="sc">-</span><span class="dv">6000</span>, <span class="sc">-</span><span class="dv">3600</span>),</span>
<span id="cb52-4"><a href="#cb52-4"></a>  <span class="fu">c</span>(<span class="sc">-</span><span class="dv">6000</span>, <span class="sc">-</span><span class="dv">2600</span>),</span>
<span id="cb52-5"><a href="#cb52-5"></a>  <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5000</span>, <span class="sc">-</span><span class="dv">2600</span>),</span>
<span id="cb52-6"><a href="#cb52-6"></a>  <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5000</span>, <span class="sc">-</span><span class="dv">3600</span>),</span>
<span id="cb52-7"><a href="#cb52-7"></a>  <span class="fu">c</span>(<span class="sc">-</span><span class="dv">6000</span>, <span class="sc">-</span><span class="dv">3600</span>)</span>
<span id="cb52-8"><a href="#cb52-8"></a>)), <span class="at">dim =</span> <span class="st">"XY"</span>)</span>
<span id="cb52-9"><a href="#cb52-9"></a><span class="co"># 主体内容</span></span>
<span id="cb52-10"><a href="#cb52-10"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb52-11"><a href="#cb52-11"></a>  <span class="fu">geom_stars</span>(</span>
<span id="cb52-12"><a href="#cb52-12"></a>    <span class="at">data =</span> rongelap_stars, <span class="at">na.action =</span> na.omit,</span>
<span id="cb52-13"><a href="#cb52-13"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> pred_sp <span class="sc">/</span> time)</span>
<span id="cb52-14"><a href="#cb52-14"></a>  ) <span class="sc">+</span></span>
<span id="cb52-15"><a href="#cb52-15"></a>  <span class="co"># 海岸线</span></span>
<span id="cb52-16"><a href="#cb52-16"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb52-17"><a href="#cb52-17"></a>    <span class="at">data =</span> rongelap_coastline_sfp,</span>
<span id="cb52-18"><a href="#cb52-18"></a>    <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">"gray30"</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span></span>
<span id="cb52-19"><a href="#cb52-19"></a>  ) <span class="sc">+</span></span>
<span id="cb52-20"><a href="#cb52-20"></a>  <span class="co"># 图例</span></span>
<span id="cb52-21"><a href="#cb52-21"></a>  <span class="fu">scale_fill_viridis_c</span>(</span>
<span id="cb52-22"><a href="#cb52-22"></a>    <span class="at">option =</span> <span class="st">"C"</span>, <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">12</span>,</span>
<span id="cb52-23"><a href="#cb52-23"></a>    <span class="at">guide =</span> <span class="fu">guide_colourbar</span>(</span>
<span id="cb52-24"><a href="#cb52-24"></a>      <span class="at">barwidth =</span> <span class="dv">15</span>, <span class="at">barheight =</span> <span class="fl">1.5</span>,</span>
<span id="cb52-25"><a href="#cb52-25"></a>      <span class="at">title.position =</span> <span class="st">"top"</span> <span class="co"># 图例标题位于图例上方</span></span>
<span id="cb52-26"><a href="#cb52-26"></a>    )</span>
<span id="cb52-27"><a href="#cb52-27"></a>  ) <span class="sc">+</span></span>
<span id="cb52-28"><a href="#cb52-28"></a>  <span class="co"># 虚线框</span></span>
<span id="cb52-29"><a href="#cb52-29"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> dash_sfp, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="fl">0.75</span>, <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb52-30"><a href="#cb52-30"></a>  <span class="co"># 箭头</span></span>
<span id="cb52-31"><a href="#cb52-31"></a>  <span class="fu">geom_segment</span>(</span>
<span id="cb52-32"><a href="#cb52-32"></a>    <span class="at">data =</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="sc">-</span><span class="dv">5500</span>, <span class="at">xend =</span> <span class="sc">-</span><span class="dv">5000</span>, <span class="at">y =</span> <span class="sc">-</span><span class="dv">2600</span>, <span class="at">yend =</span> <span class="sc">-</span><span class="dv">2250</span>),</span>
<span id="cb52-33"><a href="#cb52-33"></a>    <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">xend =</span> xend, <span class="at">yend =</span> yend),</span>
<span id="cb52-34"><a href="#cb52-34"></a>    <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.03</span>, <span class="st">"npc"</span>))</span>
<span id="cb52-35"><a href="#cb52-35"></a>  ) <span class="sc">+</span></span>
<span id="cb52-36"><a href="#cb52-36"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb52-37"><a href="#cb52-37"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"横坐标（米）"</span>, <span class="at">y =</span> <span class="st">"纵坐标（米）"</span>, <span class="at">fill =</span> <span class="st">"辐射强度"</span>) <span class="sc">+</span></span>
<span id="cb52-38"><a href="#cb52-38"></a>  <span class="fu">theme</span>(</span>
<span id="cb52-39"><a href="#cb52-39"></a>    <span class="at">legend.position =</span> <span class="st">"inside"</span>,</span>
<span id="cb52-40"><a href="#cb52-40"></a>    <span class="at">legend.position.inside =</span> <span class="fu">c</span>(<span class="fl">0.75</span>, <span class="fl">0.1</span>),</span>
<span id="cb52-41"><a href="#cb52-41"></a>    <span class="at">legend.direction =</span> <span class="st">"horizontal"</span>,</span>
<span id="cb52-42"><a href="#cb52-42"></a>    <span class="at">legend.background =</span> <span class="fu">element_blank</span>()</span>
<span id="cb52-43"><a href="#cb52-43"></a>  )</span>
<span id="cb52-44"><a href="#cb52-44"></a></span>
<span id="cb52-45"><a href="#cb52-45"></a>p4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb52-46"><a href="#cb52-46"></a>  <span class="fu">geom_stars</span>(</span>
<span id="cb52-47"><a href="#cb52-47"></a>    <span class="at">data =</span> rongelap_stars, <span class="at">na.action =</span> na.omit,</span>
<span id="cb52-48"><a href="#cb52-48"></a>    <span class="fu">aes</span>(<span class="at">fill =</span> pred_sp <span class="sc">/</span> time), <span class="at">show.legend =</span> <span class="cn">FALSE</span></span>
<span id="cb52-49"><a href="#cb52-49"></a>  ) <span class="sc">+</span></span>
<span id="cb52-50"><a href="#cb52-50"></a>  <span class="fu">geom_sf</span>(</span>
<span id="cb52-51"><a href="#cb52-51"></a>    <span class="at">data =</span> rongelap_coastline_sfp,</span>
<span id="cb52-52"><a href="#cb52-52"></a>    <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">color =</span> <span class="st">"gray30"</span>, <span class="at">linewidth =</span> <span class="fl">0.75</span></span>
<span id="cb52-53"><a href="#cb52-53"></a>  ) <span class="sc">+</span></span>
<span id="cb52-54"><a href="#cb52-54"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">"C"</span>, <span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb52-55"><a href="#cb52-55"></a>  <span class="co"># 虚线框</span></span>
<span id="cb52-56"><a href="#cb52-56"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> dash_sfp, <span class="at">fill =</span> <span class="cn">NA</span>, <span class="at">linewidth =</span> <span class="fl">0.75</span>, <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb52-57"><a href="#cb52-57"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb52-58"><a href="#cb52-58"></a>  <span class="fu">coord_sf</span>(<span class="at">expand =</span> <span class="cn">FALSE</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">6000</span>, <span class="sc">-</span><span class="dv">5000</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3600</span>, <span class="sc">-</span><span class="dv">2600</span>))</span>
<span id="cb52-59"><a href="#cb52-59"></a><span class="co"># 叠加图形</span></span>
<span id="cb52-60"><a href="#cb52-60"></a>p3</span>
<span id="cb52-61"><a href="#cb52-61"></a><span class="fu">print</span>(p4, <span class="at">vp =</span> grid<span class="sc">::</span><span class="fu">viewport</span>(<span class="at">x =</span> .<span class="dv">3</span>, <span class="at">y =</span> .<span class="dv">65</span>, <span class="at">width =</span> .<span class="dv">45</span>, <span class="at">height =</span> .<span class="dv">45</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-rongelap-pred-sp" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-rongelap-pred-sp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="analyze-spatial-data_files/figure-html/fig-rongelap-pred-sp-1.png" class="img-fluid figure-img" width="720">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rongelap-pred-sp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;28.17: 朗格拉普岛核辐射强度的分布
</figcaption></figure>
</div>
</div>
</div>
<p>美国当年是在比基尼环礁做的氢弹核试验，试验地与朗格拉普岛相距 100 多英里。核辐射羽流受大气、海洋环流等影响，漂流到朗格拉普岛。又受朗格拉普岛周围水文、地理环境影响，核辐射强度在全岛的分布是不均匀的，图中越亮的地方表示受到的核辐射越严重。</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-Christensen2002" class="csl-entry" role="listitem">
Christensen, O. F., 和 P. J. Ribeiro Jr. 2002. <span>《<span>geoRglm</span>: A package for generalised linear spatial models》</span>. <em>R News</em> 2 (2): 26–28.
</div>
<div id="ref-Pebesma2018" class="csl-entry" role="listitem">
Pebesma, Edzer. 2018. <span>《Simple Features for <span>R</span>: Standardized Support for Spatial Vector Data》</span>. <em><span>The R Journal</span></em> 10 (1): 439–46. <a href="https://doi.org/10.32614/RJ-2018-009">https://doi.org/10.32614/RJ-2018-009</a>.
</div>
<div id="ref-stars2022" class="csl-entry" role="listitem">
———. 2022. <em><span>stars</span>: Spatiotemporal Arrays, Raster and Vector Data Cubes</em>. <a href="https://CRAN.R-project.org/package=stars">https://CRAN.R-project.org/package=stars</a>.
</div>
</div>
</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "已复制");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "已复制");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://giscus.app/client.js" data-repo="XiangyunHuang/data-analysis-in-action" data-repo-id="R_kgDOGTNtPQ" data-category="General" data-category-id="DIC_kwDOGTNtPc4CQjXN" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><input type="hidden" id="giscus-base-theme" value="light"><input type="hidden" id="giscus-alt-theme" value="dark"><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./analyze-point-pattern.html" class="pagination-link  aria-label=">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">点模式数据分析</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./analyze-areal-data.html" class="pagination-link" aria-label="<span class='chapter-number'>29</span>&nbsp; <span class='chapter-title'>区域数据分析</span>">
        <span class="nav-page-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">区域数据分析</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/XiangyunHuang/data-analysis-in-action/blob/main/analyze-spatial-data.qmd" class="toc-action"><i class="bi bi-github"></i>查看代码</a></li></ul></div></div></div></footer></body></html>