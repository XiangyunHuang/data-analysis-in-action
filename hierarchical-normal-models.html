<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-Hans" xml:lang="zh-Hans"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.527">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>R 语言数据分析实战 - 35&nbsp; 分层正态模型</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./mixed-effects-models.html" rel="next">
<link href="./generalized-linear-models.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "没有结果",
    "search-matching-documents-text": "匹配的文档",
    "search-copy-link-title": "复制搜索链接",
    "search-hide-matches-text": "隐藏其它匹配结果",
    "search-more-match-text": "更多匹配结果",
    "search-more-matches-text": "更多匹配结果",
    "search-clear-button-title": "清除",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "取消",
    "search-submit-button-title": "提交",
    "search-label": "搜索"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-ZPWJBMKFL8"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-ZPWJBMKFL8', { 'anonymize_ip': true});
</script><script>
MathJax ={
  tex: {
    macros: {
      bm: ["{\\boldsymbol #1}",1],
    }
  }
};
</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="切换侧边栏导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./probabilistic-reasoning-framework.html">贝叶斯建模</a></li><li class="breadcrumb-item"><a href="./hierarchical-normal-models.html"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">分层正态模型</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="切换侧边栏导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R 语言数据分析实战</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/XiangyunHuang/data-analysis-in-action" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="./_main.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="切换深色模式"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="搜索"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">欢迎</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">前言</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">介绍</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">数据准备</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling-objects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">数据对象</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling-collection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">数据获取</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling-cleaning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">数据清洗</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling-manipulation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">数据操作</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling-processing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">数据处理</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">数据探索</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-basic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">ggplot2 入门</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-intermediate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">基础图形</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-advanced.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">统计图形</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-lattice.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">lattice 入门</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-graphics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">graphics 入门</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-tikz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">TikZ 入门</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-practice.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">探索实践</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">数据交流</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interactive-graphics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">交互图形</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interactive-tables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">交互表格</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interactive-applications.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">交互应用</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./documents-html.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">HTML 文档</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./documents-latex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">PDF 文档</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./documents-office.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Office 文档</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">统计分析</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./common-statistical-tests.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">常见的统计检验</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regression-and-correlation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">回归与相关分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./categorical-data-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">分类数据的分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./power-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">统计检验的功效</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">数据建模</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-network-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">网络分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-text-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">文本分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-survival-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">生存分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-time-series-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">时序分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-point-pattern.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">空间点模式分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-spatial-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">预测核辐射强度的分布</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-areal-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">区域数据分析</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">优化建模</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./statistical-computation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">统计计算</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./numerical-optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">数值优化</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./optimization-problems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">优化问题</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
 <span class="menu-text">贝叶斯建模</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./probabilistic-reasoning-framework.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">概率推理框架</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./generalized-linear-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">广义线性模型</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hierarchical-normal-models.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">分层正态模型</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mixed-effects-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">混合效应模型</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./generalized-additive-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">广义可加模型</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gaussian-processes-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">高斯过程回归</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./time-series-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">时间序列回归</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true">
 <span class="menu-text">机器学习</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./classification-problems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">分类问题</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./clustering-problems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">聚类问题</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regression-problems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">回归问题</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">参考文献</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true">
 <span class="menu-text">附录</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./notations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">数学符号</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./matrix-operations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">矩阵运算</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./git-github.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Git 和 Github</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">目录</h2>
   
  <ul>
<li>
<a href="#sec-8schools-rstan" id="toc-sec-8schools-rstan" class="nav-link active" data-scroll-target="#sec-8schools-rstan"><span class="header-section-number">35.1</span> rstan 包</a>
  <ul class="collapse">
<li><a href="#%E6%8B%9F%E5%90%88%E6%A8%A1%E5%9E%8B" id="toc-拟合模型" class="nav-link" data-scroll-target="#%E6%8B%9F%E5%90%88%E6%A8%A1%E5%9E%8B"><span class="header-section-number">35.1.1</span> 拟合模型</a></li>
  <li><a href="#%E6%A8%A1%E5%9E%8B%E8%BE%93%E5%87%BA" id="toc-模型输出" class="nav-link" data-scroll-target="#%E6%A8%A1%E5%9E%8B%E8%BE%93%E5%87%BA"><span class="header-section-number">35.1.2</span> 模型输出</a></li>
  <li><a href="#%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE" id="toc-操作数据" class="nav-link" data-scroll-target="#%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE"><span class="header-section-number">35.1.3</span> 操作数据</a></li>
  <li><a href="#%E9%87%87%E6%A0%B7%E8%AF%8A%E6%96%AD" id="toc-采样诊断" class="nav-link" data-scroll-target="#%E9%87%87%E6%A0%B7%E8%AF%8A%E6%96%AD"><span class="header-section-number">35.1.4</span> 采样诊断</a></li>
  <li><a href="#%E5%90%8E%E9%AA%8C%E5%88%86%E5%B8%83" id="toc-后验分布" class="nav-link" data-scroll-target="#%E5%90%8E%E9%AA%8C%E5%88%86%E5%B8%83"><span class="header-section-number">35.1.5</span> 后验分布</a></li>
  </ul>
</li>
  <li>
<a href="#sec-8schools-others" id="toc-sec-8schools-others" class="nav-link" data-scroll-target="#sec-8schools-others"><span class="header-section-number">35.2</span> 其它 R 包</a>
  <ul class="collapse">
<li><a href="#nlme" id="toc-nlme" class="nav-link" data-scroll-target="#nlme"><span class="header-section-number">35.2.1</span> nlme</a></li>
  <li><a href="#lme4" id="toc-lme4" class="nav-link" data-scroll-target="#lme4"><span class="header-section-number">35.2.2</span> lme4</a></li>
  <li><a href="#blme" id="toc-blme" class="nav-link" data-scroll-target="#blme"><span class="header-section-number">35.2.3</span> blme</a></li>
  <li><a href="#mcmcglmm" id="toc-mcmcglmm" class="nav-link" data-scroll-target="#mcmcglmm"><span class="header-section-number">35.2.4</span> MCMCglmm</a></li>
  <li><a href="#cmdstanr" id="toc-cmdstanr" class="nav-link" data-scroll-target="#cmdstanr"><span class="header-section-number">35.2.5</span> cmdstanr</a></li>
  </ul>
</li>
  <li><a href="#sec-thirty-rats" id="toc-sec-thirty-rats" class="nav-link" data-scroll-target="#sec-thirty-rats"><span class="header-section-number">35.3</span> 案例：rats 数据</a></li>
  <li>
<a href="#sec-rats-frequentist" id="toc-sec-rats-frequentist" class="nav-link" data-scroll-target="#sec-rats-frequentist"><span class="header-section-number">35.4</span> 频率派方法</a>
  <ul class="collapse">
<li><a href="#sec-rats-nlme" id="toc-sec-rats-nlme" class="nav-link" data-scroll-target="#sec-rats-nlme"><span class="header-section-number">35.4.1</span> nlme</a></li>
  <li><a href="#lavaan" id="toc-lavaan" class="nav-link" data-scroll-target="#lavaan"><span class="header-section-number">35.4.2</span> lavaan</a></li>
  <li><a href="#lme4-1" id="toc-lme4-1" class="nav-link" data-scroll-target="#lme4-1"><span class="header-section-number">35.4.3</span> lme4</a></li>
  <li><a href="#glmmtmb" id="toc-glmmtmb" class="nav-link" data-scroll-target="#glmmtmb"><span class="header-section-number">35.4.4</span> glmmTMB</a></li>
  <li><a href="#mass" id="toc-mass" class="nav-link" data-scroll-target="#mass"><span class="header-section-number">35.4.5</span> MASS</a></li>
  <li><a href="#spamm" id="toc-spamm" class="nav-link" data-scroll-target="#spamm"><span class="header-section-number">35.4.6</span> spaMM</a></li>
  <li><a href="#hglm" id="toc-hglm" class="nav-link" data-scroll-target="#hglm"><span class="header-section-number">35.4.7</span> hglm</a></li>
  <li><a href="#mgcv" id="toc-mgcv" class="nav-link" data-scroll-target="#mgcv"><span class="header-section-number">35.4.8</span> mgcv</a></li>
  </ul>
</li>
  <li>
<a href="#sec-rats-bayesianism" id="toc-sec-rats-bayesianism" class="nav-link" data-scroll-target="#sec-rats-bayesianism"><span class="header-section-number">35.5</span> 贝叶斯方法</a>
  <ul class="collapse">
<li><a href="#sec-rats-rstan" id="toc-sec-rats-rstan" class="nav-link" data-scroll-target="#sec-rats-rstan"><span class="header-section-number">35.5.1</span> rstan</a></li>
  <li><a href="#cmdstanr-1" id="toc-cmdstanr-1" class="nav-link" data-scroll-target="#cmdstanr-1"><span class="header-section-number">35.5.2</span> cmdstanr</a></li>
  <li><a href="#brms" id="toc-brms" class="nav-link" data-scroll-target="#brms"><span class="header-section-number">35.5.3</span> brms</a></li>
  <li><a href="#rstanarm" id="toc-rstanarm" class="nav-link" data-scroll-target="#rstanarm"><span class="header-section-number">35.5.4</span> rstanarm</a></li>
  <li><a href="#blme-1" id="toc-blme-1" class="nav-link" data-scroll-target="#blme-1"><span class="header-section-number">35.5.5</span> blme</a></li>
  <li><a href="#rjags" id="toc-rjags" class="nav-link" data-scroll-target="#rjags"><span class="header-section-number">35.5.6</span> rjags</a></li>
  <li><a href="#mcmcglmm-1" id="toc-mcmcglmm-1" class="nav-link" data-scroll-target="#mcmcglmm-1"><span class="header-section-number">35.5.7</span> MCMCglmm</a></li>
  <li><a href="#inla" id="toc-inla" class="nav-link" data-scroll-target="#inla"><span class="header-section-number">35.5.8</span> INLA</a></li>
  </ul>
</li>
  <li><a href="#sec-hierarchical-normal-models-summary" id="toc-sec-hierarchical-normal-models-summary" class="nav-link" data-scroll-target="#sec-hierarchical-normal-models-summary"><span class="header-section-number">35.6</span> 总结</a></li>
  <li><a href="#sec-hierarchical-models-exercises" id="toc-sec-hierarchical-models-exercises" class="nav-link" data-scroll-target="#sec-hierarchical-models-exercises"><span class="header-section-number">35.7</span> 习题</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/XiangyunHuang/data-analysis-in-action/blob/main/hierarchical-normal-models.qmd" class="toc-action"><i class="bi bi-github"></i>查看代码</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./probabilistic-reasoning-framework.html">贝叶斯建模</a></li><li class="breadcrumb-item"><a href="./hierarchical-normal-models.html"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">分层正态模型</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title"><span id="sec-hierarchical-normal-models" class="quarto-section-identifier"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">分层正态模型</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><blockquote class="blockquote">
<p>This is a bit like asking how should I tweak my sailboat so I can explore the ocean floor.</p>
<p>— Roger Koenker <a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
</blockquote>
<p>乔治·博克斯说，所有的模型都是错的，但有些是有用的。在真实的数据面前，尽我们所能，结果发现没有最好的模型，只有更好的模型。总是需要自己去构造符合自己需求的模型及其实现，只有自己能够实现，才能在模型的海洋中畅快地遨游。</p>
<p>介绍分层正态模型的定义、结构、估计，分层正态模型与曲线生长模型的关系，分层正态模型与潜变量模型的关系，分层正态模型与线性混合效应的关系。以 <strong>rstan</strong> 包和 <strong>nlme</strong> 包拟合分层正态模型，说明 <strong>rstan</strong> 包的一些用法，比较贝叶斯和频率派方法拟合的结果，给出结果的解释。再对比 16 个不同的 R包实现，总结一般地使用经验，也体会不同 R 包的独特性。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(StanHeaders)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">library</span>(rstan)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co"># 将编译的 Stan 模型与代码文件放在一起</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="fu">rstan_options</span>(<span class="at">auto_write =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co"># 如果CPU和内存足够，设置成与马尔科夫链一样多</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="fu">options</span>(<span class="at">mc.cores =</span> <span class="dv">2</span>)</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co"># 调色板</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>custom_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-10"><a href="#cb1-10"></a>  <span class="st">"#4285f4"</span>, <span class="co"># GoogleBlue</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>  <span class="st">"#34A853"</span>, <span class="co"># GoogleGreen</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>  <span class="st">"#FBBC05"</span>, <span class="co"># GoogleYellow</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>  <span class="st">"#EA4335"</span>  <span class="co"># GoogleRed</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>)</span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="fu">rstan_ggtheme_options</span>(</span>
<span id="cb1-16"><a href="#cb1-16"></a>  <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>),</span>
<span id="cb1-17"><a href="#cb1-17"></a>  <span class="at">legend.position =</span> <span class="st">"top"</span></span>
<span id="cb1-18"><a href="#cb1-18"></a>)</span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="fu">rstan_gg_options</span>(</span>
<span id="cb1-20"><a href="#cb1-20"></a>  <span class="at">fill =</span> <span class="st">"#4285f4"</span>, <span class="at">color =</span> <span class="st">"white"</span>,</span>
<span id="cb1-21"><a href="#cb1-21"></a>  <span class="at">pt_color =</span> <span class="st">"#EA4335"</span>, <span class="at">chain_colors =</span> custom_colors</span>
<span id="cb1-22"><a href="#cb1-22"></a>)</span>
<span id="cb1-23"><a href="#cb1-23"></a><span class="fu">library</span>(bayesplot)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="sec-8schools-rstan" class="level2" data-number="35.1"><h2 data-number="35.1" class="anchored" data-anchor-id="sec-8schools-rstan">
<span class="header-section-number">35.1</span> rstan 包</h2>
<p>本节以 8schools 数据为例介绍分层正态模型及 <strong>rstan</strong> 包实现，8schools 数据最早来自 <span class="citation" data-cites="Rubin1981">Rubin (<a href="references.html#ref-Rubin1981" role="doc-biblioref">1981</a>)</span> ，分层正态模型如下：</p>
<p><span class="math display">\[
\begin{aligned}
y_j &amp;\sim \mathcal{N}(\theta_j,\sigma_j^2) \quad
\theta_j = \mu + \tau \times \eta_j \\
\theta_j &amp;\sim \mathcal{N}(\mu, \tau^2) \quad
\eta_j \sim \mathcal{N}(0,1) \\
\mu &amp;\sim \mathcal{N}(0, 100^2) \quad \tau \sim \mathrm{half\_normal}(0,100^2)
\end{aligned}
\]</span></p>
<p>其中，<span class="math inline">\(y_j,\sigma_j\)</span> 是已知的观测数据，<span class="math inline">\(\theta_j\)</span> 是模型参数， <span class="math inline">\(\eta_j\)</span> 是服从标准正态分布的潜变量，<span class="math inline">\(\mu,\tau\)</span> 是超参数，分别服从正态分布（将方差设置为很大的数，则变成弱信息先验或无信息均匀先验）和半正态分布（随机变量限制为正值）。</p>
<section id="拟合模型" class="level3" data-number="35.1.1"><h3 data-number="35.1.1" class="anchored" data-anchor-id="拟合模型">
<span class="header-section-number">35.1.1</span> 拟合模型</h3>
<p>用 <strong>rstan</strong> 包来拟合模型，下面采用非中心的参数化表示，降低参数的相关性，减少发散的迭代次数，提高采样效率。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># 编译模型</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>eight_schools_fit <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="at">model_name =</span> <span class="st">"eight_schools"</span>,</span>
<span id="cb2-4"><a href="#cb2-4"></a>  <span class="co"># file = "code/eight_schools.stan",</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>  <span class="at">model_code =</span> <span class="st">"</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="st">  // saved as eight_schools.stan</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="st">  data {</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="st">    int&lt;lower=0&gt; J;                // number of schools</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="st">    array[J] real y;               // estimated treatment effects</span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="st">    array[J] real &lt;lower=0&gt; sigma; // standard error of effect estimates</span></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="st">  }</span></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="st">  parameters {</span></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="st">    real mu;                // population treatment effect</span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="st">    real&lt;lower=0&gt; tau;      // standard deviation in treatment effects</span></span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="st">    vector[J] eta;          // unscaled deviation from mu by school</span></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="st">  }</span></span>
<span id="cb2-17"><a href="#cb2-17"></a><span class="st">  transformed parameters {</span></span>
<span id="cb2-18"><a href="#cb2-18"></a><span class="st">    vector[J] theta = mu + tau * eta;        // school treatment effects</span></span>
<span id="cb2-19"><a href="#cb2-19"></a><span class="st">  }</span></span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="st">  model {</span></span>
<span id="cb2-21"><a href="#cb2-21"></a><span class="st">    target += normal_lpdf(mu | 0, 100); </span></span>
<span id="cb2-22"><a href="#cb2-22"></a><span class="st">    target += normal_lpdf(tau | 0, 100);</span></span>
<span id="cb2-23"><a href="#cb2-23"></a><span class="st">    target += normal_lpdf(eta | 0, 1);  // prior log-density</span></span>
<span id="cb2-24"><a href="#cb2-24"></a><span class="st">    target += normal_lpdf(y | theta, sigma); // log-likelihood</span></span>
<span id="cb2-25"><a href="#cb2-25"></a><span class="st">  }</span></span>
<span id="cb2-26"><a href="#cb2-26"></a><span class="st">  "</span>,</span>
<span id="cb2-27"><a href="#cb2-27"></a>  <span class="at">data =</span> <span class="fu">list</span>( <span class="co"># 观测数据</span></span>
<span id="cb2-28"><a href="#cb2-28"></a>    <span class="at">J =</span> <span class="dv">8</span>,</span>
<span id="cb2-29"><a href="#cb2-29"></a>    <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">28</span>, <span class="dv">8</span>, <span class="sc">-</span><span class="dv">3</span>, <span class="dv">7</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">18</span>, <span class="dv">12</span>),</span>
<span id="cb2-30"><a href="#cb2-30"></a>    <span class="at">sigma =</span> <span class="fu">c</span>(<span class="dv">15</span>, <span class="dv">10</span>, <span class="dv">16</span>, <span class="dv">11</span>, <span class="dv">9</span>, <span class="dv">11</span>, <span class="dv">10</span>, <span class="dv">18</span>)</span>
<span id="cb2-31"><a href="#cb2-31"></a>  ),</span>
<span id="cb2-32"><a href="#cb2-32"></a>  <span class="at">warmup =</span> <span class="dv">1000</span>, <span class="co"># 每条链预处理迭代次数</span></span>
<span id="cb2-33"><a href="#cb2-33"></a>  <span class="at">iter =</span> <span class="dv">2000</span>,   <span class="co"># 每条链总迭代次数</span></span>
<span id="cb2-34"><a href="#cb2-34"></a>  <span class="at">chains =</span> <span class="dv">2</span>,    <span class="co"># 马尔科夫链的数目</span></span>
<span id="cb2-35"><a href="#cb2-35"></a>  <span class="at">cores =</span> <span class="dv">2</span>,     <span class="co"># 指定 CPU 核心数，可以给每条链分配一个</span></span>
<span id="cb2-36"><a href="#cb2-36"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="co"># 不显示迭代的中间过程</span></span>
<span id="cb2-37"><a href="#cb2-37"></a>  <span class="at">refresh =</span> <span class="dv">0</span>,     <span class="co"># 不显示采样的进度</span></span>
<span id="cb2-38"><a href="#cb2-38"></a>  <span class="at">seed =</span> <span class="dv">20232023</span>  <span class="co"># 设置随机数种子，不要使用 set.seed() 函数</span></span>
<span id="cb2-39"><a href="#cb2-39"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="模型输出" class="level3" data-number="35.1.2"><h3 data-number="35.1.2" class="anchored" data-anchor-id="模型输出">
<span class="header-section-number">35.1.2</span> 模型输出</h3>
<p>用函数 <code><a href="https://rdrr.io/r/base/print.html">print()</a></code> 打印输出结果，保留 2 位小数。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">print</span>(eight_schools_fit, <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Inference for Stan model: eight_schools.
#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; 
#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.
#&gt; 
#&gt;            mean se_mean   sd   2.5%    25%    50%    75%  97.5% n_eff Rhat
#&gt; mu         7.90    0.16 5.00  -1.79   4.60   7.71  11.05  18.37   988    1
#&gt; tau        6.43    0.20 5.35   0.22   2.49   5.23   8.94  19.73   733    1
#&gt; eta[1]     0.40    0.02 0.96  -1.57  -0.21   0.41   1.06   2.27  2252    1
#&gt; eta[2]     0.00    0.02 0.88  -1.74  -0.59  -0.01   0.57   1.77  1977    1
#&gt; eta[3]    -0.17    0.02 0.92  -1.93  -0.78  -0.18   0.41   1.71  2307    1
#&gt; eta[4]    -0.04    0.02 0.91  -1.90  -0.64  -0.01   0.55   1.76  2053    1
#&gt; eta[5]    -0.34    0.02 0.89  -2.03  -0.97  -0.38   0.25   1.43  1769    1
#&gt; eta[6]    -0.22    0.02 0.87  -1.89  -0.81  -0.23   0.36   1.52  1959    1
#&gt; eta[7]     0.33    0.02 0.86  -1.30  -0.26   0.31   0.90   2.00  2020    1
#&gt; eta[8]     0.05    0.02 0.96  -1.89  -0.59   0.05   0.69   1.94  2597    1
#&gt; theta[1]  11.29    0.20 8.11  -1.69   5.88  10.14  15.34  31.08  1728    1
#&gt; theta[2]   7.80    0.13 6.25  -4.68   3.88   7.88  11.62  19.78  2362    1
#&gt; theta[3]   6.30    0.17 7.57 -10.90   2.15   6.63  10.87  20.04  1902    1
#&gt; theta[4]   7.72    0.14 6.53  -5.33   3.78   7.52  11.66  21.22  2249    1
#&gt; theta[5]   5.10    0.14 6.48  -9.20   1.04   5.69   9.50  16.71  2030    1
#&gt; theta[6]   6.06    0.16 6.88  -8.61   2.07   6.39  10.33  19.01  1766    1
#&gt; theta[7]  10.41    0.14 6.42  -0.18   6.03   9.59  13.98  24.97  2057    1
#&gt; theta[8]   8.45    0.19 8.00  -7.45   4.02   8.13  12.69  26.56  1728    1
#&gt; lp__     -50.67    0.11 2.64 -56.69 -52.25 -50.40 -48.78 -46.34   584    1
#&gt; 
#&gt; Samples were drawn using NUTS(diag_e) at Wed Dec 20 12:24:21 2023.
#&gt; For each parameter, n_eff is a crude measure of effective sample size,
#&gt; and Rhat is the potential scale reduction factor on split chains (at 
#&gt; convergence, Rhat=1).</code></pre>
</div>
</div>
<p>值得一提，数据有限而且规律不明确，数据隐含的信息不是很多，则先验分布的情况将会对参数估计结果产生很大影响。Stan 默认采用无信息的先验分布，当使用非常弱的信息先验时，结果就非常不同了。提取任意一个参数的结果，如查看参数 <span class="math inline">\(\tau\)</span> 的 95% 置信区间。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">print</span>(eight_schools_fit, <span class="at">pars =</span> <span class="st">"tau"</span>, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Inference for Stan model: eight_schools.
#&gt; 2 chains, each with iter=2000; warmup=1000; thin=1; 
#&gt; post-warmup draws per chain=1000, total post-warmup draws=2000.
#&gt; 
#&gt;     mean se_mean   sd 2.5% 97.5% n_eff Rhat
#&gt; tau 6.43     0.2 5.35 0.22 19.73   733    1
#&gt; 
#&gt; Samples were drawn using NUTS(diag_e) at Wed Dec 20 12:24:21 2023.
#&gt; For each parameter, n_eff is a crude measure of effective sample size,
#&gt; and Rhat is the potential scale reduction factor on split chains (at 
#&gt; convergence, Rhat=1).</code></pre>
</div>
</div>
<p>从迭代抽样数据获得与 <code>print(fit)</code> 一样的结果。以便后续对原始采样数据做任意的进一步分析。<strong>rstan</strong> 包扩展泛型函数 <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> 以支持对 stanfit 数据对象汇总，输出各个参数分链条和合并链条的后验分布结果。</p>
</section><section id="操作数据" class="level3" data-number="35.1.3"><h3 data-number="35.1.3" class="anchored" data-anchor-id="操作数据">
<span class="header-section-number">35.1.3</span> 操作数据</h3>
<p>抽取数据对象 <code>eight_schools_fit</code> 中的采样数据，合并几条马氏链的结果，返回的结果是一个列表。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>eight_schools_sim <span class="ot">&lt;-</span> <span class="fu">extract</span>(eight_schools_fit, <span class="at">permuted =</span> <span class="cn">TRUE</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>返回列表中的每个元素是一个数组，标量参数对应一维数组，向量参数对应二维数组。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="fu">str</span>(eight_schools_sim)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; List of 5
#&gt;  $ mu   : num [1:2000(1d)] 9.84 9.4 1.98 5.63 2.16 ...
#&gt;   ..- attr(*, "dimnames")=List of 1
#&gt;   .. ..$ iterations: NULL
#&gt;  $ tau  : num [1:2000(1d)] 4.92 13.31 9.3 2.94 8.87 ...
#&gt;   ..- attr(*, "dimnames")=List of 1
#&gt;   .. ..$ iterations: NULL
#&gt;  $ eta  : num [1:2000, 1:8] -1.21 0.292 1.365 -0.479 1.142 ...
#&gt;   ..- attr(*, "dimnames")=List of 2
#&gt;   .. ..$ iterations: NULL
#&gt;   .. ..$           : NULL
#&gt;  $ theta: num [1:2000, 1:8] 3.88 13.29 14.68 4.23 12.28 ...
#&gt;   ..- attr(*, "dimnames")=List of 2
#&gt;   .. ..$ iterations: NULL
#&gt;   .. ..$           : NULL
#&gt;  $ lp__ : num [1:2000(1d)] -49 -45.8 -48.2 -52.2 -49.8 ...
#&gt;   ..- attr(*, "dimnames")=List of 1
#&gt;   .. ..$ iterations: NULL</code></pre>
</div>
</div>
<p>对于列表，适合用函数 <code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code> 配合算术函数计算 <span class="math inline">\(\mu,\tau\)</span> 等参数的均值。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>fun_mean <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb10-2"><a href="#cb10-2"></a>  <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">dim</span>(x)) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb10-3"><a href="#cb10-3"></a>    <span class="fu">apply</span>(x, <span class="dv">2</span>, mean)</span>
<span id="cb10-4"><a href="#cb10-4"></a>  } <span class="cf">else</span> {</span>
<span id="cb10-5"><a href="#cb10-5"></a>    <span class="fu">mean</span>(x)</span>
<span id="cb10-6"><a href="#cb10-6"></a>  }</span>
<span id="cb10-7"><a href="#cb10-7"></a>}</span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="fu">lapply</span>(eight_schools_sim, <span class="at">FUN =</span> fun_mean)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; $mu
#&gt; [1] 7.896911
#&gt; 
#&gt; $tau
#&gt; [1] 6.427487
#&gt; 
#&gt; $eta
#&gt; [1]  0.39815800 -0.00403665 -0.17091492 -0.03835530 -0.34447579 -0.21592391
#&gt; [7]  0.33375651  0.04527884
#&gt; 
#&gt; $theta
#&gt; [1] 11.293515  7.796730  6.300619  7.722628  5.100476  6.059899 10.411386
#&gt; [8]  8.451163
#&gt; 
#&gt; $lp__
#&gt; [1] -50.66637</code></pre>
</div>
</div>
<p>类似地，计算 <span class="math inline">\(\mu,\tau\)</span> 等参数的分位点。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>fun_quantile <span class="ot">&lt;-</span> <span class="cf">function</span>(x, probs) {</span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">dim</span>(x)) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb12-3"><a href="#cb12-3"></a>    <span class="fu">t</span>(<span class="fu">apply</span>(x, <span class="dv">2</span>, quantile, <span class="at">probs =</span> probs))</span>
<span id="cb12-4"><a href="#cb12-4"></a>  } <span class="cf">else</span> {</span>
<span id="cb12-5"><a href="#cb12-5"></a>    <span class="fu">quantile</span>(x, <span class="at">probs =</span> probs)</span>
<span id="cb12-6"><a href="#cb12-6"></a>  }</span>
<span id="cb12-7"><a href="#cb12-7"></a>}</span>
<span id="cb12-8"><a href="#cb12-8"></a><span class="fu">lapply</span>(eight_schools_sim, fun_quantile, <span class="at">probs =</span> <span class="fu">c</span>(<span class="fl">2.5</span>, <span class="dv">25</span>, <span class="dv">50</span>, <span class="dv">75</span>, <span class="fl">97.5</span>) <span class="sc">/</span> <span class="dv">100</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; $mu
#&gt;      2.5%       25%       50%       75%     97.5% 
#&gt; -1.787025  4.603868  7.706957 11.054801 18.370903 
#&gt; 
#&gt; $tau
#&gt;       2.5%        25%        50%        75%      97.5% 
#&gt;  0.2221582  2.4933088  5.2289974  8.9369194 19.7296019 
#&gt; 
#&gt; $eta
#&gt;       
#&gt;             2.5%        25%          50%       75%    97.5%
#&gt;   [1,] -1.571814 -0.2051970  0.412478990 1.0592655 2.267580
#&gt;   [2,] -1.740860 -0.5924433 -0.009587292 0.5740810 1.768344
#&gt;   [3,] -1.933032 -0.7815080 -0.181728735 0.4102823 1.709490
#&gt;   [4,] -1.896206 -0.6383988 -0.008634091 0.5491973 1.758581
#&gt;   [5,] -2.029051 -0.9674769 -0.376669547 0.2505514 1.425229
#&gt;   [6,] -1.890733 -0.8146685 -0.227713876 0.3642582 1.524509
#&gt;   [7,] -1.295196 -0.2552945  0.310815774 0.9046577 1.995717
#&gt;   [8,] -1.894366 -0.5853674  0.053723000 0.6912584 1.940257
#&gt; 
#&gt; $theta
#&gt;       
#&gt;               2.5%      25%       50%       75%    97.5%
#&gt;   [1,]  -1.6909041 5.879186 10.136104 15.343330 31.08250
#&gt;   [2,]  -4.6774314 3.880805  7.876314 11.616239 19.77814
#&gt;   [3,] -10.9015495 2.149377  6.629543 10.872316 20.03882
#&gt;   [4,]  -5.3329649 3.779338  7.521149 11.663011 21.22172
#&gt;   [5,]  -9.2028941 1.035711  5.692159  9.501092 16.70603
#&gt;   [6,]  -8.6129198 2.068728  6.393843 10.333108 19.00727
#&gt;   [7,]  -0.1804168 6.033491  9.594300 13.980905 24.96505
#&gt;   [8,]  -7.4463975 4.015728  8.129632 12.694195 26.55720
#&gt; 
#&gt; $lp__
#&gt;      2.5%       25%       50%       75%     97.5% 
#&gt; -56.69300 -52.24867 -50.39536 -48.78482 -46.34192</code></pre>
</div>
</div>
<p>同理，可以计算最大值 <code><a href="https://rdrr.io/r/base/Extremes.html">max()</a></code>、最小值 <code><a href="https://rdrr.io/r/base/Extremes.html">min()</a></code> 和中位数 <code><a href="https://rdrr.io/r/stats/median.html">median()</a></code> 等。</p>
</section><section id="采样诊断" class="level3" data-number="35.1.4"><h3 data-number="35.1.4" class="anchored" data-anchor-id="采样诊断">
<span class="header-section-number">35.1.4</span> 采样诊断</h3>
<p>获取马尔科夫链迭代点列数据</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>eight_schools_sim <span class="ot">&lt;-</span> <span class="fu">extract</span>(eight_schools_fit, <span class="at">permuted =</span> <span class="cn">FALSE</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>eight_schools_sim</code> 是一个三维数组，1000（次迭代）* 2 （条链）* 19（个参数）。如果 <code>permuted = TRUE</code> 则会合并马氏链的迭代结果，变成一个列表。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="co"># 数据类型</span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="fu">class</span>(eight_schools_sim)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] "array"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="co"># 1000（次迭代）* 2 （条链）* 19（个参数）</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="fu">str</span>(eight_schools_sim)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;  num [1:1000, 1:2, 1:19] 14.18 2.19 12.29 12.51 5.02 ...
#&gt;  - attr(*, "dimnames")=List of 3
#&gt;   ..$ iterations: NULL
#&gt;   ..$ chains    : chr [1:2] "chain:1" "chain:2"
#&gt;   ..$ parameters: chr [1:19] "mu" "tau" "eta[1]" "eta[2]" ...</code></pre>
</div>
</div>
<p>提取参数 <span class="math inline">\(\mu\)</span> 的迭代点列，绘制迭代轨迹。</p>
<div class="cell" data-par="true">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>eight_schools_mu_sim <span class="ot">&lt;-</span> eight_schools_sim[, , <span class="st">"mu"</span>]</span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="fu">matplot</span>(</span>
<span id="cb19-3"><a href="#cb19-3"></a>  eight_schools_mu_sim, <span class="at">xlab =</span> <span class="st">"迭代次数"</span>, <span class="at">ylab =</span> <span class="fu">expression</span>(mu),</span>
<span id="cb19-4"><a href="#cb19-4"></a>  <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">col =</span> custom_colors</span>
<span id="cb19-5"><a href="#cb19-5"></a>)</span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="fu">apply</span>(eight_schools_mu_sim, <span class="dv">2</span>, mean), <span class="at">col =</span> custom_colors)</span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="fu">legend</span>(</span>
<span id="cb19-8"><a href="#cb19-8"></a>  <span class="st">"topleft"</span>, <span class="at">legend =</span> <span class="fu">paste</span>(<span class="st">"chain"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>), <span class="at">box.col =</span> <span class="st">"white"</span>, </span>
<span id="cb19-9"><a href="#cb19-9"></a>  <span class="at">inset =</span> <span class="fl">0.01</span>, <span class="at">lty =</span> <span class="st">"solid"</span>, <span class="at">horiz =</span> <span class="cn">TRUE</span>, <span class="at">col =</span> custom_colors</span>
<span id="cb19-10"><a href="#cb19-10"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-8schools-mu-base" class="quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-8schools-mu-base-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="hierarchical-normal-models_files/figure-html/fig-8schools-mu-base-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-8schools-mu-base-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;35.1: Base R 绘制参数 <span class="math inline">\(\mu\)</span> 的迭代轨迹
</figcaption></figure>
</div>
</div>
</div>
<p>也可以使用 <strong>rstan</strong> 包提供的函数 <code>traceplot()</code> 或者 <code>stan_trace()</code> 绘制参数的迭代轨迹图。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="fu">stan_trace</span>(eight_schools_fit, <span class="at">pars =</span> <span class="st">"mu"</span>) <span class="sc">+</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"迭代次数"</span>, <span class="at">y =</span> <span class="fu">expression</span>(mu))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-8schools-mu-ggplot2" class="quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-8schools-mu-ggplot2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="hierarchical-normal-models_files/figure-html/fig-8schools-mu-ggplot2-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-8schools-mu-ggplot2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;35.2: rstan 绘制参数 <span class="math inline">\(\mu\)</span> 的迭代轨迹
</figcaption></figure>
</div>
</div>
</div>
</section><section id="后验分布" class="level3" data-number="35.1.5"><h3 data-number="35.1.5" class="anchored" data-anchor-id="后验分布">
<span class="header-section-number">35.1.5</span> 后验分布</h3>
<p>可以用函数 <code>stan_hist()</code> 或 <code>stan_dens()</code> 绘制后验分布图。下图分别展示参数 <span class="math inline">\(\mu\)</span>、<span class="math inline">\(\tau\)</span> 的直方图，以及二者的散点图，参数 <span class="math inline">\(\mu\)</span> 的后验概率密度分布图。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">stan_hist</span>(eight_schools_fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"mu"</span>,<span class="st">"tau"</span>), <span class="at">bins =</span> <span class="dv">30</span>)</span>
<span id="cb21-2"><a href="#cb21-2"></a>p2 <span class="ot">&lt;-</span> <span class="fu">stan_scat</span>(eight_schools_fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"mu"</span>,<span class="st">"tau"</span>), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb21-3"><a href="#cb21-3"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(mu), <span class="at">y =</span> <span class="fu">expression</span>(tau))</span>
<span id="cb21-4"><a href="#cb21-4"></a>p3 <span class="ot">&lt;-</span> <span class="fu">stan_dens</span>(eight_schools_fit, <span class="at">pars =</span> <span class="st">"mu"</span>) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(mu))</span>
<span id="cb21-5"><a href="#cb21-5"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb21-6"><a href="#cb21-6"></a>p1 <span class="sc">/</span> (p2 <span class="sc">+</span> p3)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-8schools-rstan-posterior" class="quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-8schools-rstan-posterior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="hierarchical-normal-models_files/figure-html/fig-8schools-rstan-posterior-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-8schools-rstan-posterior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;35.3: rstan 包绘制后验分布图
</figcaption></figure>
</div>
</div>
</div>
<p>相比于 <strong>rstan</strong> 包，<strong>bayesplot</strong> 包可视化能力更强，支持对特定的参数做变换。<strong>bayesplot</strong> 包的函数 <code>mcmc_pairs()</code> 以矩阵图展示多个参数的分布，下图展示参数 <span class="math inline">\(\mu\)</span>，<span class="math inline">\(\log(\tau)\)</span> 后验分布图。但是，这些函数都固定了一些标题，不能修改。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_pairs</span>(</span>
<span id="cb22-2"><a href="#cb22-2"></a>  eight_schools_fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"mu"</span>, <span class="st">"tau"</span>), <span class="at">transform =</span> <span class="fu">list</span>(<span class="at">tau =</span> <span class="st">"log"</span>)</span>
<span id="cb22-3"><a href="#cb22-3"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-8schools-bayesplot-posterior" class="quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-8schools-bayesplot-posterior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="hierarchical-normal-models_files/figure-html/fig-8schools-bayesplot-posterior-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-8schools-bayesplot-posterior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;35.4: bayesplot 包绘制后验分布图
</figcaption></figure>
</div>
</div>
</div>
</section></section><section id="sec-8schools-others" class="level2" data-number="35.2"><h2 data-number="35.2" class="anchored" data-anchor-id="sec-8schools-others">
<span class="header-section-number">35.2</span> 其它 R 包</h2>
<section id="nlme" class="level3" data-number="35.2.1"><h3 data-number="35.2.1" class="anchored" data-anchor-id="nlme">
<span class="header-section-number">35.2.1</span> nlme</h3>
<p>接下来，用 <strong>nlme</strong> 包拟合模型。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># 成绩</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>y <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">28</span>, <span class="dv">8</span>, <span class="sc">-</span><span class="dv">3</span>, <span class="dv">7</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">18</span>, <span class="dv">12</span>)</span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="co"># 标准差</span></span>
<span id="cb23-4"><a href="#cb23-4"></a>sigma <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">15</span>, <span class="dv">10</span>, <span class="dv">16</span>, <span class="dv">11</span>, <span class="dv">9</span>, <span class="dv">11</span>, <span class="dv">10</span>, <span class="dv">18</span>)</span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="co"># 学校编号</span></span>
<span id="cb23-6"><a href="#cb23-6"></a>g <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>首先，调用 <strong>nlme</strong> 包的函数 <code>lme()</code> 拟合模型。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="fu">library</span>(nlme)</span>
<span id="cb24-2"><a href="#cb24-2"></a>fit_lme <span class="ot">&lt;-</span> <span class="fu">lme</span>(y <span class="sc">~</span> <span class="dv">1</span>, <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> g, <span class="at">weights =</span> <span class="fu">varFixed</span>(<span class="sc">~</span> sigma<span class="sc">^</span><span class="dv">2</span>), <span class="at">method =</span> <span class="st">"REML"</span>)</span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="fu">summary</span>(fit_lme)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Linear mixed-effects model fit by REML
#&gt;   Data: NULL 
#&gt;        AIC      BIC    logLik
#&gt;   60.21091 60.04864 -27.10546
#&gt; 
#&gt; Random effects:
#&gt;  Formula: ~1 | g
#&gt;         (Intercept) Residual
#&gt; StdDev:    2.917988 0.780826
#&gt; 
#&gt; Variance function:
#&gt;  Structure: fixed weights
#&gt;  Formula: ~sigma^2 
#&gt; Fixed effects:  y ~ 1 
#&gt;                Value Std.Error DF  t-value p-value
#&gt; (Intercept) 7.785729  3.368082  8 2.311621  0.0496
#&gt; 
#&gt; Standardized Within-Group Residuals:
#&gt;         Min          Q1         Med          Q3         Max 
#&gt; -1.06635035 -0.73588511 -0.02896764  0.50254917  1.62502386 
#&gt; 
#&gt; Number of Observations: 8
#&gt; Number of Groups: 8</code></pre>
</div>
</div>
<p>随机效应的标准差 2.917988 ，随机效应部分的估计</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="fu">ranef</span>(fit_lme)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;   (Intercept)
#&gt; 1  1.18135690
#&gt; 2  0.02625714
#&gt; 3 -0.55795543
#&gt; 4 -0.08130333
#&gt; 5 -1.29202240
#&gt; 6 -0.70215328
#&gt; 7  1.25167648
#&gt; 8  0.17414393</code></pre>
</div>
</div>
<p>类比 Stan 输出结果中的 <span class="math inline">\(\theta\)</span> 向量，每个学校的成绩估计</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="fl">7.785729</span> <span class="sc">+</span> <span class="fl">2.917988</span> <span class="sc">*</span> <span class="fu">ranef</span>(fit_lme)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;   (Intercept)
#&gt; 1   11.232914
#&gt; 2    7.862347
#&gt; 3    6.157622
#&gt; 4    7.548487
#&gt; 5    4.015623
#&gt; 6    5.736854
#&gt; 7   11.438106
#&gt; 8    8.293879</code></pre>
</div>
</div>
</section><section id="lme4" class="level3" data-number="35.2.2"><h3 data-number="35.2.2" class="anchored" data-anchor-id="lme4">
<span class="header-section-number">35.2.2</span> lme4</h3>
<p>接着，采用 <strong>lme4</strong> 包拟合模型，发现 <strong>lme4</strong> 包获得与 <strong>nlme</strong> 包一样的结果。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>control <span class="ot">&lt;-</span> lme4<span class="sc">::</span><span class="fu">lmerControl</span>(</span>
<span id="cb30-2"><a href="#cb30-2"></a>  <span class="at">check.conv.singular =</span> <span class="st">"ignore"</span>,</span>
<span id="cb30-3"><a href="#cb30-3"></a>  <span class="at">check.nobs.vs.nRE =</span> <span class="st">"ignore"</span>,</span>
<span id="cb30-4"><a href="#cb30-4"></a>  <span class="at">check.nobs.vs.nlev =</span> <span class="st">"ignore"</span></span>
<span id="cb30-5"><a href="#cb30-5"></a>)</span>
<span id="cb30-6"><a href="#cb30-6"></a>fit_lme4 <span class="ot">&lt;-</span> lme4<span class="sc">::</span><span class="fu">lmer</span>(y <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> g), <span class="at">weights =</span> <span class="dv">1</span> <span class="sc">/</span> sigma<span class="sc">^</span><span class="dv">2</span>, <span class="at">control =</span> control, <span class="at">REML =</span> <span class="cn">TRUE</span>)</span>
<span id="cb30-7"><a href="#cb30-7"></a><span class="fu">summary</span>(fit_lme4)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Linear mixed model fit by REML ['lmerMod']
#&gt; Formula: y ~ 1 + (1 | g)
#&gt; Weights: 1/sigma^2
#&gt; Control: control
#&gt; 
#&gt; REML criterion at convergence: 54.2
#&gt; 
#&gt; Scaled residuals: 
#&gt;      Min       1Q   Median       3Q      Max 
#&gt; -1.06635 -0.73589 -0.02897  0.50255  1.62502 
#&gt; 
#&gt; Random effects:
#&gt;  Groups   Name        Variance Std.Dev.
#&gt;  g        (Intercept) 8.5145   2.9180  
#&gt;  Residual             0.6097   0.7808  
#&gt; Number of obs: 8, groups:  g, 8
#&gt; 
#&gt; Fixed effects:
#&gt;             Estimate Std. Error t value
#&gt; (Intercept)    7.786      3.368   2.312</code></pre>
</div>
</div>
</section><section id="blme" class="level3" data-number="35.2.3"><h3 data-number="35.2.3" class="anchored" data-anchor-id="blme">
<span class="header-section-number">35.2.3</span> blme</h3>
<p>下面使用 <strong>blme</strong> 包 <span class="citation" data-cites="Chung2013">(<a href="references.html#ref-Chung2013" role="doc-biblioref">Chung 等 2013</a>)</span> ，<strong>blme</strong> 包基于 <strong>lme4</strong> 包，参数估计结果完全一致。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="co"># the mode should be at the boundary of the space.</span></span>
<span id="cb32-2"><a href="#cb32-2"></a></span>
<span id="cb32-3"><a href="#cb32-3"></a>fit_blme <span class="ot">&lt;-</span> blme<span class="sc">::</span><span class="fu">blmer</span>(</span>
<span id="cb32-4"><a href="#cb32-4"></a>  y <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> g), <span class="at">control =</span> control, <span class="at">REML =</span> <span class="cn">TRUE</span>, </span>
<span id="cb32-5"><a href="#cb32-5"></a>  <span class="at">cov.prior =</span> <span class="cn">NULL</span>, <span class="at">weights =</span> <span class="dv">1</span> <span class="sc">/</span> sigma<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb32-6"><a href="#cb32-6"></a>)</span>
<span id="cb32-7"><a href="#cb32-7"></a><span class="fu">summary</span>(fit_blme)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Prior dev  : 0
#&gt; 
#&gt; Linear mixed model fit by REML ['blmerMod']
#&gt; Formula: y ~ 1 + (1 | g)
#&gt; Weights: 1/sigma^2
#&gt; Control: control
#&gt; 
#&gt; REML criterion at convergence: 54.2
#&gt; 
#&gt; Scaled residuals: 
#&gt;      Min       1Q   Median       3Q      Max 
#&gt; -1.06635 -0.73589 -0.02897  0.50255  1.62502 
#&gt; 
#&gt; Random effects:
#&gt;  Groups   Name        Variance Std.Dev.
#&gt;  g        (Intercept) 8.5145   2.9180  
#&gt;  Residual             0.6097   0.7808  
#&gt; Number of obs: 8, groups:  g, 8
#&gt; 
#&gt; Fixed effects:
#&gt;             Estimate Std. Error t value
#&gt; (Intercept)    7.786      3.368   2.312</code></pre>
</div>
</div>
</section><section id="mcmcglmm" class="level3" data-number="35.2.4"><h3 data-number="35.2.4" class="anchored" data-anchor-id="mcmcglmm">
<span class="header-section-number">35.2.4</span> MCMCglmm</h3>
<p><strong>MCMCglmm</strong> 包 <span class="citation" data-cites="Hadfield2010">(<a href="references.html#ref-Hadfield2010" role="doc-biblioref">Hadfield 2010</a>)</span> 采用 MCMC 算法拟合数据。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>schools <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">sigma =</span> sigma, <span class="at">g =</span> g)</span>
<span id="cb34-2"><a href="#cb34-2"></a>schools<span class="sc">$</span>g <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(schools<span class="sc">$</span>g)</span>
<span id="cb34-3"><a href="#cb34-3"></a><span class="co"># inverse-gamma prior with scale and shape equal to 0.001</span></span>
<span id="cb34-4"><a href="#cb34-4"></a>prior1 <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb34-5"><a href="#cb34-5"></a>  <span class="at">R =</span> <span class="fu">list</span>(<span class="at">V =</span> <span class="fu">diag</span>(schools<span class="sc">$</span>sigma<span class="sc">^</span><span class="dv">2</span>), <span class="at">fix =</span> <span class="dv">1</span>),</span>
<span id="cb34-6"><a href="#cb34-6"></a>  <span class="at">G =</span> <span class="fu">list</span>(<span class="at">G1 =</span> <span class="fu">list</span>(<span class="at">V =</span> <span class="dv">1</span>, <span class="at">nu =</span> <span class="fl">0.002</span>))</span>
<span id="cb34-7"><a href="#cb34-7"></a>)</span>
<span id="cb34-8"><a href="#cb34-8"></a><span class="co"># 为可重复</span></span>
<span id="cb34-9"><a href="#cb34-9"></a><span class="fu">set.seed</span>(<span class="dv">20232023</span>)</span>
<span id="cb34-10"><a href="#cb34-10"></a><span class="co"># 拟合模型</span></span>
<span id="cb34-11"><a href="#cb34-11"></a>fit_mcmc <span class="ot">&lt;-</span> MCMCglmm<span class="sc">::</span><span class="fu">MCMCglmm</span>(</span>
<span id="cb34-12"><a href="#cb34-12"></a>  y <span class="sc">~</span> <span class="dv">1</span>, <span class="at">random =</span> <span class="sc">~</span>g, <span class="at">rcov =</span> <span class="sc">~</span> <span class="fu">idh</span>(g)<span class="sc">:</span>units, </span>
<span id="cb34-13"><a href="#cb34-13"></a>  <span class="at">data =</span> schools, <span class="at">prior =</span> prior1, <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb34-14"><a href="#cb34-14"></a>)</span>
<span id="cb34-15"><a href="#cb34-15"></a><span class="co"># 输出结果</span></span>
<span id="cb34-16"><a href="#cb34-16"></a><span class="fu">summary</span>(fit_mcmc)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt;  Iterations = 3001:12991
#&gt;  Thinning interval  = 10
#&gt;  Sample size  = 1000 
#&gt; 
#&gt;  DIC: -98.07615 
#&gt; 
#&gt;  G-structure:  ~g
#&gt; 
#&gt;   post.mean  l-95% CI u-95% CI eff.samp
#&gt; g     11.23 0.0004247    68.57    361.3
#&gt; 
#&gt;  R-structure:  ~idh(g):units
#&gt; 
#&gt;          post.mean l-95% CI u-95% CI eff.samp
#&gt; g1.units       225      225      225        0
#&gt; g2.units       100      100      100        0
#&gt; g3.units       256      256      256        0
#&gt; g4.units       121      121      121        0
#&gt; g5.units        81       81       81        0
#&gt; g6.units       121      121      121        0
#&gt; g7.units       100      100      100        0
#&gt; g8.units       324      324      324        0
#&gt; 
#&gt;  Location effects: y ~ 1 
#&gt; 
#&gt;             post.mean l-95% CI u-95% CI eff.samp pMCMC  
#&gt; (Intercept)    7.6938  -0.5149  15.3275     1023 0.062 .
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>R-structure 表示残差方差，这是已知的参数。G-structure 表示随机截距的方差，Location effects 表示固定效应的截距。截距和 <strong>nlme</strong> 包的结果很接近。</p>
</section><section id="cmdstanr" class="level3" data-number="35.2.5"><h3 data-number="35.2.5" class="anchored" data-anchor-id="cmdstanr">
<span class="header-section-number">35.2.5</span> cmdstanr</h3>
<p>一般地，<strong>rstan</strong> 包使用的 stan 框架版本低于 <strong>cmdstanr</strong> 包，从 <strong>rstan</strong> 包切换到 <strong>cmdstanr</strong> 包，需要注意语法、函数的变化。<strong>rstan</strong> 和 <strong>cmdstanr</strong> 使用的 Stan 版本不同导致参数估计结果不同，结果可重复的条件非常苛刻，详见 <a href="https://mc-stan.org/docs/reference-manual/reproducibility.html">Stan 参考手册</a>。在都是较新的版本时，Stan 代码不需要做改动，如下：</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb36-1"><a href="#cb36-1"></a><span class="kw">data</span> {</span>
<span id="cb36-2"><a href="#cb36-2"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; J; <span class="co">// 学校数目 </span></span>
<span id="cb36-3"><a href="#cb36-3"></a>  <span class="dt">array</span>[J] <span class="dt">real</span> y; <span class="co">// 测试效果的预测值</span></span>
<span id="cb36-4"><a href="#cb36-4"></a>  <span class="dt">array</span>[J] <span class="dt">real</span> &lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; sigma; <span class="co">// 测试效果的标准差 </span></span>
<span id="cb36-5"><a href="#cb36-5"></a>}</span>
<span id="cb36-6"><a href="#cb36-6"></a><span class="kw">parameters</span> {</span>
<span id="cb36-7"><a href="#cb36-7"></a>  <span class="dt">real</span> mu; </span>
<span id="cb36-8"><a href="#cb36-8"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; tau;</span>
<span id="cb36-9"><a href="#cb36-9"></a>  <span class="dt">vector</span>[J] eta;</span>
<span id="cb36-10"><a href="#cb36-10"></a>}</span>
<span id="cb36-11"><a href="#cb36-11"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb36-12"><a href="#cb36-12"></a>  <span class="dt">vector</span>[J] theta;</span>
<span id="cb36-13"><a href="#cb36-13"></a>  theta = mu + tau * eta;</span>
<span id="cb36-14"><a href="#cb36-14"></a>}</span>
<span id="cb36-15"><a href="#cb36-15"></a><span class="kw">model</span> {</span>
<span id="cb36-16"><a href="#cb36-16"></a>  <span class="kw">target +=</span> normal_lpdf(mu | <span class="dv">0</span>, <span class="dv">100</span>); </span>
<span id="cb36-17"><a href="#cb36-17"></a>  <span class="kw">target +=</span> normal_lpdf(tau | <span class="dv">0</span>, <span class="dv">100</span>);</span>
<span id="cb36-18"><a href="#cb36-18"></a>  <span class="kw">target +=</span> normal_lpdf(eta | <span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb36-19"><a href="#cb36-19"></a>  <span class="kw">target +=</span> normal_lpdf(y | theta, sigma);</span>
<span id="cb36-20"><a href="#cb36-20"></a>}</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>此处，给参数 <span class="math inline">\(\mu,\tau\)</span> 添加了非常弱（模糊）的先验，结果将出现较大不同。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>eight_schools_dat <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb37-2"><a href="#cb37-2"></a>  <span class="at">J =</span> <span class="dv">8</span>,</span>
<span id="cb37-3"><a href="#cb37-3"></a>  <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">28</span>, <span class="dv">8</span>, <span class="sc">-</span><span class="dv">3</span>, <span class="dv">7</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">18</span>, <span class="dv">12</span>),</span>
<span id="cb37-4"><a href="#cb37-4"></a>  <span class="at">sigma =</span> <span class="fu">c</span>(<span class="dv">15</span>, <span class="dv">10</span>, <span class="dv">16</span>, <span class="dv">11</span>, <span class="dv">9</span>, <span class="dv">11</span>, <span class="dv">10</span>, <span class="dv">18</span>)</span>
<span id="cb37-5"><a href="#cb37-5"></a>)</span>
<span id="cb37-6"><a href="#cb37-6"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb37-7"><a href="#cb37-7"></a>mod_eight_schools <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(</span>
<span id="cb37-8"><a href="#cb37-8"></a>  <span class="at">stan_file =</span> <span class="st">"code/eight_schools.stan"</span>,</span>
<span id="cb37-9"><a href="#cb37-9"></a>  <span class="at">compile =</span> <span class="cn">TRUE</span>, <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">TRUE</span>)</span>
<span id="cb37-10"><a href="#cb37-10"></a>)</span>
<span id="cb37-11"><a href="#cb37-11"></a>fit_eight_schools <span class="ot">&lt;-</span> mod_eight_schools<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb37-12"><a href="#cb37-12"></a>  <span class="at">data =</span> eight_schools_dat, <span class="co"># 数据</span></span>
<span id="cb37-13"><a href="#cb37-13"></a>  <span class="at">chains =</span> <span class="dv">2</span>,            <span class="co"># 总链条数</span></span>
<span id="cb37-14"><a href="#cb37-14"></a>  <span class="at">parallel_chains =</span> <span class="dv">2</span>,   <span class="co"># 并行数目</span></span>
<span id="cb37-15"><a href="#cb37-15"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>,    <span class="co"># 每条链预处理的迭代次数</span></span>
<span id="cb37-16"><a href="#cb37-16"></a>  <span class="at">iter_sampling =</span> <span class="dv">1000</span>,  <span class="co"># 每条链采样的迭代次数</span></span>
<span id="cb37-17"><a href="#cb37-17"></a>  <span class="at">threads_per_chain =</span> <span class="dv">2</span>, <span class="co"># 每条链设置 2 个线程</span></span>
<span id="cb37-18"><a href="#cb37-18"></a>  <span class="at">seed =</span> <span class="dv">20232023</span>,       <span class="co"># 随机数种子</span></span>
<span id="cb37-19"><a href="#cb37-19"></a>  <span class="at">show_messages =</span> <span class="cn">FALSE</span>, <span class="co"># 不显示消息</span></span>
<span id="cb37-20"><a href="#cb37-20"></a>  <span class="at">refresh =</span> <span class="dv">0</span> <span class="co"># 不显示采样迭代的进度</span></span>
<span id="cb37-21"><a href="#cb37-21"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>结果保留 3 位有效数字，模型输出如下：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>fit_eight_schools<span class="sc">$</span><span class="fu">summary</span>(<span class="at">.num_args =</span> <span class="fu">list</span>(<span class="at">sigfig =</span> <span class="dv">3</span>, <span class="at">notation =</span> <span class="st">"dec"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 19 × 10
#&gt;    variable      mean    median    sd   mad      q5    q95  rhat ess_bulk
#&gt;    &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
#&gt;  1 lp__     -50.6     -50.4     2.59  2.49  -55.4   -46.7   1.00     720.
#&gt;  2 mu         7.79      7.81    5.05  4.76   -0.652  15.9   1.00    1519.
#&gt;  3 tau        6.28      4.97    5.36  4.66    0.384  16.6   1.00     833.
#&gt;  4 eta[1]     0.402     0.387   0.963 0.974  -1.18    1.99  1.00    3034.
#&gt;  5 eta[2]     0.00672   0.00898 0.877 0.841  -1.45    1.46  1.00    2404.
#&gt;  6 eta[3]    -0.169    -0.178   0.918 0.916  -1.68    1.38  1.00    2580.
#&gt;  7 eta[4]    -0.0109   -0.0144  0.878 0.876  -1.43    1.45  1.00    2492.
#&gt;  8 eta[5]    -0.340    -0.359   0.840 0.811  -1.69    1.06  1.00    1952.
#&gt;  9 eta[6]    -0.186    -0.178   0.887 0.854  -1.64    1.31  1.00    2559.
#&gt; 10 eta[7]     0.339     0.362   0.910 0.890  -1.25    1.82  1.00    2322.
#&gt; 11 eta[8]     0.0687    0.0622  0.893 0.897  -1.35    1.53  1.00    2924.
#&gt; 12 theta[1]  11.3       9.95    8.07  6.45    0.450  26.8   1.00    2421.
#&gt; 13 theta[2]   7.75      7.64    6.06  5.45   -1.99   18.0   1.00    2510.
#&gt; 14 theta[3]   6.27      6.91    7.44  6.28   -6.72   17.4   1.00    2381.
#&gt; 15 theta[4]   7.83      7.81    6.75  5.98   -2.99   18.7   1.00    2551.
#&gt; 16 theta[5]   5.25      5.59    6.02  5.67   -5.50   14.3   1.00    1958.
#&gt; 17 theta[6]   6.29      6.58    6.65  6.16   -5.62   16.7   1.00    2506.
#&gt; 18 theta[7]  10.6      10.0     6.76  6.22    0.486  22.6   1.00    2242.
#&gt; 19 theta[8]   8.45      8.11    7.52  6.29   -2.99   21.2   1.00    2472.
#&gt; # ℹ 1 more variable: ess_tail &lt;dbl&gt;</code></pre>
</div>
</div>
<p>模型采样过程的诊断结果如下：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>fit_eight_schools<span class="sc">$</span><span class="fu">diagnostic_summary</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; $num_divergent
#&gt; [1] 0 0
#&gt; 
#&gt; $num_max_treedepth
#&gt; [1] 0 0
#&gt; 
#&gt; $ebfmi
#&gt; [1] 0.7979763 0.8891174</code></pre>
</div>
</div>
<p>分层模型的参数 <span class="math inline">\(\mu,\log(\tau)\)</span> 的后验联合分布呈现经典的漏斗状。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_scatter</span>(</span>
<span id="cb42-2"><a href="#cb42-2"></a>  fit_eight_schools<span class="sc">$</span><span class="fu">draws</span>(), <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"mu"</span>, <span class="st">"tau"</span>), </span>
<span id="cb42-3"><a href="#cb42-3"></a>  <span class="at">transform =</span> <span class="fu">list</span>(<span class="at">tau =</span> <span class="st">"log"</span>), <span class="at">size =</span> <span class="dv">2</span></span>
<span id="cb42-4"><a href="#cb42-4"></a>) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"$</span><span class="sc">\\</span><span class="st">mu$"</span>, <span class="at">y =</span> <span class="st">"$</span><span class="sc">\\</span><span class="st">log(</span><span class="sc">\\</span><span class="st">tau)$"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-8schools-funnels" class="quarto-figure quarto-figure-center anchored" width="480">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-8schools-funnels-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="hierarchical-normal-models_files/figure-html/fig-8schools-funnels-1.png" class="img-fluid figure-img" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-8schools-funnels-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;35.5: 参数 <span class="math inline">\(\mu,\log(\tau)\)</span> 的联合分布
</figcaption></figure>
</div>
</div>
</div>
<p>对于调用 <strong>cmdstanr</strong> 包拟合的模型，适合用 <strong>bayesplot</strong> 包来可视化后验分布和诊断采样。</p>
</section></section><section id="sec-thirty-rats" class="level2" data-number="35.3"><h2 data-number="35.3" class="anchored" data-anchor-id="sec-thirty-rats">
<span class="header-section-number">35.3</span> 案例：rats 数据</h2>
<p>rats 数据最早来自 <span class="citation" data-cites="gelfand1990">Gelfand 等 (<a href="references.html#ref-gelfand1990" role="doc-biblioref">1990</a>)</span> ，记录 30 只小鼠每隔一周的重量，一共进行了 5 周。第一次记录是小鼠第 8 天的时候，第二次测量记录是第 15 天的时候，一直持续到第 36 天。下面在 R 环境中准备数据。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a><span class="co"># 总共 30 只老鼠</span></span>
<span id="cb43-2"><a href="#cb43-2"></a>N <span class="ot">&lt;-</span> <span class="dv">30</span></span>
<span id="cb43-3"><a href="#cb43-3"></a><span class="co"># 总共进行 5 周</span></span>
<span id="cb43-4"><a href="#cb43-4"></a>T <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb43-5"><a href="#cb43-5"></a><span class="co"># 小鼠重量</span></span>
<span id="cb43-6"><a href="#cb43-6"></a>y <span class="ot">&lt;-</span> <span class="fu">structure</span>(<span class="fu">c</span>(</span>
<span id="cb43-7"><a href="#cb43-7"></a>  <span class="dv">151</span>, <span class="dv">145</span>, <span class="dv">147</span>, <span class="dv">155</span>, <span class="dv">135</span>, <span class="dv">159</span>, <span class="dv">141</span>, <span class="dv">159</span>, <span class="dv">177</span>, <span class="dv">134</span>,</span>
<span id="cb43-8"><a href="#cb43-8"></a>  <span class="dv">160</span>, <span class="dv">143</span>, <span class="dv">154</span>, <span class="dv">171</span>, <span class="dv">163</span>, <span class="dv">160</span>, <span class="dv">142</span>, <span class="dv">156</span>, <span class="dv">157</span>, <span class="dv">152</span>, <span class="dv">154</span>, <span class="dv">139</span>, <span class="dv">146</span>,</span>
<span id="cb43-9"><a href="#cb43-9"></a>  <span class="dv">157</span>, <span class="dv">132</span>, <span class="dv">160</span>, <span class="dv">169</span>, <span class="dv">157</span>, <span class="dv">137</span>, <span class="dv">153</span>, <span class="dv">199</span>, <span class="dv">199</span>, <span class="dv">214</span>, <span class="dv">200</span>, <span class="dv">188</span>, <span class="dv">210</span>,</span>
<span id="cb43-10"><a href="#cb43-10"></a>  <span class="dv">189</span>, <span class="dv">201</span>, <span class="dv">236</span>, <span class="dv">182</span>, <span class="dv">208</span>, <span class="dv">188</span>, <span class="dv">200</span>, <span class="dv">221</span>, <span class="dv">216</span>, <span class="dv">207</span>, <span class="dv">187</span>, <span class="dv">203</span>, <span class="dv">212</span>,</span>
<span id="cb43-11"><a href="#cb43-11"></a>  <span class="dv">203</span>, <span class="dv">205</span>, <span class="dv">190</span>, <span class="dv">191</span>, <span class="dv">211</span>, <span class="dv">185</span>, <span class="dv">207</span>, <span class="dv">216</span>, <span class="dv">205</span>, <span class="dv">180</span>, <span class="dv">200</span>, <span class="dv">246</span>, <span class="dv">249</span>,</span>
<span id="cb43-12"><a href="#cb43-12"></a>  <span class="dv">263</span>, <span class="dv">237</span>, <span class="dv">230</span>, <span class="dv">252</span>, <span class="dv">231</span>, <span class="dv">248</span>, <span class="dv">285</span>, <span class="dv">220</span>, <span class="dv">261</span>, <span class="dv">220</span>, <span class="dv">244</span>, <span class="dv">270</span>, <span class="dv">242</span>,</span>
<span id="cb43-13"><a href="#cb43-13"></a>  <span class="dv">248</span>, <span class="dv">234</span>, <span class="dv">243</span>, <span class="dv">259</span>, <span class="dv">246</span>, <span class="dv">253</span>, <span class="dv">225</span>, <span class="dv">229</span>, <span class="dv">250</span>, <span class="dv">237</span>, <span class="dv">257</span>, <span class="dv">261</span>, <span class="dv">248</span>,</span>
<span id="cb43-14"><a href="#cb43-14"></a>  <span class="dv">219</span>, <span class="dv">244</span>, <span class="dv">283</span>, <span class="dv">293</span>, <span class="dv">312</span>, <span class="dv">272</span>, <span class="dv">280</span>, <span class="dv">298</span>, <span class="dv">275</span>, <span class="dv">297</span>, <span class="dv">350</span>, <span class="dv">260</span>, <span class="dv">313</span>,</span>
<span id="cb43-15"><a href="#cb43-15"></a>  <span class="dv">273</span>, <span class="dv">289</span>, <span class="dv">326</span>, <span class="dv">281</span>, <span class="dv">288</span>, <span class="dv">280</span>, <span class="dv">283</span>, <span class="dv">307</span>, <span class="dv">286</span>, <span class="dv">298</span>, <span class="dv">267</span>, <span class="dv">272</span>, <span class="dv">285</span>,</span>
<span id="cb43-16"><a href="#cb43-16"></a>  <span class="dv">286</span>, <span class="dv">303</span>, <span class="dv">295</span>, <span class="dv">289</span>, <span class="dv">258</span>, <span class="dv">286</span>, <span class="dv">320</span>, <span class="dv">354</span>, <span class="dv">328</span>, <span class="dv">297</span>, <span class="dv">323</span>, <span class="dv">331</span>, <span class="dv">305</span>,</span>
<span id="cb43-17"><a href="#cb43-17"></a>  <span class="dv">338</span>, <span class="dv">376</span>, <span class="dv">296</span>, <span class="dv">352</span>, <span class="dv">314</span>, <span class="dv">325</span>, <span class="dv">358</span>, <span class="dv">312</span>, <span class="dv">324</span>, <span class="dv">316</span>, <span class="dv">317</span>, <span class="dv">336</span>, <span class="dv">321</span>,</span>
<span id="cb43-18"><a href="#cb43-18"></a>  <span class="dv">334</span>, <span class="dv">302</span>, <span class="dv">302</span>, <span class="dv">323</span>, <span class="dv">331</span>, <span class="dv">345</span>, <span class="dv">333</span>, <span class="dv">316</span>, <span class="dv">291</span>, <span class="dv">324</span></span>
<span id="cb43-19"><a href="#cb43-19"></a>), <span class="at">.Dim =</span> <span class="fu">c</span>(<span class="dv">30</span>, <span class="dv">5</span>))</span>
<span id="cb43-20"><a href="#cb43-20"></a><span class="co"># 第几天</span></span>
<span id="cb43-21"><a href="#cb43-21"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">8.0</span>, <span class="fl">15.0</span>, <span class="fl">22.0</span>, <span class="fl">29.0</span>, <span class="fl">36.0</span>)</span>
<span id="cb43-22"><a href="#cb43-22"></a>xbar <span class="ot">&lt;-</span> <span class="fl">22.0</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>重复测量的小鼠重量数据 rats 如下 <a href="#tbl-rats" class="quarto-xref">表格&nbsp;<span>35.1</span></a> 所示。</p>
<div class="cell">
<div id="tbl-rats" class="cell anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-rats-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表格&nbsp;35.1: 小鼠重量数据（部分）
</figcaption><div aria-describedby="tbl-rats-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="cell table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">第 8 天</th>
<th style="text-align: right;">第 15 天</th>
<th style="text-align: right;">第 22 天</th>
<th style="text-align: right;">第 29 天</th>
<th style="text-align: right;">第 36 天</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1</td>
<td style="text-align: right;">151</td>
<td style="text-align: right;">199</td>
<td style="text-align: right;">246</td>
<td style="text-align: right;">283</td>
<td style="text-align: right;">320</td>
</tr>
<tr class="even">
<td style="text-align: left;">2</td>
<td style="text-align: right;">145</td>
<td style="text-align: right;">199</td>
<td style="text-align: right;">249</td>
<td style="text-align: right;">293</td>
<td style="text-align: right;">354</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3</td>
<td style="text-align: right;">147</td>
<td style="text-align: right;">214</td>
<td style="text-align: right;">263</td>
<td style="text-align: right;">312</td>
<td style="text-align: right;">328</td>
</tr>
<tr class="even">
<td style="text-align: left;">4</td>
<td style="text-align: right;">155</td>
<td style="text-align: right;">200</td>
<td style="text-align: right;">237</td>
<td style="text-align: right;">272</td>
<td style="text-align: right;">297</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5</td>
<td style="text-align: right;">135</td>
<td style="text-align: right;">188</td>
<td style="text-align: right;">230</td>
<td style="text-align: right;">280</td>
<td style="text-align: right;">323</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: right;">159</td>
<td style="text-align: right;">210</td>
<td style="text-align: right;">252</td>
<td style="text-align: right;">298</td>
<td style="text-align: right;">331</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>小鼠重量数据的分布和变化情况见下图，由图可以假定 30 只小鼠的重量服从正态分布，而30 只小鼠的重量呈现一种线性增长趋势。</p>
<div id="fig-rats" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-rats-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-rats" style="flex-basis: 50.0%;justify-content: flex-start;display: flex;">
<div id="fig-rats-1" class="quarto-figure quarto-figure-center anchored" width="480">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-rats-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="hierarchical-normal-models_files/figure-html/fig-rats-1.png" class="img-fluid figure-img" data-ref-parent="fig-rats" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-rats-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) 小鼠重量的分布
</figcaption></figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-rats" style="flex-basis: 50.0%;justify-content: flex-start;display: flex;">
<div id="fig-rats-2" class="quarto-figure quarto-figure-center anchored" width="480">
<figure class="quarto-float quarto-subfloat-fig figure"><div aria-describedby="fig-rats-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="hierarchical-normal-models_files/figure-html/fig-rats-2.png" class="img-fluid figure-img" data-ref-parent="fig-rats" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-rats-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) 小鼠重量的变化
</figcaption></figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rats-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;35.6: 30 只小鼠 5 次测量的数据
</figcaption></figure>
</div>
</section><section id="sec-rats-frequentist" class="level2" data-number="35.4"><h2 data-number="35.4" class="anchored" data-anchor-id="sec-rats-frequentist">
<span class="header-section-number">35.4</span> 频率派方法</h2>
<section id="sec-rats-nlme" class="level3" data-number="35.4.1"><h3 data-number="35.4.1" class="anchored" data-anchor-id="sec-rats-nlme">
<span class="header-section-number">35.4.1</span> nlme</h3>
<p><strong>nlme</strong> 包适合长格式的数据，因此，先将小鼠数据整理成长格式。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>rats_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb44-2"><a href="#cb44-2"></a>  <span class="at">weight =</span> <span class="fu">as.vector</span>(y), </span>
<span id="cb44-3"><a href="#cb44-3"></a>  <span class="at">rats =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>, <span class="at">times =</span> <span class="dv">5</span>), </span>
<span id="cb44-4"><a href="#cb44-4"></a>  <span class="at">days =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">15</span>, <span class="dv">22</span>, <span class="dv">29</span>, <span class="dv">36</span>), <span class="at">each =</span> <span class="dv">30</span>)</span>
<span id="cb44-5"><a href="#cb44-5"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>将 30 只小鼠的重量变化及回归曲线画出来，发现各只小鼠的回归线的斜率几乎一样，截距略有不同。不同小鼠的出生重量是不同，前面 Stan 采用变截距变斜率的混合效应模型拟合数据。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> rats_data, <span class="fu">aes</span>(<span class="at">x =</span> days, <span class="at">y =</span> weight)) <span class="sc">+</span></span>
<span id="cb45-2"><a href="#cb45-2"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb45-3"><a href="#cb45-3"></a>  <span class="fu">geom_smooth</span>(<span class="at">formula =</span> <span class="st">"y ~ x"</span>, <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb45-4"><a href="#cb45-4"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb45-5"><a href="#cb45-5"></a>  <span class="fu">facet_wrap</span>(<span class="at">facets =</span> <span class="sc">~</span>rats, <span class="at">labeller =</span> <span class="st">"label_both"</span>, <span class="at">ncol =</span> <span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb45-6"><a href="#cb45-6"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"第几天"</span>, <span class="at">y =</span> <span class="st">"重量"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-rats-lm" class="quarto-figure quarto-figure-center anchored" width="576">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-rats-lm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="hierarchical-normal-models_files/figure-html/fig-rats-lm-1.png" class="img-fluid figure-img" width="576">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rats-lm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;35.7: 小鼠重量变化曲线
</figcaption></figure>
</div>
</div>
</div>
<p>小鼠的重量随时间增长，不同小鼠的情况又会有所不同。作为一个参照，首先考虑变截距的随机效应模型。</p>
<p><span class="math display">\[
y_{ij} = \beta_0 + \beta_1 * x_j + \alpha_i + \epsilon_{ij}, \quad i = 1,2,\ldots,30. \quad j = 1,2,3,4,5
\]</span></p>
<p>其中，<span class="math inline">\(y_{ij}\)</span> 表示第 <span class="math inline">\(i\)</span> 只小鼠在第 <span class="math inline">\(j\)</span> 次测量的重量，一共 30 只小鼠，共测量了 5 次。固定效应部分是 <span class="math inline">\(\beta_0\)</span> 和 <span class="math inline">\(\beta_1\)</span> ，分别表示截距和斜率。随机效应部分是 <span class="math inline">\(\alpha_i\)</span> 和 <span class="math inline">\(\epsilon_{ij}\)</span> ，分别服从正态分布<span class="math inline">\(\alpha_i \sim \mathcal{N}(0, \sigma^2_{\alpha})\)</span> 和 <span class="math inline">\(\epsilon_{ij} \sim \mathcal{N}(0, \sigma^2_{\epsilon})\)</span> 。<span class="math inline">\(\sigma^2_{\alpha}\)</span> 和 <span class="math inline">\(\sigma^2_{\epsilon}\)</span> 分别表示组间方差（group level）和组内方差（individual level）。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a><span class="fu">library</span>(nlme)</span>
<span id="cb46-2"><a href="#cb46-2"></a>rats_lme0 <span class="ot">&lt;-</span> <span class="fu">lme</span>(<span class="at">data =</span> rats_data, <span class="at">fixed =</span> weight <span class="sc">~</span> days, <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> rats)</span>
<span id="cb46-3"><a href="#cb46-3"></a><span class="fu">summary</span>(rats_lme0)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Linear mixed-effects model fit by REML
#&gt;   Data: rats_data 
#&gt;        AIC     BIC    logLik
#&gt;   1145.302 1157.29 -568.6508
#&gt; 
#&gt; Random effects:
#&gt;  Formula: ~1 | rats
#&gt;         (Intercept) Residual
#&gt; StdDev:    14.03351 8.203811
#&gt; 
#&gt; Fixed effects:  weight ~ days 
#&gt;                 Value Std.Error  DF  t-value p-value
#&gt; (Intercept) 106.56762 3.0379720 119 35.07854       0
#&gt; days          6.18571 0.0676639 119 91.41824       0
#&gt;  Correlation: 
#&gt;      (Intr)
#&gt; days -0.49 
#&gt; 
#&gt; Standardized Within-Group Residuals:
#&gt;        Min         Q1        Med         Q3        Max 
#&gt; -2.7388198 -0.4770046  0.1261342  0.5634904  2.9981636 
#&gt; 
#&gt; Number of Observations: 150
#&gt; Number of Groups: 30</code></pre>
</div>
</div>
<p>当然，若考虑不同小鼠的生长速度不同（变化不是很大），可用变截距和变斜率的随机效应模型表示生长曲线模型，下面加载 <strong>nlme</strong> 包调用函数 <code>lme()</code> 拟合该模型。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a><span class="fu">library</span>(nlme)</span>
<span id="cb48-2"><a href="#cb48-2"></a>rats_lme <span class="ot">&lt;-</span> <span class="fu">lme</span>(<span class="at">data =</span> rats_data, <span class="at">fixed =</span> weight <span class="sc">~</span> days, <span class="at">random =</span> <span class="sc">~</span> days <span class="sc">|</span> rats)</span>
<span id="cb48-3"><a href="#cb48-3"></a><span class="fu">summary</span>(rats_lme)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Linear mixed-effects model fit by REML
#&gt;   Data: rats_data 
#&gt;        AIC      BIC    logLik
#&gt;   1107.373 1125.357 -547.6867
#&gt; 
#&gt; Random effects:
#&gt;  Formula: ~days | rats
#&gt;  Structure: General positive-definite, Log-Cholesky parametrization
#&gt;             StdDev     Corr  
#&gt; (Intercept) 10.7425835 (Intr)
#&gt; days         0.5105447 -0.159
#&gt; Residual     6.0146608       
#&gt; 
#&gt; Fixed effects:  weight ~ days 
#&gt;                 Value Std.Error  DF  t-value p-value
#&gt; (Intercept) 106.56762 2.2976183 119 46.38178       0
#&gt; days          6.18571 0.1055912 119 58.58174       0
#&gt;  Correlation: 
#&gt;      (Intr)
#&gt; days -0.343
#&gt; 
#&gt; Standardized Within-Group Residuals:
#&gt;        Min         Q1        Med         Q3        Max 
#&gt; -2.6370825 -0.5394956  0.1187658  0.4927200  2.6090652 
#&gt; 
#&gt; Number of Observations: 150
#&gt; Number of Groups: 30</code></pre>
</div>
</div>
<p>模型输出结果中，固定效应中的截距项 <code>(Intercept)</code> 对应 106.56762，斜率 <code>days</code> 对应 6.18571。Stan 模型中截距参数 <code>alpha0</code> 的后验估计是 106.332，斜率参数 <code>beta_c</code> 的后验估计是 6.188。对比 Stan 和 <strong>nlme</strong> 包的拟合结果，可以发现贝叶斯和频率方法的结果是非常接近的。截距参数 <code>alpha0</code> 可以看作小鼠的初始（出生）重量，斜率参数 <code>beta_c</code> 可以看作小鼠的生长率 growth rate。</p>
<p>函数 <code>lme()</code> 的输出结果中，随机效应的随机截距标准差 10.7425835，对应 <code>tau_alpha</code>，表示每个小鼠的截距偏移量的波动。而随机斜率的标准差为 0.5105447，对应 <code>tau_beta</code>，相对随机截距标准差来说很小。残差标准差为 6.0146608，对应 <code>tau_c</code>，表示与小鼠无关的剩余量的波动，比如测量误差。总之，和 Stan 的结果有所不同，但相去不远。主要是前面的 Stan 模型没有考虑随机截距和随机斜率之间的相关性，这可以进一步调整 <span class="citation" data-cites="sorensen2016">(<a href="references.html#ref-sorensen2016" role="doc-biblioref">Sorensen, Hohenstein, 和 Vasishth 2016</a>)</span> 。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a><span class="co"># 参数的置信区间</span></span>
<span id="cb50-2"><a href="#cb50-2"></a><span class="fu">intervals</span>(rats_lme, <span class="at">level =</span> <span class="fl">0.95</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Approximate 95% confidence intervals
#&gt; 
#&gt;  Fixed effects:
#&gt;                  lower       est.      upper
#&gt; (Intercept) 102.018105 106.567619 111.117133
#&gt; days          5.976633   6.185714   6.394795
#&gt; 
#&gt;  Random Effects:
#&gt;   Level: rats 
#&gt;                            lower       est.      upper
#&gt; sd((Intercept))        7.5159648 10.7425835 15.3543961
#&gt; sd(days)               0.3661761  0.5105447  0.7118322
#&gt; cor((Intercept),days) -0.5659916 -0.1590236  0.3102623
#&gt; 
#&gt;  Within-group standard error:
#&gt;    lower     est.    upper 
#&gt; 5.197218 6.014661 6.960675</code></pre>
</div>
</div>
<p>Stan 输出中，截距项 alpha、斜率项 beta 参数的标准差分别是 <code>tau_alpha</code> 和 <code>tau_beta</code> ，残差标准差参数 <code>tau_c</code> 的估计为 6.1。简单起见，没有考虑截距项和斜率项的相关性，即不考虑小鼠出生时的重量和生长率的相关性，一般来说，应该是有关系的。函数 <code>lme()</code> 的输出结果中给出了截距项和斜率项的相关性为 -0.343，随机截距和随机斜率的相关性为 -0.159。</p>
<p>计算与 Stan 输出中的截距项 <code>alpha_c</code> 对应的量，结合函数 <code>lme()</code> 的输出，截距、斜率加和之后，如下</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a><span class="fl">106.56762</span> <span class="sc">+</span> <span class="fl">6.18571</span> <span class="sc">*</span> <span class="dv">22</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 242.6532</code></pre>
</div>
</div>
<p>值得注意，Stan 代码中对时间 days 做了中心化处理，即 <span class="math inline">\(x_t - \bar{x}\)</span>，目的是降低采样时参数 <span class="math inline">\(\alpha_i\)</span> 和 <span class="math inline">\(\beta_i\)</span> 之间的相关性，而在拟合函数 <code>lme()</code> 中没有做处理，因此，结果无需转化，而且更容易解释。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a>fit_lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(weight <span class="sc">~</span> days, <span class="at">data =</span> rats_data)</span>
<span id="cb54-2"><a href="#cb54-2"></a><span class="fu">summary</span>(fit_lm)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Call:
#&gt; lm(formula = weight ~ days, data = rats_data)
#&gt; 
#&gt; Residuals:
#&gt;     Min      1Q  Median      3Q     Max 
#&gt; -38.253 -11.278   0.197   7.647  64.047 
#&gt; 
#&gt; Coefficients:
#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    
#&gt; (Intercept) 106.5676     3.2099   33.20   &lt;2e-16 ***
#&gt; days          6.1857     0.1331   46.49   &lt;2e-16 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt; Residual standard error: 16.13 on 148 degrees of freedom
#&gt; Multiple R-squared:  0.9359, Adjusted R-squared:  0.9355 
#&gt; F-statistic:  2161 on 1 and 148 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>采用简单线性模型即可获得与 <strong>nlme</strong> 包非常接近的估计结果，主要是小鼠重量的分布比较正态，且随时间的变化非常线性。</p>
</section><section id="lavaan" class="level3" data-number="35.4.2"><h3 data-number="35.4.2" class="anchored" data-anchor-id="lavaan">
<span class="header-section-number">35.4.2</span> lavaan</h3>
<p><strong>lavaan</strong> 包 <span class="citation" data-cites="Rosseel2012">(<a href="references.html#ref-Rosseel2012" role="doc-biblioref">Rosseel 2012</a>)</span> 主要是用来拟合结构方程模型，而生长曲线模型可以放在该框架下。所以，也可以用 <strong>lavaan</strong> 包来拟合，并且，它提供的函数 <code>growth()</code> 可以直接拟合生长曲线模型。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a><span class="fu">library</span>(lavaan)</span>
<span id="cb56-2"><a href="#cb56-2"></a><span class="co"># 设置矩阵 y 的列名</span></span>
<span id="cb56-3"><a href="#cb56-3"></a><span class="fu">colnames</span>(y) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"t1"</span>,<span class="st">"t2"</span>,<span class="st">"t3"</span>,<span class="st">"t4"</span>,<span class="st">"t5"</span>)</span>
<span id="cb56-4"><a href="#cb56-4"></a>rats_growt_model <span class="ot">&lt;-</span> <span class="st">" </span></span>
<span id="cb56-5"><a href="#cb56-5"></a><span class="st">  # intercept and slope with fixed coefficients</span></span>
<span id="cb56-6"><a href="#cb56-6"></a><span class="st">  intercept =~ 1*t1 + 1*t2 + 1*t3 + 1*t4 + 1*t5</span></span>
<span id="cb56-7"><a href="#cb56-7"></a><span class="st">  days =~ 0*t1 + 1*t2 + 2*t3 + 3*t4 + 4*t5 </span></span>
<span id="cb56-8"><a href="#cb56-8"></a></span>
<span id="cb56-9"><a href="#cb56-9"></a><span class="st">  # if we fix the variances to be equal, the models are now identical.</span></span>
<span id="cb56-10"><a href="#cb56-10"></a><span class="st">  t1 ~~ resvar*t1    </span></span>
<span id="cb56-11"><a href="#cb56-11"></a><span class="st">  t2 ~~ resvar*t2</span></span>
<span id="cb56-12"><a href="#cb56-12"></a><span class="st">  t3 ~~ resvar*t3</span></span>
<span id="cb56-13"><a href="#cb56-13"></a><span class="st">  t4 ~~ resvar*t4</span></span>
<span id="cb56-14"><a href="#cb56-14"></a><span class="st">  t5 ~~ resvar*t5</span></span>
<span id="cb56-15"><a href="#cb56-15"></a><span class="st">"</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>其中，算子符号 <code>=~</code> 定义潜变量，<code>~~</code> 定义残差协方差，intercept 表示截距， days 表示斜率。假定 5 次测量的测量误差（组内方差）是相同的。拟合模型的代码如下：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a>rats_growth_fit <span class="ot">&lt;-</span> <span class="fu">growth</span>(rats_growt_model, <span class="at">data =</span> y)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>提供函数 <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> 获得模型输出，结果如下：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a><span class="fu">summary</span>(rats_growth_fit, <span class="at">fit.measures =</span> <span class="cn">TRUE</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; lavaan 0.6.16 ended normally after 87 iterations
#&gt; 
#&gt;   Estimator                                         ML
#&gt;   Optimization method                           NLMINB
#&gt;   Number of model parameters                        10
#&gt;   Number of equality constraints                     4
#&gt; 
#&gt;   Number of observations                            30
#&gt; 
#&gt; Model Test User Model:
#&gt;                                                       
#&gt;   Test statistic                               106.203
#&gt;   Degrees of freedom                                14
#&gt;   P-value (Chi-square)                           0.000
#&gt; 
#&gt; Model Test Baseline Model:
#&gt; 
#&gt;   Test statistic                               247.075
#&gt;   Degrees of freedom                                10
#&gt;   P-value                                        0.000
#&gt; 
#&gt; User Model versus Baseline Model:
#&gt; 
#&gt;   Comparative Fit Index (CFI)                    0.611
#&gt;   Tucker-Lewis Index (TLI)                       0.722
#&gt; 
#&gt; Loglikelihood and Information Criteria:
#&gt; 
#&gt;   Loglikelihood user model (H0)               -548.029
#&gt;   Loglikelihood unrestricted model (H1)       -494.927
#&gt;                                                       
#&gt;   Akaike (AIC)                                1108.057
#&gt;   Bayesian (BIC)                              1116.465
#&gt;   Sample-size adjusted Bayesian (SABIC)       1097.783
#&gt; 
#&gt; Root Mean Square Error of Approximation:
#&gt; 
#&gt;   RMSEA                                          0.469
#&gt;   90 Percent confidence interval - lower         0.388
#&gt;   90 Percent confidence interval - upper         0.554
#&gt;   P-value H_0: RMSEA &lt;= 0.050                    0.000
#&gt;   P-value H_0: RMSEA &gt;= 0.080                    1.000
#&gt; 
#&gt; Standardized Root Mean Square Residual:
#&gt; 
#&gt;   SRMR                                           0.151
#&gt; 
#&gt; Parameter Estimates:
#&gt; 
#&gt;   Standard errors                             Standard
#&gt;   Information                                 Expected
#&gt;   Information saturated (h1) model          Structured
#&gt; 
#&gt; Latent Variables:
#&gt;                    Estimate  Std.Err  z-value  P(&gt;|z|)
#&gt;   intercept =~                                        
#&gt;     t1                1.000                           
#&gt;     t2                1.000                           
#&gt;     t3                1.000                           
#&gt;     t4                1.000                           
#&gt;     t5                1.000                           
#&gt;   days =~                                             
#&gt;     t1                0.000                           
#&gt;     t2                1.000                           
#&gt;     t3                2.000                           
#&gt;     t4                3.000                           
#&gt;     t5                4.000                           
#&gt; 
#&gt; Covariances:
#&gt;                    Estimate  Std.Err  z-value  P(&gt;|z|)
#&gt;   intercept ~~                                        
#&gt;     days              8.444    8.521    0.991    0.322
#&gt; 
#&gt; Intercepts:
#&gt;                    Estimate  Std.Err  z-value  P(&gt;|z|)
#&gt;    .t1                0.000                           
#&gt;    .t2                0.000                           
#&gt;    .t3                0.000                           
#&gt;    .t4                0.000                           
#&gt;    .t5                0.000                           
#&gt;     intercept       156.053    2.123   73.516    0.000
#&gt;     days             43.300    0.727   59.582    0.000
#&gt; 
#&gt; Variances:
#&gt;                    Estimate  Std.Err  z-value  P(&gt;|z|)
#&gt;    .t1      (rsvr)   36.176    5.393    6.708    0.000
#&gt;    .t2      (rsvr)   36.176    5.393    6.708    0.000
#&gt;    .t3      (rsvr)   36.176    5.393    6.708    0.000
#&gt;    .t4      (rsvr)   36.176    5.393    6.708    0.000
#&gt;    .t5      (rsvr)   36.176    5.393    6.708    0.000
#&gt;     intrcpt         113.470   35.052    3.237    0.001
#&gt;     days             12.226    4.126    2.963    0.003</code></pre>
</div>
</div>
<p>输出结果显示 <strong>lavaan</strong> 包的函数 <code>growth()</code> 采用极大似然估计方法。协方差部分 <code>Covariances:</code> 随机效应中斜率和截距的协方差。截距部分 <code>Intercepts:</code> 对应于混合效应模型的固定效应部分。方差部分 <code>Variances:</code> 对应于混合效应模型的随机效应部分，包括残差方差、斜率和截距的方差。不难看出，这和前面 <strong>nlme</strong> 包的输出结果差别很大。原因是 <strong>lavaan</strong> 包将测量的次序从 0 开始计，0 代表小鼠出生后的第 8 天。也就是说，<strong>lavaan</strong> 采用的是次序标记，而不是实际数据。将测量发生的时间（第几天）换算成次序（第几次），并从 0 开始计，则函数 <code>lme()</code> 的输出和函数 <code>growth()</code> 就一致了。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a><span class="co"># 重新组织数据</span></span>
<span id="cb60-2"><a href="#cb60-2"></a>rats_data2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb60-3"><a href="#cb60-3"></a>  <span class="at">weight =</span> <span class="fu">as.vector</span>(y), </span>
<span id="cb60-4"><a href="#cb60-4"></a>  <span class="at">rats =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>, <span class="at">times =</span> <span class="dv">5</span>), </span>
<span id="cb60-5"><a href="#cb60-5"></a>  <span class="at">days =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>), <span class="at">each =</span> <span class="dv">30</span>)</span>
<span id="cb60-6"><a href="#cb60-6"></a>)</span>
<span id="cb60-7"><a href="#cb60-7"></a><span class="co"># ML 方法估计模型参数</span></span>
<span id="cb60-8"><a href="#cb60-8"></a>rats_lme2 <span class="ot">&lt;-</span> <span class="fu">lme</span>(<span class="at">data =</span> rats_data2, <span class="at">fixed =</span> weight <span class="sc">~</span> days, <span class="at">random =</span> <span class="sc">~</span> days <span class="sc">|</span> rats, <span class="at">method =</span> <span class="st">"ML"</span>)</span>
<span id="cb60-9"><a href="#cb60-9"></a><span class="fu">summary</span>(rats_lme2)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Linear mixed-effects model fit by maximum likelihood
#&gt;   Data: rats_data2 
#&gt;        AIC      BIC    logLik
#&gt;   1108.057 1126.121 -548.0287
#&gt; 
#&gt; Random effects:
#&gt;  Formula: ~days | rats
#&gt;  Structure: General positive-definite, Log-Cholesky parametrization
#&gt;             StdDev    Corr  
#&gt; (Intercept) 10.652385 (Intr)
#&gt; days         3.496584 0.227 
#&gt; Residual     6.014613       
#&gt; 
#&gt; Fixed effects:  weight ~ days 
#&gt;                Value Std.Error  DF  t-value p-value
#&gt; (Intercept) 156.0533 2.1370181 119 73.02387       0
#&gt; days         43.3000 0.7316138 119 59.18423       0
#&gt;  Correlation: 
#&gt;      (Intr)
#&gt; days 0.026 
#&gt; 
#&gt; Standardized Within-Group Residuals:
#&gt;        Min         Q1        Med         Q3        Max 
#&gt; -2.6317200 -0.5421564  0.1154349  0.4948020  2.6188195 
#&gt; 
#&gt; Number of Observations: 150
#&gt; Number of Groups: 30</code></pre>
</div>
</div>
<p>可以看到函数 <code>growth()</code> 给出的截距和斜率的协方差估计为 8.444，函数 <code>lme()</code> 给出对应截距和斜率的标准差分别是 10.652390 和 3.496588，它们的相关系数为 0.227，则函数 <code>lme()</code> 给出的协方差估计为 <code>10.652390*3.496588*0.227</code> ，即 8.455，协方差估计比较一致。同理，比较两个输出结果中的其它成分，函数 <code>growth()</code> 给出的残差方差估计为 36.176，则残差标准差估计为 6.0146，结合函数 <code>lme()</code> 给出的 <code>Random effects:</code> 中 <code>Residual</code>，结果完全一样。函数 <code>growth()</code> 给出的 <code>Intercepts:</code> 对应于函数 <code>lme()</code> 给出的固定效应部分，结果也是完全一样。</p>
<p>针对模型拟合对象 <code>rats_growth_fit</code> ，除了函数 <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> 可以汇总结果，<strong>lavaan</strong> 包还提供 <code><a href="https://rdrr.io/r/stats/AIC.html">AIC()</a></code> 、 <code><a href="https://rdrr.io/r/stats/AIC.html">BIC()</a></code> 和 <code><a href="https://rdrr.io/r/stats/logLik.html">logLik()</a></code> 等函数，分别可以提取 AIC、BIC 和对数似然值， <code><a href="https://rdrr.io/r/stats/AIC.html">AIC()</a></code> 和 <code><a href="https://rdrr.io/r/stats/logLik.html">logLik()</a></code> 结果与前面的函数 <code>lme()</code> 的输出是一样的，而 <code><a href="https://rdrr.io/r/stats/AIC.html">BIC()</a></code> 不同。</p>
</section><section id="lme4-1" class="level3" data-number="35.4.3"><h3 data-number="35.4.3" class="anchored" data-anchor-id="lme4-1">
<span class="header-section-number">35.4.3</span> lme4</h3>
<p>当采用 <strong>lme4</strong> 包拟合数据的时候，发现输出结果与 <strong>nlme</strong> 包几乎相同。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1"></a>rats_lme4 <span class="ot">&lt;-</span> lme4<span class="sc">::</span><span class="fu">lmer</span>(weight <span class="sc">~</span> days <span class="sc">+</span> (days <span class="sc">|</span> rats), <span class="at">data =</span> rats_data)</span>
<span id="cb62-2"><a href="#cb62-2"></a><span class="fu">summary</span>(rats_lme4)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Linear mixed model fit by REML ['lmerMod']
#&gt; Formula: weight ~ days + (days | rats)
#&gt;    Data: rats_data
#&gt; 
#&gt; REML criterion at convergence: 1095.4
#&gt; 
#&gt; Scaled residuals: 
#&gt;     Min      1Q  Median      3Q     Max 
#&gt; -2.6371 -0.5395  0.1188  0.4927  2.6091 
#&gt; 
#&gt; Random effects:
#&gt;  Groups   Name        Variance Std.Dev. Corr 
#&gt;  rats     (Intercept) 115.4239 10.7435       
#&gt;           days          0.2607  0.5106  -0.16
#&gt;  Residual              36.1753  6.0146       
#&gt; Number of obs: 150, groups:  rats, 30
#&gt; 
#&gt; Fixed effects:
#&gt;             Estimate Std. Error t value
#&gt; (Intercept) 106.5676     2.2978   46.38
#&gt; days          6.1857     0.1056   58.58
#&gt; 
#&gt; Correlation of Fixed Effects:
#&gt;      (Intr)
#&gt; days -0.343</code></pre>
</div>
</div>
</section><section id="glmmtmb" class="level3" data-number="35.4.4"><h3 data-number="35.4.4" class="anchored" data-anchor-id="glmmtmb">
<span class="header-section-number">35.4.4</span> glmmTMB</h3>
<p>glmmTMB 包基于 Template Model Builder (TMB) ，拟合广义线性混合效应模型，公式语法与 <strong>lme4</strong> 包一致。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1"></a>rats_glmmtmb <span class="ot">&lt;-</span> glmmTMB<span class="sc">::</span><span class="fu">glmmTMB</span>(weight <span class="sc">~</span> days <span class="sc">+</span> (days <span class="sc">|</span> rats), <span class="at">REML =</span> <span class="cn">TRUE</span>, <span class="at">data =</span> rats_data)</span>
<span id="cb64-2"><a href="#cb64-2"></a><span class="fu">summary</span>(rats_glmmtmb)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;  Family: gaussian  ( identity )
#&gt; Formula:          weight ~ days + (days | rats)
#&gt; Data: rats_data
#&gt; 
#&gt;      AIC      BIC   logLik deviance df.resid 
#&gt;   1107.4   1125.4   -547.7   1095.4      146 
#&gt; 
#&gt; Random effects:
#&gt; 
#&gt; Conditional model:
#&gt;  Groups   Name        Variance Std.Dev. Corr  
#&gt;  rats     (Intercept) 115.4195 10.7433        
#&gt;           days          0.2607  0.5106  -0.16 
#&gt;  Residual              36.1756  6.0146        
#&gt; Number of obs: 150, groups:  rats, 30
#&gt; 
#&gt; Dispersion estimate for gaussian family (sigma^2): 36.2 
#&gt; 
#&gt; Conditional model:
#&gt;             Estimate Std. Error z value Pr(&gt;|z|)    
#&gt; (Intercept) 106.5676     2.2977   46.38   &lt;2e-16 ***
#&gt; days          6.1857     0.1056   58.58   &lt;2e-16 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>结果与 <strong>nlme</strong> 包完全一样。</p>
</section><section id="mass" class="level3" data-number="35.4.5"><h3 data-number="35.4.5" class="anchored" data-anchor-id="mass">
<span class="header-section-number">35.4.5</span> MASS</h3>
<p><strong>MASS</strong> 包的结果与前面完全一致。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1"></a>rats_mass <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">glmmPQL</span>(</span>
<span id="cb66-2"><a href="#cb66-2"></a>  <span class="at">fixed =</span> weight <span class="sc">~</span> days, <span class="at">random =</span> <span class="sc">~</span> days <span class="sc">|</span> rats, </span>
<span id="cb66-3"><a href="#cb66-3"></a>  <span class="at">data =</span> rats_data, <span class="at">family =</span> <span class="fu">gaussian</span>(), <span class="at">verbose =</span> <span class="cn">FALSE</span></span>
<span id="cb66-4"><a href="#cb66-4"></a>)</span>
<span id="cb66-5"><a href="#cb66-5"></a><span class="fu">summary</span>(rats_mass)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Linear mixed-effects model fit by maximum likelihood
#&gt;   Data: rats_data 
#&gt;   AIC BIC logLik
#&gt;    NA  NA     NA
#&gt; 
#&gt; Random effects:
#&gt;  Formula: ~days | rats
#&gt;  Structure: General positive-definite, Log-Cholesky parametrization
#&gt;             StdDev     Corr  
#&gt; (Intercept) 10.4945051 (Intr)
#&gt; days         0.4994795 -0.15 
#&gt; Residual     6.0146664       
#&gt; 
#&gt; Variance function:
#&gt;  Structure: fixed weights
#&gt;  Formula: ~invwt 
#&gt; Fixed effects:  weight ~ days 
#&gt;                 Value Std.Error  DF  t-value p-value
#&gt; (Intercept) 106.56762 2.2742917 119 46.85750       0
#&gt; days          6.18571 0.1045112 119 59.18709       0
#&gt;  Correlation: 
#&gt;      (Intr)
#&gt; days -0.343
#&gt; 
#&gt; Standardized Within-Group Residuals:
#&gt;        Min         Q1        Med         Q3        Max 
#&gt; -2.6316763 -0.5421361  0.1154445  0.4947986  2.6187979 
#&gt; 
#&gt; Number of Observations: 150
#&gt; Number of Groups: 30</code></pre>
</div>
</div>
</section><section id="spamm" class="level3" data-number="35.4.6"><h3 data-number="35.4.6" class="anchored" data-anchor-id="spamm">
<span class="header-section-number">35.4.6</span> spaMM</h3>
<p><strong>spaMM</strong> 包的结果与前面完全一致。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1"></a>rats_spamm <span class="ot">&lt;-</span> spaMM<span class="sc">::</span><span class="fu">fitme</span>(weight <span class="sc">~</span> days <span class="sc">+</span> (days <span class="sc">|</span> rats), <span class="at">data =</span> rats_data)</span>
<span id="cb68-2"><a href="#cb68-2"></a><span class="fu">summary</span>(rats_spamm)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; formula: weight ~ days + (days | rats)
#&gt; ML: Estimation of ranCoefs and phi by ML.
#&gt;     Estimation of fixed effects by ML.
#&gt; Estimation of phi by 'outer' ML, maximizing logL.
#&gt; family: gaussian( link = identity ) 
#&gt;  ------------ Fixed effects (beta) ------------
#&gt;             Estimate Cond. SE t-value
#&gt; (Intercept)  106.568   2.2591   47.17
#&gt; days           6.186   0.1038   59.58
#&gt;  --------------- Random effects ---------------
#&gt; Family: gaussian( link = identity ) 
#&gt;          --- Random-coefficients Cov matrices:
#&gt;  Group        Term   Var.   Corr.
#&gt;   rats (Intercept)  110.1        
#&gt;   rats        days 0.2495 -0.1507
#&gt; # of obs: 150; # of groups: rats, 30 
#&gt;  -------------- Residual variance  ------------
#&gt; phi estimate was 36.1755 
#&gt;  ------------- Likelihood values  -------------
#&gt;                         logLik
#&gt; logL       (p_v(h)): -548.0287</code></pre>
</div>
</div>
<div class="sourceCode" id="cb70"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb70-1"><a href="#cb70-1"></a> --------------- Random effects ---------------</span>
<span id="cb70-2"><a href="#cb70-2"></a>Family: gaussian( link = identity ) </span>
<span id="cb70-3"><a href="#cb70-3"></a>         --- Random-coefficients Cov matrices:</span>
<span id="cb70-4"><a href="#cb70-4"></a> Group        Term   Var.   Corr.</span>
<span id="cb70-5"><a href="#cb70-5"></a>  rats (Intercept)  110.1        </span>
<span id="cb70-6"><a href="#cb70-6"></a>  rats        days 0.2495 -0.1507</span>
<span id="cb70-7"><a href="#cb70-7"></a><span class="fu"># of obs: 150; # of groups: rats, 30 </span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>随机效应的截距方差 110.1，斜率方差 0.2495，则标准差分别是 10.49 和 0.499，相关性为 -0.1507。</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb71-1"><a href="#cb71-1"></a> -------------- Residual variance  ------------</span>
<span id="cb71-2"><a href="#cb71-2"></a>phi estimate was 36.1755 </span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>残差方差为 36.1755，则标准差为 6.0146。</p>
</section><section id="hglm" class="level3" data-number="35.4.7"><h3 data-number="35.4.7" class="anchored" data-anchor-id="hglm">
<span class="header-section-number">35.4.7</span> hglm</h3>
<p><strong>hglm</strong> 包 <span class="citation" data-cites="rönnegård2010">(<a href="references.html#ref-r%C3%B6nneg%C3%A5rd2010" role="doc-biblioref">Rönnegård, Shen, 和 Alam 2010</a>)</span> 可以拟合分层广义线性模型，线性混合效应模型和广义线性混合效应模型，随机效应和响应变量服从的分布可以很广泛，使用语法与 <strong>lme4</strong> 包一样。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1"></a>rats_hglm <span class="ot">&lt;-</span> hglm<span class="sc">::</span><span class="fu">hglm2</span>(weight <span class="sc">~</span> days <span class="sc">+</span> (days <span class="sc">|</span> rats), <span class="at">data =</span> rats_data)</span>
<span id="cb72-2"><a href="#cb72-2"></a><span class="fu">summary</span>(rats_hglm)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Call: 
#&gt; hglm2.formula(meanmodel = weight ~ days + (days | rats), data = rats_data)
#&gt; 
#&gt; ----------
#&gt; MEAN MODEL
#&gt; ----------
#&gt; 
#&gt; Summary of the fixed effects estimates:
#&gt; 
#&gt;             Estimate Std. Error t-value Pr(&gt;|t|)    
#&gt; (Intercept) 106.5676     2.1787   48.91   &lt;2e-16 ***
#&gt; days          6.1857     0.1029   60.13   &lt;2e-16 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; Note: P-values are based on 103 degrees of freedom
#&gt; 
#&gt; Summary of the random effects estimates:
#&gt; 
#&gt;                     Estimate Std. Error
#&gt; (Intercept)| rats:1  -0.1705     5.3422
#&gt; (Intercept)| rats:2  -9.8655     5.3422
#&gt; (Intercept)| rats:3   2.7201     5.3422
#&gt; ...
#&gt; NOTE: to show all the random effects, use print(summary(hglm.object), print.ranef = TRUE).
#&gt; 
#&gt; Summary of the random effects estimates:
#&gt; 
#&gt;              Estimate Std. Error
#&gt; days| rats:1  -0.1213      0.229
#&gt; days| rats:2   0.7260      0.229
#&gt; days| rats:3   0.3280      0.229
#&gt; ...
#&gt; NOTE: to show all the random effects, use print(summary(hglm.object), print.ranef = TRUE).
#&gt; 
#&gt; ----------------
#&gt; DISPERSION MODEL
#&gt; ----------------
#&gt; 
#&gt; NOTE: h-likelihood estimates through EQL can be biased.
#&gt; 
#&gt; Dispersion parameter for the mean model:
#&gt; [1] 37.09572
#&gt; 
#&gt; Model estimates for the dispersion term:
#&gt; 
#&gt; Link = log 
#&gt; 
#&gt; Effects:
#&gt;   Estimate Std. Error 
#&gt;     3.6135     0.1391 
#&gt; 
#&gt; Dispersion = 1 is used in Gamma model on deviances to calculate the standard error(s).
#&gt; 
#&gt; Dispersion parameter for the random effects:
#&gt; [1] 103.4501   0.2407
#&gt; 
#&gt; Dispersion model for the random effects:
#&gt; 
#&gt; Link = log
#&gt; 
#&gt; Effects:
#&gt; .|Random1 
#&gt;   Estimate Std. Error 
#&gt;     4.6391     0.3069 
#&gt; 
#&gt; .|Random2 
#&gt;   Estimate Std. Error 
#&gt;    -1.4241     0.2920 
#&gt; 
#&gt; Dispersion = 1 is used in Gamma model on deviances to calculate the standard error(s).
#&gt; 
#&gt; EQL estimation converged in 5 iterations.</code></pre>
</div>
</div>
<p>固定效应的截距和斜率都是和 <strong>nlme</strong> 包的输出结果一致。值得注意，随机效应和模型残差都是以发散参数（Dispersion parameter）来表示的，模型残差方差为 37.09572，则标准差为 6.0906，随机效应的随机截距和随机斜率的方差分别为 103.4501 和 0.2407，则标准差分别为 10.1710 和 0.4906，这与 <strong>nlme</strong> 包的结果也是一致的。</p>
</section><section id="mgcv" class="level3" data-number="35.4.8"><h3 data-number="35.4.8" class="anchored" data-anchor-id="mgcv">
<span class="header-section-number">35.4.8</span> mgcv</h3>
<p>先考虑一个变截距的混合效应模型</p>
<p><span class="math display">\[
y_{ij} = \beta_0 + \beta_1 * x_j + \alpha_i + \epsilon_{ij}, \quad i = 1,2,\ldots,30. \quad j = 1,2,3,4,5
\]</span></p>
<p>假设随机效应服从独立同正态分布，等价于在似然函数中添加一个岭惩罚。广义可加模型在一定形式下和上述混合效应模型存在等价关系，在广义可加模型中，可以样条表示随机效应。<strong>mgcv</strong> 包拟合代码如下。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb74-2"><a href="#cb74-2"></a>rats_data<span class="sc">$</span>rats <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(rats_data<span class="sc">$</span>rats)</span>
<span id="cb74-3"><a href="#cb74-3"></a>rats_gam <span class="ot">&lt;-</span> <span class="fu">gam</span>(weight <span class="sc">~</span> days <span class="sc">+</span> <span class="fu">s</span>(rats, <span class="at">bs =</span> <span class="st">"re"</span>), <span class="at">data =</span> rats_data)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>其中，参数取值 <code>bs = "re"</code> 指定样条类型，re 是 Random effects 的简写。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1"></a><span class="fu">summary</span>(rats_gam)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Family: gaussian 
#&gt; Link function: identity 
#&gt; 
#&gt; Formula:
#&gt; weight ~ days + s(rats, bs = "re")
#&gt; 
#&gt; Parametric coefficients:
#&gt;              Estimate Std. Error t value Pr(&gt;|t|)    
#&gt; (Intercept) 106.56762    3.03797   35.08   &lt;2e-16 ***
#&gt; days          6.18571    0.06766   91.42   &lt;2e-16 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt; Approximate significance of smooth terms:
#&gt;           edf Ref.df     F p-value    
#&gt; s(rats) 27.14     29 14.63  &lt;2e-16 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt; R-sq.(adj) =  0.983   Deviance explained = 98.6%
#&gt; GCV = 83.533  Scale est. = 67.303    n = 150</code></pre>
</div>
</div>
<p>其中，残差的方差 Scale est. = 67.303 ，则标准差为 <span class="math inline">\(\sigma_{\epsilon} = 8.2038\)</span> 。随机效应的标准差如下</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1"></a><span class="fu">gam.vcomp</span>(rats_gam, <span class="at">rescale =</span> <span class="cn">TRUE</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;  s(rats) 
#&gt; 14.03351</code></pre>
</div>
</div>
<p><code>rescale = TRUE</code> 表示恢复至原数据的尺度，标准差 <span class="math inline">\(\sigma_{\alpha} = 14.033\)</span>。可以看到，固定效应和随机效应的估计结果与 <strong>nlme</strong> 包等完全一致。若考虑变截距和变斜率的混合效应模型，拟合代码如下：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1"></a>rats_gam1 <span class="ot">&lt;-</span> <span class="fu">gam</span>(</span>
<span id="cb79-2"><a href="#cb79-2"></a>  weight <span class="sc">~</span> days <span class="sc">+</span> <span class="fu">s</span>(rats, <span class="at">bs =</span> <span class="st">"re"</span>) <span class="sc">+</span> <span class="fu">s</span>(rats, <span class="at">by =</span> days, <span class="at">bs =</span> <span class="st">"re"</span>),</span>
<span id="cb79-3"><a href="#cb79-3"></a>  <span class="at">data =</span> rats_data, <span class="at">method =</span> <span class="st">"REML"</span></span>
<span id="cb79-4"><a href="#cb79-4"></a>)</span>
<span id="cb79-5"><a href="#cb79-5"></a><span class="fu">summary</span>(rats_gam1)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Family: gaussian 
#&gt; Link function: identity 
#&gt; 
#&gt; Formula:
#&gt; weight ~ days + s(rats, bs = "re") + s(rats, by = days, bs = "re")
#&gt; 
#&gt; Parametric coefficients:
#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    
#&gt; (Intercept) 106.5676     2.2365   47.65   &lt;2e-16 ***
#&gt; days          6.1857     0.1028   60.18   &lt;2e-16 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt; Approximate significance of smooth terms:
#&gt;                edf Ref.df     F p-value    
#&gt; s(rats)      21.80     29 183.9  &lt;2e-16 ***
#&gt; s(rats):days 23.47     29 201.8  &lt;2e-16 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt; R-sq.(adj) =  0.991   Deviance explained = 99.4%
#&gt; -REML = 547.89  Scale est. = 36.834    n = 150</code></pre>
</div>
</div>
<p>输出结果中，固定效应部分的结果和 <strong>nlme</strong> 包完全一样。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1"></a><span class="fu">gam.vcomp</span>(rats_gam1, <span class="at">rescale =</span> <span class="cn">TRUE</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Standard deviations and 0.95 confidence intervals:
#&gt; 
#&gt;                 std.dev     lower      upper
#&gt; s(rats)      10.3107538 7.2978205 14.5675882
#&gt; s(rats):days  0.4916736 0.3571229  0.6769181
#&gt; scale         6.0691017 5.2454835  7.0220401
#&gt; 
#&gt; Rank: 3/3</code></pre>
</div>
</div>
<p>输出结果中，依次是随机效应的截距、斜率和残差的标准差（标准偏差），和 <strong>nlme</strong> 包给出的结果非常接近。</p>
<p><strong>mgcv</strong> 包还提供函数 <code>gamm()</code>，它将混合效应和固定效应分开，在拟合 LMM 模型时，它类似 <strong>nlme</strong> 包的函数 <code>lme()</code>。返回一个含有 lme 和 gam 两个元素的列表，前者包含随机效应的估计，后者是固定效应的估计，固定效应中可以添加样条（或样条表示的简单随机效益，比如本节前面提及的模型）。实际上，函数 <code>gamm()</code> 分别调用 <strong>nlme</strong> 包和 <strong>MASS</strong> 包来拟合 LMM 模型和 GLMM 模型。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1"></a>rats_gamm <span class="ot">&lt;-</span> <span class="fu">gamm</span>(weight <span class="sc">~</span> days, <span class="at">random =</span> <span class="fu">list</span>(<span class="at">rats =</span> <span class="sc">~</span>days), <span class="at">method =</span> <span class="st">"REML"</span>, <span class="at">data =</span> rats_data)</span>
<span id="cb83-2"><a href="#cb83-2"></a><span class="co"># LME</span></span>
<span id="cb83-3"><a href="#cb83-3"></a><span class="fu">summary</span>(rats_gamm<span class="sc">$</span>lme)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Linear mixed-effects model fit by REML
#&gt;   Data: strip.offset(mf) 
#&gt;        AIC      BIC    logLik
#&gt;   1107.373 1125.357 -547.6867
#&gt; 
#&gt; Random effects:
#&gt;  Formula: ~days | rats
#&gt;  Structure: General positive-definite, Log-Cholesky parametrization
#&gt;             StdDev     Corr  
#&gt; (Intercept) 10.7433332 (Intr)
#&gt; days         0.5105577 -0.159
#&gt; Residual     6.0146119       
#&gt; 
#&gt; Fixed effects:  y ~ X - 1 
#&gt;                  Value Std.Error  DF  t-value p-value
#&gt; X(Intercept) 106.56762 2.2977301 119 46.37952       0
#&gt; Xdays          6.18571 0.1055931 119 58.58069       0
#&gt;  Correlation: 
#&gt;       X(Int)
#&gt; Xdays -0.343
#&gt; 
#&gt; Standardized Within-Group Residuals:
#&gt;        Min         Q1        Med         Q3        Max 
#&gt; -2.6371079 -0.5394997  0.1187534  0.4927191  2.6091109 
#&gt; 
#&gt; Number of Observations: 150
#&gt; Number of Groups: 30</code></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1"></a><span class="co"># GAM</span></span>
<span id="cb85-2"><a href="#cb85-2"></a><span class="fu">summary</span>(rats_gamm<span class="sc">$</span>gam)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Family: gaussian 
#&gt; Link function: identity 
#&gt; 
#&gt; Formula:
#&gt; weight ~ days
#&gt; 
#&gt; Parametric coefficients:
#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    
#&gt; (Intercept) 106.5676     2.2977   46.38   &lt;2e-16 ***
#&gt; days          6.1857     0.1056   58.58   &lt;2e-16 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt; 
#&gt; R-sq.(adj) =  0.935   
#&gt;   Scale est. = 36.176    n = 150</code></pre>
</div>
</div>
</section></section><section id="sec-rats-bayesianism" class="level2" data-number="35.5"><h2 data-number="35.5" class="anchored" data-anchor-id="sec-rats-bayesianism">
<span class="header-section-number">35.5</span> 贝叶斯方法</h2>
<section id="sec-rats-rstan" class="level3" data-number="35.5.1"><h3 data-number="35.5.1" class="anchored" data-anchor-id="sec-rats-rstan">
<span class="header-section-number">35.5.1</span> rstan</h3>
<p>初始化模型参数，设置采样算法的参数。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1"></a><span class="co"># 迭代链</span></span>
<span id="cb87-2"><a href="#cb87-2"></a>chains <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb87-3"><a href="#cb87-3"></a><span class="co"># 迭代次数</span></span>
<span id="cb87-4"><a href="#cb87-4"></a>iter <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb87-5"><a href="#cb87-5"></a><span class="co"># 初始值</span></span>
<span id="cb87-6"><a href="#cb87-6"></a>init <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">list</span>(<span class="fu">list</span>(</span>
<span id="cb87-7"><a href="#cb87-7"></a>  <span class="at">alpha =</span> <span class="fu">rep</span>(<span class="dv">250</span>, <span class="dv">30</span>), <span class="at">beta =</span> <span class="fu">rep</span>(<span class="dv">6</span>, <span class="dv">30</span>),</span>
<span id="cb87-8"><a href="#cb87-8"></a>  <span class="at">alpha_c =</span> <span class="dv">150</span>, <span class="at">beta_c =</span> <span class="dv">10</span>,</span>
<span id="cb87-9"><a href="#cb87-9"></a>  <span class="at">tausq_c =</span> <span class="dv">1</span>, <span class="at">tausq_alpha =</span> <span class="dv">1</span>,</span>
<span id="cb87-10"><a href="#cb87-10"></a>  <span class="at">tausq_beta =</span> <span class="dv">1</span></span>
<span id="cb87-11"><a href="#cb87-11"></a>)), chains)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>接下来，基于重复测量数据，建立线性生长曲线模型：</p>
<p><span class="math display">\[
\begin{aligned}
\alpha_c &amp;\sim \mathcal{N}(0,100) \quad \beta_c  \sim \mathcal{N}(0,100) \\
\tau^2_{\alpha} &amp;\sim \mathrm{inv\_gamma}(0.001, 0.001) \\
\tau^2_{\beta}  &amp;\sim \mathrm{inv\_gamma}(0.001, 0.001) \\
\tau^2_c &amp;\sim \mathrm{inv\_gamma}(0.001, 0.001) \\
\alpha_n &amp;\sim \mathcal{N}(\alpha_c, \tau_{\alpha})  \quad
\beta_n  \sim \mathcal{N}(\beta_c, \tau_{\beta}) \\
y_{nt} &amp;\sim \mathcal{N}(\alpha_n + \beta_n * (x_t - \bar{x}), \tau_c) \\
&amp; n = 1,2,\ldots,N \quad t = 1,2,\ldots,T
\end{aligned}
\]</span></p>
<p>其中， <span class="math inline">\(\alpha_c,\beta_c,\tau_c,\tau_{\alpha},\tau_{\beta}\)</span> 为无信息先验，<span class="math inline">\(\bar{x} = 22\)</span> 表示第 22 天，<span class="math inline">\(N = 30\)</span> 和 <span class="math inline">\(T = 5\)</span> 分别表示实验中的小鼠数量和测量次数，下面采用 Stan 编码、编译、采样和拟合模型。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1"></a>rats_fit <span class="ot">&lt;-</span> <span class="fu">stan</span>(</span>
<span id="cb88-2"><a href="#cb88-2"></a>  <span class="at">model_name =</span> <span class="st">"rats"</span>,</span>
<span id="cb88-3"><a href="#cb88-3"></a>  <span class="at">model_code =</span> <span class="st">"</span></span>
<span id="cb88-4"><a href="#cb88-4"></a><span class="st">  data {</span></span>
<span id="cb88-5"><a href="#cb88-5"></a><span class="st">    int&lt;lower=0&gt; N;</span></span>
<span id="cb88-6"><a href="#cb88-6"></a><span class="st">    int&lt;lower=0&gt; T;</span></span>
<span id="cb88-7"><a href="#cb88-7"></a><span class="st">    vector[T] x;</span></span>
<span id="cb88-8"><a href="#cb88-8"></a><span class="st">    matrix[N,T] y;</span></span>
<span id="cb88-9"><a href="#cb88-9"></a><span class="st">    real xbar;</span></span>
<span id="cb88-10"><a href="#cb88-10"></a><span class="st">  }</span></span>
<span id="cb88-11"><a href="#cb88-11"></a><span class="st">  parameters {</span></span>
<span id="cb88-12"><a href="#cb88-12"></a><span class="st">    vector[N] alpha;</span></span>
<span id="cb88-13"><a href="#cb88-13"></a><span class="st">    vector[N] beta;</span></span>
<span id="cb88-14"><a href="#cb88-14"></a></span>
<span id="cb88-15"><a href="#cb88-15"></a><span class="st">    real alpha_c;</span></span>
<span id="cb88-16"><a href="#cb88-16"></a><span class="st">    real beta_c;          // beta.c in original bugs model</span></span>
<span id="cb88-17"><a href="#cb88-17"></a></span>
<span id="cb88-18"><a href="#cb88-18"></a><span class="st">    real&lt;lower=0&gt; tausq_c;</span></span>
<span id="cb88-19"><a href="#cb88-19"></a><span class="st">    real&lt;lower=0&gt; tausq_alpha;</span></span>
<span id="cb88-20"><a href="#cb88-20"></a><span class="st">    real&lt;lower=0&gt; tausq_beta;</span></span>
<span id="cb88-21"><a href="#cb88-21"></a><span class="st">  }</span></span>
<span id="cb88-22"><a href="#cb88-22"></a><span class="st">  transformed parameters {</span></span>
<span id="cb88-23"><a href="#cb88-23"></a><span class="st">    real&lt;lower=0&gt; tau_c;       // sigma in original bugs model</span></span>
<span id="cb88-24"><a href="#cb88-24"></a><span class="st">    real&lt;lower=0&gt; tau_alpha;</span></span>
<span id="cb88-25"><a href="#cb88-25"></a><span class="st">    real&lt;lower=0&gt; tau_beta;</span></span>
<span id="cb88-26"><a href="#cb88-26"></a></span>
<span id="cb88-27"><a href="#cb88-27"></a><span class="st">    tau_c = sqrt(tausq_c);</span></span>
<span id="cb88-28"><a href="#cb88-28"></a><span class="st">    tau_alpha = sqrt(tausq_alpha);</span></span>
<span id="cb88-29"><a href="#cb88-29"></a><span class="st">    tau_beta = sqrt(tausq_beta);</span></span>
<span id="cb88-30"><a href="#cb88-30"></a><span class="st">  }</span></span>
<span id="cb88-31"><a href="#cb88-31"></a><span class="st">  model {</span></span>
<span id="cb88-32"><a href="#cb88-32"></a><span class="st">    alpha_c ~ normal(0, 100);</span></span>
<span id="cb88-33"><a href="#cb88-33"></a><span class="st">    beta_c ~ normal(0, 100);</span></span>
<span id="cb88-34"><a href="#cb88-34"></a><span class="st">    tausq_c ~ inv_gamma(0.001, 0.001);</span></span>
<span id="cb88-35"><a href="#cb88-35"></a><span class="st">    tausq_alpha ~ inv_gamma(0.001, 0.001);</span></span>
<span id="cb88-36"><a href="#cb88-36"></a><span class="st">    tausq_beta ~ inv_gamma(0.001, 0.001);</span></span>
<span id="cb88-37"><a href="#cb88-37"></a><span class="st">    alpha ~ normal(alpha_c, tau_alpha); // vectorized</span></span>
<span id="cb88-38"><a href="#cb88-38"></a><span class="st">    beta ~ normal(beta_c, tau_beta);  // vectorized</span></span>
<span id="cb88-39"><a href="#cb88-39"></a><span class="st">    for (n in 1:N)</span></span>
<span id="cb88-40"><a href="#cb88-40"></a><span class="st">      for (t in 1:T)</span></span>
<span id="cb88-41"><a href="#cb88-41"></a><span class="st">        y[n,t] ~ normal(alpha[n] + beta[n] * (x[t] - xbar), tau_c);</span></span>
<span id="cb88-42"><a href="#cb88-42"></a><span class="st">  }</span></span>
<span id="cb88-43"><a href="#cb88-43"></a><span class="st">  generated quantities {</span></span>
<span id="cb88-44"><a href="#cb88-44"></a><span class="st">    real alpha0;</span></span>
<span id="cb88-45"><a href="#cb88-45"></a><span class="st">    alpha0 = alpha_c - xbar * beta_c;</span></span>
<span id="cb88-46"><a href="#cb88-46"></a><span class="st">  }</span></span>
<span id="cb88-47"><a href="#cb88-47"></a><span class="st">  "</span>,</span>
<span id="cb88-48"><a href="#cb88-48"></a>  <span class="at">data =</span> <span class="fu">list</span>(<span class="at">N =</span> N, <span class="at">T =</span> T, <span class="at">y =</span> y, <span class="at">x =</span> x, <span class="at">xbar =</span> xbar),</span>
<span id="cb88-49"><a href="#cb88-49"></a>  <span class="at">chains =</span> chains, <span class="at">init =</span> init, <span class="at">iter =</span> iter,   </span>
<span id="cb88-50"><a href="#cb88-50"></a>  <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">refresh =</span> <span class="dv">0</span>, <span class="at">seed =</span> <span class="dv">20190425</span></span>
<span id="cb88-51"><a href="#cb88-51"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>模型输出结果如下：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1"></a><span class="fu">print</span>(rats_fit, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>), <span class="at">include =</span> <span class="cn">FALSE</span>, <span class="at">digits =</span> <span class="dv">1</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Inference for Stan model: rats.
#&gt; 4 chains, each with iter=1000; warmup=500; thin=1; 
#&gt; post-warmup draws per chain=500, total post-warmup draws=2000.
#&gt; 
#&gt;               mean se_mean   sd   2.5%    25%    50%    75%  97.5% n_eff Rhat
#&gt; alpha_c      242.5     0.1  2.7  237.1  240.6  242.5  244.3  247.7  1728    1
#&gt; beta_c         6.2     0.0  0.1    6.0    6.1    6.2    6.3    6.4  2205    1
#&gt; tausq_c       37.0     0.2  5.8   27.6   32.9   36.4   40.6   50.0   947    1
#&gt; tausq_alpha  218.0     1.6 64.1  125.3  172.0  207.8  253.0  372.8  1703    1
#&gt; tausq_beta     0.3     0.0  0.1    0.1    0.2    0.3    0.3    0.5  1481    1
#&gt; tau_c          6.1     0.0  0.5    5.3    5.7    6.0    6.4    7.1   938    1
#&gt; tau_alpha     14.6     0.0  2.1   11.2   13.1   14.4   15.9   19.3  1826    1
#&gt; tau_beta       0.5     0.0  0.1    0.4    0.5    0.5    0.6    0.7  1429    1
#&gt; alpha0       106.3     0.1  3.6   99.5  103.9  106.4  108.8  113.2  1965    1
#&gt; lp__        -438.0     0.3  7.0 -452.8 -442.6 -437.4 -433.2 -425.4   558    1
#&gt; 
#&gt; Samples were drawn using NUTS(diag_e) at Wed Dec 20 12:25:53 2023.
#&gt; For each parameter, n_eff is a crude measure of effective sample size,
#&gt; and Rhat is the potential scale reduction factor on split chains (at 
#&gt; convergence, Rhat=1).</code></pre>
</div>
</div>
<p><code>alpha_c</code> 表示小鼠 5 次测量的平均重量，<code>beta_c</code> 表示小鼠体重的增长率，<span class="math inline">\(\alpha_i,\beta_i\)</span> 分别表示第 <span class="math inline">\(i\)</span> 只小鼠在第 22 天（第 3 次测量或 <span class="math inline">\(x_t = \bar{x}\)</span> ）的重量和增长率（每日增加的重量）。</p>
<p>对于分量众多的参数向量，比较适合用岭线图展示后验分布，下面调用 <strong>bayesplot</strong> 包绘制参数向量 <span class="math inline">\(\boldsymbol{\alpha},\boldsymbol{\beta}\)</span> 的后验分布。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1"></a><span class="co"># plot(rats_fit, pars = "alpha", show_density = TRUE, ci_level = 0.8, outer_level = 0.95)</span></span>
<span id="cb91-2"><a href="#cb91-2"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_areas_ridges</span>(rats_fit, <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">"alpha"</span>, <span class="st">"["</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>, <span class="st">"]"</span>)) <span class="sc">+</span></span>
<span id="cb91-3"><a href="#cb91-3"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">parse_format</span>()) </span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-rats-alpha" class="quarto-figure quarto-figure-center anchored" width="576">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-rats-alpha-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="hierarchical-normal-models_files/figure-html/fig-rats-alpha-1.png" class="img-fluid figure-img" width="576">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rats-alpha-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;35.8: 参数 <span class="math inline">\(\boldsymbol{\alpha}\)</span> 的后验分布
</figcaption></figure>
</div>
</div>
</div>
<p>参数向量 <span class="math inline">\(\boldsymbol{\alpha}\)</span> 的后验估计可以看作 <span class="math inline">\(x_t = \bar{x}\)</span> 时小鼠的重量，上图即为各个小鼠重量的后验分布。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1"></a><span class="co"># plot(rats_fit, pars = "beta", ci_level = 0.8, outer_level = 0.95)</span></span>
<span id="cb92-2"><a href="#cb92-2"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_areas_ridges</span>(rats_fit, <span class="at">pars =</span> <span class="fu">paste0</span>(<span class="st">"beta"</span>, <span class="st">"["</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>, <span class="st">"]"</span>)) <span class="sc">+</span></span>
<span id="cb92-3"><a href="#cb92-3"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">parse_format</span>()) </span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-rats-beta" class="quarto-figure quarto-figure-center anchored" width="576">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-rats-beta-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="hierarchical-normal-models_files/figure-html/fig-rats-beta-1.png" class="img-fluid figure-img" width="576">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rats-beta-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;35.9: 参数 <span class="math inline">\(\boldsymbol{\beta}\)</span> 的后验分布
</figcaption></figure>
</div>
</div>
</div>
<p>参数向量 <span class="math inline">\(\boldsymbol{\beta}\)</span> 的后验估计可以看作是小鼠的重量的增长率，上图即为各个小鼠重量的增长率的后验分布。</p>
</section><section id="cmdstanr-1" class="level3" data-number="35.5.2"><h3 data-number="35.5.2" class="anchored" data-anchor-id="cmdstanr-1">
<span class="header-section-number">35.5.2</span> cmdstanr</h3>
<p>从 rstan 包转 cmdstanr 包是非常容易的，只要语法兼容，模型代码可以原封不动。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb93-2"><a href="#cb93-2"></a>mod_rats <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(</span>
<span id="cb93-3"><a href="#cb93-3"></a>  <span class="at">stan_file =</span> <span class="st">"code/rats.stan"</span>,</span>
<span id="cb93-4"><a href="#cb93-4"></a>  <span class="at">compile =</span> <span class="cn">TRUE</span>, <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">TRUE</span>)</span>
<span id="cb93-5"><a href="#cb93-5"></a>)</span>
<span id="cb93-6"><a href="#cb93-6"></a>fit_rats <span class="ot">&lt;-</span> mod_rats<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb93-7"><a href="#cb93-7"></a>  <span class="at">data =</span> <span class="fu">list</span>(<span class="at">N =</span> N, <span class="at">T =</span> T, <span class="at">y =</span> y, <span class="at">x =</span> x, <span class="at">xbar =</span> xbar), <span class="co"># 数据</span></span>
<span id="cb93-8"><a href="#cb93-8"></a>  <span class="at">chains =</span> <span class="dv">2</span>,            <span class="co"># 总链条数</span></span>
<span id="cb93-9"><a href="#cb93-9"></a>  <span class="at">parallel_chains =</span> <span class="dv">2</span>,   <span class="co"># 并行数目</span></span>
<span id="cb93-10"><a href="#cb93-10"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>,    <span class="co"># 每条链预处理的迭代次数</span></span>
<span id="cb93-11"><a href="#cb93-11"></a>  <span class="at">iter_sampling =</span> <span class="dv">1000</span>,  <span class="co"># 每条链采样的迭代次数</span></span>
<span id="cb93-12"><a href="#cb93-12"></a>  <span class="at">threads_per_chain =</span> <span class="dv">2</span>, <span class="co"># 每条链设置 2 个线程</span></span>
<span id="cb93-13"><a href="#cb93-13"></a>  <span class="at">seed =</span> <span class="dv">20232023</span>,       <span class="co"># 随机数种子</span></span>
<span id="cb93-14"><a href="#cb93-14"></a>  <span class="at">show_messages =</span> <span class="cn">FALSE</span>, <span class="co"># 不显示消息</span></span>
<span id="cb93-15"><a href="#cb93-15"></a>  <span class="at">adapt_delta =</span> <span class="fl">0.9</span>,     <span class="co"># 接受率</span></span>
<span id="cb93-16"><a href="#cb93-16"></a>  <span class="at">refresh =</span> <span class="dv">0</span> <span class="co"># 不显示采样迭代的进度</span></span>
<span id="cb93-17"><a href="#cb93-17"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>模型输出</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1"></a><span class="co"># 显示除了参数 alpha 和 beta 以外的结果</span></span>
<span id="cb94-2"><a href="#cb94-2"></a>vars <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(fit_rats<span class="sc">$</span><span class="fu">metadata</span>()<span class="sc">$</span>stan_variables, <span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>))</span>
<span id="cb94-3"><a href="#cb94-3"></a>fit_rats<span class="sc">$</span><span class="fu">summary</span>(<span class="at">variables =</span> vars)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 10 × 10
#&gt;    variable       mean   median      sd     mad       q5      q95  rhat ess_bulk
#&gt;    &lt;chr&gt;         &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
#&gt;  1 lp__       -438.    -438.     6.87    6.83   -450.    -427.    1.01      586.
#&gt;  2 alpha_c     243.     242.     2.79    2.70    238.     247.    1.00     3528.
#&gt;  3 beta_c        6.18     6.18   0.106   0.107     6.01     6.36  1.00     3494.
#&gt;  4 tausq_c      37.4     36.8    5.57    5.49     28.9     47.1   1.00     1720.
#&gt;  5 tausq_alp…  217.     208.    63.5    57.7     134.     335.    1.00     3104.
#&gt;  6 tausq_beta    0.275    0.259  0.0975  0.0884    0.148    0.457 0.999    2070.
#&gt;  7 tau_c         6.10     6.07   0.451   0.453     5.38     6.86  1.00     1720.
#&gt;  8 tau_alpha    14.6     14.4    2.06    2.00     11.6     18.3   1.00     3104.
#&gt;  9 tau_beta      0.517    0.509  0.0896  0.0882    0.385    0.676 0.999    2070.
#&gt; 10 alpha0      106.     107.     3.63    3.68    100.     112.    0.999    3565.
#&gt; # ℹ 1 more variable: ess_tail &lt;dbl&gt;</code></pre>
</div>
</div>
<p>诊断信息</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1"></a>fit_rats<span class="sc">$</span><span class="fu">diagnostic_summary</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; $num_divergent
#&gt; [1] 0 0
#&gt; 
#&gt; $num_max_treedepth
#&gt; [1] 0 0
#&gt; 
#&gt; $ebfmi
#&gt; [1] 0.8995806 0.8828313</code></pre>
</div>
</div>
</section><section id="brms" class="level3" data-number="35.5.3"><h3 data-number="35.5.3" class="anchored" data-anchor-id="brms">
<span class="header-section-number">35.5.3</span> brms</h3>
<p><strong>brms</strong> 包是基于 <strong>rstan</strong> 包的，基于 Stan 语言做贝叶斯推断，提供与 lme4 包一致的公式语法，且扩展了模型种类。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1"></a>rats_brms <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">brm</span>(weight <span class="sc">~</span> days <span class="sc">+</span> (days <span class="sc">|</span> rats), <span class="at">data =</span> rats_data)</span>
<span id="cb98-2"><a href="#cb98-2"></a><span class="fu">summary</span>(rats_brms)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb99"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb99-1"><a href="#cb99-1"></a> Family: gaussian </span>
<span id="cb99-2"><a href="#cb99-2"></a>  Links: mu = identity; sigma = identity </span>
<span id="cb99-3"><a href="#cb99-3"></a>Formula: weight ~ days + (days | rats) </span>
<span id="cb99-4"><a href="#cb99-4"></a>   Data: rats_data (Number of observations: 150) </span>
<span id="cb99-5"><a href="#cb99-5"></a>  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span>
<span id="cb99-6"><a href="#cb99-6"></a>         total post-warmup draws = 4000</span>
<span id="cb99-7"><a href="#cb99-7"></a></span>
<span id="cb99-8"><a href="#cb99-8"></a>Group-Level Effects: </span>
<span id="cb99-9"><a href="#cb99-9"></a>~rats (Number of levels: 30) </span>
<span id="cb99-10"><a href="#cb99-10"></a>                    Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span>
<span id="cb99-11"><a href="#cb99-11"></a>sd(Intercept)          11.27      2.23     7.36    16.08 1.00     2172     2939</span>
<span id="cb99-12"><a href="#cb99-12"></a>sd(days)                0.54      0.09     0.37     0.74 1.00     1380     2356</span>
<span id="cb99-13"><a href="#cb99-13"></a>cor(Intercept,days)    -0.11      0.24    -0.53     0.39 1.00      920     1541</span>
<span id="cb99-14"><a href="#cb99-14"></a></span>
<span id="cb99-15"><a href="#cb99-15"></a>Population-Level Effects: </span>
<span id="cb99-16"><a href="#cb99-16"></a>          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span>
<span id="cb99-17"><a href="#cb99-17"></a>Intercept   106.47      2.47   101.61   111.23 1.00     2173     2768</span>
<span id="cb99-18"><a href="#cb99-18"></a>days          6.18      0.11     5.96     6.41 1.00     1617     2177</span>
<span id="cb99-19"><a href="#cb99-19"></a></span>
<span id="cb99-20"><a href="#cb99-20"></a>Family Specific Parameters: </span>
<span id="cb99-21"><a href="#cb99-21"></a>      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span>
<span id="cb99-22"><a href="#cb99-22"></a>sigma     6.15      0.47     5.30     7.14 1.00     1832     3151</span>
<span id="cb99-23"><a href="#cb99-23"></a></span>
<span id="cb99-24"><a href="#cb99-24"></a>Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span>
<span id="cb99-25"><a href="#cb99-25"></a>and Tail_ESS are effective sample size measures, and Rhat is the potential</span>
<span id="cb99-26"><a href="#cb99-26"></a>scale reduction factor on split chains (at convergence, Rhat = 1).</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section><section id="rstanarm" class="level3" data-number="35.5.4"><h3 data-number="35.5.4" class="anchored" data-anchor-id="rstanarm">
<span class="header-section-number">35.5.4</span> rstanarm</h3>
<p><strong>rstanarm</strong> 包与 <strong>brms</strong> 包类似，区别是前者预编译了 Stan 模型，后者根据输入数据和模型编译即时编译，此外，后者支持的模型范围更加广泛。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1"></a><span class="fu">library</span>(rstanarm)</span>
<span id="cb100-2"><a href="#cb100-2"></a>rats_rstanarm <span class="ot">&lt;-</span> <span class="fu">stan_lmer</span>(<span class="at">formula =</span> weight <span class="sc">~</span> days <span class="sc">+</span> (days <span class="sc">|</span> rats), <span class="at">data =</span> rats_data)</span>
<span id="cb100-3"><a href="#cb100-3"></a><span class="fu">summary</span>(rats_rstanarm)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb101"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb101-1"><a href="#cb101-1"></a><span class="an">Model Info:</span></span>
<span id="cb101-2"><a href="#cb101-2"></a> function:     stan_lmer</span>
<span id="cb101-3"><a href="#cb101-3"></a> family:       gaussian <span class="co">[</span><span class="ot">identity</span><span class="co">]</span></span>
<span id="cb101-4"><a href="#cb101-4"></a> formula:      weight ~ days + (days | rats)</span>
<span id="cb101-5"><a href="#cb101-5"></a> algorithm:    sampling</span>
<span id="cb101-6"><a href="#cb101-6"></a> sample:       4000 (posterior sample size)</span>
<span id="cb101-7"><a href="#cb101-7"></a> priors:       see help('prior_summary')</span>
<span id="cb101-8"><a href="#cb101-8"></a> observations: 150</span>
<span id="cb101-9"><a href="#cb101-9"></a> groups:       rats (30)</span>
<span id="cb101-10"><a href="#cb101-10"></a></span>
<span id="cb101-11"><a href="#cb101-11"></a>Estimates:</span>
<span id="cb101-12"><a href="#cb101-12"></a>                                      mean    sd      10%     50%     90%  </span>
<span id="cb101-13"><a href="#cb101-13"></a>(Intercept)                         106.575   2.236 103.789 106.559 109.415</span>
<span id="cb101-14"><a href="#cb101-14"></a>days                                  6.187   0.111   6.048   6.185   6.329</span>
<span id="cb101-15"><a href="#cb101-15"></a>sigma                                 6.219   0.497   5.626   6.183   6.862</span>
<span id="cb101-16"><a href="#cb101-16"></a>Sigma<span class="co">[</span><span class="ot">rats:(Intercept),(Intercept)</span><span class="co">]</span> 103.927  42.705  57.329  98.128 159.086</span>
<span id="cb101-17"><a href="#cb101-17"></a>Sigma<span class="co">[</span><span class="ot">rats:days,(Intercept)</span><span class="co">]</span>         -0.545   1.492  -2.361  -0.402   1.162</span>
<span id="cb101-18"><a href="#cb101-18"></a>Sigma<span class="co">[</span><span class="ot">rats:days,days</span><span class="co">]</span>                 0.304   0.112   0.181   0.285   0.445</span>
<span id="cb101-19"><a href="#cb101-19"></a></span>
<span id="cb101-20"><a href="#cb101-20"></a>MCMC diagnostics</span>
<span id="cb101-21"><a href="#cb101-21"></a>                                    mcse  Rhat  n_eff</span>
<span id="cb101-22"><a href="#cb101-22"></a>(Intercept)                         0.043 1.000 2753 </span>
<span id="cb101-23"><a href="#cb101-23"></a>days                                0.003 1.005 1694 </span>
<span id="cb101-24"><a href="#cb101-24"></a>sigma                               0.015 1.001 1172 </span>
<span id="cb101-25"><a href="#cb101-25"></a>Sigma<span class="co">[</span><span class="ot">rats:(Intercept),(Intercept)</span><span class="co">]</span> 1.140 1.000 1403 </span>
<span id="cb101-26"><a href="#cb101-26"></a>Sigma<span class="co">[</span><span class="ot">rats:days,(Intercept)</span><span class="co">]</span>        0.054 1.006  772 </span>
<span id="cb101-27"><a href="#cb101-27"></a>Sigma<span class="co">[</span><span class="ot">rats:days,days</span><span class="co">]</span>               0.003 1.000 1456 </span>
<span id="cb101-28"><a href="#cb101-28"></a></span>
<span id="cb101-29"><a href="#cb101-29"></a>For each parameter, mcse is Monte Carlo standard error, </span>
<span id="cb101-30"><a href="#cb101-30"></a>n_eff is a crude measure of effective sample size, </span>
<span id="cb101-31"><a href="#cb101-31"></a>and Rhat is the potential scale reduction factor </span>
<span id="cb101-32"><a href="#cb101-32"></a>on split chains (at convergence Rhat=1).</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>固定效应的部分，截距和斜率如下：</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb102-1"><a href="#cb102-1"></a><span class="an">Estimates:</span></span>
<span id="cb102-2"><a href="#cb102-2"></a><span class="co">                                      mean    sd      10%     50%     90%  </span></span>
<span id="cb102-3"><a href="#cb102-3"></a>(Intercept)                         106.575   2.236 103.789 106.559 109.415</span>
<span id="cb102-4"><a href="#cb102-4"></a>days                                  6.187   0.111   6.048   6.185   6.329</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>模型残差的标准差 sigma、随机效应 Sigma 的随机截距的方差 103.927 、随机斜率的方差 0.304 及其协方差 -0.545。</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb103-1"><a href="#cb103-1"></a>sigma                                 6.219   0.497   5.626   6.183   6.862</span>
<span id="cb103-2"><a href="#cb103-2"></a>Sigma<span class="co">[</span><span class="ot">rats:(Intercept),(Intercept)</span><span class="co">]</span> 103.927  42.705  57.329  98.128 159.086</span>
<span id="cb103-3"><a href="#cb103-3"></a>Sigma<span class="co">[</span><span class="ot">rats:days,(Intercept)</span><span class="co">]</span>         -0.545   1.492  -2.361  -0.402   1.162</span>
<span id="cb103-4"><a href="#cb103-4"></a>Sigma<span class="co">[</span><span class="ot">rats:days,days</span><span class="co">]</span>                 0.304   0.112   0.181   0.285   0.445</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>rstanarm</strong> 和 <strong>brms</strong> 包的结果基本一致的。</p>
</section><section id="blme-1" class="level3" data-number="35.5.5"><h3 data-number="35.5.5" class="anchored" data-anchor-id="blme-1">
<span class="header-section-number">35.5.5</span> blme</h3>
<p><strong>blme</strong> 包 <span class="citation" data-cites="Chung2013">(<a href="references.html#ref-Chung2013" role="doc-biblioref">Chung 等 2013</a>)</span> 基于 <strong>lme4</strong> 包 <span class="citation" data-cites="Bates2015">(<a href="references.html#ref-Bates2015" role="doc-biblioref">Bates 等 2015</a>)</span> 拟合贝叶斯线性混合效应模型。参考前面 <strong>rstan</strong> 小节中关于模型参数的先验设置，下面将残差方差的先验设置为逆伽马分布，随机效应的协方差设置为扁平分布。发现拟合结果和 <strong>nlme</strong> 和 <strong>lme4</strong> 包的几乎一样。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1"></a>rats_blme <span class="ot">&lt;-</span> blme<span class="sc">::</span><span class="fu">blmer</span>(</span>
<span id="cb104-2"><a href="#cb104-2"></a>  weight <span class="sc">~</span> days <span class="sc">+</span> (days <span class="sc">|</span> rats), <span class="at">data =</span> rats_data,</span>
<span id="cb104-3"><a href="#cb104-3"></a>  <span class="at">resid.prior =</span> invgamma, <span class="at">cov.prior =</span> <span class="cn">NULL</span></span>
<span id="cb104-4"><a href="#cb104-4"></a>)</span>
<span id="cb104-5"><a href="#cb104-5"></a><span class="fu">summary</span>(rats_blme)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Resid prior: invgamma(shape = 0, scale = 0, posterior.scale = var)
#&gt; Prior dev  : 7.1328
#&gt; 
#&gt; Linear mixed model fit by REML ['blmerMod']
#&gt; Formula: weight ~ days + (days | rats)
#&gt;    Data: rats_data
#&gt; 
#&gt; REML criterion at convergence: 1095.4
#&gt; 
#&gt; Scaled residuals: 
#&gt;     Min      1Q  Median      3Q     Max 
#&gt; -2.6697 -0.5440  0.1202  0.4968  2.6317 
#&gt; 
#&gt; Random effects:
#&gt;  Groups   Name        Variance Std.Dev. Corr 
#&gt;  rats     (Intercept) 116.3517 10.7866       
#&gt;           days          0.2623  0.5121  -0.16
#&gt;  Residual              35.3891  5.9489       
#&gt; Number of obs: 150, groups:  rats, 30
#&gt; 
#&gt; Fixed effects:
#&gt;             Estimate Std. Error t value
#&gt; (Intercept) 106.5676     2.2977   46.38
#&gt; days          6.1857     0.1056   58.58
#&gt; 
#&gt; Correlation of Fixed Effects:
#&gt;      (Intr)
#&gt; days -0.343</code></pre>
</div>
</div>
<p>与 <strong>lme4</strong> 包的函数 <code>lmer()</code> 所不同的是参数 <code>resid.prior</code> 、<code>fixef.prior</code> 和 <code>cov.prior</code> ，它们设置参数的先验分布，其它参数的含义同 <code>lme4</code> 包。<code>resid.prior = invgamma</code> 表示残差方差参数使用逆伽马分布，<code>cov.prior = NULL</code> 表示随机效应的协方差参数使用扁平先验 flat priors。</p>
</section><section id="rjags" class="level3" data-number="35.5.6"><h3 data-number="35.5.6" class="anchored" data-anchor-id="rjags">
<span class="header-section-number">35.5.6</span> rjags</h3>
<p><strong>rjags</strong> <span class="citation" data-cites="rjags">(<a href="references.html#ref-rjags" role="doc-biblioref">Plummer 2021</a>)</span> 是 JAGS 软件的 R 语言接口，可以拟合分层正态模型，再借助 <strong>coda 包</strong> <span class="citation" data-cites="coda2006">(<a href="references.html#ref-coda2006" role="doc-biblioref">Plummer 等 2006</a>)</span> 可以分析 JAGS 返回的各项数据。</p>
<p>JAGS 代码和 Stan 代码有不少相似之处，最大的共同点在于以直观的统计模型的符号表示编码模型，仿照 Stan 代码， JAGS 编码的模型（BUGS 代码）如下：</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode numberSource bugs number-lines code-with-copy"><code class="sourceCode"><span id="cb106-1"><a href="#cb106-1"></a>model {</span>
<span id="cb106-2"><a href="#cb106-2"></a>  alpha_c ~ dnorm(0, 1.0E-4);</span>
<span id="cb106-3"><a href="#cb106-3"></a>  beta_c ~ dnorm(0, 1.0E-4);</span>
<span id="cb106-4"><a href="#cb106-4"></a>  </span>
<span id="cb106-5"><a href="#cb106-5"></a>  tau_c ~ dgamma(0.001, 0.001);</span>
<span id="cb106-6"><a href="#cb106-6"></a>  tau_alpha ~ dgamma(0.001, 0.001);</span>
<span id="cb106-7"><a href="#cb106-7"></a>  tau_beta ~ dgamma(0.001, 0.001);</span>
<span id="cb106-8"><a href="#cb106-8"></a></span>
<span id="cb106-9"><a href="#cb106-9"></a>  sigma_c &lt;- 1.0 / sqrt(tau_c);</span>
<span id="cb106-10"><a href="#cb106-10"></a>  sigma_alpha &lt;- 1.0 / sqrt(tau_alpha);</span>
<span id="cb106-11"><a href="#cb106-11"></a>  sigma_beta &lt;- 1.0 / sqrt(tau_beta);</span>
<span id="cb106-12"><a href="#cb106-12"></a>  </span>
<span id="cb106-13"><a href="#cb106-13"></a>  for (n in 1:N){</span>
<span id="cb106-14"><a href="#cb106-14"></a>      alpha[n] ~ dnorm(alpha_c, tau_alpha); </span>
<span id="cb106-15"><a href="#cb106-15"></a>      beta[n] ~ dnorm(beta_c, tau_beta);</span>
<span id="cb106-16"><a href="#cb106-16"></a>    for (t in 1:T) {</span>
<span id="cb106-17"><a href="#cb106-17"></a>      y[n,t] ~ dnorm(alpha[n] + beta[n] * (x[t] - xbar), tau_c);</span>
<span id="cb106-18"><a href="#cb106-18"></a>    }</span>
<span id="cb106-19"><a href="#cb106-19"></a>  }</span>
<span id="cb106-20"><a href="#cb106-20"></a>}</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>转化主要集中在模型块，注意二者概率分布的名称以及参数含义对应关系，JAGS 使用 precision 而不是 standard deviation or variance，比如正态分布中的方差（标准偏差）被替换为其倒数。JAGS 可以省略类型声明（初始化模型时会补上），最后，JAGS 不支持 Stan 中的向量化操作，这种新特性是独特的。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1"></a><span class="fu">library</span>(rjags)</span>
<span id="cb107-2"><a href="#cb107-2"></a><span class="co"># 初始值</span></span>
<span id="cb107-3"><a href="#cb107-3"></a>rats_inits <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb107-4"><a href="#cb107-4"></a>  <span class="fu">list</span>(<span class="st">".RNG.name"</span> <span class="ot">=</span> <span class="st">"base::Marsaglia-Multicarry"</span>, </span>
<span id="cb107-5"><a href="#cb107-5"></a>       <span class="st">".RNG.seed"</span> <span class="ot">=</span> <span class="dv">20222022</span>, </span>
<span id="cb107-6"><a href="#cb107-6"></a>       <span class="st">"alpha_c"</span> <span class="ot">=</span> <span class="dv">100</span>, <span class="st">"beta_c"</span> <span class="ot">=</span> <span class="dv">6</span>, <span class="st">"tau_c"</span> <span class="ot">=</span> <span class="dv">5</span>, <span class="st">"tau_alpha"</span> <span class="ot">=</span> <span class="dv">10</span>, <span class="st">"tau_beta"</span> <span class="ot">=</span> <span class="fl">0.5</span>),</span>
<span id="cb107-7"><a href="#cb107-7"></a>  <span class="fu">list</span>(<span class="st">".RNG.name"</span> <span class="ot">=</span> <span class="st">"base::Marsaglia-Multicarry"</span>, </span>
<span id="cb107-8"><a href="#cb107-8"></a>       <span class="st">".RNG.seed"</span> <span class="ot">=</span> <span class="dv">20232023</span>, </span>
<span id="cb107-9"><a href="#cb107-9"></a>       <span class="st">"alpha_c"</span> <span class="ot">=</span> <span class="dv">200</span>, <span class="st">"beta_c"</span> <span class="ot">=</span> <span class="dv">10</span>, <span class="st">"tau_c"</span> <span class="ot">=</span> <span class="dv">15</span>, <span class="st">"tau_alpha"</span> <span class="ot">=</span> <span class="dv">15</span>, <span class="st">"tau_beta"</span> <span class="ot">=</span> <span class="dv">1</span>)</span>
<span id="cb107-10"><a href="#cb107-10"></a>)</span>
<span id="cb107-11"><a href="#cb107-11"></a><span class="co"># 模型</span></span>
<span id="cb107-12"><a href="#cb107-12"></a>rats_model <span class="ot">&lt;-</span> <span class="fu">jags.model</span>(</span>
<span id="cb107-13"><a href="#cb107-13"></a>  <span class="at">file =</span> <span class="st">"code/rats.bugs"</span>,</span>
<span id="cb107-14"><a href="#cb107-14"></a>  <span class="at">data =</span> <span class="fu">list</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">N =</span> <span class="dv">30</span>, <span class="at">T =</span> <span class="dv">5</span>, <span class="at">xbar =</span> <span class="fl">22.0</span>),</span>
<span id="cb107-15"><a href="#cb107-15"></a>  <span class="at">inits =</span> rats_inits, </span>
<span id="cb107-16"><a href="#cb107-16"></a>  <span class="at">n.chains =</span> <span class="dv">2</span>, <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb107-17"><a href="#cb107-17"></a>)</span>
<span id="cb107-18"><a href="#cb107-18"></a><span class="co"># burn-in</span></span>
<span id="cb107-19"><a href="#cb107-19"></a><span class="fu">update</span>(rats_model, <span class="at">n.iter =</span> <span class="dv">2000</span>)</span>
<span id="cb107-20"><a href="#cb107-20"></a><span class="co"># 抽样</span></span>
<span id="cb107-21"><a href="#cb107-21"></a>rats_samples <span class="ot">&lt;-</span> <span class="fu">coda.samples</span>(rats_model,</span>
<span id="cb107-22"><a href="#cb107-22"></a>  <span class="at">variable.names =</span> <span class="fu">c</span>(<span class="st">"alpha_c"</span>, <span class="st">"beta_c"</span>, <span class="st">"sigma_alpha"</span>, <span class="st">"sigma_beta"</span>, <span class="st">"sigma_c"</span>),</span>
<span id="cb107-23"><a href="#cb107-23"></a>  <span class="at">n.iter =</span> <span class="dv">4000</span>, <span class="at">thin =</span> <span class="dv">1</span></span>
<span id="cb107-24"><a href="#cb107-24"></a>)</span>
<span id="cb107-25"><a href="#cb107-25"></a><span class="co"># 参数的后验估计</span></span>
<span id="cb107-26"><a href="#cb107-26"></a><span class="fu">summary</span>(rats_samples)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Iterations = 2001:6000
#&gt; Thinning interval = 1 
#&gt; Number of chains = 2 
#&gt; Sample size per chain = 4000 
#&gt; 
#&gt; 1. Empirical mean and standard deviation for each variable,
#&gt;    plus standard error of the mean:
#&gt; 
#&gt;                 Mean      SD Naive SE Time-series SE
#&gt; alpha_c     242.4752 2.72749 0.030494       0.031571
#&gt; beta_c        6.1878 0.10798 0.001207       0.001481
#&gt; sigma_alpha  14.6233 2.05688 0.022997       0.025070
#&gt; sigma_beta    0.5176 0.09266 0.001036       0.001741
#&gt; sigma_c       6.0731 0.46425 0.005191       0.007984
#&gt; 
#&gt; 2. Quantiles for each variable:
#&gt; 
#&gt;                 2.5%      25%      50%      75%    97.5%
#&gt; alpha_c     237.0333 240.6832 242.5024 244.2965 247.7816
#&gt; beta_c        5.9785   6.1150   6.1867   6.2593   6.4035
#&gt; sigma_alpha  11.1840  13.1802  14.4152  15.8340  19.2429
#&gt; sigma_beta    0.3571   0.4538   0.5098   0.5734   0.7187
#&gt; sigma_c       5.2384   5.7479   6.0455   6.3803   7.0413</code></pre>
</div>
</div>
<p>输出结果与 rstan 十分一致，且采样速度极快。类似地，<code>alpha0 = alpha_c - xbar * beta_c</code> 可得 alpha0 = 242.4752 - 22 * 6.1878 = 106.3436。</p>
</section><section id="mcmcglmm-1" class="level3" data-number="35.5.7"><h3 data-number="35.5.7" class="anchored" data-anchor-id="mcmcglmm-1">
<span class="header-section-number">35.5.7</span> MCMCglmm</h3>
<p>同前，先考虑变截距的混合效应模型，<strong>MCMCglmm</strong> 包 <span class="citation" data-cites="Hadfield2010">(<a href="references.html#ref-Hadfield2010" role="doc-biblioref">Hadfield 2010</a>)</span> 给出的拟合结果与 <strong>nlme</strong> 包很接近。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1"></a><span class="do">## 变截距模型</span></span>
<span id="cb109-2"><a href="#cb109-2"></a>prior1 <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb109-3"><a href="#cb109-3"></a>  <span class="at">R =</span> <span class="fu">list</span>(<span class="at">V =</span> <span class="dv">1</span>, <span class="at">nu =</span> <span class="fl">0.002</span>),</span>
<span id="cb109-4"><a href="#cb109-4"></a>  <span class="at">G =</span> <span class="fu">list</span>(<span class="at">G1 =</span> <span class="fu">list</span>(<span class="at">V =</span> <span class="dv">1</span>, <span class="at">nu =</span> <span class="fl">0.002</span>))</span>
<span id="cb109-5"><a href="#cb109-5"></a>)</span>
<span id="cb109-6"><a href="#cb109-6"></a><span class="fu">set.seed</span>(<span class="dv">20232023</span>)</span>
<span id="cb109-7"><a href="#cb109-7"></a>rats_mcmc1 <span class="ot">&lt;-</span> MCMCglmm<span class="sc">::</span><span class="fu">MCMCglmm</span>(</span>
<span id="cb109-8"><a href="#cb109-8"></a>  weight <span class="sc">~</span> days, <span class="at">random =</span> <span class="sc">~</span> rats,</span>
<span id="cb109-9"><a href="#cb109-9"></a>  <span class="at">data =</span> rats_data, <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">prior =</span> prior1</span>
<span id="cb109-10"><a href="#cb109-10"></a>)</span>
<span id="cb109-11"><a href="#cb109-11"></a><span class="fu">summary</span>(rats_mcmc1)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt;  Iterations = 3001:12991
#&gt;  Thinning interval  = 10
#&gt;  Sample size  = 1000 
#&gt; 
#&gt;  DIC: 1088.71 
#&gt; 
#&gt;  G-structure:  ~rats
#&gt; 
#&gt;      post.mean l-95% CI u-95% CI eff.samp
#&gt; rats       213    108.4    336.4     1000
#&gt; 
#&gt;  R-structure:  ~units
#&gt; 
#&gt;       post.mean l-95% CI u-95% CI eff.samp
#&gt; units     68.58    50.63    86.58     1000
#&gt; 
#&gt;  Location effects: weight ~ days 
#&gt; 
#&gt;             post.mean l-95% CI u-95% CI eff.samp  pMCMC    
#&gt; (Intercept)   106.568  100.464  112.897     1000 &lt;0.001 ***
#&gt; days            6.185    6.051    6.315     1000 &lt;0.001 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>随机效应的方差（组间方差）为 211.4 ，则标准差为 14.539。残差方差（组内方差）为 68.77，则标准差为 8.293。</p>
<p>再考虑变截距和斜率的混合效应模型。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1"></a><span class="do">## 变截距、变斜率模型</span></span>
<span id="cb111-2"><a href="#cb111-2"></a>prior2 <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb111-3"><a href="#cb111-3"></a>  <span class="at">R =</span> <span class="fu">list</span>(<span class="at">V =</span> <span class="dv">1</span>, <span class="at">nu =</span> <span class="fl">0.002</span>),</span>
<span id="cb111-4"><a href="#cb111-4"></a>  <span class="at">G =</span> <span class="fu">list</span>(<span class="at">G1 =</span> <span class="fu">list</span>(<span class="at">V =</span> <span class="fu">diag</span>(<span class="dv">2</span>), <span class="at">nu =</span> <span class="fl">0.002</span>))</span>
<span id="cb111-5"><a href="#cb111-5"></a>)</span>
<span id="cb111-6"><a href="#cb111-6"></a><span class="fu">set.seed</span>(<span class="dv">20232023</span>)</span>
<span id="cb111-7"><a href="#cb111-7"></a>rats_mcmc2 <span class="ot">&lt;-</span> MCMCglmm<span class="sc">::</span><span class="fu">MCMCglmm</span>(weight <span class="sc">~</span> days,</span>
<span id="cb111-8"><a href="#cb111-8"></a>  <span class="at">random =</span> <span class="sc">~</span> <span class="fu">us</span>(<span class="dv">1</span> <span class="sc">+</span> days)<span class="sc">:</span>rats,</span>
<span id="cb111-9"><a href="#cb111-9"></a>  <span class="at">data =</span> rats_data, <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">prior =</span> prior2</span>
<span id="cb111-10"><a href="#cb111-10"></a>)</span>
<span id="cb111-11"><a href="#cb111-11"></a><span class="fu">summary</span>(rats_mcmc2)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt;  Iterations = 3001:12991
#&gt;  Thinning interval  = 10
#&gt;  Sample size  = 1000 
#&gt; 
#&gt;  DIC: 1018.746 
#&gt; 
#&gt;  G-structure:  ~us(1 + days):rats
#&gt; 
#&gt;                              post.mean l-95% CI u-95% CI eff.samp
#&gt; (Intercept):(Intercept).rats  124.1327  41.5313  226.059    847.2
#&gt; days:(Intercept).rats          -0.7457  -4.3090    2.571    896.6
#&gt; (Intercept):days.rats          -0.7457  -4.3090    2.571    896.6
#&gt; days:days.rats                  0.2783   0.1067    0.493    786.9
#&gt; 
#&gt;  R-structure:  ~units
#&gt; 
#&gt;       post.mean l-95% CI u-95% CI eff.samp
#&gt; units     38.14    27.07    51.08     1000
#&gt; 
#&gt;  Location effects: weight ~ days 
#&gt; 
#&gt;             post.mean l-95% CI u-95% CI eff.samp  pMCMC    
#&gt; (Intercept)    106.40   101.70   110.78    823.3 &lt;0.001 ***
#&gt; days             6.19     5.99     6.41    963.4 &lt;0.001 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>G-structure 代表随机效应部分，R-structure 代表残差效应部分，Location effects 代表固定效应部分。<strong>MCMCglmm</strong> 包的这套模型表示术语源自商业软件 <a href="https://vsni.co.uk/software/asreml">ASReml</a> 。</p>
<p>随机截距的方差为 124.1327，标准差为 11.1415，随机斜率的方差 0.2783，标准差为 0.5275，随机截距和随机斜率的协方差 -0.7457，相关系数为 -0.1268，这与 <strong>nlme</strong> 包结果很接近。</p>
</section><section id="inla" class="level3" data-number="35.5.8"><h3 data-number="35.5.8" class="anchored" data-anchor-id="inla">
<span class="header-section-number">35.5.8</span> INLA</h3>
<p>同前，先考虑变截距的混合效应模型。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1"></a><span class="fu">library</span>(INLA)</span>
<span id="cb113-2"><a href="#cb113-2"></a><span class="fu">inla.setOption</span>(<span class="at">short.summary =</span> <span class="cn">TRUE</span>)</span>
<span id="cb113-3"><a href="#cb113-3"></a><span class="co"># 数值稳定性考虑</span></span>
<span id="cb113-4"><a href="#cb113-4"></a>rats_data<span class="sc">$</span>weight <span class="ot">&lt;-</span> rats_data<span class="sc">$</span>weight <span class="sc">/</span> <span class="dv">400</span></span>
<span id="cb113-5"><a href="#cb113-5"></a><span class="co"># 变截距</span></span>
<span id="cb113-6"><a href="#cb113-6"></a>rats_inla1 <span class="ot">&lt;-</span> <span class="fu">inla</span>(weight <span class="sc">~</span> days <span class="sc">+</span> <span class="fu">f</span>(rats, <span class="at">model =</span> <span class="st">"iid"</span>, <span class="at">n =</span> <span class="dv">30</span>), </span>
<span id="cb113-7"><a href="#cb113-7"></a>                  <span class="at">family =</span> <span class="st">"gaussian"</span>, <span class="at">data =</span> rats_data)</span>
<span id="cb113-8"><a href="#cb113-8"></a><span class="co"># 输出结果</span></span>
<span id="cb113-9"><a href="#cb113-9"></a><span class="fu">summary</span>(rats_inla1)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Fixed effects:
#&gt;              mean    sd 0.025quant 0.5quant 0.975quant  mode kld
#&gt; (Intercept) 0.266 0.008      0.252    0.266      0.281 0.266   0
#&gt; days        0.015 0.000      0.015    0.015      0.016 0.015   0
#&gt; 
#&gt; Model hyperparameters:
#&gt;                                            mean     sd 0.025quant 0.5quant
#&gt; Precision for the Gaussian observations 2414.80 311.28    1852.68  2397.51
#&gt; Precision for rats                       888.43 244.92     495.43   858.84
#&gt;                                         0.975quant    mode
#&gt; Precision for the Gaussian observations    3076.02 2368.15
#&gt; Precision for rats                         1451.77  804.50
#&gt; 
#&gt;  is computed</code></pre>
</div>
</div>
<p>再考虑变截距和斜率的混合效应模型。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1"></a><span class="co"># https://inla.r-inla-download.org/r-inla.org/doc/latent/iid.pdf</span></span>
<span id="cb115-2"><a href="#cb115-2"></a><span class="co"># 二维高斯随机效应的先验为 Wishart prior</span></span>
<span id="cb115-3"><a href="#cb115-3"></a>rats_data<span class="sc">$</span>rats <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(rats_data<span class="sc">$</span>rats)</span>
<span id="cb115-4"><a href="#cb115-4"></a>rats_data<span class="sc">$</span>slopeid <span class="ot">&lt;-</span> <span class="dv">30</span> <span class="sc">+</span> rats_data<span class="sc">$</span>rats</span>
<span id="cb115-5"><a href="#cb115-5"></a><span class="co"># 变截距、变斜率</span></span>
<span id="cb115-6"><a href="#cb115-6"></a>rats_inla2 <span class="ot">&lt;-</span> <span class="fu">inla</span>(</span>
<span id="cb115-7"><a href="#cb115-7"></a>  weight <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> days <span class="sc">+</span> <span class="fu">f</span>(rats, <span class="at">model =</span> <span class="st">"iid2d"</span>, <span class="at">n =</span> <span class="dv">2</span> <span class="sc">*</span> <span class="dv">30</span>) <span class="sc">+</span> <span class="fu">f</span>(slopeid, days, <span class="at">copy =</span> <span class="st">"rats"</span>),</span>
<span id="cb115-8"><a href="#cb115-8"></a>  <span class="at">data =</span> rats_data, <span class="at">family =</span> <span class="st">"gaussian"</span></span>
<span id="cb115-9"><a href="#cb115-9"></a>)</span>
<span id="cb115-10"><a href="#cb115-10"></a><span class="co"># 输出结果</span></span>
<span id="cb115-11"><a href="#cb115-11"></a><span class="fu">summary</span>(rats_inla2)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Fixed effects:
#&gt;              mean    sd 0.025quant 0.5quant 0.975quant  mode kld
#&gt; (Intercept) 0.266 0.034       0.20    0.266      0.333 0.266   0
#&gt; days        0.015 0.033      -0.05    0.015      0.080 0.015   0
#&gt; 
#&gt; Model hyperparameters:
#&gt;                                             mean      sd 0.025quant 0.5quant
#&gt; Precision for the Gaussian observations 4522.630 666.544   3334.877 4480.318
#&gt; Precision for rats (component 1)          32.097   7.956     18.939   31.260
#&gt; Precision for rats (component 2)          33.234   8.227     19.603   32.377
#&gt; Rho1:2 for rats                           -0.001   0.172     -0.335   -0.001
#&gt;                                         0.975quant     mode
#&gt; Precision for the Gaussian observations   5952.954 4407.848
#&gt; Precision for rats (component 1)            50.051   29.769
#&gt; Precision for rats (component 2)            51.773   30.859
#&gt; Rho1:2 for rats                              0.334   -0.001
#&gt; 
#&gt;  is computed</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
警告
</div>
</div>
<div class="callout-body-container callout-body">
<p>对于变截距和斜率混合效应模型，还未完全弄清楚 INLA 包的输出结果。固定效应部分和残差部分都是和前面一致的，但不清楚随机效应的方差协方差矩阵的估计与 INLA 输出的对应关系。参考<a href="https://becarioprecario.bitbucket.io/inla-gitbook/index.html">《Bayesian inference with INLA》</a>第 3 章第 3 小节。</p>
</div>
</div>
</section></section><section id="sec-hierarchical-normal-models-summary" class="level2" data-number="35.6"><h2 data-number="35.6" class="anchored" data-anchor-id="sec-hierarchical-normal-models-summary">
<span class="header-section-number">35.6</span> 总结</h2>
<p>基于 rats 数据建立变截距、变斜率的分层正态模型，也是线性混合效应模型的一种特殊情况，下表给出不同方法对模型各个参数的估计及置信区间。</p>
<div id="tbl-rats-freqentist-compare" class="anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-rats-freqentist-compare-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表格&nbsp;35.2: 频率派方法比较
</figcaption><div aria-describedby="tbl-rats-freqentist-compare-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table">
<colgroup>
<col style="width: 20%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
</colgroup>
<thead><tr class="header">
<th></th>
<th><span class="math inline">\(\beta_0\)</span></th>
<th><span class="math inline">\(\beta_1\)</span></th>
<th><span class="math inline">\(\sigma_0\)</span></th>
<th><span class="math inline">\(\sigma_1\)</span></th>
<th><span class="math inline">\(\rho_{\sigma}\)</span></th>
<th><span class="math inline">\(\sigma_{\epsilon}\)</span></th>
</tr></thead>
<tbody>
<tr class="odd">
<td>nlme (REML)</td>
<td>106.568</td>
<td>6.186</td>
<td>10.743</td>
<td>0.511</td>
<td>-0.159</td>
<td>6.015</td>
</tr>
<tr class="even">
<td>lme4 (REML)</td>
<td>106.568</td>
<td>6.186</td>
<td>10.744</td>
<td>0.511</td>
<td>-0.16</td>
<td>6.015</td>
</tr>
<tr class="odd">
<td>glmmTMB (REML)</td>
<td>106.568</td>
<td>6.186</td>
<td>10.743</td>
<td>0.511</td>
<td>-0.16</td>
<td>6.015</td>
</tr>
<tr class="even">
<td>MASS (PQL)</td>
<td>106.568</td>
<td>6.186</td>
<td>10.495</td>
<td>0.500</td>
<td>-0.15</td>
<td>6.015</td>
</tr>
<tr class="odd">
<td>spaMM (ML)</td>
<td>106.568</td>
<td>6.186</td>
<td>10.49</td>
<td>0.499</td>
<td>-0.15</td>
<td>6.015</td>
</tr>
<tr class="even">
<td>hglm</td>
<td>106.568</td>
<td>6.186</td>
<td>10.171</td>
<td>0.491</td>
<td>-</td>
<td>6.091</td>
</tr>
<tr class="odd">
<td>mgcv (REML)</td>
<td>106.568</td>
<td>6.186</td>
<td>10.311</td>
<td>0.492</td>
<td>-</td>
<td>6.069</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>表中给出截距 <span class="math inline">\(\beta_0\)</span> 、斜率 <span class="math inline">\(\beta_1\)</span> 、随机截距 <span class="math inline">\(\sigma_0\)</span>、随机斜率 <span class="math inline">\(\sigma_1\)</span>、随机截距和斜率的相关系数 <span class="math inline">\(\rho_{\sigma}\)</span>、残差 <span class="math inline">\(\sigma_{\epsilon}\)</span> 等参数的估计及 95% 的置信区间，四舍五入保留 3 位小数。固定效应部分的结果完全相同，随机效应部分略有不同。</p>
<div id="tbl-rats-bayesian-compare" class="anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-rats-bayesian-compare-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表格&nbsp;35.3: 贝叶斯方法比较
</figcaption><div aria-describedby="tbl-rats-bayesian-compare-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table">
<colgroup>
<col style="width: 20%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
</colgroup>
<thead><tr class="header">
<th></th>
<th><span class="math inline">\(\beta_0\)</span></th>
<th><span class="math inline">\(\beta_1\)</span></th>
<th><span class="math inline">\(\sigma_0\)</span></th>
<th><span class="math inline">\(\sigma_1\)</span></th>
<th><span class="math inline">\(\rho_{\sigma}\)</span></th>
<th><span class="math inline">\(\sigma_{\epsilon}\)</span></th>
</tr></thead>
<tbody>
<tr class="odd">
<td>rstan (NUTS)</td>
<td>106.4</td>
<td>6.2</td>
<td>14.6</td>
<td>0.5</td>
<td>-</td>
<td>6.1</td>
</tr>
<tr class="even">
<td>cmdstanr (NUTS)</td>
<td>106</td>
<td>6.19</td>
<td>14.5</td>
<td>0.513</td>
<td>-</td>
<td>6.09</td>
</tr>
<tr class="odd">
<td>brms (NUTS)</td>
<td>106.47</td>
<td>6.18</td>
<td>11.27</td>
<td>0.54</td>
<td>-0.11</td>
<td>6.15</td>
</tr>
<tr class="even">
<td>rstanarm (NUTS)</td>
<td>106.575</td>
<td>6.187</td>
<td>10.194</td>
<td>0.551</td>
<td>-0.0969</td>
<td>6.219</td>
</tr>
<tr class="odd">
<td>blme (REML)</td>
<td>106.568</td>
<td>6.186</td>
<td>10.787</td>
<td>0.512</td>
<td>-0.160</td>
<td>5.949</td>
</tr>
<tr class="even">
<td>rjags (Gibbs)</td>
<td>106.344</td>
<td>6.188</td>
<td>14.623</td>
<td>0.518</td>
<td>-</td>
<td>6.073</td>
</tr>
<tr class="odd">
<td>MCMCglmm (MCMC)</td>
<td>106.40</td>
<td>6.19</td>
<td>11.14</td>
<td>0.53</td>
<td>-0.13</td>
<td>6.18</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>其中，<strong>INLA</strong> 结果的转化未完成，表格中暂缺。<strong>rstan</strong> 、 <strong>cmdstanr</strong> 和 <strong>rjags</strong> 未考虑随机截距和随机斜率的相关性，因此，相关系数暂缺。MCMC 是一种随机优化算法，在不同的实现中，可重复性的要求不同，设置随机数种子仅是其中的一个必要条件，故而，每次运行程序结果可能略微不同，但不影响结论。Stan 相关的 R 包输出结果中，<strong>rstan</strong> 保留 1 位小数，<strong>cmdstanr</strong> 保留 3 位有效数字，<strong>brms</strong> 保留 2 位小数，<strong>rstanarm</strong> 小数点后保留 3 位有效数字，各不相同，暂未统一处理。</p>
</section><section id="sec-hierarchical-models-exercises" class="level2" data-number="35.7"><h2 data-number="35.7" class="anchored" data-anchor-id="sec-hierarchical-models-exercises">
<span class="header-section-number">35.7</span> 习题</h2>
<ol type="1">
<li>
<p>四个组的重复测量数据，如下表所示，建立贝叶斯线性混合效应模型/分层正态模型分析数据，与 nlme 包拟合的结果对比。</p>
<div class="cell">
<div id="tbl-exer" class="cell anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-exer-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表格&nbsp;35.4: 实验数据
</figcaption><div aria-describedby="tbl-exer-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="cell table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: right;">编号</th>
<th style="text-align: right;">第1组</th>
<th style="text-align: right;">第2组</th>
<th style="text-align: right;">第3组</th>
<th style="text-align: right;">第4组</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">62</td>
<td style="text-align: right;">63</td>
<td style="text-align: right;">68</td>
<td style="text-align: right;">56</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">60</td>
<td style="text-align: right;">67</td>
<td style="text-align: right;">66</td>
<td style="text-align: right;">62</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">63</td>
<td style="text-align: right;">71</td>
<td style="text-align: right;">71</td>
<td style="text-align: right;">60</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">59</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">67</td>
<td style="text-align: right;">61</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;"></td>
<td style="text-align: right;">65</td>
<td style="text-align: right;">68</td>
<td style="text-align: right;">63</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;"></td>
<td style="text-align: right;">66</td>
<td style="text-align: right;">68</td>
<td style="text-align: right;">64</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;">63</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td style="text-align: right;">59</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p><span class="math display">\[
\begin{aligned}
y_{ij}   \sim \mathcal{N}(\theta_i, \sigma^2) &amp;\quad
\theta_i \sim \mathcal{N}(\mu, \tau^2) \\
(\mu,\log \sigma, \tau) &amp;\sim \mathrm{uniform\ prior} \\
i = 1,2,3,4 &amp;\quad j = 1,2, \ldots, n_i
\end{aligned}
\]</span></p>
<p><span class="math inline">\(y_{ij}\)</span> 表示第 <span class="math inline">\(i\)</span> 组的第 <span class="math inline">\(j\)</span> 个测量值，<span class="math inline">\(\theta_i\)</span> 表示第 <span class="math inline">\(i\)</span> 组的均值，<span class="math inline">\(\mu\)</span> 表示整体的均值，<span class="math inline">\(\sigma^2\)</span> 表示组内的方差，<span class="math inline">\(\tau^2\)</span> 表示组内的方差。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1"></a><span class="fu">library</span>(nlme)</span>
<span id="cb117-2"><a href="#cb117-2"></a>fit_lme <span class="ot">&lt;-</span> <span class="fu">lme</span>(<span class="at">data =</span> dat, <span class="at">fixed =</span> y <span class="sc">~</span> <span class="dv">1</span>, <span class="at">random =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> group)</span>
<span id="cb117-3"><a href="#cb117-3"></a><span class="fu">summary</span>(fit_lme)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Linear mixed-effects model fit by REML
#&gt;   Data: dat 
#&gt;        AIC      BIC    logLik
#&gt;   121.7804 125.1869 -57.89019
#&gt; 
#&gt; Random effects:
#&gt;  Formula: ~1 | group
#&gt;         (Intercept) Residual
#&gt; StdDev:    3.419288 2.366309
#&gt; 
#&gt; Fixed effects:  y ~ 1 
#&gt;                Value Std.Error DF  t-value p-value
#&gt; (Intercept) 64.01266  1.780313 20 35.95584       0
#&gt; 
#&gt; Standardized Within-Group Residuals:
#&gt;         Min          Q1         Med          Q3         Max 
#&gt; -2.18490896 -0.59921167  0.09332131  0.54077636  2.17507789 
#&gt; 
#&gt; Number of Observations: 24
#&gt; Number of Groups: 4</code></pre>
</div>
</div>
<p>随机效应（组间标准差）<span class="math inline">\(\tau^2\)</span> 3.419288 、残差效应（组内标准差）<span class="math inline">\(\sigma^2\)</span> 2.366309。截距 <span class="math inline">\(\mu\)</span> 64.01266 代表整体的均值。各组的均值如下：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1"></a><span class="fl">64.01266</span> <span class="sc">+</span> <span class="fu">ranef</span>(fit_lme)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;   (Intercept)
#&gt; 1    61.32214
#&gt; 2    65.85309
#&gt; 3    67.70525
#&gt; 4    61.17016</code></pre>
</div>
</div>
<p>也可以调用 <strong>rjags</strong> 包连接 JAGS 软件做贝叶斯推理，JAGS 代码如下：</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode numberSource bugs number-lines code-with-copy"><code class="sourceCode"><span id="cb121-1"><a href="#cb121-1"></a>model {</span>
<span id="cb121-2"><a href="#cb121-2"></a>  ## specify the distribution for observations</span>
<span id="cb121-3"><a href="#cb121-3"></a>  for(i in 1:n){</span>
<span id="cb121-4"><a href="#cb121-4"></a>    y[i] ~ dnorm(theta[group[i]], 1/sigma2)</span>
<span id="cb121-5"><a href="#cb121-5"></a>  }</span>
<span id="cb121-6"><a href="#cb121-6"></a></span>
<span id="cb121-7"><a href="#cb121-7"></a>  ## specify the prior for theta</span>
<span id="cb121-8"><a href="#cb121-8"></a>  for(j in 1:J){</span>
<span id="cb121-9"><a href="#cb121-9"></a>    theta[j] ~ dnorm(mu, 1/tau2)</span>
<span id="cb121-10"><a href="#cb121-10"></a>  }</span>
<span id="cb121-11"><a href="#cb121-11"></a></span>
<span id="cb121-12"><a href="#cb121-12"></a>  ## specify the prior for hyperparameters</span>
<span id="cb121-13"><a href="#cb121-13"></a>  mu ~ dunif(55, 75)</span>
<span id="cb121-14"><a href="#cb121-14"></a></span>
<span id="cb121-15"><a href="#cb121-15"></a>  log_sigma ~ dunif(-10, 3)</span>
<span id="cb121-16"><a href="#cb121-16"></a>  sigma2 &lt;- exp(2*log_sigma)</span>
<span id="cb121-17"><a href="#cb121-17"></a>  sigma &lt;- exp(log_sigma)</span>
<span id="cb121-18"><a href="#cb121-18"></a></span>
<span id="cb121-19"><a href="#cb121-19"></a>  tau ~ dunif(0, 8)</span>
<span id="cb121-20"><a href="#cb121-20"></a>  tau2 &lt;- pow(tau, 2)</span>
<span id="cb121-21"><a href="#cb121-21"></a>}</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>完整的运行代码如下：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1"></a><span class="fu">library</span>(rjags)</span>
<span id="cb122-2"><a href="#cb122-2"></a><span class="co"># 参考值</span></span>
<span id="cb122-3"><a href="#cb122-3"></a>mu_a <span class="ot">&lt;-</span> <span class="fu">min</span>(y)</span>
<span id="cb122-4"><a href="#cb122-4"></a>mu_b <span class="ot">&lt;-</span> <span class="fu">max</span>(y)</span>
<span id="cb122-5"><a href="#cb122-5"></a>log_sigma_b <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">log</span>(<span class="fu">sd</span>(y))</span>
<span id="cb122-6"><a href="#cb122-6"></a>tau_b <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">sd</span>(y)</span>
<span id="cb122-7"><a href="#cb122-7"></a></span>
<span id="cb122-8"><a href="#cb122-8"></a>J <span class="ot">&lt;-</span> <span class="dv">4</span>            <span class="co"># 4 个组</span></span>
<span id="cb122-9"><a href="#cb122-9"></a>n <span class="ot">&lt;-</span> <span class="fu">length</span>(y)    <span class="co"># 观察值数量</span></span>
<span id="cb122-10"><a href="#cb122-10"></a>N <span class="ot">&lt;-</span> <span class="dv">1500</span>         <span class="co"># 总采样数</span></span>
<span id="cb122-11"><a href="#cb122-11"></a>nthin <span class="ot">&lt;-</span> <span class="dv">1</span>        <span class="co"># 采样间隔</span></span>
<span id="cb122-12"><a href="#cb122-12"></a>nchains <span class="ot">&lt;-</span> <span class="dv">2</span>      <span class="co"># 2 条链</span></span>
<span id="cb122-13"><a href="#cb122-13"></a>ndiscard <span class="ot">&lt;-</span> N <span class="sc">/</span> <span class="dv">2</span> <span class="co"># 预处理阶段 warm-up / burn-in</span></span>
<span id="cb122-14"><a href="#cb122-14"></a></span>
<span id="cb122-15"><a href="#cb122-15"></a><span class="co"># 初始值</span></span>
<span id="cb122-16"><a href="#cb122-16"></a>jags_inits <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb122-17"><a href="#cb122-17"></a>  <span class="fu">list</span>(<span class="st">".RNG.name"</span> <span class="ot">=</span> <span class="st">"base::Marsaglia-Multicarry"</span>, </span>
<span id="cb122-18"><a href="#cb122-18"></a>       <span class="st">".RNG.seed"</span> <span class="ot">=</span> <span class="dv">20222022</span>, </span>
<span id="cb122-19"><a href="#cb122-19"></a>       <span class="st">"theta"</span> <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">3</span>, <span class="dv">4</span>), <span class="st">"mu"</span> <span class="ot">=</span> <span class="dv">60</span>, <span class="st">"log_sigma"</span> <span class="ot">=</span> <span class="dv">0</span>, <span class="st">"tau"</span> <span class="ot">=</span> <span class="fl">1.5</span>),</span>
<span id="cb122-20"><a href="#cb122-20"></a>  <span class="fu">list</span>(<span class="st">".RNG.name"</span> <span class="ot">=</span> <span class="st">"base::Marsaglia-Multicarry"</span>, </span>
<span id="cb122-21"><a href="#cb122-21"></a>       <span class="st">".RNG.seed"</span> <span class="ot">=</span> <span class="dv">20232023</span>, </span>
<span id="cb122-22"><a href="#cb122-22"></a>       <span class="st">"theta"</span> <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">2</span>, <span class="dv">4</span>), <span class="st">"mu"</span> <span class="ot">=</span> <span class="dv">60</span>, <span class="st">"log_sigma"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"tau"</span> <span class="ot">=</span> <span class="fl">0.375</span>)</span>
<span id="cb122-23"><a href="#cb122-23"></a>)</span>
<span id="cb122-24"><a href="#cb122-24"></a><span class="co"># Call JAGS from R</span></span>
<span id="cb122-25"><a href="#cb122-25"></a>jags_model <span class="ot">&lt;-</span> <span class="fu">jags.model</span>(</span>
<span id="cb122-26"><a href="#cb122-26"></a>  <span class="at">file =</span> <span class="st">"code/hnm.bugs"</span>,</span>
<span id="cb122-27"><a href="#cb122-27"></a>  <span class="at">data =</span> <span class="fu">list</span>(<span class="st">"y"</span> <span class="ot">=</span> y, <span class="st">"group"</span> <span class="ot">=</span> group, <span class="st">"J"</span> <span class="ot">=</span> J, <span class="st">"n"</span> <span class="ot">=</span> n),</span>
<span id="cb122-28"><a href="#cb122-28"></a>  <span class="at">inits =</span> jags_inits, <span class="at">n.chains =</span> nchains, <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb122-29"><a href="#cb122-29"></a>)</span>
<span id="cb122-30"><a href="#cb122-30"></a><span class="co"># burn-in</span></span>
<span id="cb122-31"><a href="#cb122-31"></a><span class="fu">update</span>(jags_model, <span class="at">n.iter =</span> ndiscard)</span>
<span id="cb122-32"><a href="#cb122-32"></a><span class="co"># 抽样</span></span>
<span id="cb122-33"><a href="#cb122-33"></a>jags_samples <span class="ot">&lt;-</span> <span class="fu">coda.samples</span>(jags_model,</span>
<span id="cb122-34"><a href="#cb122-34"></a>  <span class="at">variable.names =</span> <span class="fu">c</span>(<span class="st">'theta'</span>,<span class="st">'mu'</span>,<span class="st">'sigma'</span>,<span class="st">'tau'</span>), <span class="at">n.iter =</span> N</span>
<span id="cb122-35"><a href="#cb122-35"></a>)</span>
<span id="cb122-36"><a href="#cb122-36"></a><span class="co"># 参数的后验估计</span></span>
<span id="cb122-37"><a href="#cb122-37"></a><span class="fu">summary</span>(jags_samples)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Iterations = 1751:3250
#&gt; Thinning interval = 1 
#&gt; Number of chains = 2 
#&gt; Sample size per chain = 1500 
#&gt; 
#&gt; 1. Empirical mean and standard deviation for each variable,
#&gt;    plus standard error of the mean:
#&gt; 
#&gt;            Mean     SD Naive SE Time-series SE
#&gt; mu       64.142 2.3470  0.04285        0.05879
#&gt; sigma     2.473 0.4278  0.00781        0.01117
#&gt; tau       4.372 1.5995  0.02920        0.05101
#&gt; theta[1] 61.356 1.2301  0.02246        0.02503
#&gt; theta[2] 65.877 1.0056  0.01836        0.01928
#&gt; theta[3] 67.696 1.0247  0.01871        0.02119
#&gt; theta[4] 61.186 0.8694  0.01587        0.01692
#&gt; 
#&gt; 2. Quantiles for each variable:
#&gt; 
#&gt;            2.5%    25%    50%    75%  97.5%
#&gt; mu       59.145 62.700 64.167 65.510 69.027
#&gt; sigma     1.795  2.165  2.424  2.718  3.471
#&gt; tau       1.846  3.128  4.171  5.464  7.652
#&gt; theta[1] 58.947 60.545 61.342 62.161 63.771
#&gt; theta[2] 63.866 65.228 65.878 66.548 67.872
#&gt; theta[3] 65.665 67.046 67.712 68.337 69.692
#&gt; theta[4] 59.446 60.632 61.189 61.707 62.975</code></pre>
</div>
</div>
</li>
<li>
<p>基于 <strong>lme4</strong> 包中学生对老师的评价数据 <code>InstEval</code> 建立（广义）线性混合效应模型分析数据。将响应变量（学生评价）视为有序的离散型变量，比较观察两个模型拟合效果（lme4、GLMMadaptive、spaMM 都不支持有序的响应变量，brms 则支持各类有序回归，使用语法与 lme4 完全一样。但是，由于数据规模比较大，计算时间数以天计，可考虑用 Stan 直接编码）。再者，从 Stan 实现的贝叶斯模型来看，感受 Stan 建模的灵活性和扩展性。（<strong>nlme</strong> 包不支持此等交叉随机效应的表达。）</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1"></a><span class="fu">data</span>(InstEval, <span class="at">package =</span> <span class="st">"lme4"</span>)</span>
<span id="cb124-2"><a href="#cb124-2"></a><span class="fu">str</span>(InstEval)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 'data.frame':    73421 obs. of  7 variables:
#&gt;  $ s      : Factor w/ 2972 levels "1","2","3","4",..: 1 1 1 1 2 2 3 3 3 3 ...
#&gt;  $ d      : Factor w/ 1128 levels "1","6","7","8",..: 525 560 832 1068 62 406 3 6 19 75 ...
#&gt;  $ studage: Ord.factor w/ 4 levels "2"&lt;"4"&lt;"6"&lt;"8": 1 1 1 1 1 1 1 1 1 1 ...
#&gt;  $ lectage: Ord.factor w/ 6 levels "1"&lt;"2"&lt;"3"&lt;"4"&lt;..: 2 1 2 2 1 1 1 1 1 1 ...
#&gt;  $ service: Factor w/ 2 levels "0","1": 1 2 1 2 1 1 2 1 1 1 ...
#&gt;  $ dept   : Factor w/ 14 levels "15","5","10",..: 14 5 14 12 2 2 13 3 3 3 ...
#&gt;  $ y      : int  5 2 5 3 2 4 4 5 5 4 ...</code></pre>
</div>
</div>
<ul>
<li>因子型变量 <code>s</code> 表示 1-2972 位参与评分的学生。</li>
<li>因子型变量 <code>d</code> 表示 1-2160 位上课的讲师。</li>
<li>因子型变量 <code>dept</code> 表示课程相关的 1-15 院系。</li>
<li>因子型变量 <code>service</code> 表示讲师除了授课外，是否承担其它服务。</li>
<li>数值型变量 <code>y</code> 表示学生给课程的评分，1-5 分对应从坏到很好。</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1"></a><span class="co"># 数值型的响应变量</span></span>
<span id="cb126-2"><a href="#cb126-2"></a>fit_lme4 <span class="ot">&lt;-</span> lme4<span class="sc">::</span><span class="fu">lmer</span>(y <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> service <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> s) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> d) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> dept), <span class="at">data =</span> InstEval)</span>
<span id="cb126-3"><a href="#cb126-3"></a><span class="fu">summary</span>(fit_lme4)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Linear mixed model fit by REML ['lmerMod']
#&gt; Formula: y ~ 1 + service + (1 | s) + (1 | d) + (1 | dept)
#&gt;    Data: InstEval
#&gt; 
#&gt; REML criterion at convergence: 237733.8
#&gt; 
#&gt; Scaled residuals: 
#&gt;     Min      1Q  Median      3Q     Max 
#&gt; -3.0597 -0.7478  0.0404  0.7723  3.1988 
#&gt; 
#&gt; Random effects:
#&gt;  Groups   Name        Variance Std.Dev.
#&gt;  s        (Intercept) 0.105998 0.32557 
#&gt;  d        (Intercept) 0.265219 0.51499 
#&gt;  dept     (Intercept) 0.006912 0.08314 
#&gt;  Residual             1.386501 1.17750 
#&gt; Number of obs: 73421, groups:  s, 2972; d, 1128; dept, 14
#&gt; 
#&gt; Fixed effects:
#&gt;             Estimate Std. Error t value
#&gt; (Intercept)  3.28259    0.02935 111.860
#&gt; service1    -0.09264    0.01339  -6.919
#&gt; 
#&gt; Correlation of Fixed Effects:
#&gt;          (Intr)
#&gt; service1 -0.152</code></pre>
</div>
</div>
<p><strong>lme4</strong> 包不支持响应变量为有序分类变量的情形，可用 <strong>ordinal</strong> 包，此等规模数据，拟合模型需要 5-10 分钟时间。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1"></a><span class="co"># 有序因子型的响应变量</span></span>
<span id="cb128-2"><a href="#cb128-2"></a>InstEval<span class="sc">$</span>y <span class="ot">&lt;-</span> <span class="fu">factor</span>(InstEval<span class="sc">$</span>y, <span class="at">ordered =</span> <span class="cn">TRUE</span>)</span>
<span id="cb128-3"><a href="#cb128-3"></a><span class="fu">library</span>(ordinal)</span>
<span id="cb128-4"><a href="#cb128-4"></a>fit_ordinal <span class="ot">&lt;-</span> <span class="fu">clmm</span>(</span>
<span id="cb128-5"><a href="#cb128-5"></a>  y <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> service <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> s) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> d) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> dept),</span>
<span id="cb128-6"><a href="#cb128-6"></a>  <span class="at">data =</span> InstEval, <span class="at">link =</span> <span class="st">"probit"</span>, <span class="at">threshold =</span> <span class="st">"equidistant"</span></span>
<span id="cb128-7"><a href="#cb128-7"></a>)</span>
<span id="cb128-8"><a href="#cb128-8"></a><span class="fu">summary</span>(fit_ordinal)</span>
<span id="cb128-9"><a href="#cb128-9"></a></span>
<span id="cb128-10"><a href="#cb128-10"></a><span class="do">## MCMCglmm</span></span>
<span id="cb128-11"><a href="#cb128-11"></a><span class="fu">library</span>(MCMCglmm)</span>
<span id="cb128-12"><a href="#cb128-12"></a>prior2 <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb128-13"><a href="#cb128-13"></a>  <span class="at">R =</span> <span class="fu">list</span>(<span class="at">V =</span> <span class="dv">1</span>, <span class="at">nu =</span> <span class="fl">0.002</span>),</span>
<span id="cb128-14"><a href="#cb128-14"></a>  <span class="at">G =</span> <span class="fu">list</span>(</span>
<span id="cb128-15"><a href="#cb128-15"></a>    <span class="at">G1 =</span> <span class="fu">list</span>(<span class="at">V =</span> <span class="dv">1</span>, <span class="at">nu =</span> <span class="fl">0.002</span>),</span>
<span id="cb128-16"><a href="#cb128-16"></a>    <span class="at">G2 =</span> <span class="fu">list</span>(<span class="at">V =</span> <span class="dv">1</span>, <span class="at">nu =</span> <span class="fl">0.002</span>),</span>
<span id="cb128-17"><a href="#cb128-17"></a>    <span class="at">G3 =</span> <span class="fu">list</span>(<span class="at">V =</span> <span class="dv">1</span>, <span class="at">nu =</span> <span class="fl">0.002</span>)</span>
<span id="cb128-18"><a href="#cb128-18"></a>  )</span>
<span id="cb128-19"><a href="#cb128-19"></a>)</span>
<span id="cb128-20"><a href="#cb128-20"></a><span class="co"># 响应变量视为数值变量</span></span>
<span id="cb128-21"><a href="#cb128-21"></a>fit_mcmc2 <span class="ot">&lt;-</span> <span class="fu">MCMCglmm</span>(</span>
<span id="cb128-22"><a href="#cb128-22"></a>  y <span class="sc">~</span> service, <span class="at">random =</span> <span class="sc">~</span> s <span class="sc">+</span> d <span class="sc">+</span> dept, <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb128-23"><a href="#cb128-23"></a>  <span class="at">data =</span> InstEval, <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">prior =</span> prior2</span>
<span id="cb128-24"><a href="#cb128-24"></a>)</span>
<span id="cb128-25"><a href="#cb128-25"></a><span class="co"># 响应变量视为有序的分类变量</span></span>
<span id="cb128-26"><a href="#cb128-26"></a>fit_mcmc3 <span class="ot">&lt;-</span> <span class="fu">MCMCglmm</span>(</span>
<span id="cb128-27"><a href="#cb128-27"></a>  y <span class="sc">~</span> service, <span class="at">random =</span> <span class="sc">~</span> s <span class="sc">+</span> d <span class="sc">+</span> dept, <span class="at">family =</span> <span class="st">"ordinal"</span>,</span>
<span id="cb128-28"><a href="#cb128-28"></a>  <span class="at">data =</span> InstEval, <span class="at">verbose =</span> <span class="cn">FALSE</span>, <span class="at">prior =</span> prior2</span>
<span id="cb128-29"><a href="#cb128-29"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>当数据量较大时，<strong>MCMCglmm</strong> 包拟合模型需要很长时间，放弃，此时，Stan 的相对优势可以体现出来了。Stan 适合大型复杂概率统计模型。</p>
</li>
</ol>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-Bates2015" class="csl-entry" role="listitem">
Bates, Douglas, Martin Mächler, Ben Bolker, 和 Steve Walker. 2015. <span>《Fitting Linear Mixed-Effects Models Using <span>lme4</span>》</span>. <em>Journal of Statistical Software</em> 67 (1): 1–48. <a href="https://doi.org/10.18637/jss.v067.i01">https://doi.org/10.18637/jss.v067.i01</a>.
</div>
<div id="ref-Chung2013" class="csl-entry" role="listitem">
Chung, Yeojin, Sophia Rabe-Hesketh, Vincent Dorie, Andrew Gelman, 和 Jingchen Liu. 2013. <span>《A nondegenerate penalized likelihood estimator for variance parameters in multilevel models》</span>. <em>Psychometrika</em> 78 (4): 685–709. <a href="https://doi.org/10.1007/s11336-013-9328-2">https://doi.org/10.1007/s11336-013-9328-2</a>.
</div>
<div id="ref-gelfand1990" class="csl-entry" role="listitem">
Gelfand, Alan E., Susan E. Hills, Amy Racine-Poon, 和 Adrian F. M. Smith. 1990. <span>《Illustration of Bayesian Inference in Normal Data Models Using Gibbs Sampling》</span>. <em>Journal of the American Statistical Association</em> 85 (412): 972–85. <a href="https://doi.org/10.2307/2289594">https://doi.org/10.2307/2289594</a>.
</div>
<div id="ref-Hadfield2010" class="csl-entry" role="listitem">
Hadfield, Jarrod D. 2010. <span>《<span>MCMC</span> Methods for Multi-Response Generalized Linear Mixed Models: The <span>MCMCglmm</span> <span>R</span> Package》</span>. <em>Journal of Statistical Software</em> 33 (2): 1–22. <a href="https://www.jstatsoft.org/v33/i02/">https://www.jstatsoft.org/v33/i02/</a>.
</div>
<div id="ref-rjags" class="csl-entry" role="listitem">
Plummer, Martyn. 2021. <em><span>rjags</span>: Bayesian Graphical Models using <span>MCMC</span></em>. <a href="https://CRAN.R-project.org/package=rjags">https://CRAN.R-project.org/package=rjags</a>.
</div>
<div id="ref-coda2006" class="csl-entry" role="listitem">
Plummer, Martyn, Nicky Best, Kate Cowles, 和 Karen Vines. 2006. <span>《<span>coda</span>: Convergence Diagnosis and Output Analysis for <span>MCMC</span>》</span>. <em>R News</em> 6 (1): 7–11. <a href="https://journal.r-project.org/archive/">https://journal.r-project.org/archive/</a>.
</div>
<div id="ref-rönnegård2010" class="csl-entry" role="listitem">
Rönnegård, Lars, Xia Shen, 和 Moudud Alam. 2010. <span>《<span>hglm</span>: A Package for Fitting Hierarchical Generalized Linear Models》</span>. <em>The R Journal</em> 2 (2): 20–28. <a href="https://doi.org/10.32614/RJ-2010-009">https://doi.org/10.32614/RJ-2010-009</a>.
</div>
<div id="ref-Rosseel2012" class="csl-entry" role="listitem">
Rosseel, Yves. 2012. <span>《<span>lavaan</span>: An <span>R</span> Package for Structural Equation Modeling》</span>. <em>Journal of Statistical Software</em> 48 (2): 1–36. <a href="https://doi.org/10.18637/jss.v048.i02">https://doi.org/10.18637/jss.v048.i02</a>.
</div>
<div id="ref-Rubin1981" class="csl-entry" role="listitem">
Rubin, Donald B. 1981. <span>《Estimation in Parallel Randomized Experiments》</span>. <em>Journal of Educational Statistics</em> 6 (4): 377–401. <a href="https://doi.org/10.3102/10769986006004377">https://doi.org/10.3102/10769986006004377</a>.
</div>
<div id="ref-sorensen2016" class="csl-entry" role="listitem">
Sorensen, Tanner, Sven Hohenstein, 和 Shravan Vasishth. 2016. <span>《Bayesian linear mixed models using Stan: A tutorial for psychologists, linguists, and cognitive scientists》</span>. <em>The Quantitative Methods for Psychology</em> 12 (3): 175–200. <a href="https://doi.org/10.20982/tqmp.12.3.p175">https://doi.org/10.20982/tqmp.12.3.p175</a>.
</div>
</div>
</section><aside id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><hr>
<ol>
<li id="fn1"><p><a href="https://stat.ethz.ch/pipermail/r-help/2013-May/354311.html" class="uri">https://stat.ethz.ch/pipermail/r-help/2013-May/354311.html</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol></aside></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "已复制");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "已复制");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./generalized-linear-models.html" class="pagination-link  aria-label=">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">广义线性模型</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./mixed-effects-models.html" class="pagination-link" aria-label="<span class='chapter-number'>36</span>&nbsp; <span class='chapter-title'>混合效应模型</span>">
        <span class="nav-page-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">混合效应模型</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/XiangyunHuang/data-analysis-in-action/blob/main/hierarchical-normal-models.qmd" class="toc-action"><i class="bi bi-github"></i>查看代码</a></li></ul></div></div></div></footer></body></html>