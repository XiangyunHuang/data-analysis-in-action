# 统计模拟 {#sec-statistical-simulation}

<!-- 
1. 重抽样法
1. 自助法
1. MCMC 方法
-->
 
## 泊松回归模型 {#sec-poisson-cmdstanr}

先介绍泊松广义线性模型，包括模拟和计算，并和 Stan 实现的结果比较。

泊松广义线性模型如下：

$$
\begin{aligned}
\log(\lambda) &= \beta_0 + \beta_1 x_1 + \beta_2 x_2 \\
Y &\sim \mathrm{Poisson}(u\lambda)
\end{aligned}
$$

设定参数向量 $\beta = (\beta_0, \beta_1, \beta_2) = (0.5, 0.3, 0.2)$，观测变量 $X_1$ 和 $X_2$ 的均值都为0，协方差矩阵 $\Sigma$ 为

$$
\left[
 \begin{matrix}
   1.0 & 0.8  \\
   0.8 & 1.0 
 \end{matrix}
\right]
$$

模拟观测到的响应变量值和协变量值，添加漂移项

```{r}
set.seed(2023)
n <- 2500 # 样本量
beta <- c(0.5, 0.3, 0.2)
X <- MASS::mvrnorm(n, mu = rep(0, 2), Sigma = matrix(c(1, 0.8, 0.8, 1), 2))
u <- rep(c(2, 4), each = n / 2)
lambda <- u * exp(cbind(1, X) %*% beta)
y <- rpois(n, lambda = lambda)
# 拟合泊松回归模型
fit_poisson_glm <- glm(y ~ X, family = poisson(link = "log"), offset = log(u))
summary(fit_poisson_glm)
```

```{r}
# 对数似然函数值
log_poission_lik <- logLik(fit_poisson_glm)
# 计算 AIC AIC(fit_poisson_glm)
-2 * c(log_poission_lik) + 2 * attr(log_poission_lik, "df")
```

::: {.callout-tip}
对于常见的统计模型，**brms** 包[@brms2017]都内置了预编译的 Stan 程序，下面用 **brms** 包的函数 `brm()` 拟合带上述漂移项的泊松广义线性模型，参数估计结果和 Base R 函数 `glm()` 的几乎一致，因编译和抽样的过程比较花费时间，速度不及 Base R。

```r
# brms
dat <- data.frame(y = y, X = X, u = u)
colnames(dat) <- c("y", "x1", "x2", "u")
fit_poisson_brm <- brms::brm(y ~ x1 + x2 + offset(log(u)),
  data = dat, family = poisson(link = "log"),
)
fit_poisson_brm
```
```
 Family: poisson 
  Links: mu = log 
Formula: y ~ x1 + x2 + offset(log(u)) 
   Data: dat (Number of observations: 2500) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Population-Level Effects: 
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     0.49      0.01     0.47     0.51 1.00     2509     2171
x1            0.29      0.01     0.26     0.32 1.00     1771     1645
x2            0.21      0.01     0.19     0.24 1.00     1727     1847

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).
```
```r
loo::loo(fit_poisson_brm)
```
```
Computed from 4000 by 2500 log-likelihood matrix

         Estimate   SE
elpd_loo  -5386.3 37.8
p_loo         2.9  0.1
looic     10772.6 75.5
------
Monte Carlo SE of elpd_loo is 0.0.

All Pareto k estimates are good (k < 0.5).
See help('pareto-k-diagnostic') for details.
```

looic 指标的作用类似 AIC 指标，所以也几乎相同的。
:::



## 泊松过程回归模型 {#sec-poisson-process-regression}

下面继续增加复杂度，在泊松型广义线性模型中添加一个二维的高斯随机过程 $\mathcal{S}$ 作为随机效应，具体地，如果 $D$ 代表二维平面坐标，则该模型为泊松型空间广义线性混合效应模型，见 @eq-poisson-sglmm 。

$$
\begin{aligned}
\log(\lambda(\bm{d})) &= X\boldsymbol{\beta} + S(\bm{d})\\
Y(\bm{d}) &\sim \mathrm{Poisson}(u(\bm{d})\lambda(\bm{d}))
\end{aligned}
$$ {#eq-poisson-sglmm}

其中，$S(\bm{d}) = \big(S(d_1), S(d_2), \cdots,S(d_N)\big)$ 是随机过程 $\mathcal{S}$ 的一个具体实现，代表一个随机向量。记 $S_i = S(d_i)$ 表示位置 $d_i$ 处的随机效应，是一个随机变量。响应变量 $Y(\bm{d})$ 、漂移项 $u(\bm{d})$ 和强度 $\lambda(\bm{d})$ 都是和位置 $\bm{d}$ 相关的，$\boldsymbol{\beta}$ 是 $k \times 1$ 维的回归向量。通常情况下，位置 $\bm{d}$ 表示一对一对的二维坐标，也可以是三维的。随机过程 $S(\bm{d})$ 服从均值函数为 0，自协方差函数为 $R(h)$ 的二维平稳空间高斯过程，简单起见，自协方差函数为幂二次指数型，如下：

$$
\begin{aligned}
R(h;\sigma^2,\phi) &= \mathsf{Cov}\big(S(d_i), S(d_j)\big) \\
     &= \sigma^2\exp(-||d_i - d_j||_2 / \phi) \\
     &= \sigma^2\exp(-h^2 / \phi)
\end{aligned}
$$

其中 $h$ 表示位置 $d_i$ 与 $d_j$ 之间的距离，常用的距离度量是欧氏距离。另一个常用的自协方差函数为 Matern 型，带有 3 个参数，如下：

$$
R(h;\sigma^2,\phi,\kappa) = \sigma^2 \frac{(h/\phi)^{\kappa}\mathcal{K}_{\kappa}(h/\phi)}{2^{\kappa-1}\Gamma(\kappa)}
$$

其中 $\mathcal{K}$ 表示贝塞尔函数，$\kappa$ 常取 0.5。

下面设定一组参数，从模型 @eq-poisson-sglmm 模拟一组数据，绘制真实的观测图，然后调用 Stan 拟合模型，将真实参数和估计的结果比较，再预测重构观测图。

