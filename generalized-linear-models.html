<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-Hans" xml:lang="zh-Hans"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>R 语言数据分析实战 - 34&nbsp; 广义线性模型</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./hierarchical-normal-models.html" rel="next">
<link href="./probabilistic-reasoning-framework.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "没有结果",
    "search-matching-documents-text": "匹配的文档",
    "search-copy-link-title": "复制搜索链接",
    "search-hide-matches-text": "隐藏其它匹配结果",
    "search-more-match-text": "更多匹配结果",
    "search-more-matches-text": "更多匹配结果",
    "search-clear-button-title": "清除",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "取消",
    "search-submit-button-title": "提交",
    "search-label": "搜索"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-ZPWJBMKFL8"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-ZPWJBMKFL8', { 'anonymize_ip': true});
</script><script>
MathJax ={
  tex: {
    macros: {
      bm: ["{\\boldsymbol #1}",1],
    }
  }
};
</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="切换侧边栏导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./probabilistic-reasoning-framework.html">贝叶斯建模</a></li><li class="breadcrumb-item"><a href="./generalized-linear-models.html"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">广义线性模型</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="切换侧边栏导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R 语言数据分析实战</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/XiangyunHuang/data-analysis-in-action" title="源代码" class="quarto-navigation-tool px-1" aria-label="源代码"><i class="bi bi-github"></i></a>
    <a href="./_main.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="切换深色模式"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="搜索"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">欢迎</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">前言</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">介绍</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">数据准备</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling-objects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">数据对象</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling-collection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">数据获取</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling-cleaning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">数据清洗</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling-manipulation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">数据操作</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling-processing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">数据处理</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">数据探索</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-basic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">ggplot2 入门</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-intermediate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">基础图形</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-advanced.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">统计图形</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-lattice.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">lattice 入门</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-graphics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">graphics 入门</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-tikz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">TikZ 入门</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-practice.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">探索实践</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">数据交流</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interactive-graphics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">交互图形</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interactive-tables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">交互表格</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interactive-applications.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">交互应用</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./documents-html.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">HTML 文档</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./documents-latex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">PDF 文档</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./documents-office.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Office 文档</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">统计分析</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./common-statistical-tests.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">常见的统计检验</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regression-and-correlation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">回归与相关分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./categorical-data-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">分类数据的分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./power-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">统计检验的功效</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">数据建模</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-network-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">网络数据分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-text-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">文本数据分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-survival-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">生存数据分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-time-series-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">时序数据分析</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">空间分析</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-point-pattern.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">点模式数据分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-spatial-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">点参考数据分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-areal-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">区域数据分析</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
 <span class="menu-text">优化建模</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./statistical-computation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">统计计算</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./numerical-optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">数值优化</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./optimization-problems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">优化问题</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true">
 <span class="menu-text">贝叶斯建模</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./probabilistic-reasoning-framework.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">概率推理框架</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./generalized-linear-models.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">广义线性模型</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hierarchical-normal-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">分层正态模型</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mixed-effects-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">混合效应模型</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./generalized-additive-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">广义可加模型</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gaussian-processes-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">高斯过程回归</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./time-series-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">时间序列回归</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true">
 <span class="menu-text">机器学习</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./classification-problems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">分类问题</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./clustering-problems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">聚类问题</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regression-problems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">回归问题</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">参考文献</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" aria-expanded="true">
 <span class="menu-text">附录</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./notations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">数学符号</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./matrix-operations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">矩阵运算</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./git-github.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Git 和 Github</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">目录</h2>
   
  <ul>
<li><a href="#sec-simulate-poisson-data" id="toc-sec-simulate-poisson-data" class="nav-link active" data-scroll-target="#sec-simulate-poisson-data"><span class="header-section-number">34.1</span> 生成模拟数据</a></li>
  <li><a href="#sec-poisson-model" id="toc-sec-poisson-model" class="nav-link" data-scroll-target="#sec-poisson-model"><span class="header-section-number">34.2</span> 拟合泊松模型</a></li>
  <li><a href="#sec-posterior-distribution" id="toc-sec-posterior-distribution" class="nav-link" data-scroll-target="#sec-posterior-distribution"><span class="header-section-number">34.3</span> 参数后验分布</a></li>
  <li><a href="#sec-model-evaluation" id="toc-sec-model-evaluation" class="nav-link" data-scroll-target="#sec-model-evaluation"><span class="header-section-number">34.4</span> 模型评估指标</a></li>
  <li><a href="#sec-bayesian-brms" id="toc-sec-bayesian-brms" class="nav-link" data-scroll-target="#sec-bayesian-brms"><span class="header-section-number">34.5</span> 可选替代实现</a></li>
  <li>
<a href="#sec-esoph" id="toc-sec-esoph" class="nav-link" data-scroll-target="#sec-esoph"><span class="header-section-number">34.6</span> 案例：吸烟喝酒和食道癌的关系</a>
  <ul class="collapse">
<li><a href="#%E6%8F%8F%E8%BF%B0%E5%88%86%E6%9E%90" id="toc-描述分析" class="nav-link" data-scroll-target="#%E6%8F%8F%E8%BF%B0%E5%88%86%E6%9E%90"><span class="header-section-number">34.6.1</span> 描述分析</a></li>
  <li><a href="#%E6%8B%9F%E5%90%88%E6%A8%A1%E5%9E%8B" id="toc-拟合模型" class="nav-link" data-scroll-target="#%E6%8B%9F%E5%90%88%E6%A8%A1%E5%9E%8B"><span class="header-section-number">34.6.2</span> 拟合模型</a></li>
  <li><a href="#%E4%B8%8E-brms-%E6%AF%94%E8%BE%83" id="toc-与-brms-比较" class="nav-link" data-scroll-target="#%E4%B8%8E-brms-%E6%AF%94%E8%BE%83"><span class="header-section-number">34.6.3</span> 与 brms 比较</a></li>
  </ul>
</li>
  <li><a href="#%E6%A1%88%E4%BE%8B%E5%93%A5%E6%9C%AC%E5%93%88%E6%A0%B9%E4%BD%8F%E6%88%BF%E7%8A%B6%E5%86%B5%E8%B0%83%E6%9F%A5" id="toc-案例哥本哈根住房状况调查" class="nav-link" data-scroll-target="#%E6%A1%88%E4%BE%8B%E5%93%A5%E6%9C%AC%E5%93%88%E6%A0%B9%E4%BD%8F%E6%88%BF%E7%8A%B6%E5%86%B5%E8%B0%83%E6%9F%A5"><span class="header-section-number">34.7</span> 案例：哥本哈根住房状况调查</a></li>
  <li><a href="#sec-bayesian-exercises" id="toc-sec-bayesian-exercises" class="nav-link" data-scroll-target="#sec-bayesian-exercises"><span class="header-section-number">34.8</span> 习题</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/XiangyunHuang/data-analysis-in-action/blob/main/generalized-linear-models.qmd" class="toc-action"><i class="bi bi-github"></i>查看代码</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./probabilistic-reasoning-framework.html">贝叶斯建模</a></li><li class="breadcrumb-item"><a href="./generalized-linear-models.html"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">广义线性模型</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title"><span id="sec-generalized-linear-models" class="quarto-section-identifier"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">广义线性模型</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="sec-simulate-poisson-data" class="level2" data-number="34.1"><h2 data-number="34.1" class="anchored" data-anchor-id="sec-simulate-poisson-data">
<span class="header-section-number">34.1</span> 生成模拟数据</h2>
<p>先介绍泊松广义线性模型，包括模拟和计算，并和 Stan 实现的结果比较。</p>
<p>泊松广义线性模型如下：</p>
<p><span class="math display">\[
\begin{aligned}
\log(\lambda) &amp;= \beta_0 + \beta_1 x_1 + \beta_2 x_2 \\
Y &amp;\sim \mathrm{Poisson}(u\lambda)
\end{aligned}
\]</span></p>
<p>设定参数向量 <span class="math inline">\(\beta = (\beta_0, \beta_1, \beta_2) = (0.5, 0.3, 0.2)\)</span>，观测变量 <span class="math inline">\(X_1\)</span> 和 <span class="math inline">\(X_2\)</span> 的均值都为 0，协方差矩阵 <span class="math inline">\(\Sigma\)</span> 为</p>
<p><span class="math display">\[
\left[
\begin{matrix}
   1.0 &amp; 0.8  \\
   0.8 &amp; 1.0
\end{matrix}
\right]
\]</span></p>
<p>模拟观测到的响应变量值和协变量值，添加漂移项</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">set.seed</span>(<span class="dv">2023</span>)</span>
<span id="cb1-2"><a href="#cb1-2"></a>n <span class="ot">&lt;-</span> <span class="dv">2500</span> <span class="co"># 样本量</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>beta <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.3</span>, <span class="fl">0.2</span>)</span>
<span id="cb1-4"><a href="#cb1-4"></a>X <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(n, <span class="at">mu =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">2</span>), <span class="at">Sigma =</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.8</span>, <span class="fl">0.8</span>, <span class="dv">1</span>), <span class="dv">2</span>))</span>
<span id="cb1-5"><a href="#cb1-5"></a>u <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>), <span class="at">each =</span> n <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb1-6"><a href="#cb1-6"></a>lambda <span class="ot">&lt;-</span> u <span class="sc">*</span> <span class="fu">exp</span>(<span class="fu">cbind</span>(<span class="dv">1</span>, X) <span class="sc">%*%</span> beta)</span>
<span id="cb1-7"><a href="#cb1-7"></a>y <span class="ot">&lt;-</span> <span class="fu">rpois</span>(n, <span class="at">lambda =</span> lambda)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="sec-poisson-model" class="level2" data-number="34.2"><h2 data-number="34.2" class="anchored" data-anchor-id="sec-poisson-model">
<span class="header-section-number">34.2</span> 拟合泊松模型</h2>
<p>拟合泊松回归模型</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>fit_poisson_glm <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> X, <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>), <span class="at">offset =</span> <span class="fu">log</span>(u))</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="fu">summary</span>(fit_poisson_glm)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Call:
#&gt; glm(formula = y ~ X, family = poisson(link = "log"), offset = log(u))
#&gt; 
#&gt; Coefficients:
#&gt;             Estimate Std. Error z value Pr(&gt;|z|)    
#&gt; (Intercept) 0.488932   0.009427   51.86   &lt;2e-16 ***
#&gt; X1          0.289984   0.014298   20.28   &lt;2e-16 ***
#&gt; X2          0.214846   0.014420   14.90   &lt;2e-16 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt; (Dispersion parameter for poisson family taken to be 1)
#&gt; 
#&gt;     Null deviance: 6052.9  on 2499  degrees of freedom
#&gt; Residual deviance: 2675.5  on 2497  degrees of freedom
#&gt; AIC: 10773
#&gt; 
#&gt; Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># 对数似然函数值</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>log_poisson_lik <span class="ot">&lt;-</span> <span class="fu">logLik</span>(fit_poisson_glm)</span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co"># 计算 AIC AIC(fit_poisson_glm)</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="sc">-</span><span class="dv">2</span> <span class="sc">*</span> <span class="fu">c</span>(log_poisson_lik) <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">attr</span>(log_poisson_lik, <span class="st">"df"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 10772.79</code></pre>
</div>
</div>
<p>下面用 Stan 编码泊松回归模型，模型代码如下：</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">data</span> {</span>
<span id="cb6-2"><a href="#cb6-2"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; k;</span>
<span id="cb6-3"><a href="#cb6-3"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; n;</span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="dt">matrix</span>[n, k] X;</span>
<span id="cb6-5"><a href="#cb6-5"></a>  <span class="dt">array</span>[n] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; y;</span>
<span id="cb6-6"><a href="#cb6-6"></a>  <span class="dt">vector</span>[n] log_offset;</span>
<span id="cb6-7"><a href="#cb6-7"></a>}</span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="kw">parameters</span> {</span>
<span id="cb6-9"><a href="#cb6-9"></a>  <span class="dt">vector</span>[k] beta;</span>
<span id="cb6-10"><a href="#cb6-10"></a>  <span class="dt">real</span> alpha;</span>
<span id="cb6-11"><a href="#cb6-11"></a>}</span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="kw">model</span> {</span>
<span id="cb6-13"><a href="#cb6-13"></a>  <span class="kw">target +=</span> std_normal_lpdf(beta);</span>
<span id="cb6-14"><a href="#cb6-14"></a>  <span class="kw">target +=</span> std_normal_lpdf(alpha);</span>
<span id="cb6-15"><a href="#cb6-15"></a>  <span class="kw">target +=</span> poisson_log_glm_lpmf(y | X, alpha + log_offset, beta);</span>
<span id="cb6-16"><a href="#cb6-16"></a>}</span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="kw">generated quantities</span> {</span>
<span id="cb6-18"><a href="#cb6-18"></a>  <span class="dt">vector</span>[n] log_lik; <span class="co">// pointwise log-likelihood for LOO</span></span>
<span id="cb6-19"><a href="#cb6-19"></a>  <span class="dt">vector</span>[n] y_rep;   <span class="co">// replications from posterior predictive dist</span></span>
<span id="cb6-20"><a href="#cb6-20"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span> : n) {</span>
<span id="cb6-21"><a href="#cb6-21"></a>    <span class="dt">real</span> y_hat_i = alpha + X[i] * beta + log_offset[i];</span>
<span id="cb6-22"><a href="#cb6-22"></a>    log_lik[i] = poisson_log_lpmf(y[i] | y_hat_i);</span>
<span id="cb6-23"><a href="#cb6-23"></a>    y_rep[i] = poisson_log_rng(y_hat_i);</span>
<span id="cb6-24"><a href="#cb6-24"></a>  }</span>
<span id="cb6-25"><a href="#cb6-25"></a>}</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Stan 代码主要分三部分：</p>
<ol type="1">
<li><p>数据部分 <code>data</code>：声明模型的输入数据，数据类型、大小、约束。</p></li>
<li><p>参数部分 <code>parameters</code>：类似数据部分，声明模型的参数，参数类型、大小。</p></li>
<li><p>模型部分 <code>model</code>：指定模型参数的先验分布。</p></li>
<li><p>生成量 <code>generated quantities</code>：拟合模型获得参数估计值后，计算一些统计量。</p></li>
</ol>
<p>下面准备数据</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>nchains <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="co"># 4 条迭代链</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="co"># 给每条链设置不同的参数初始值</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>inits_data <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>nchains, <span class="cf">function</span>(i) {</span>
<span id="cb7-4"><a href="#cb7-4"></a>  <span class="fu">list</span>(</span>
<span id="cb7-5"><a href="#cb7-5"></a>    <span class="at">alpha =</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb7-6"><a href="#cb7-6"></a>    <span class="at">beta =</span> <span class="fu">runif</span>(<span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">10</span>)</span>
<span id="cb7-7"><a href="#cb7-7"></a>  )</span>
<span id="cb7-8"><a href="#cb7-8"></a>})</span>
<span id="cb7-9"><a href="#cb7-9"></a></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="co"># 准备数据</span></span>
<span id="cb7-11"><a href="#cb7-11"></a>poisson_d <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb7-12"><a href="#cb7-12"></a>  <span class="at">n =</span> <span class="dv">2500</span>, <span class="co"># 观测记录的条数</span></span>
<span id="cb7-13"><a href="#cb7-13"></a>  <span class="at">k =</span> <span class="dv">2</span>, <span class="co"># 协变量个数</span></span>
<span id="cb7-14"><a href="#cb7-14"></a>  <span class="at">X =</span> X, <span class="co"># N x 2 矩阵</span></span>
<span id="cb7-15"><a href="#cb7-15"></a>  <span class="at">y =</span> y, <span class="co"># N 向量</span></span>
<span id="cb7-16"><a href="#cb7-16"></a>  <span class="at">log_offset =</span> <span class="fu">log</span>(u)</span>
<span id="cb7-17"><a href="#cb7-17"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>编译模型，抽样获取参数的后验分布</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># 加载 cmdstanr 包</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="co"># 编译模型</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>mod_poisson <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(</span>
<span id="cb8-5"><a href="#cb8-5"></a>  <span class="at">stan_file =</span> <span class="st">"code/poisson_log_glm.stan"</span>,</span>
<span id="cb8-6"><a href="#cb8-6"></a>  <span class="at">compile =</span> <span class="cn">TRUE</span>,</span>
<span id="cb8-7"><a href="#cb8-7"></a>  <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-8"><a href="#cb8-8"></a>)</span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="co"># 采样拟合模型</span></span>
<span id="cb8-10"><a href="#cb8-10"></a>fit_poisson_stan <span class="ot">&lt;-</span> mod_poisson<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb8-11"><a href="#cb8-11"></a>  <span class="at">data =</span> poisson_d, <span class="co"># 观测数据</span></span>
<span id="cb8-12"><a href="#cb8-12"></a>  <span class="at">init =</span> inits_data, <span class="co"># 迭代初值</span></span>
<span id="cb8-13"><a href="#cb8-13"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>, <span class="co"># 每条链预处理迭代次数</span></span>
<span id="cb8-14"><a href="#cb8-14"></a>  <span class="at">iter_sampling =</span> <span class="dv">2000</span>, <span class="co"># 每条链总迭代次数</span></span>
<span id="cb8-15"><a href="#cb8-15"></a>  <span class="at">chains =</span> nchains, <span class="co"># 马尔科夫链的数目</span></span>
<span id="cb8-16"><a href="#cb8-16"></a>  <span class="at">parallel_chains =</span> <span class="dv">1</span>, <span class="co"># 指定 CPU 核心数，可以给每条链分配一个</span></span>
<span id="cb8-17"><a href="#cb8-17"></a>  <span class="at">threads_per_chain =</span> <span class="dv">1</span>, <span class="co"># 每条链设置一个线程</span></span>
<span id="cb8-18"><a href="#cb8-18"></a>  <span class="at">show_messages =</span> <span class="cn">FALSE</span>, <span class="co"># 不显示迭代的中间过程</span></span>
<span id="cb8-19"><a href="#cb8-19"></a>  <span class="at">refresh =</span> <span class="dv">0</span>, <span class="co"># 不显示采样的进度</span></span>
<span id="cb8-20"><a href="#cb8-20"></a>  <span class="at">seed =</span> <span class="dv">20222022</span> <span class="co"># 设置随机数种子，不要使用 set.seed() 函数</span></span>
<span id="cb8-21"><a href="#cb8-21"></a>)</span>
<span id="cb8-22"><a href="#cb8-22"></a><span class="co"># 迭代诊断</span></span>
<span id="cb8-23"><a href="#cb8-23"></a>fit_poisson_stan<span class="sc">$</span><span class="fu">diagnostic_summary</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; $num_divergent
#&gt; [1] 0 0 0 0
#&gt; 
#&gt; $num_max_treedepth
#&gt; [1] 0 0 0 0
#&gt; 
#&gt; $ebfmi
#&gt; [1] 1.1424219 0.9995611 1.0849789 1.0899448</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># 输出结果</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>fit_poisson_stan<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"lp__"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 4 × 10
#&gt;   variable      mean    median      sd     mad        q5      q95  rhat ess_bulk
#&gt;   &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
#&gt; 1 alpha        0.489     0.489 0.00934 0.00909     0.474  5.04e-1  1.00    4391.
#&gt; 2 beta[1]      0.290     0.290 0.0142  0.0144      0.266  3.13e-1  1.00    3312.
#&gt; 3 beta[2]      0.215     0.215 0.0142  0.0147      0.192  2.38e-1  1.00    3440.
#&gt; 4 lp__     -5388.    -5388.    1.19    0.979   -5390.    -5.39e+3  1.00    3301.
#&gt; # ℹ 1 more variable: ess_tail &lt;dbl&gt;</code></pre>
</div>
</div>
</section><section id="sec-posterior-distribution" class="level2" data-number="34.3"><h2 data-number="34.3" class="anchored" data-anchor-id="sec-posterior-distribution">
<span class="header-section-number">34.3</span> 参数后验分布</h2>
<p>加载 <strong>bayesplot</strong> 包，bayesplot 包提供一系列描述数据分布的绘图函数，比如绘制散点图 <code>mcmc_scatter()</code> 。<span class="math inline">\(\beta_1\)</span> 和 <span class="math inline">\(\beta_2\)</span> 的联合分布</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="fu">mcmc_scatter</span>(fit_poisson_stan<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"beta[1]"</span>, <span class="st">"beta[2]"</span>)), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(beta[<span class="dv">1</span>]), <span class="at">y =</span> <span class="fu">expression</span>(beta[<span class="dv">2</span>]))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-stan-scatter" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-stan-scatter-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="generalized-linear-models_files/figure-html/fig-stan-scatter-1.png" class="img-fluid figure-img" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stan-scatter-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;34.1: <span class="math inline">\(\beta_1\)</span> 和 <span class="math inline">\(\beta_2\)</span> 的联合分布
</figcaption></figure>
</div>
</div>
</div>
<p>如果提取采样的数据，也可使用 ggplot2 包绘图，不局限于 bayesplot 设定的风格。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>beta_df <span class="ot">&lt;-</span> fit_poisson_stan<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"beta[1]"</span>, <span class="st">"beta[2]"</span>), <span class="at">format =</span> <span class="st">"draws_df"</span>)</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="fu">ggplot</span>(<span class="at">data =</span> beta_df, <span class="fu">aes</span>(<span class="at">x =</span> <span class="st">`</span><span class="at">beta[1]</span><span class="st">`</span>, <span class="at">y =</span> <span class="st">`</span><span class="at">beta[2]</span><span class="st">`</span>)) <span class="sc">+</span></span>
<span id="cb13-3"><a href="#cb13-3"></a>  <span class="fu">geom_density_2d_filled</span>() <span class="sc">+</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>.chain, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb13-5"><a href="#cb13-5"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(beta[<span class="dv">1</span>]), <span class="at">y =</span> <span class="fu">expression</span>(beta[<span class="dv">2</span>]))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-density-filled" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-density-filled-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="generalized-linear-models_files/figure-html/fig-density-filled-1.png" class="img-fluid figure-img" width="576">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-density-filled-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;34.2: <span class="math inline">\(\beta_1\)</span> 和 <span class="math inline">\(\beta_2\)</span> 的联合分布
</figcaption></figure>
</div>
</div>
</div>
<p><span class="math inline">\(\beta_1\)</span> 和 <span class="math inline">\(\beta_2\)</span> 的热力图</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">mcmc_hex</span>(fit_poisson_stan<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"beta[1]"</span>, <span class="st">"beta[2]"</span>))) <span class="sc">+</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb14-3"><a href="#cb14-3"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(beta[<span class="dv">1</span>]), <span class="at">y =</span> <span class="fu">expression</span>(beta[<span class="dv">2</span>]))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-stan-hex" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-stan-hex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="generalized-linear-models_files/figure-html/fig-stan-hex-1.png" class="img-fluid figure-img" width="528">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stan-hex-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;34.3: <span class="math inline">\(\beta_1\)</span> 和 <span class="math inline">\(\beta_2\)</span> 的热力图
</figcaption></figure>
</div>
</div>
</div>
<p>各个参数的轨迹图</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">mcmc_trace</span>(fit_poisson_stan<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"beta[1]"</span>, <span class="st">"beta[2]"</span>)),</span>
<span id="cb15-2"><a href="#cb15-2"></a>  <span class="at">facet_args =</span> <span class="fu">list</span>(</span>
<span id="cb15-3"><a href="#cb15-3"></a>    <span class="at">labeller =</span> ggplot2<span class="sc">::</span>label_parsed, <span class="at">strip.position =</span> <span class="st">"top"</span>, <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>  )</span>
<span id="cb15-5"><a href="#cb15-5"></a>) <span class="sc">+</span></span>
<span id="cb15-6"><a href="#cb15-6"></a>  <span class="fu">theme_classic</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-stan-trace" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-stan-trace-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="generalized-linear-models_files/figure-html/fig-stan-trace-1.png" class="img-fluid figure-img" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stan-trace-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;34.4: 各个参数的轨迹图
</figcaption></figure>
</div>
</div>
</div>
<p>可以将模型参数的后验分布图展示出来</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="fu">mcmc_dens</span>(fit_poisson_stan<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"beta[1]"</span>, <span class="st">"beta[2]"</span>)),</span>
<span id="cb16-2"><a href="#cb16-2"></a>  <span class="at">facet_args =</span> <span class="fu">list</span>(</span>
<span id="cb16-3"><a href="#cb16-3"></a>    <span class="at">labeller =</span> ggplot2<span class="sc">::</span>label_parsed, <span class="at">strip.position =</span> <span class="st">"top"</span>, <span class="at">ncol =</span> <span class="dv">1</span></span>
<span id="cb16-4"><a href="#cb16-4"></a>  )</span>
<span id="cb16-5"><a href="#cb16-5"></a>) <span class="sc">+</span></span>
<span id="cb16-6"><a href="#cb16-6"></a>  <span class="fu">theme_classic</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-stan-dens" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-stan-dens-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="generalized-linear-models_files/figure-html/fig-stan-dens-1.png" class="img-fluid figure-img" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stan-dens-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;34.5: 各个参数的分布图（密度图）
</figcaption></figure>
</div>
</div>
</div>
<p>后验分布的中位数、80% 区间</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="fu">mcmc_areas</span>(fit_poisson_stan<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"beta[1]"</span>, <span class="st">"beta[2]"</span>)), <span class="at">prob =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">parse_format</span>()) <span class="sc">+</span></span>
<span id="cb17-3"><a href="#cb17-3"></a>  <span class="fu">theme_classic</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-stan-areas" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-stan-areas-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="generalized-linear-models_files/figure-html/fig-stan-areas-1.png" class="img-fluid figure-img" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stan-areas-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;34.6: 各个参数的分布图（岭线图）
</figcaption></figure>
</div>
</div>
</div>
<p>岭线图就是将各个参数的后验分布图放在一起。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="fu">mcmc_areas_ridges</span>(<span class="at">x =</span> fit_poisson_stan<span class="sc">$</span><span class="fu">draws</span>(), <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">"beta[1]"</span>, <span class="st">"beta[2]"</span>)) <span class="sc">+</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">parse_format</span>()) <span class="sc">+</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="fu">theme_classic</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-stan-ridges" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-stan-ridges-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="generalized-linear-models_files/figure-html/fig-stan-ridges-1.png" class="img-fluid figure-img" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stan-ridges-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;34.7: 各个参数的分布图（岭线图）
</figcaption></figure>
</div>
</div>
</div>
<p>参数的 <span class="math inline">\(\hat{R}\)</span> 潜在尺度收缩因子</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>bayesplot<span class="sc">::</span><span class="fu">rhat</span>(fit_poisson_stan, <span class="at">pars =</span> <span class="st">"alpha"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;    alpha 
#&gt; 1.001704</code></pre>
</div>
</div>
<p>后验预测诊断的想法是检查根据拟合模型生成的随机数 <span class="math inline">\(y^{rep}\)</span> 与真实观测数据 <span class="math inline">\(y\)</span> 的接近程度。为直观起见，可以用一系列描述数据分布的图来可视化检验。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="co"># mcmc_scatter(fit_poisson_stan$draws(),</span></span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="co">#   pars = c("beta[1]", "beta[2]"),</span></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="co">#   np = nuts_params(fit_poisson_stan)</span></span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="co"># )</span></span>
<span id="cb21-5"><a href="#cb21-5"></a></span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="fu">mcmc_nuts_energy</span>(<span class="at">x =</span> <span class="fu">nuts_params</span>(fit_poisson_stan), <span class="at">binwidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb21-7"><a href="#cb21-7"></a>  <span class="fu">ggtitle</span>(<span class="at">label =</span> <span class="st">"NUTS Energy Diagnostic"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-stan-nuts" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-stan-nuts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="generalized-linear-models_files/figure-html/fig-stan-nuts-1.png" class="img-fluid figure-img" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stan-nuts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;34.8: NUTS 能量诊断图
</figcaption></figure>
</div>
</div>
</div>
<p>y 是真实数据，yrep 是根据贝叶斯拟合模型生成的数据。下图是真实数据的密度图和50组生成数据的密度图。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="co"># 抽取 yrep 数据</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>yrep <span class="ot">&lt;-</span> fit_poisson_stan<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="st">"y_rep"</span>, <span class="at">format =</span> <span class="st">"draws_matrix"</span>)</span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="fu">pp_check</span>(y, <span class="at">yrep =</span> yrep[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, ], <span class="at">fun =</span> ppc_dens_overlay) <span class="sc">+</span></span>
<span id="cb22-4"><a href="#cb22-4"></a>  <span class="fu">theme_classic</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-stan-ppcheck-dens" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-stan-ppcheck-dens-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="generalized-linear-models_files/figure-html/fig-stan-ppcheck-dens-1.png" class="img-fluid figure-img" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stan-ppcheck-dens-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;34.9: 后验预测诊断图（密度图）
</figcaption></figure>
</div>
</div>
</div>
<p>观察后验预测区间与真实数据的覆盖情况，不妨取前 50 次观测的数据，即 <code>y[1:50]</code> 与第 2 个自变量 <code>X[1:50, 2]</code> ，基于后验分布的 500 次采样数据绘制 50% 后验置信区间。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="fu">ppc_intervals</span>(y[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>], <span class="at">yrep =</span> yrep[<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>], <span class="at">x =</span> X[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, <span class="dv">2</span>], <span class="at">prob =</span> <span class="fl">0.5</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-stan-ppcheck-intervals" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-stan-ppcheck-intervals-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="generalized-linear-models_files/figure-html/fig-stan-ppcheck-intervals-1.png" class="img-fluid figure-img" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stan-ppcheck-intervals-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;34.10: 后验预测诊断图（区间图）
</figcaption></figure>
</div>
</div>
</div>
</section><section id="sec-model-evaluation" class="level2" data-number="34.4"><h2 data-number="34.4" class="anchored" data-anchor-id="sec-model-evaluation">
<span class="header-section-number">34.4</span> 模型评估指标</h2>
<p><strong>loo</strong> 包可以计算 WAIC</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>fit_poisson_waic <span class="ot">&lt;-</span> loo<span class="sc">::</span><span class="fu">waic</span>(fit_poisson_stan<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="st">"log_lik"</span>))</span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="fu">print</span>(fit_poisson_waic)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Computed from 8000 by 2500 log-likelihood matrix.
#&gt; 
#&gt;           Estimate   SE
#&gt; elpd_waic  -5386.3 37.7
#&gt; p_waic         2.9  0.1
#&gt; waic       10772.6 75.5</code></pre>
</div>
</div>
<p><strong>loo</strong> 包推荐使用 LOO-CV ，它还提供诊断信息、有效样本量和蒙特卡罗估计。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>fit_poisson_loo <span class="ot">&lt;-</span> fit_poisson_stan<span class="sc">$</span><span class="fu">loo</span>(<span class="at">variables =</span> <span class="st">"log_lik"</span>, <span class="at">cores =</span> <span class="dv">2</span>)</span>
<span id="cb26-2"><a href="#cb26-2"></a><span class="fu">print</span>(fit_poisson_loo)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Computed from 8000 by 2500 log-likelihood matrix.
#&gt; 
#&gt;          Estimate   SE
#&gt; elpd_loo  -5386.3 37.7
#&gt; p_loo         2.9  0.1
#&gt; looic     10772.6 75.5
#&gt; ------
#&gt; MCSE of elpd_loo is 0.0.
#&gt; MCSE and ESS estimates assume MCMC draws (r_eff in [0.4, 1.3]).
#&gt; 
#&gt; All Pareto k estimates are good (k &lt; 0.7).
#&gt; See help('pareto-k-diagnostic') for details.</code></pre>
</div>
</div>
</section><section id="sec-bayesian-brms" class="level2" data-number="34.5"><h2 data-number="34.5" class="anchored" data-anchor-id="sec-bayesian-brms">
<span class="header-section-number">34.5</span> 可选替代实现</h2>
<p>对于常见的统计模型，rstanarm 和 <strong>brms</strong> 包都内置了预编译的 Stan 程序，下面用 <strong>brms</strong> 包的函数 <code>brm()</code> 拟合带上述漂移项的泊松广义线性模型，参数估计结果和 Base R 函数 <code><a href="https://rdrr.io/r/stats/glm.html">glm()</a></code> 的几乎一致，因编译和抽样的过程比较花费时间，速度不及 Base R。</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># brms</span></span>
<span id="cb28-2"><a href="#cb28-2"></a>dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y =</span> y, <span class="at">X =</span> X, <span class="at">u =</span> u)</span>
<span id="cb28-3"><a href="#cb28-3"></a><span class="fu">colnames</span>(dat) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"y"</span>, <span class="st">"x1"</span>, <span class="st">"x2"</span>, <span class="st">"u"</span>)</span>
<span id="cb28-4"><a href="#cb28-4"></a>fit_poisson_brm <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">brm</span>(y <span class="sc">~</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(u)),</span>
<span id="cb28-5"><a href="#cb28-5"></a>  <span class="at">data =</span> dat, <span class="at">family =</span> <span class="fu">poisson</span>(<span class="at">link =</span> <span class="st">"log"</span>)</span>
<span id="cb28-6"><a href="#cb28-6"></a>)</span>
<span id="cb28-7"><a href="#cb28-7"></a>fit_poisson_brm</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code> Family: poisson 
  Links: mu = log 
Formula: y ~ x1 + x2 + offset(log(u)) 
   Data: dat (Number of observations: 2500) 
  Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup draws = 4000

Population-Level Effects: 
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     0.49      0.01     0.47     0.51 1.00     2509     2171
x1            0.29      0.01     0.26     0.32 1.00     1771     1645
x2            0.21      0.01     0.19     0.24 1.00     1727     1847

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>调用函数 <code>brm()</code> 拟合模型后返回一个 brmsfit 对象 <code>fit_poisson_brm</code>，<strong>brms</strong> 包提供很多函数处理该数据对象，比如 <code><a href="https://mc-stan.org/loo/reference/loo.html">brms::loo()</a></code> 计算 LOO-CV</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>brms<span class="sc">::</span><span class="fu">loo</span>(fit_poisson_brm)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>Computed from 4000 by 2500 log-likelihood matrix

         Estimate   SE
elpd_loo  -5386.3 37.8
p_loo         2.9  0.1
looic     10772.6 75.5
------
Monte Carlo SE of elpd_loo is 0.0.

All Pareto k estimates are good (k &lt; 0.5).
See help('pareto-k-diagnostic') for details.</code></pre>
<p>输出结果中， LOO IC 信息准则 Loo information criterion，looic 指标的作用类似频率派模型中的 AIC 指标，所以也几乎相同的。</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="co"># 后验预测检查</span></span>
<span id="cb32-2"><a href="#cb32-2"></a>brms<span class="sc">::</span><span class="fu">pp_check</span>(fit_poisson_brm)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section><section id="sec-esoph" class="level2" data-number="34.6"><h2 data-number="34.6" class="anchored" data-anchor-id="sec-esoph">
<span class="header-section-number">34.6</span> 案例：吸烟喝酒和食道癌的关系</h2>
<!-- 存在有序分类变量数据  -->
<p>本例数据集 esoph 来自 Base R 内置的 datasets 包，是法国伊勒-维莱讷食道癌研究数据，研究吸烟、喝酒与食道癌的关系，量化酒精、烟草、酒精和烟草的交互作用。部分数据集见 <a href="#tbl-esoph" class="quarto-xref">表格&nbsp;<span>34.1</span></a> ，年龄组 agegp、酒精量 alcgp 和烟草量 tobgp 为有序的分类变量，正常来说，年龄越大，吸烟、喝酒对食道癌影响越大。</p>
<div class="cell">
<div id="tbl-esoph" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-esoph-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表格&nbsp;34.1: 食道癌研究数据（部分）
</figcaption><div aria-describedby="tbl-esoph-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;">年龄组</th>
<th style="text-align: left;">酒精量</th>
<th style="text-align: left;">烟草量</th>
<th style="text-align: right;">实验组</th>
<th style="text-align: right;">控制组</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">25-34</td>
<td style="text-align: left;">0-39g/day</td>
<td style="text-align: left;">0-9g/day</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">40</td>
</tr>
<tr class="even">
<td style="text-align: left;">25-34</td>
<td style="text-align: left;">0-39g/day</td>
<td style="text-align: left;">10-19</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">10</td>
</tr>
<tr class="odd">
<td style="text-align: left;">25-34</td>
<td style="text-align: left;">0-39g/day</td>
<td style="text-align: left;">20-29</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="even">
<td style="text-align: left;">25-34</td>
<td style="text-align: left;">0-39g/day</td>
<td style="text-align: left;">30+</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">25-34</td>
<td style="text-align: left;">40-79</td>
<td style="text-align: left;">0-9g/day</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">27</td>
</tr>
<tr class="even">
<td style="text-align: left;">25-34</td>
<td style="text-align: left;">40-79</td>
<td style="text-align: left;">10-19</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">7</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<section id="描述分析" class="level3" data-number="34.6.1"><h3 data-number="34.6.1" class="anchored" data-anchor-id="描述分析">
<span class="header-section-number">34.6.1</span> 描述分析</h3>
<p>先来简单统计一下各年龄组、酒精量组的食道癌发病人数</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="fu">xtabs</span>(<span class="at">data =</span> esoph, <span class="fu">cbind</span>(ncases, ncontrols) <span class="sc">~</span> agegp <span class="sc">+</span> alcgp)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; , ,  = ncases
#&gt; 
#&gt;        alcgp
#&gt; agegp   0-39g/day 40-79 80-119 120+
#&gt;   25-34         0     0      0    1
#&gt;   35-44         1     4      0    4
#&gt;   45-54         1    20     12   13
#&gt;   55-64        12    22     24   18
#&gt;   65-74        11    25     13    6
#&gt;   75+           4     4      2    3
#&gt; 
#&gt; , ,  = ncontrols
#&gt; 
#&gt;        alcgp
#&gt; agegp   0-39g/day 40-79 80-119 120+
#&gt;   25-34        61    45      5    4
#&gt;   35-44        88    76     20    6
#&gt;   45-54        77    61     27    2
#&gt;   55-64        77    62     19    8
#&gt;   65-74        60    28     16    2
#&gt;   75+          23     8      0    0</code></pre>
</div>
</div>
<p><a href="#fig-esoph" class="quarto-xref">图&nbsp;<span>34.11</span></a> 描述食道癌发病率与年龄组、酒精量的关系</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb35-2"><a href="#cb35-2"></a><span class="fu">aggregate</span>(<span class="fu">cbind</span>(ncases, ncontrols) <span class="sc">~</span> agegp <span class="sc">+</span> alcgp, <span class="at">data =</span> esoph, sum) <span class="sc">|&gt;</span></span>
<span id="cb35-3"><a href="#cb35-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> agegp, <span class="at">y =</span> alcgp, <span class="at">fill =</span> ncases <span class="sc">/</span> (ncases <span class="sc">+</span> ncontrols))) <span class="sc">+</span></span>
<span id="cb35-4"><a href="#cb35-4"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">percent_format</span>()) <span class="sc">+</span></span>
<span id="cb35-5"><a href="#cb35-5"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb35-6"><a href="#cb35-6"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"年龄组"</span>, <span class="at">y =</span> <span class="st">"酒精量"</span>, <span class="at">fill =</span> <span class="st">"发病率"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-esoph" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-esoph-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="generalized-linear-models_files/figure-html/fig-esoph-1.png" class="img-fluid figure-img" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-esoph-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;34.11: 食道癌发病率与年龄组、酒精量的关系
</figcaption></figure>
</div>
</div>
</div>
</section><section id="拟合模型" class="level3" data-number="34.6.2"><h3 data-number="34.6.2" class="anchored" data-anchor-id="拟合模型">
<span class="header-section-number">34.6.2</span> 拟合模型</h3>
<p>响应变量服从二项分布，自变量包含年龄分组 agegp、酒精量 alcgp、烟草量 tobgp 和 酒精量与烟草量的交互作用，建立广义线性模型。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>fit_glm_esoph <span class="ot">&lt;-</span> <span class="fu">glm</span>(<span class="fu">cbind</span>(ncases, ncontrols) <span class="sc">~</span> agegp <span class="sc">+</span> tobgp <span class="sc">*</span> alcgp,</span>
<span id="cb36-2"><a href="#cb36-2"></a>  <span class="at">data =</span> esoph, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>)</span>
<span id="cb36-3"><a href="#cb36-3"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>模型输出</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a><span class="fu">summary</span>(fit_glm_esoph)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Call:
#&gt; glm(formula = cbind(ncases, ncontrols) ~ agegp + tobgp * alcgp, 
#&gt;     family = binomial(link = "logit"), data = esoph)
#&gt; 
#&gt; Coefficients:
#&gt;                 Estimate Std. Error z value Pr(&gt;|z|)    
#&gt; (Intercept)     -1.16933    0.20767  -5.631 1.79e-08 ***
#&gt; agegp.L          3.97135    0.69286   5.732 9.94e-09 ***
#&gt; agegp.Q         -1.58715    0.61943  -2.562   0.0104 *  
#&gt; agegp.C          0.09866    0.47331   0.208   0.8349    
#&gt; agegp^4          0.09950    0.32816   0.303   0.7617    
#&gt; agegp^5         -0.27067    0.21516  -1.258   0.2084    
#&gt; tobgp.L          1.10809    0.27042   4.098 4.17e-05 ***
#&gt; tobgp.Q          0.26586    0.25419   1.046   0.2956    
#&gt; tobgp.C          0.29394    0.24026   1.223   0.2212    
#&gt; alcgp.L          2.42627    0.28829   8.416  &lt; 2e-16 ***
#&gt; alcgp.Q          0.12999    0.25418   0.511   0.6091    
#&gt; alcgp.C          0.36600    0.22252   1.645   0.1000    
#&gt; tobgp.L:alcgp.L -0.42942    0.58589  -0.733   0.4636    
#&gt; tobgp.Q:alcgp.L  0.33676    0.56764   0.593   0.5530    
#&gt; tobgp.C:alcgp.L -0.15742    0.54313  -0.290   0.7719    
#&gt; tobgp.L:alcgp.Q  0.04169    0.53027   0.079   0.9373    
#&gt; tobgp.Q:alcgp.Q -0.62384    0.50922  -1.225   0.2205    
#&gt; tobgp.C:alcgp.Q -0.06700    0.48120  -0.139   0.8893    
#&gt; tobgp.L:alcgp.C -0.25088    0.47211  -0.531   0.5951    
#&gt; tobgp.Q:alcgp.C  0.02303    0.44197   0.052   0.9584    
#&gt; tobgp.C:alcgp.C -0.17340    0.40908  -0.424   0.6717    
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt; (Dispersion parameter for binomial family taken to be 1)
#&gt; 
#&gt;     Null deviance: 367.953  on 87  degrees of freedom
#&gt; Residual deviance:  76.886  on 67  degrees of freedom
#&gt; AIC: 233.94
#&gt; 
#&gt; Number of Fisher Scoring iterations: 6</code></pre>
</div>
</div>
<p>整理模型输出后，见 <a href="#tbl-glm-esoph" class="quarto-xref">表格&nbsp;<span>34.2</span></a></p>
<div class="cell">
<div id="tbl-glm-esoph" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-glm-esoph-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表格&nbsp;34.2: 广义线性模型各个参数的估计结果
</figcaption><div aria-describedby="tbl-glm-esoph-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell table table-sm table-striped small">
<thead><tr class="header">
<th style="text-align: left;">term</th>
<th style="text-align: right;">estimate</th>
<th style="text-align: right;">std.error</th>
<th style="text-align: right;">statistic</th>
<th style="text-align: right;">p.value</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">-1.1693289</td>
<td style="text-align: right;">0.2076675</td>
<td style="text-align: right;">-5.6307761</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="even">
<td style="text-align: left;">agegp.L</td>
<td style="text-align: right;">3.9713482</td>
<td style="text-align: right;">0.6928602</td>
<td style="text-align: right;">5.7318175</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">agegp.Q</td>
<td style="text-align: right;">-1.5871516</td>
<td style="text-align: right;">0.6194310</td>
<td style="text-align: right;">-2.5622734</td>
<td style="text-align: right;">0.0103989</td>
</tr>
<tr class="even">
<td style="text-align: left;">agegp.C</td>
<td style="text-align: right;">0.0986649</td>
<td style="text-align: right;">0.4733144</td>
<td style="text-align: right;">0.2084553</td>
<td style="text-align: right;">0.8348735</td>
</tr>
<tr class="odd">
<td style="text-align: left;">agegp^4</td>
<td style="text-align: right;">0.0995027</td>
<td style="text-align: right;">0.3281577</td>
<td style="text-align: right;">0.3032161</td>
<td style="text-align: right;">0.7617251</td>
</tr>
<tr class="even">
<td style="text-align: left;">agegp^5</td>
<td style="text-align: right;">-0.2706732</td>
<td style="text-align: right;">0.2151596</td>
<td style="text-align: right;">-1.2580111</td>
<td style="text-align: right;">0.2083877</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tobgp.L</td>
<td style="text-align: right;">1.1080898</td>
<td style="text-align: right;">0.2704214</td>
<td style="text-align: right;">4.0976401</td>
<td style="text-align: right;">0.0000417</td>
</tr>
<tr class="even">
<td style="text-align: left;">tobgp.Q</td>
<td style="text-align: right;">0.2658557</td>
<td style="text-align: right;">0.2541932</td>
<td style="text-align: right;">1.0458805</td>
<td style="text-align: right;">0.2956162</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tobgp.C</td>
<td style="text-align: right;">0.2939369</td>
<td style="text-align: right;">0.2402602</td>
<td style="text-align: right;">1.2234109</td>
<td style="text-align: right;">0.2211745</td>
</tr>
<tr class="even">
<td style="text-align: left;">alcgp.L</td>
<td style="text-align: right;">2.4262714</td>
<td style="text-align: right;">0.2882861</td>
<td style="text-align: right;">8.4161937</td>
<td style="text-align: right;">0.0000000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">alcgp.Q</td>
<td style="text-align: right;">0.1299883</td>
<td style="text-align: right;">0.2541785</td>
<td style="text-align: right;">0.5114056</td>
<td style="text-align: right;">0.6090671</td>
</tr>
<tr class="even">
<td style="text-align: left;">alcgp.C</td>
<td style="text-align: right;">0.3659976</td>
<td style="text-align: right;">0.2225178</td>
<td style="text-align: right;">1.6448016</td>
<td style="text-align: right;">0.1000107</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tobgp.L:alcgp.L</td>
<td style="text-align: right;">-0.4294231</td>
<td style="text-align: right;">0.5858868</td>
<td style="text-align: right;">-0.7329456</td>
<td style="text-align: right;">0.4635916</td>
</tr>
<tr class="even">
<td style="text-align: left;">tobgp.Q:alcgp.L</td>
<td style="text-align: right;">0.3367616</td>
<td style="text-align: right;">0.5676428</td>
<td style="text-align: right;">0.5932632</td>
<td style="text-align: right;">0.5530050</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tobgp.C:alcgp.L</td>
<td style="text-align: right;">-0.1574229</td>
<td style="text-align: right;">0.5431330</td>
<td style="text-align: right;">-0.2898423</td>
<td style="text-align: right;">0.7719369</td>
</tr>
<tr class="even">
<td style="text-align: left;">tobgp.L:alcgp.Q</td>
<td style="text-align: right;">0.0416850</td>
<td style="text-align: right;">0.5302708</td>
<td style="text-align: right;">0.0786108</td>
<td style="text-align: right;">0.9373422</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tobgp.Q:alcgp.Q</td>
<td style="text-align: right;">-0.6238362</td>
<td style="text-align: right;">0.5092212</td>
<td style="text-align: right;">-1.2250790</td>
<td style="text-align: right;">0.2205454</td>
</tr>
<tr class="even">
<td style="text-align: left;">tobgp.C:alcgp.Q</td>
<td style="text-align: right;">-0.0670047</td>
<td style="text-align: right;">0.4811987</td>
<td style="text-align: right;">-0.1392454</td>
<td style="text-align: right;">0.8892562</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tobgp.L:alcgp.C</td>
<td style="text-align: right;">-0.2508767</td>
<td style="text-align: right;">0.4721073</td>
<td style="text-align: right;">-0.5313976</td>
<td style="text-align: right;">0.5951433</td>
</tr>
<tr class="even">
<td style="text-align: left;">tobgp.Q:alcgp.C</td>
<td style="text-align: right;">0.0230305</td>
<td style="text-align: right;">0.4419683</td>
<td style="text-align: right;">0.0521088</td>
<td style="text-align: right;">0.9584420</td>
</tr>
<tr class="odd">
<td style="text-align: left;">tobgp.C:alcgp.C</td>
<td style="text-align: right;">-0.1733950</td>
<td style="text-align: right;">0.4090805</td>
<td style="text-align: right;">-0.4238652</td>
<td style="text-align: right;">0.6716641</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
</section><section id="与-brms-比较" class="level3" data-number="34.6.3"><h3 data-number="34.6.3" class="anchored" data-anchor-id="与-brms-比较">
<span class="header-section-number">34.6.3</span> 与 brms 比较</h3>
<p>下面从贝叶斯的视角分析和建模，使用 <strong>brms</strong> 包对该数据拟合，同样是广义线性模型。</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a>fit_brm_esoph <span class="ot">&lt;-</span> <span class="fu">brm</span>(ncases <span class="sc">|</span> <span class="fu">trials</span>(ncases <span class="sc">+</span> ncontrols) <span class="sc">~</span> agegp <span class="sc">+</span> tobgp <span class="sc">*</span> alcgp, </span>
<span id="cb39-2"><a href="#cb39-2"></a>                     <span class="at">data =</span> esoph, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code> Family: binomial 
  Links: mu = logit 
Formula: ncases | trials(ncases + ncontrols) ~ agegp + tobgp * alcgp 
   Data: esoph (Number of observations: 88) 
Samples: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
         total post-warmup samples = 4000

Population-Level Effects: 
                Estimate Est.Error l-95% CI u-95% CI Eff.Sample Rhat
Intercept          -1.91      0.25    -2.49    -1.51        735 1.01
agegp.L             3.39      0.86     2.13     5.45        674 1.01
agegp.Q            -1.68      0.78    -3.58    -0.50        658 1.01
agegp.C             0.31      0.57    -0.59     1.63        709 1.00
agegpE4            -0.01      0.36    -0.80     0.65        907 1.01
agegpE5            -0.20      0.21    -0.59     0.22       1970 1.00
tobgp.L             0.63      0.20     0.24     1.03       4654 1.00
tobgp.Q             0.03      0.20    -0.38     0.42       3469 1.00
tobgp.C             0.17      0.20    -0.21     0.57       3892 1.00
alcgp.L             1.41      0.22     0.99     1.84       4067 1.00
alcgp.Q            -0.16      0.20    -0.56     0.24       3335 1.00
alcgp.C             0.25      0.19    -0.12     0.62       3870 1.00
tobgp.L:alcgp.L    -0.69      0.42    -1.51     0.16       3878 1.00
tobgp.Q:alcgp.L     0.13      0.43    -0.75     0.97       4249 1.00
tobgp.C:alcgp.L    -0.30      0.44    -1.15     0.58       5149 1.00
tobgp.L:alcgp.Q     0.13      0.41    -0.67     0.94       3127 1.00
tobgp.Q:alcgp.Q    -0.46      0.41    -1.24     0.34       4037 1.00
tobgp.C:alcgp.Q    -0.05      0.40    -0.82     0.74       4490 1.00
tobgp.L:alcgp.C    -0.15      0.38    -0.89     0.58       3507 1.00
tobgp.Q:alcgp.C     0.04      0.37    -0.69     0.75       3274 1.00
tobgp.C:alcgp.C    -0.17      0.36    -0.88     0.54       3773 1.00

Samples were drawn using sampling(NUTS). For each parameter, Eff.Sample 
is a crude measure of effective sample size, and Rhat is the potential 
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
<p>输出结果和 <code><a href="https://rdrr.io/r/stats/glm.html">glm()</a></code> 有不少差别的。</p>
</section></section><section id="案例哥本哈根住房状况调查" class="level2" data-number="34.7"><h2 data-number="34.7" class="anchored" data-anchor-id="案例哥本哈根住房状况调查">
<span class="header-section-number">34.7</span> 案例：哥本哈根住房状况调查</h2>
<!-- 响应变量是分类有序的变量 -->
<p>数据集 housing 哥本哈根住房状况调查中的次数分布表，<code>Sat</code> 住户对目前居住环境的满意程度，是一个有序的因子变量，<code>Infl</code> 住户对物业管理的感知影响程度，<code>Type</code> 租赁住宿类型，如塔楼、中庭、公寓、露台，<code>Cont</code> 联系居民可与其他居民联系(低、高)，<code>Freq</code> 每个类中的居民人数，调查的人数。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a><span class="fu">data</span>(<span class="st">"housing"</span>, <span class="at">package =</span> <span class="st">"MASS"</span>)</span>
<span id="cb41-2"><a href="#cb41-2"></a><span class="fu">str</span>(housing)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 'data.frame':    72 obs. of  5 variables:
#&gt;  $ Sat : Ord.factor w/ 3 levels "Low"&lt;"Medium"&lt;..: 1 2 3 1 2 3 1 2 3 1 ...
#&gt;  $ Infl: Factor w/ 3 levels "Low","Medium",..: 1 1 1 2 2 2 3 3 3 1 ...
#&gt;  $ Type: Factor w/ 4 levels "Tower","Apartment",..: 1 1 1 1 1 1 1 1 1 2 ...
#&gt;  $ Cont: Factor w/ 2 levels "Low","High": 1 1 1 1 1 1 1 1 1 1 ...
#&gt;  $ Freq: int  21 21 28 34 22 36 10 11 36 61 ...</code></pre>
</div>
</div>
<p>响应变量是居民对居住环境满意度 Sat ，分三个等级，且存在强弱，等级，大小之分。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a><span class="co"># 因子变量的处理</span></span>
<span id="cb43-2"><a href="#cb43-2"></a><span class="fu">options</span>(<span class="at">contrasts =</span> <span class="fu">c</span>(<span class="st">"contr.treatment"</span>, <span class="st">"contr.poly"</span>))</span>
<span id="cb43-3"><a href="#cb43-3"></a><span class="co"># 有序逻辑回归</span></span>
<span id="cb43-4"><a href="#cb43-4"></a>housing_mass <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">polr</span>(Sat <span class="sc">~</span> Infl <span class="sc">+</span> Type <span class="sc">+</span> Cont, <span class="at">weights =</span> Freq, <span class="at">data =</span> housing, <span class="at">Hess =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-5"><a href="#cb43-5"></a><span class="fu">summary</span>(housing_mass)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Call:
#&gt; MASS::polr(formula = Sat ~ Infl + Type + Cont, data = housing, 
#&gt;     weights = Freq, Hess = TRUE)
#&gt; 
#&gt; Coefficients:
#&gt;                 Value Std. Error t value
#&gt; InflMedium     0.5664    0.10465   5.412
#&gt; InflHigh       1.2888    0.12716  10.136
#&gt; TypeApartment -0.5724    0.11924  -4.800
#&gt; TypeAtrium    -0.3662    0.15517  -2.360
#&gt; TypeTerrace   -1.0910    0.15149  -7.202
#&gt; ContHigh       0.3603    0.09554   3.771
#&gt; 
#&gt; Intercepts:
#&gt;             Value   Std. Error t value
#&gt; Low|Medium  -0.4961  0.1248    -3.9739
#&gt; Medium|High  0.6907  0.1255     5.5049
#&gt; 
#&gt; Residual Deviance: 3479.149 
#&gt; AIC: 3495.149</code></pre>
</div>
</div>
<p>计算置信区间</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a><span class="co"># 剖面</span></span>
<span id="cb45-2"><a href="#cb45-2"></a><span class="fu">confint</span>(<span class="fu">profile</span>(housing_mass), <span class="at">level =</span> <span class="fl">0.95</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;                    2.5 %      97.5 %
#&gt; InflMedium     0.3616415  0.77195375
#&gt; InflHigh       1.0409701  1.53958138
#&gt; TypeApartment -0.8069590 -0.33940432
#&gt; TypeAtrium    -0.6705862 -0.06204495
#&gt; TypeTerrace   -1.3893863 -0.79533958
#&gt; ContHigh       0.1733589  0.54792854</code></pre>
</div>
</div>
</section><section id="sec-bayesian-exercises" class="level2" data-number="34.8"><h2 data-number="34.8" class="anchored" data-anchor-id="sec-bayesian-exercises">
<span class="header-section-number">34.8</span> 习题</h2>
<ol type="1">
<li>
<p>分析挑战者号航天飞机 O 型环数据。<strong>DAAG</strong> 包的 orings 数据集记录美国挑战者号航天飞机 O 型环在不同温度下发生 Erosion 腐蚀和 Blowby 串气的失效数量。 <a href="#fig-cdplot-orings" class="quarto-xref">图&nbsp;<span>34.12</span></a> 展示航天飞机 O 型环在不同温度下失效的分布图（条件密度图）：随着温度升高，O 型环越来越不容易失效。请分别用 Base R 函数 <code><a href="https://rdrr.io/r/stats/glm.html">glm()</a></code> 和 <strong>cmdstanr</strong> 包建模分析 O 型环数据。</p>
<div class="cell">
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a><span class="co"># data(orings, package = "DAAG")</span></span>
<span id="cb47-2"><a href="#cb47-2"></a>orings <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">"data/orings.rds"</span>)</span>
<span id="cb47-3"><a href="#cb47-3"></a><span class="fu">ggplot</span>(orings, <span class="fu">aes</span>(<span class="at">x =</span> Temperature, <span class="at">y =</span> <span class="fu">after_stat</span>(count))) <span class="sc">+</span></span>
<span id="cb47-4"><a href="#cb47-4"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">fill =</span> Total <span class="sc">&gt;</span> <span class="dv">0</span>), <span class="at">position =</span> <span class="st">"fill"</span>, <span class="at">bw =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb47-5"><a href="#cb47-5"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_percent</span>()) <span class="sc">+</span></span>
<span id="cb47-6"><a href="#cb47-6"></a>  <span class="fu">scale_fill_grey</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"是"</span>, <span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"否"</span>)) <span class="sc">+</span></span>
<span id="cb47-7"><a href="#cb47-7"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb47-8"><a href="#cb47-8"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"温度"</span>, <span class="at">y =</span> <span class="st">"比例"</span>, <span class="at">fill =</span> <span class="st">"失效"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-cdplot-orings" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-cdplot-orings-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="generalized-linear-models_files/figure-html/fig-cdplot-orings-1.png" class="img-fluid figure-img" width="576">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cdplot-orings-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;34.12: 航天飞机 O 型环在不同温度下失效的条件密度图
</figcaption></figure>
</div>
</div>
</div>
</li>
<li>
<p>基于数据集 infert 分析自然流产和人工流产后的不育情况，</p>
<div class="cell">
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a>infert_glm <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb48-2"><a href="#cb48-2"></a>  case <span class="sc">~</span> age <span class="sc">+</span> parity <span class="sc">+</span> education <span class="sc">+</span> spontaneous <span class="sc">+</span> induced,</span>
<span id="cb48-3"><a href="#cb48-3"></a>  <span class="at">data =</span> infert, <span class="at">family =</span> <span class="fu">binomial</span>()</span>
<span id="cb48-4"><a href="#cb48-4"></a>)</span>
<span id="cb48-5"><a href="#cb48-5"></a><span class="fu">summary</span>(infert_glm)</span>
<span id="cb48-6"><a href="#cb48-6"></a></span>
<span id="cb48-7"><a href="#cb48-7"></a><span class="co"># conditional logistic regression</span></span>
<span id="cb48-8"><a href="#cb48-8"></a><span class="fu">library</span>(survival)</span>
<span id="cb48-9"><a href="#cb48-9"></a>infert_survival <span class="ot">&lt;-</span> <span class="fu">clogit</span>(</span>
<span id="cb48-10"><a href="#cb48-10"></a>  case <span class="sc">~</span> age <span class="sc">+</span> parity <span class="sc">+</span> education <span class="sc">+</span> spontaneous <span class="sc">+</span> induced <span class="sc">+</span> <span class="fu">strata</span>(stratum), <span class="at">data =</span> infert</span>
<span id="cb48-11"><a href="#cb48-11"></a>)</span>
<span id="cb48-12"><a href="#cb48-12"></a><span class="fu">summary</span>(infert_survival)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</li>
<li><p>根据 <a href="analyze-spatial-data.html" class="quarto-xref"><span>章节 28</span></a> 的数据，建立贝叶斯空间广义线性混合模型，用 Stan 预测核辐射强度的分布。</p></li>
</ol>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "已复制");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "已复制");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><script src="https://giscus.app/client.js" data-repo="XiangyunHuang/data-analysis-in-action" data-repo-id="R_kgDOGTNtPQ" data-category="General" data-category-id="DIC_kwDOGTNtPc4CQjXN" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script><input type="hidden" id="giscus-base-theme" value="light"><input type="hidden" id="giscus-alt-theme" value="dark"><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./probabilistic-reasoning-framework.html" class="pagination-link  aria-label=">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">概率推理框架</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./hierarchical-normal-models.html" class="pagination-link" aria-label="<span class='chapter-number'>35</span>&nbsp; <span class='chapter-title'>分层正态模型</span>">
        <span class="nav-page-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">分层正态模型</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/XiangyunHuang/data-analysis-in-action/blob/main/generalized-linear-models.qmd" class="toc-action"><i class="bi bi-github"></i>查看代码</a></li></ul></div></div></div></footer></body></html>