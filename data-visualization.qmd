# 数据可视化 {#sec-data-visualization .unnumbered}


```{r}
#| echo: false

knitr::knit_hooks$set(par = function(before, options, envir) {
  if (before && options$fig.show != "none") {
    par(
      mar = c(4, 4, .5, .5)
    )
  }
})

if (xfun::is_macos()) {
  # 准备 Noto 中英文字体
  sysfonts::font_paths(new = "~/Library/Fonts/")
  ## 宋体
  sysfonts::font_add(
    family = "Noto Serif CJK SC",
    regular = "NotoSerifCJKsc-Regular.otf",
    bold = "NotoSerifCJKsc-Bold.otf"
  )
  ## 黑体
  sysfonts::font_add(
    family = "Noto Sans CJK SC",
    regular = "NotoSansCJKsc-Regular.otf",
    bold = "NotoSansCJKsc-Bold.otf"
  )
} else { # Github Action Ubuntu
  sysfonts::font_paths(new = c(
    "/usr/share/fonts/opentype/noto/",
    "/usr/share/fonts/truetype/noto/"
  ))
  ## 宋体
  sysfonts::font_add(
    family = "Noto Serif CJK SC",
    regular = "NotoSerifCJK-Regular.ttc",
    bold = "NotoSerifCJK-Bold.ttc"
  )
  ## 黑体
  sysfonts::font_add(
    family = "Noto Sans CJK SC",
    regular = "NotoSansCJK-Regular.ttc",
    bold = "NotoSansCJK-Bold.ttc"
  )
}

## 衬线字体
sysfonts::font_add(
  family = "Noto Serif",
  regular = "NotoSerif-Regular.ttf",
  bold = "NotoSerif-Bold.ttf",
  italic = "NotoSerif-Italic.ttf",
  bolditalic = "NotoSerif-BoldItalic.ttf"
)
## 无衬线字体
sysfonts::font_add(
  family = "Noto Sans",
  regular = "NotoSans-Regular.ttf",
  bold = "NotoSans-Bold.ttf",
  italic = "NotoSans-Italic.ttf",
  bolditalic = "NotoSans-BoldItalic.ttf"
)
```


:::{.callout-tip}
其它小节完成后再写本节。
:::

数据可视化的主要目的有两个：其一是探索 Explore，其二是解释 Explain。

大多教科书侧重理论和方法，计算机强调编程，数值计算是精确的，图形是粗燥的。然而，只有模型和方法，缺乏数据探索的分析和建模，计算的结果和分析的结论可能是不正确的，数据可能在欺骗你[@Anscombe1973]。

[**datasauRus**](https://github.com/jumpingrivers/datasauRus) 包 [@datasauRus2022] 内置了一个数据集 datasaurus_dozen，它整合了 13 个子数据集，它们在均值、标准差等描述性统计量方面十分接近，见下 @tbl-datasaurus-summ 。其中 $\bar{x},\sigma_x$ 分别代表预测变量 $X$ 的均值和标准差，$\bar{y},\sigma_y$ 代表响应变量 $Y$ 的均值和标准差，$\beta_0,\beta_1$ 代表回归方程 @eq-datasaurus-lm 的截距和斜率，$R^2$ 代表模型拟合数据的程度。

$$
y = \beta_0 + \beta_1 x + \epsilon
$$ {#eq-datasaurus-lm}

```{r}
#| echo: false
#| label: tbl-datasaurus-summ
#| tbl-cap: "datasaurus_dozen 数据集的一些描述性统计量和线性回归结果"

data("datasaurus_dozen", package = "datasauRus")
library(data.table)
datasaurus_dozen <- as.data.table(datasaurus_dozen)
datasaurus_summ <- datasaurus_dozen[, cbind.data.frame(
  x_mean = mean(x),
  x_sd = sd(x),
  y_mean = mean(y),
  y_sd = sd(y),
  as.list(coef(lm(y ~ x))),
  r_squared = summary(lm(y ~ x))$r.squared #,
  # adj_r_squared = summary(lm(y ~ x))$adj.r.squared,
  # rse = sqrt(sum(residuals(lm(y ~ x))^2)/(.N - 2))
), by = .(dataset)]

knitr::kable(datasaurus_summ, col.names = c(
  "子数据集", "$\\bar{x}$", "$\\sigma_x$", "$\\bar{y}$", "$\\sigma_y$",
  "$\\beta_0$", "$\\beta_1$", "$R^2$" #, "调整的 $R^2$", "残差标准差"
), digits = 3, escape = FALSE)
```


诸多统计量都难以发现它们的差异，透过数据可视化这面照妖镜，却可以使数据的本来面目无所遁形，如 @fig-datasaurus-dozen 所示。可见，单个统计量就好比管窥蠡测，稍有不慎，我们就成了盲人摸象。


```{r}
#| label: fig-datasaurus-dozen
#| fig-cap: "数据可视化为何如此重要"
#| fig-width: 6
#| fig-height: 6
#| fig-showtext: true
#| echo: false

library(ggplot2)
ggplot(datasaurus_dozen, aes(x = x, y = y)) +
  geom_point(aes(colour = dataset), show.legend = FALSE) +
  facet_wrap(facets = ~dataset, ncol = 4) +
  theme_void() +
  theme(strip.text = element_blank())
```

数据可视化的重要性在于探索数据的真实分布，为数据建模提供假设和依据，也为验证、评估模型的效果。结合 @fig-datasaurus-dozen 也解释了为什么线性回归模型在解释数据方面的无能为力，即 $R^2$ 介于 0.004 至 0.005 之间，数据根本不符合线性模型的条件。


有时候是有的数据符合模型假设，而有的不符合，我们没有上帝之眼，看不到哪些符合哪些不符合。在数据集不多的情况下，可以全部展示出来，数据集很多的时候，可以抽样一部分，再展示。下面再举一个例子，anscombe 数据集来自 R 软件内置的 R 包 **datasets**，它包含四组数据 $(x_i, y_i), i =1,2,3,4$，如 @tbl-anscombe-datasets 所示。

```{r}
#| label: tbl-anscombe-datasets
#| tbl-cap: "anscombe 数据集"
#| echo: false

new_order <- unlist(lapply(1:4, function(x) paste(c("x", "y"), x, sep = "")))
# knitr::kable(anscombe[, new_order], booktabs = T) |>
#   kableExtra::kable_styling(
#     bootstrap_options = "basic",
#     full_width = F, position = "center"
#   ) |>
#   kableExtra::add_header_above(c(
#     "第1组" = 2, "第2组" = 2,
#     "第3组" = 2, "第4组" = 2
#   ))

# flextable::flextable(anscombe[, new_order]) |>
#   flextable::add_header_row(
#     colwidths = c(2, 2, 2, 2),
#     values = c("第1组", "第2组", "第3组", "第4组")
#   )

gt::gt(anscombe[, new_order]) |> 
  gt::tab_spanner(label = "第1组", columns = c("x1", "y1")) |> 
  gt::tab_spanner(label = "第2组", columns = c("x2", "y2")) |> 
  gt::tab_spanner(label = "第3组", columns = c("x3", "y3")) |> 
  gt::tab_spanner(label = "第4组", columns = c("x4", "y4"))
```

用统计的方法发现四组数据的样本均值、方差、相关系数和回归系数几乎是相同的，实际上，借助散点 @fig-anscombe 分别描述各组数据的关系时，却发现四组数据之间有极大的差异，且只有第一组数据看起来符合线性模型的条件 [@Anscombe1973]。

```{r}
#| label: fig-anscombe
#| echo: false
#| fig-cap: "数据可视化为何如此重要"
#| fig-subcap: 
#| - "第一组数据"
#| - "第二组数据"
#| - "第三组数据"
#| - "第四组数据"
#| fig-width: 3
#| fig-height: 3
#| fig-showtext: true
#| fig-ncol: 2

library(ggplot2)
data(anscombe)
p <- ggplot(data = anscombe) +
  theme_classic()
p +
  geom_point(aes(x = x1, y = y1), color = "#E41A1C") +
  geom_smooth(aes(x = x1, y = y1),
    color = "#E41A1C",
    formula = y ~ x, method = "lm", se = FALSE
  )

p +
  geom_point(aes(x = x2, y = y2), color = "#377EB8") +
  geom_smooth(aes(x = x2, y = y2),
    color = "#377EB8",
    formula = y ~ x, method = "lm", se = FALSE
  )
p +
  geom_point(aes(x = x3, y = y3), color = "#4DAF4A") +
  geom_smooth(aes(x = x3, y = y3),
    color = "#4DAF4A",
    formula = y ~ x, method = "lm", se = FALSE
  )
p +
  geom_point(aes(x = x4, y = y4), color = "#984EA3") +
  geom_smooth(aes(x = x4, y = y4),
    color = "#984EA3",
    formula = y ~ x, method = "lm", se = FALSE
  )
```

图形还告诉我们第二组数据的更适合二次非线性回归，第三组数据受到离群点的重大影响，第四组数据自变量只有两个取值，像是两个分布按不同比例混合的结果。
