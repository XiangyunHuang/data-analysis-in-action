<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-Hans" xml:lang="zh-Hans"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.527">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>R 语言数据分析实战 - 33&nbsp; 概率推理框架</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./generalized-linear-models.html" rel="next">
<link href="./optimization-problems.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "没有结果",
    "search-matching-documents-text": "匹配的文档",
    "search-copy-link-title": "复制搜索链接",
    "search-hide-matches-text": "隐藏其它匹配结果",
    "search-more-match-text": "更多匹配结果",
    "search-more-matches-text": "更多匹配结果",
    "search-clear-button-title": "清除",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "取消",
    "search-submit-button-title": "提交",
    "search-label": "搜索"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-ZPWJBMKFL8"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-ZPWJBMKFL8', { 'anonymize_ip': true});
</script><script>
MathJax ={
  tex: {
    macros: {
      bm: ["{\\boldsymbol #1}",1],
    }
  }
};
</script><script src="site_libs/quarto-diagram/mermaid.min.js"></script><script src="site_libs/quarto-diagram/mermaid-init.js"></script><link href="site_libs/quarto-diagram/mermaid.css" rel="stylesheet">
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="切换侧边栏导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./probabilistic-reasoning-framework.html">贝叶斯建模</a></li><li class="breadcrumb-item"><a href="./probabilistic-reasoning-framework.html"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">概率推理框架</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="切换侧边栏导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R 语言数据分析实战</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/XiangyunHuang/data-analysis-in-action" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <a href="./_main.pdf" title="Download PDF" class="quarto-navigation-tool px-1" aria-label="Download PDF"><i class="bi bi-file-pdf"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="切换深色模式"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="搜索"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">欢迎</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">前言</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">介绍</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">数据准备</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling-objects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">数据对象</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling-collection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">数据获取</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling-cleaning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">数据清洗</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling-manipulation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">数据操作</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling-processing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">数据处理</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">数据探索</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-basic.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">ggplot2 入门</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-intermediate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">基础图形</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-advanced.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">统计图形</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-lattice.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">lattice 入门</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-graphics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">graphics 入门</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-tikz.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">TikZ 入门</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./visualization-practice.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">探索实践</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">数据交流</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interactive-graphics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">交互图形</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interactive-tables.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">交互表格</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interactive-applications.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">交互应用</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./documents-html.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">HTML 文档</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./documents-latex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">PDF 文档</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./documents-office.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Office 文档</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">统计分析</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./common-statistical-tests.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">常见的统计检验</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regression-and-correlation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">回归与相关分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./categorical-data-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">分类数据的分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./power-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">统计检验的功效</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">数据建模</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-network-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">网络分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-text-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">文本分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-survival-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">生存分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-time-series-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">时序分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-point-pattern.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">空间点模式分析</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-spatial-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">预测核辐射强度的分布</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analyze-areal-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">区域数据分析</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">优化建模</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./statistical-computation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">统计计算</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./numerical-optimization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">数值优化</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./optimization-problems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">优化问题</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
 <span class="menu-text">贝叶斯建模</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./probabilistic-reasoning-framework.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">概率推理框架</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./generalized-linear-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">广义线性模型</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hierarchical-normal-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">分层正态模型</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mixed-effects-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">混合效应模型</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./generalized-additive-models.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">广义可加模型</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gaussian-processes-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">高斯过程回归</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./time-series-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">时间序列回归</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true">
 <span class="menu-text">机器学习</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./classification-problems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">分类问题</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./clustering-problems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">聚类问题</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./regression-problems.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">回归问题</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">参考文献</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true">
 <span class="menu-text">附录</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./notations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">数学符号</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./matrix-operations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">矩阵运算</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./git-github.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Git 和 Github</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">目录</h2>
   
  <ul>
<li><a href="#sec-stan-overview" id="toc-sec-stan-overview" class="nav-link active" data-scroll-target="#sec-stan-overview"><span class="header-section-number">33.1</span> Stan 概览</a></li>
  <li>
<a href="#sec-getting-started" id="toc-sec-getting-started" class="nav-link" data-scroll-target="#sec-getting-started"><span class="header-section-number">33.2</span> Stan 入门</a>
  <ul class="collapse">
<li><a href="#sec-stan-syntax" id="toc-sec-stan-syntax" class="nav-link" data-scroll-target="#sec-stan-syntax"><span class="header-section-number">33.2.1</span> Stan 的基础语法</a></li>
  <li><a href="#sec-stan-variables" id="toc-sec-stan-variables" class="nav-link" data-scroll-target="#sec-stan-variables"><span class="header-section-number">33.2.2</span> Stan 的变量类型</a></li>
  <li><a href="#sec-stan-code" id="toc-sec-stan-code" class="nav-link" data-scroll-target="#sec-stan-code"><span class="header-section-number">33.2.3</span> Stan 的代码结构</a></li>
  <li><a href="#sec-stan-function" id="toc-sec-stan-function" class="nav-link" data-scroll-target="#sec-stan-function"><span class="header-section-number">33.2.4</span> Stan 的函数使用</a></li>
  </ul>
</li>
  <li>
<a href="#sec-choose-prior" id="toc-sec-choose-prior" class="nav-link" data-scroll-target="#sec-choose-prior"><span class="header-section-number">33.3</span> 先验分布</a>
  <ul class="collapse">
<li><a href="#sec-prior-normal" id="toc-sec-prior-normal" class="nav-link" data-scroll-target="#sec-prior-normal"><span class="header-section-number">33.3.1</span> 正态先验</a></li>
  <li><a href="#sec-prior-lasso" id="toc-sec-prior-lasso" class="nav-link" data-scroll-target="#sec-prior-lasso"><span class="header-section-number">33.3.2</span> Lasso 先验</a></li>
  <li><a href="#sec-prior-horseshoe" id="toc-sec-prior-horseshoe" class="nav-link" data-scroll-target="#sec-prior-horseshoe"><span class="header-section-number">33.3.3</span> Horseshoe 先验</a></li>
  <li><a href="#sec-prior-spikeslab" id="toc-sec-prior-spikeslab" class="nav-link" data-scroll-target="#sec-prior-spikeslab"><span class="header-section-number">33.3.4</span> SpikeSlab 先验</a></li>
  </ul>
</li>
  <li>
<a href="#sec-choose-inference" id="toc-sec-choose-inference" class="nav-link" data-scroll-target="#sec-choose-inference"><span class="header-section-number">33.4</span> 推理算法</a>
  <ul class="collapse">
<li><a href="#sec-optimization-algorithms" id="toc-sec-optimization-algorithms" class="nav-link" data-scroll-target="#sec-optimization-algorithms"><span class="header-section-number">33.4.1</span> 惩罚极大似然算法</a></li>
  <li><a href="#sec-variational-approximation-algorithms" id="toc-sec-variational-approximation-algorithms" class="nav-link" data-scroll-target="#sec-variational-approximation-algorithms"><span class="header-section-number">33.4.2</span> 变分近似推断算法</a></li>
  <li><a href="#sec-laplace-approximation-algorithms" id="toc-sec-laplace-approximation-algorithms" class="nav-link" data-scroll-target="#sec-laplace-approximation-algorithms"><span class="header-section-number">33.4.3</span> 拉普拉斯近似算法</a></li>
  <li><a href="#sec-pathfinder-algorithms" id="toc-sec-pathfinder-algorithms" class="nav-link" data-scroll-target="#sec-pathfinder-algorithms"><span class="header-section-number">33.4.4</span> 探路者变分算法</a></li>
  </ul>
</li>
  <li><a href="#%E4%B9%A0%E9%A2%98" id="toc-习题" class="nav-link" data-scroll-target="#%E4%B9%A0%E9%A2%98"><span class="header-section-number">33.5</span> 习题</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/XiangyunHuang/data-analysis-in-action/blob/main/probabilistic-reasoning-framework.qmd" class="toc-action"><i class="bi bi-github"></i>查看代码</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./probabilistic-reasoning-framework.html">贝叶斯建模</a></li><li class="breadcrumb-item"><a href="./probabilistic-reasoning-framework.html"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">概率推理框架</span></a></li></ol></nav><div class="quarto-title">
<h1 class="title"><span id="sec-probabilistic-reasoning-framework" class="quarto-section-identifier"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">概率推理框架</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><div class="hidden">
<p><span class="math display">\[
\def\bm#1{{\boldsymbol #1}}
\]</span></p>
</div>
<p>本章的目的是让读者快速熟悉和上手，主要分为以下几个部分。</p>
<ol type="1">
<li>Stan 的概览，介绍 Stan 是什么，怎么样。</li>
<li>Stan 的入门，以推理一个正态分布均值参数为例，从基础语法、类型声明和代码结构三个方面介绍 Stan 的使用。</li>
<li>选择先验分布，先验分布在贝叶斯推理中的重要性不言而喻，本节以一个简单的广义线性模型为例，介绍常见的几个先验分布对模型的影响。</li>
<li>选择推理算法，接上一节的例子，围绕怎么用、效果如何介绍 Stan 内置的几个推理算法。</li>
</ol>
<section id="sec-stan-overview" class="level2" data-number="33.1"><h2 data-number="33.1" class="anchored" data-anchor-id="sec-stan-overview">
<span class="header-section-number">33.1</span> Stan 概览</h2>
<p><a href="https://github.com/stan-dev">Stan</a> 是一个贝叶斯统计建模和计算的概率推理框架，也是一门用于贝叶斯推断和优化的概率编程语言 <span class="citation" data-cites="Gelman2015 Carpenter2017">(<a href="references.html#ref-Gelman2015" role="doc-biblioref">Gelman, Lee, 和 Guo 2015</a>; <a href="references.html#ref-Carpenter2017" role="doc-biblioref">Carpenter 等 2017</a>)</span>。它使用汉密尔顿蒙特卡罗算法（Hamiltonian Monte Carlo algorithm ，简称 HMC 算法）抽样，内置一种可以自适应调整采样步长的 No-U-Turn sampler （简称 NUTS 采样器） 。Stan 还提供自动微分变分推断（Automatic Differentiation Variational Inference algorithm 简称 ADVI 算法）算法做近似贝叶斯推断获取参数的后验分布，以及拟牛顿法（the limited memory Broyden-Fletcher-Goldfarb-Shanno algorithm 简称 L-BFGS 算法）优化算法获取参数的惩罚极大似然估计。</p>
<p>经过 10 多年的发展，Stan 已经形成一个相对成熟的生态，它提供统计建模、数据分析和预测能力，广泛应用于社会、生物、物理、工程、商业等领域，在学术界和工业界的影响力也不小。下 <a href="#fig-stan-api" class="quarto-xref">图&nbsp;<span>33.1</span></a> 是 Stan 生态中各组件依赖架构图，<a href="https://github.com/stan-dev/math">math</a> 库<span class="citation" data-cites="Carpenter2015">(<a href="references.html#ref-Carpenter2015" role="doc-biblioref">Carpenter 等 2015</a>)</span>是 Stan 框架最核心的组件，它基于 <a href="https://github.com/boostorg/boost">Boost</a> 、<a href="https://gitlab.com/libeigen/eigen">Eigen</a> 、<a href="https://www.khronos.org/opencl/">OpenCL</a> 、<a href="https://github.com/LLNL/sundials">SUNDIALS</a> 和 <a href="https://github.com/oneapi-src/oneTBB">oneTBB</a> 等诸多 C++ 库，提供概率推理、自动微分、矩阵计算、并行计算、GPU 计算和求解代数微分方程等功能。</p>
<div class="cell" data-fig-width="6.5" data-layout-align="default">
<div class="cell-output-display">
<div id="fig-stan-api" class="quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-stan-api-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<pre class="mermaid mermaid-js" data-label="fig-stan-api">flowchart TB
  Boost(Boost) --&gt; math(math)
  Eigen(Eigen) --&gt; math(math)
  OpenCL(OpenCL) --&gt; math(math)
  SUNDIALS(SUNDIALS) --&gt; math(math)
  oneTBB(oneTBB) --&gt; math(math)
  math(math) --&gt; Stan(Stan)
  Stan(Stan) --&gt; CmdStan(CmdStan)
  Stan(Stan) --&gt; RStan(RStan)
  RStan --&gt; rstanarm(rstanarm)
  RStan --&gt; brms(brms)
  RStan --&gt; prophet(prophet)
  CmdStan --&gt; CmdStanR(CmdStanR)
  CmdStan --&gt; CmdStanPy(CmdStanPy)
  CmdStan --&gt; MathematicaStan(MathematicaStan)
  CmdStanR --&gt; bayesplot(bayesplot)
  CmdStanR --&gt; loo(loo)
  CmdStanR --&gt; posterior(posterior)
  CmdStanR --&gt; projpred(projpred)
</pre>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stan-api-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;33.1: Stan、CmdStan 和 CmdStanR 等的依赖关系图
</figcaption></figure>
</div>
</div>
</div>
<p>CmdStan 是 Stan 的命令行接口，可在 MacOS / Linux 的终端软件，Windows 的命令行窗口或 PowerShell 软件中使用。<strong>CmdStanR</strong> <span class="citation" data-cites="Gabry2023">(<a href="references.html#ref-Gabry2023" role="doc-biblioref">Gabry, Češnovar, 和 Johnson 2023</a>)</span><strong>、</strong>CmdStanPy 和 MathematicaStan 分别是 CmdStan 的 R 语言、Python 语言和 Mathematica 语言接口。每次当 Stan 发布新版本时，CmdStan 也会随之发布新版，只需指定新的 CmdStan 安装路径，<strong>CmdStanR</strong> 就可以使用上，<strong>CmdStanR</strong> 包与 Stan 是相互独立的更新机制。 <strong>CmdStanR</strong> 负责处理 CmdStan 运行的结果，而编译代码，生成模型和模拟采样等都是由 <strong>CmdStan 完成</strong>。入门 <strong>CmdStanR</strong> 后，可以快速转入对 Stan 底层原理的学习，有利于编码符合实际需要的复杂模型，有利于掌握常用的炼丹技巧，提高科研和工作的效率。</p>
<p>此外，<strong>bayesplot</strong> 包 <span class="citation" data-cites="Gabry2019">(<a href="references.html#ref-Gabry2019" role="doc-biblioref">Gabry 等 2019</a>)</span> 针对 cmdstanr 包生成的拟合模型对象提供一系列可视化图形，用于诊断采样过程、展示后验分布等。<strong>loo</strong> 包<span class="citation" data-cites="Vehtari2017">(<a href="references.html#ref-Vehtari2017" role="doc-biblioref">Vehtari, Gelman, 和 Gabry 2017</a>)</span>计算 LOOIC （留一交叉验证信息准则）和 WAIC （通用信息准则）等指标，用于模型评估与比较。<strong>posterior</strong> 包 <span class="citation" data-cites="Vehtari2021">(<a href="references.html#ref-Vehtari2021" role="doc-biblioref">Vehtari 等 2021</a>)</span> 对采样数据提供统一的操作方法和类型转化，计算常用的后验分布的统计量等。<strong>projpred</strong> 包 <span class="citation" data-cites="Piironen2017b Piironen2020">(<a href="references.html#ref-Piironen2017b" role="doc-biblioref">Piironen 和 Vehtari 2017a</a>; <a href="references.html#ref-Piironen2020" role="doc-biblioref">Piironen, Paasiniemi, 和 Vehtari 2020</a>)</span> 实现投影预测推断用于模型预测和特征选择。</p>
<p><a href="https://github.com/stan-dev/rstan"><strong>rstan</strong></a> 包<span class="citation" data-cites="RStan2023">(<a href="references.html#ref-RStan2023" role="doc-biblioref">Stan Development Team 2023a</a>)</span>是 Stan 的 R 语言接口，该接口依赖 <strong>Rcpp</strong> <span class="citation" data-cites="Rcpp2011 Rcpp2018">(<a href="references.html#ref-Rcpp2011" role="doc-biblioref">Eddelbuettel 和 François 2011</a>; <a href="references.html#ref-Rcpp2018" role="doc-biblioref">Eddelbuettel 和 Balamuta 2018</a>)</span>、<strong>RcppEigen</strong> <span class="citation" data-cites="Bates2013">(<a href="references.html#ref-Bates2013" role="doc-biblioref">Bates 和 Eddelbuettel 2013</a>)</span>、<strong>BH</strong> <span class="citation" data-cites="BH2023">(<a href="references.html#ref-BH2023" role="doc-biblioref">Eddelbuettel, Emerson, 和 Kane 2023</a>)</span>、<strong>RcppParallel</strong> <span class="citation" data-cites="RcppParallel2023">(<a href="references.html#ref-RcppParallel2023" role="doc-biblioref">Allaire 等 2023</a>)</span>和 <strong>StanHeaders</strong> <span class="citation" data-cites="StanHeaders2023">(<a href="references.html#ref-StanHeaders2023" role="doc-biblioref">Stan Development Team 2023b</a>)</span>等 R 包，由于存在众多上游 R 包依赖和兼容性问题，尤其在 Windows 系统环境中，因此，<strong>RStan 的</strong>安装、更新都比较麻烦。<strong>RStan</strong> 的更新通常严重滞后于 Stan 的更新，不利于及时地使用最新的学术研究成果。 而相比于 <strong>rstan</strong> 包，<strong>CmdStanR</strong> 更加轻量，可以更快地将 CmdStan 的新功能融入进来，而且 <strong>cmdstanr</strong> 和 CmdStan 是分离的，方便用户升级和维护。</p>
<p><a href="https://github.com/stan-dev/rstanarm"><strong>rstanarm</strong></a> <span class="citation" data-cites="Goodrich2023">(<a href="references.html#ref-Goodrich2023" role="doc-biblioref">Goodrich 等 2023</a>)</span> 和 <a href="https://github.com/paul-buerkner/brms"><strong>brms</strong></a> <span class="citation" data-cites="brms2017">(<a href="references.html#ref-brms2017" role="doc-biblioref">Bürkner 2017</a>)</span> 是 <strong>RStan</strong> 的扩展包，各自提供了一套用于表示统计模型的公式语法。它们都支持丰富的统计模型，比如线性模型、广义线性模型、线性混合效应模型、广义线性混合效应模型等。相比于 <strong>rstan</strong>， 它们使用起来更加方便，因为它内置了大量统计模型的 Stan 实现，即将公式语法翻译成 Stan 编码的模型，然后调用 <strong>rstan</strong> 或 <strong>cmdstanr</strong> 翻译成 C++，最后编译成动态链接库。除了依赖 <strong>rstan</strong> 包，<strong>rstanarm</strong> 和 <strong>brms</strong> 还依赖大量其它 R 包。</p>
<p>顺便一提，类似的用于概率推理和统计分析的框架，还有 Python 社区的 <a href="https://github.com/pymc-devs/pymc">PyMC</a> <span class="citation" data-cites="pymc2023">(<a href="references.html#ref-pymc2023" role="doc-biblioref">Abril-Pla O 2023</a>)</span>和 <a href="https://github.com/tensorflow/probability">TensorFlow Probability</a> <span class="citation" data-cites="Dillon2017">(<a href="references.html#ref-Dillon2017" role="doc-biblioref">Joshua V. Dillon 2017</a>)</span>，它们采用的 MCMC 采样算法也是基于 NUTS 的 HMC 算法。</p>
</section><section id="sec-getting-started" class="level2" data-number="33.2"><h2 data-number="33.2" class="anchored" data-anchor-id="sec-getting-started">
<span class="header-section-number">33.2</span> Stan 入门</h2>
<section id="sec-stan-syntax" class="level3" data-number="33.2.1"><h3 data-number="33.2.1" class="anchored" data-anchor-id="sec-stan-syntax">
<span class="header-section-number">33.2.1</span> Stan 的基础语法</h3>
<p>下面以一个简单示例介绍 Stan 的用法，包括 Stan 的基本用法、变量类型、代码结构等，</p>
<p>考虑一个已知方差的正态分布，设 <span class="math inline">\(-3, -2, -1, 0, 1, 2, 3\)</span> 是取自正态分布 <span class="math inline">\(\mathcal{N}(\mu,1)\)</span> 的一个样本，也是取自该正态分布的一组随机数。现在的问题是估计该正态分布的均值参数 <span class="math inline">\(\mu\)</span> 。Stan 编码的正态分布模型如下：</p>
<div class="cell" data-output.var="mod_gaussian">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">transformed data</span> {</span>
<span id="cb1-2"><a href="#cb1-2"></a>  <span class="dt">vector</span>[<span class="dv">7</span>] y = [-<span class="dv">3</span>, -<span class="dv">2</span>, -<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>]';</span>
<span id="cb1-3"><a href="#cb1-3"></a>}</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="kw">parameters</span> {</span>
<span id="cb1-5"><a href="#cb1-5"></a>  <span class="dt">real</span> mu;</span>
<span id="cb1-6"><a href="#cb1-6"></a>}</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="kw">model</span> {</span>
<span id="cb1-8"><a href="#cb1-8"></a>  y ~ normal(mu, <span class="dv">1</span>);</span>
<span id="cb1-9"><a href="#cb1-9"></a>}</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p><code>transformed data</code> 代码块是一组已知的数据，这部分数据是不需要从外部传递进来的。这个样本是以向量存储的，需要声明向量的长度和类型（默认类型是实数），每一行以分号结尾，这与 C++ 的语法一样。</p></li>
<li><p><code>parameters</code> 代码块是未知的参数，需要声明各个参数的类型。这里只有一个参数，且只是一个未知的实数，声明类型即可。</p></li>
<li><p><code>model</code> 代码块是抽样语句表示的模型结构，符号 <code>~</code> 表示服从的意思，函数 <code>y ~ normal(mu, 1)</code> 是正态分布的抽样语句。</p></li>
</ul>
<p>接下来，编译 Stan 代码，准备参数初值，配置采样的参数。首先加载 <strong>cmdstanr</strong> 包，设置 2 条迭代链，给每条链设置相同的参数初始值。代码编译后，生成一个模型对象 <code>mod_gaussian</code>，接着，调用方法 <code><a href="https://rdrr.io/r/base/sample.html">sample()</a></code> ，传递迭代初值 <code>init</code>，初始化阶段的迭代次数 <code>iter_warmup</code> ，采样阶段的迭代次数 <code>iter_sampling</code>，采样的链条数 <code>chains</code> 及并行时 分配的 CPU 核心数 <code>parallel_chains</code> ，随机数种子 <code>seed</code> 。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb2-2"><a href="#cb2-2"></a>nchains <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co"># 2 条迭代链</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co"># 给每条链设置相同的参数初始值</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>inits_data_gaussian <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>nchains, <span class="cf">function</span>(i) {</span>
<span id="cb2-5"><a href="#cb2-5"></a>  <span class="fu">list</span>(</span>
<span id="cb2-6"><a href="#cb2-6"></a>    <span class="at">mu =</span> <span class="dv">1</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>  )</span>
<span id="cb2-8"><a href="#cb2-8"></a>})</span>
<span id="cb2-9"><a href="#cb2-9"></a></span>
<span id="cb2-10"><a href="#cb2-10"></a>fit_gaussian <span class="ot">&lt;-</span> mod_gaussian<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb2-11"><a href="#cb2-11"></a>  <span class="at">init =</span> inits_data_gaussian,   <span class="co"># 迭代初值</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>  <span class="at">iter_warmup =</span> <span class="dv">200</span>,            <span class="co"># 每条链初始化迭代次数</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>  <span class="at">iter_sampling =</span> <span class="dv">200</span>,          <span class="co"># 每条链采样迭代次数</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>  <span class="at">chains =</span> nchains,         <span class="co"># 马尔科夫链的数目</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>  <span class="at">parallel_chains =</span> nchains,<span class="co"># 指定 CPU 核心数，可以给每条链分配一个</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>  <span class="at">seed =</span> <span class="dv">20232023</span>           <span class="co"># 设置随机数种子，不要使用 set.seed() 函数</span></span>
<span id="cb2-17"><a href="#cb2-17"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Running MCMC with 2 parallel chains...
#&gt; 
#&gt; Chain 1 Iteration:   1 / 400 [  0%]  (Warmup) 
#&gt; Chain 1 Iteration: 100 / 400 [ 25%]  (Warmup) 
#&gt; Chain 1 Iteration: 200 / 400 [ 50%]  (Warmup) 
#&gt; Chain 1 Iteration: 201 / 400 [ 50%]  (Sampling) 
#&gt; Chain 1 Iteration: 300 / 400 [ 75%]  (Sampling) 
#&gt; Chain 1 Iteration: 400 / 400 [100%]  (Sampling) 
#&gt; Chain 2 Iteration:   1 / 400 [  0%]  (Warmup) 
#&gt; Chain 2 Iteration: 100 / 400 [ 25%]  (Warmup) 
#&gt; Chain 2 Iteration: 200 / 400 [ 50%]  (Warmup) 
#&gt; Chain 2 Iteration: 201 / 400 [ 50%]  (Sampling) 
#&gt; Chain 2 Iteration: 300 / 400 [ 75%]  (Sampling) 
#&gt; Chain 2 Iteration: 400 / 400 [100%]  (Sampling) 
#&gt; Chain 1 finished in 0.0 seconds.
#&gt; Chain 2 finished in 0.0 seconds.
#&gt; 
#&gt; Both chains finished successfully.
#&gt; Mean chain execution time: 0.0 seconds.
#&gt; Total execution time: 0.3 seconds.</code></pre>
</div>
</div>
<p>默认情况下，采样过程中会输出一些信息，以上是 2 条链并行采样的过程，给出百分比进度及时间消耗。采样完成后，调用方法 <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> 汇总和展示采样结果。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>fit_gaussian<span class="sc">$</span><span class="fu">summary</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 2 × 10
#&gt;   variable     mean   median    sd   mad      q5     q95  rhat ess_bulk ess_tail
#&gt;   &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
#&gt; 1 lp__     -14.4    -14.2    0.708 0.212 -15.6   -14.0    1.01     177.     220.
#&gt; 2 mu         0.0365   0.0307 0.348 0.298  -0.511   0.572  1.01     229.     173.</code></pre>
</div>
</div>
<p>输出模型中各个参数的后验分布的一些统计量，如均值（mean）、中位数（median）、标准差（sd），0.05 分位点（q5），0.95 分位点（q95）等。此外，还有 <code>lp__</code> 后验对数概率密度值，每个模型都会有该值。<code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> 方法有一些参数可以控制数字的显示方式和精度。下面展示的是保留 4 位有效数字的结果。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>fit_gaussian<span class="sc">$</span><span class="fu">summary</span>(<span class="at">.num_args =</span> <span class="fu">list</span>(<span class="at">sigfig =</span> <span class="dv">4</span>, <span class="at">notation =</span> <span class="st">"dec"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 2 × 10
#&gt;   variable      mean    median     sd    mad       q5      q95  rhat ess_bulk
#&gt;   &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
#&gt; 1 lp__     -14.43    -14.15    0.7083 0.2118 -15.60   -14.00   1.007    177.2
#&gt; 2 mu         0.03647   0.03073 0.3476 0.2978  -0.5115   0.5722 1.007    229.0
#&gt; # ℹ 1 more variable: ess_tail &lt;dbl&gt;</code></pre>
</div>
</div>
<p>接下来，要介绍 Stan 代码中的保留字 target 的含义，因为它在 Stan 代码中很常见，与输出结果中的 <code>lp__</code> 一行紧密相关。</p>
<ul>
<li>
<code>lp__</code> 表示后验概率密度函数的对数。</li>
<li>target 累加一些和参数无关的数不影响参数的估计，但影响 <code>lp__</code> 的值。</li>
<li>抽样语句表示模型会扔掉后验概率密度函数的对数的常数项。</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="fu">mcmc_hist</span>(fit_gaussian<span class="sc">$</span><span class="fu">draws</span>(<span class="st">"lp__"</span>)) <span class="sc">+</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>  <span class="fu">theme_classic</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-stan-lp" class="quarto-figure quarto-figure-center anchored" width="480">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-stan-lp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="probabilistic-reasoning-framework_files/figure-html/fig-stan-lp-1.png" class="img-fluid figure-img" width="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stan-lp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;33.2: lp__ 的后验分布
</figcaption></figure>
</div>
</div>
</div>
<p>为此，不妨在之前的 Stan 代码的基础上添加两行，新的 Stan 代码如下：</p>
<div class="cell" data-output.var="mod_gaussian_target">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">transformed data</span> {</span>
<span id="cb9-2"><a href="#cb9-2"></a>  <span class="dt">vector</span>[<span class="dv">7</span>] y = [-<span class="dv">3</span>, -<span class="dv">2</span>, -<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>]';</span>
<span id="cb9-3"><a href="#cb9-3"></a>}</span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="kw">parameters</span> {</span>
<span id="cb9-5"><a href="#cb9-5"></a>  <span class="dt">real</span> mu;</span>
<span id="cb9-6"><a href="#cb9-6"></a>}</span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="kw">model</span> {</span>
<span id="cb9-8"><a href="#cb9-8"></a>  y ~ normal(mu, <span class="dv">1</span>);</span>
<span id="cb9-9"><a href="#cb9-9"></a>  <span class="kw">target +=</span> <span class="dv">12345</span>;</span>
<span id="cb9-10"><a href="#cb9-10"></a>  <span class="kw">target +=</span> mean(exp(y));</span>
<span id="cb9-11"><a href="#cb9-11"></a>}</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>接着，再次编译代码、采样，为了节约篇幅，设置两个参数 <code>show_messages</code> 和 <code>refresh</code> ，不显示中间过程和采样进度。其它参数设置不变，代码如下：</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>fit_gaussian <span class="ot">&lt;-</span> mod_gaussian_target<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb10-2"><a href="#cb10-2"></a>  <span class="at">init =</span> inits_data_gaussian,   </span>
<span id="cb10-3"><a href="#cb10-3"></a>  <span class="at">iter_warmup =</span> <span class="dv">200</span>,            </span>
<span id="cb10-4"><a href="#cb10-4"></a>  <span class="at">iter_sampling =</span> <span class="dv">200</span>,          </span>
<span id="cb10-5"><a href="#cb10-5"></a>  <span class="at">chains =</span> nchains,             </span>
<span id="cb10-6"><a href="#cb10-6"></a>  <span class="at">parallel_chains =</span> nchains,      </span>
<span id="cb10-7"><a href="#cb10-7"></a>  <span class="at">show_messages =</span> <span class="cn">FALSE</span>,    <span class="co"># 不显示中间过程</span></span>
<span id="cb10-8"><a href="#cb10-8"></a>  <span class="at">refresh =</span> <span class="dv">0</span>,              <span class="co"># 不显示采样进度</span></span>
<span id="cb10-9"><a href="#cb10-9"></a>  <span class="at">seed =</span> <span class="dv">20232023</span>           </span>
<span id="cb10-10"><a href="#cb10-10"></a>)</span>
<span id="cb10-11"><a href="#cb10-11"></a>fit_gaussian<span class="sc">$</span><span class="fu">summary</span>(<span class="at">.num_args =</span> <span class="fu">list</span>(<span class="at">sigfig =</span> <span class="dv">4</span>, <span class="at">notation =</span> <span class="st">"dec"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 2 × 10
#&gt;   variable        mean      median     sd    mad         q5        q95  rhat
#&gt;   &lt;chr&gt;          &lt;dbl&gt;       &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt;
#&gt; 1 lp__     12335.      12335.      0.7074 0.1483 12334.     12336.     1.008
#&gt; 2 mu           0.03647     0.03073 0.3476 0.2978    -0.5115     0.5722 1.007
#&gt; # ℹ 2 more variables: ess_bulk &lt;dbl&gt;, ess_tail &lt;dbl&gt;</code></pre>
</div>
</div>
<p>可以清楚地看到 <code>lp__</code> 的值发生了变化，而参数 <code>mu</code> 的值没有变化。这是因为抽样语句 <code>y ~ normal(mu, 1);</code> 隐含一个 <code>lp__</code> ，target 指代 <code>lp__</code> 的值，符号 <code>+=</code> 表示累加。两次累加后得到 12335.09。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">model</span> {</span>
<span id="cb12-2"><a href="#cb12-2"></a>  y ~ normal(mu, <span class="dv">1</span>);</span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="kw">target +=</span> <span class="dv">12345</span>;</span>
<span id="cb12-4"><a href="#cb12-4"></a>  <span class="kw">target +=</span> mean(exp(y));</span>
<span id="cb12-5"><a href="#cb12-5"></a>}</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>y <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="sc">-</span><span class="dv">2</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="dv">12345</span> <span class="sc">+</span> <span class="fu">mean</span>(<span class="fu">exp</span>(y)) <span class="sc">-</span> <span class="fl">14.45</span> </span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 12335.09</code></pre>
</div>
</div>
<p>下面从概率密度函数出发，用 R 语言来计算逐点对数似然函数值。一般地，不妨设 <span class="math inline">\(x_1,x_2,\cdots,x_n\)</span> 是来自正态总体 <span class="math inline">\(\mathcal{N}(\mu,1)\)</span> 的一个样本。则正态分布的概率密度函数 <span class="math inline">\(f(x)\)</span> 的对数如下：</p>
<p><span class="math display">\[
\log f(x) = \log \frac{1}{\sqrt{2\pi}} - \frac{(x - \mu)^2}{2}
\]</span></p>
<p>已知参数 <span class="math inline">\(\mu\)</span> 是一个非常接近 0 的数，不妨将 <span class="math inline">\(\mu = 0\)</span> 代入计算。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">sum</span>(<span class="fu">dnorm</span>(<span class="at">x =</span> y, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>, <span class="at">log =</span> <span class="cn">TRUE</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] -20.43257</code></pre>
</div>
</div>
<p>去掉常数项后，计算概率密度函数值的对数和。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="co"># 扔掉常数</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(y, mu) {</span>
<span id="cb17-3"><a href="#cb17-3"></a>  <span class="fu">return</span>(<span class="sc">-</span><span class="fl">0.5</span> <span class="sc">*</span> (y <span class="sc">-</span> mu)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb17-4"><a href="#cb17-4"></a>}</span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="fu">sum</span>(<span class="fu">f</span>(<span class="sc">-</span><span class="dv">3</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">0</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] -14</code></pre>
</div>
</div>
<p>这就比较接近原 <code>lp__</code> 的值了，所以，<code>lp__</code> 表示后验概率密度函数的对数，扔掉了与参数无关的常数项。若以概率密度函数的对数 <code>normal_lpdf</code> 替代抽样语句，则常数项是保留的。<code>normal_lpdf</code> 是 Stan 内置的函数，输入值为随机变量的取值 <code>y</code> 、位置参数 <code>mu</code> 和尺度参数 <code>sigma</code>，返回值为 <code>real</code> 实数。</p>
<p><code>real</code> <strong><code>normal_lpdf</code></strong><code>(reals y | reals mu, reals sigma)</code></p>
<div class="cell" data-output.var="mod_gaussian_lpdf">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw">transformed data</span> {</span>
<span id="cb19-2"><a href="#cb19-2"></a>  <span class="dt">vector</span>[<span class="dv">7</span>] y = [-<span class="dv">3</span>, -<span class="dv">2</span>, -<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>]';</span>
<span id="cb19-3"><a href="#cb19-3"></a>}</span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="kw">parameters</span> {</span>
<span id="cb19-5"><a href="#cb19-5"></a>  <span class="dt">real</span> mu;</span>
<span id="cb19-6"><a href="#cb19-6"></a>}</span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="kw">model</span> {</span>
<span id="cb19-8"><a href="#cb19-8"></a>  <span class="kw">target +=</span> normal_lpdf(y | mu, <span class="dv">1</span>);</span>
<span id="cb19-9"><a href="#cb19-9"></a>}</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>接着，编译上述代码以及重复采样的步骤，参数设置也一样。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>fit_gaussian <span class="ot">&lt;-</span> mod_gaussian_lpdf<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb20-2"><a href="#cb20-2"></a>  <span class="at">init =</span> inits_data_gaussian, </span>
<span id="cb20-3"><a href="#cb20-3"></a>  <span class="at">iter_warmup =</span> <span class="dv">200</span>,            </span>
<span id="cb20-4"><a href="#cb20-4"></a>  <span class="at">iter_sampling =</span> <span class="dv">200</span>,          </span>
<span id="cb20-5"><a href="#cb20-5"></a>  <span class="at">chains =</span> nchains,            </span>
<span id="cb20-6"><a href="#cb20-6"></a>  <span class="at">parallel_chains =</span> nchains,     </span>
<span id="cb20-7"><a href="#cb20-7"></a>  <span class="at">show_messages =</span> <span class="cn">FALSE</span>,</span>
<span id="cb20-8"><a href="#cb20-8"></a>  <span class="at">refresh =</span> <span class="dv">0</span>,            </span>
<span id="cb20-9"><a href="#cb20-9"></a>  <span class="at">seed =</span> <span class="dv">20232023</span></span>
<span id="cb20-10"><a href="#cb20-10"></a>)</span>
<span id="cb20-11"><a href="#cb20-11"></a>fit_gaussian<span class="sc">$</span><span class="fu">summary</span>(<span class="at">.num_args =</span> <span class="fu">list</span>(<span class="at">sigfig =</span> <span class="dv">4</span>, <span class="at">notation =</span> <span class="st">"dec"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 2 × 10
#&gt;   variable      mean    median     sd    mad       q5      q95  rhat ess_bulk
#&gt;   &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
#&gt; 1 lp__     -20.86    -20.58    0.7083 0.2119 -22.03   -20.43   1.007    176.7
#&gt; 2 mu         0.03647   0.03073 0.3476 0.2978  -0.5115   0.5722 1.007    229.0
#&gt; # ℹ 1 more variable: ess_tail &lt;dbl&gt;</code></pre>
</div>
</div>
<p>可以看到，此时 <code>lp__</code> 的值包含常数项，两种表示方式对参数的计算结果没有影响。</p>
</section><section id="sec-stan-variables" class="level3" data-number="33.2.2"><h3 data-number="33.2.2" class="anchored" data-anchor-id="sec-stan-variables">
<span class="header-section-number">33.2.2</span> Stan 的变量类型</h3>
<p>Stan 语言和 C/C++ 语言比较类似，变量需要先声明再使用，函数需要用 <code>return</code> 返回值，总而言之，类型声明比较严格。变量的声明没有太多的内涵，就是 C++ 和 Stan 定义的语法，比如整型用 <code>int</code> 声明。建模过程中，时常需要将 R 语言环境中的数据传递给 Stan 代码编译出来的模型，而 Stan 是基于 C++ 语言，在变量类型方面有继承有发展。下表给出 Stan 与 R 语言中的变量类型对应关系。值得注意， R 语言的类型检查是不严格的，使用变量也不需要提前声明和初始化。Stan 语言中向量、矩阵的类型都是实数，下标也从 1 开始，元组类型和 R 语言中的列表类似，所有向量默认都是列向量。</p>
<p>下表第一列表示 Stan 语言的变量类型，第二列给出使用该变量的声明示例，第三列给出 R 语言中构造该类型变量的示例。</p>
<div id="tbl-stan-var-dec" class="anchored">
<figure class="quarto-float quarto-float-tbl figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-stan-var-dec-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表格&nbsp;33.1: Stan 变量类型和 R 语言中的对应
</figcaption><div aria-describedby="tbl-stan-var-dec-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="table">
<colgroup>
<col style="width: 15%">
<col style="width: 34%">
<col style="width: 50%">
</colgroup>
<thead><tr class="header">
<th>类型</th>
<th>Stan 语言</th>
<th>R 语言</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>整型</td>
<td><code>int x = 1;</code></td>
<td><code>x = 1L</code></td>
</tr>
<tr class="even">
<td>实数</td>
<td><code>real x = 3.14;</code></td>
<td><code>x = 3.14</code></td>
</tr>
<tr class="odd">
<td>向量</td>
<td><code>vector[3] x = [1, 2, 3]';</code></td>
<td><code>x = c(1, 2, 3)</code></td>
</tr>
<tr class="even">
<td>矩阵</td>
<td><code>matrix[3,1] x;</code></td>
<td><code>matrix(data = c(1, 2, 3), nrow = 3)</code></td>
</tr>
<tr class="odd">
<td>数组</td>
<td><code>array[3] int x;</code></td>
<td><code>array(data = c(1L, 2L, 3L), dim = c(3, 1, 1))</code></td>
</tr>
<tr class="even">
<td>元组</td>
<td><code>tuple(vector[3],vector[3]) x;</code></td>
<td><code>list(x = c(1, 2, 3), y = c(4, 5, 6))</code></td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section><section id="sec-stan-code" class="level3" data-number="33.2.3"><h3 data-number="33.2.3" class="anchored" data-anchor-id="sec-stan-code">
<span class="header-section-number">33.2.3</span> Stan 的代码结构</h3>
<p>Stan 代码文件最多有如下 7 块内容，模拟、拟合和预测模型会用到其中的一部分或全部。</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb22-1"><a href="#cb22-1"></a><span class="kw">functions</span> {</span>
<span id="cb22-2"><a href="#cb22-2"></a>  <span class="co">// ... function declarations and definitions ...</span></span>
<span id="cb22-3"><a href="#cb22-3"></a>}</span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="kw">data</span> {</span>
<span id="cb22-5"><a href="#cb22-5"></a>  <span class="co">// ... declarations ...</span></span>
<span id="cb22-6"><a href="#cb22-6"></a>}</span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="kw">transformed data</span> {</span>
<span id="cb22-8"><a href="#cb22-8"></a>   <span class="co">// ... declarations ... statements ...</span></span>
<span id="cb22-9"><a href="#cb22-9"></a>}</span>
<span id="cb22-10"><a href="#cb22-10"></a><span class="kw">parameters</span> {</span>
<span id="cb22-11"><a href="#cb22-11"></a>   <span class="co">// ... declarations ...</span></span>
<span id="cb22-12"><a href="#cb22-12"></a>}</span>
<span id="cb22-13"><a href="#cb22-13"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb22-14"><a href="#cb22-14"></a>   <span class="co">// ... declarations ... statements ...</span></span>
<span id="cb22-15"><a href="#cb22-15"></a>}</span>
<span id="cb22-16"><a href="#cb22-16"></a><span class="kw">model</span> {</span>
<span id="cb22-17"><a href="#cb22-17"></a>   <span class="co">// ... declarations ... statements ...</span></span>
<span id="cb22-18"><a href="#cb22-18"></a>}</span>
<span id="cb22-19"><a href="#cb22-19"></a><span class="kw">generated quantities</span> {</span>
<span id="cb22-20"><a href="#cb22-20"></a>   <span class="co">// ... declarations ... statements ...</span></span>
<span id="cb22-21"><a href="#cb22-21"></a>}</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section><section id="sec-stan-function" class="level3" data-number="33.2.4"><h3 data-number="33.2.4" class="anchored" data-anchor-id="sec-stan-function">
<span class="header-section-number">33.2.4</span> Stan 的函数使用</h3>
<p>Stan 有大量的内建函数，然而，有时候，Stan 内建的函数不足以满足需求，需要自己创建函数。下面以函数 <code>cholesky_decompose</code> 为例介绍 Stan 内置/一般函数的调用，在该函数的基础上自定义函数 <code>cholesky_decompose2</code> ，这不过是对它改个名字，其它内容只要符合 Stan 语言即可，不甚重要。</p>
<p>根据 Stan 官网函数 <code>cholesky_decompose</code> 帮助文档，Cholesky 分解的形式（Cholesky 分解有多种形式）如下：</p>
<p><span class="math display">\[
M = LL^{\top}
\]</span></p>
<p><span class="math inline">\(M\)</span> 是一个对称正定的矩阵，而 <span class="math inline">\(L\)</span> 是一个下三角矩阵。函数 <code>cholesky_decompose</code> 有一个参数 A， A 需要传递一个对称正定的矩阵。不妨设这个对称正定的矩阵为</p>
<p><span class="math display">\[
M = \begin{bmatrix}
4 &amp; 1 \\
1 &amp; 1
\end{bmatrix}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># 准备函数</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>stan_file <span class="ot">&lt;-</span> <span class="fu">write_stan_file</span>(<span class="st">"</span></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="st">functions {</span></span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="st"> matrix cholesky_decompose2(matrix A) {</span></span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="st">   return cholesky_decompose(A);</span></span>
<span id="cb23-6"><a href="#cb23-6"></a><span class="st"> }</span></span>
<span id="cb23-7"><a href="#cb23-7"></a><span class="st">}</span></span>
<span id="cb23-8"><a href="#cb23-8"></a><span class="st">parameters {</span></span>
<span id="cb23-9"><a href="#cb23-9"></a><span class="st"> real x;</span></span>
<span id="cb23-10"><a href="#cb23-10"></a><span class="st">}</span></span>
<span id="cb23-11"><a href="#cb23-11"></a><span class="st">model {</span></span>
<span id="cb23-12"><a href="#cb23-12"></a><span class="st"> x ~ std_normal();</span></span>
<span id="cb23-13"><a href="#cb23-13"></a><span class="st">}</span></span>
<span id="cb23-14"><a href="#cb23-14"></a><span class="st">"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>接着，将以上 Stan 代码编译</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>mod_cholesky_decompose <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="at">stan_file =</span> stan_file, <span class="at">compile =</span> <span class="cn">TRUE</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>准备测试数据，只要是一个对称正定的矩阵都可以做 cholesky 分解。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># 测试矩阵</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>M <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>cmdstanr</strong> 包导出函数的方法将以上 Stan 代码中的函数部分独立导出。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="co"># 编译独立的函数</span></span>
<span id="cb26-2"><a href="#cb26-2"></a>mod_cholesky_decompose<span class="sc">$</span><span class="fu">expose_functions</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>现在，可以直接调用导出的函数 <code>cholesky_decompose2</code> 。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="co"># cholesky 分解</span></span>
<span id="cb27-2"><a href="#cb27-2"></a>mod_cholesky_decompose<span class="sc">$</span>functions<span class="sc">$</span><span class="fu">cholesky_decompose2</span>(<span class="at">A =</span> M)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;      [,1]      [,2]
#&gt; [1,]  2.0 0.0000000
#&gt; [2,]  0.5 0.8660254</code></pre>
</div>
</div>
<p>最后，将 Stan 函数计算的结果与 R 语言内置的 cholesky 分解函数的结果比较。发现，函数 <code><a href="https://rdrr.io/r/base/chol.html">chol()</a></code> 的结果正好是 <code>cholesky_decompose2</code> 的转置。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="fu">chol</span>(M)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;      [,1]      [,2]
#&gt; [1,]    2 0.5000000
#&gt; [2,]    0 0.8660254</code></pre>
</div>
</div>
<p>查看帮助文档，可知 R 软件对 Cholesky 分解的定义如下：</p>
<p><span class="math display">\[
M = L^{\top}L
\]</span></p>
<p>根据数学表达式，感觉上都是差不多的，但还是有差异。R 与 Stan 混合编程就需要注意这些表达上不同的，不然，排错会很麻烦。</p>
</section></section><section id="sec-choose-prior" class="level2" data-number="33.3"><h2 data-number="33.3" class="anchored" data-anchor-id="sec-choose-prior">
<span class="header-section-number">33.3</span> 先验分布</h2>
<p>考虑一个响应变量服从伯努利分布的广义线性模型。</p>
<p><span class="math display">\[
\begin{aligned}
&amp;\boldsymbol{y} \sim \mathrm{Bernoulli}(\boldsymbol{p}) \\
&amp;\mathrm{logit}(\boldsymbol{p}) = \log (\frac{\boldsymbol{p}}{1-\boldsymbol{p}})=  \alpha + X \boldsymbol{\beta}
\end{aligned}
\]</span></p>
<p>下面模拟生成 2500 个样本，其中 10 个正态协变量，非 0 的回归系数是截距 <span class="math inline">\(\alpha = 1\)</span> 和向量 <span class="math inline">\(\boldsymbol{\beta}\)</span> 中的 <span class="math inline">\(\beta_1 = 3,\beta_2 = -2\)</span> 。对模型实际有用的是 3 个变量，采用贝叶斯建模，其它变量应该被收缩掉。贝叶斯收缩 （Bayesian shrinkage）与变量选择 （Variable selection） 是有关系的，先验分布影响收缩的力度。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="fu">set.seed</span>(<span class="dv">2023</span>)</span>
<span id="cb31-2"><a href="#cb31-2"></a>n <span class="ot">&lt;-</span> <span class="dv">2500</span></span>
<span id="cb31-3"><a href="#cb31-3"></a>k <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb31-4"><a href="#cb31-4"></a>X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n <span class="sc">*</span> k), <span class="at">ncol =</span> k)</span>
<span id="cb31-5"><a href="#cb31-5"></a>y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fu">plogis</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> X[, <span class="dv">1</span>] <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> X[, <span class="dv">2</span>]))</span>
<span id="cb31-6"><a href="#cb31-6"></a><span class="co"># 准备数据</span></span>
<span id="cb31-7"><a href="#cb31-7"></a>mdata <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">k =</span> k, <span class="at">n =</span> n, <span class="at">y =</span> y, <span class="at">X =</span> X)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>在贝叶斯先验分布中，有几个常用的概率分布，分别是正态分布、拉普拉斯分布（双指数分布）、柯西分布，下图集中展示了这几个的标准分布。</p>
<div class="cell">
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>dlaplace <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>) {</span>
<span id="cb32-2"><a href="#cb32-2"></a>  <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">2</span><span class="sc">*</span>sigma) <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span> <span class="fu">abs</span>(x <span class="sc">-</span> mu) <span class="sc">/</span> sigma)</span>
<span id="cb32-3"><a href="#cb32-3"></a>}</span>
<span id="cb32-4"><a href="#cb32-4"></a></span>
<span id="cb32-5"><a href="#cb32-5"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb32-6"><a href="#cb32-6"></a>  <span class="fu">geom_function</span>(</span>
<span id="cb32-7"><a href="#cb32-7"></a>    <span class="at">fun =</span> dnorm, <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>),</span>
<span id="cb32-8"><a href="#cb32-8"></a>    <span class="fu">aes</span>(<span class="at">colour =</span> <span class="st">"正态分布"</span>), <span class="at">linewidth =</span> <span class="fl">1.2</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">6</span>, <span class="dv">6</span>)</span>
<span id="cb32-9"><a href="#cb32-9"></a>  ) <span class="sc">+</span></span>
<span id="cb32-10"><a href="#cb32-10"></a>  <span class="fu">geom_function</span>(</span>
<span id="cb32-11"><a href="#cb32-11"></a>    <span class="at">fun =</span> dlaplace, <span class="at">args =</span> <span class="fu">list</span>(<span class="at">mu =</span> <span class="dv">0</span>, <span class="at">sigma =</span> <span class="dv">1</span>),</span>
<span id="cb32-12"><a href="#cb32-12"></a>    <span class="fu">aes</span>(<span class="at">colour =</span> <span class="st">"双指数分布"</span>), <span class="at">linewidth =</span> <span class="fl">1.2</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">6</span>, <span class="dv">6</span>)</span>
<span id="cb32-13"><a href="#cb32-13"></a>  ) <span class="sc">+</span></span>
<span id="cb32-14"><a href="#cb32-14"></a>  <span class="fu">geom_function</span>(</span>
<span id="cb32-15"><a href="#cb32-15"></a>    <span class="at">fun =</span> dcauchy, <span class="at">args =</span> <span class="fu">list</span>(<span class="at">location =</span> <span class="dv">0</span>, <span class="at">scale =</span> <span class="fl">0.5</span>),</span>
<span id="cb32-16"><a href="#cb32-16"></a>    <span class="fu">aes</span>(<span class="at">colour =</span> <span class="st">"柯西分布"</span>), <span class="at">linewidth =</span> <span class="fl">1.2</span>, <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">6</span>, <span class="dv">6</span>)</span>
<span id="cb32-17"><a href="#cb32-17"></a>  ) <span class="sc">+</span></span>
<span id="cb32-18"><a href="#cb32-18"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb32-19"><a href="#cb32-19"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.8</span>)) <span class="sc">+</span></span>
<span id="cb32-20"><a href="#cb32-20"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"$x$"</span>, <span class="at">y =</span> <span class="st">"$f(x)$"</span>, <span class="at">colour =</span> <span class="st">"先验分布"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-prior" class="quarto-figure quarto-figure-center anchored" width="432">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-prior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="probabilistic-reasoning-framework_files/figure-html/fig-prior-1.png" class="img-fluid figure-img" width="432">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-prior-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;33.3: 几个常用的概率分布
</figcaption></figure>
</div>
</div>
</div>
<p>接下来，考虑几种常见的先验设置。</p>
<section id="sec-prior-normal" class="level3" data-number="33.3.1"><h3 data-number="33.3.1" class="anchored" data-anchor-id="sec-prior-normal">
<span class="header-section-number">33.3.1</span> 正态先验</h3>
<p>指定回归系数 <span class="math inline">\(\alpha,\beta\)</span> 的先验分布如下</p>
<p><span class="math display">\[
\begin{aligned}
\alpha &amp;\sim \mathcal{N}(0, 1000) \\
\beta &amp;\sim \mathcal{N}(0, 1000)
\end{aligned}
\]</span></p>
<p>正态分布中设置相当大的方差意味着分布相当扁平， <span class="math inline">\(\alpha,\beta\)</span> 的取值在区间 <span class="math inline">\((-\infty,+\infty)\)</span> 上比较均匀。</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb33-1"><a href="#cb33-1"></a><span class="kw">data</span> {</span>
<span id="cb33-2"><a href="#cb33-2"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; k;</span>
<span id="cb33-3"><a href="#cb33-3"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; n;</span>
<span id="cb33-4"><a href="#cb33-4"></a>  <span class="dt">matrix</span>[n, k] X;</span>
<span id="cb33-5"><a href="#cb33-5"></a>  <span class="dt">array</span>[n] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>, <span class="kw">upper</span>=<span class="dv">1</span>&gt; y;</span>
<span id="cb33-6"><a href="#cb33-6"></a>}</span>
<span id="cb33-7"><a href="#cb33-7"></a><span class="kw">parameters</span> {</span>
<span id="cb33-8"><a href="#cb33-8"></a>  <span class="dt">vector</span>[k] beta;</span>
<span id="cb33-9"><a href="#cb33-9"></a>  <span class="dt">real</span> alpha;</span>
<span id="cb33-10"><a href="#cb33-10"></a>}</span>
<span id="cb33-11"><a href="#cb33-11"></a><span class="kw">model</span> {</span>
<span id="cb33-12"><a href="#cb33-12"></a>  <span class="kw">target +=</span> normal_lpdf(beta | <span class="dv">0</span>, <span class="dv">1000</span>);</span>
<span id="cb33-13"><a href="#cb33-13"></a>  <span class="kw">target +=</span> normal_lpdf(alpha | <span class="dv">0</span>, <span class="dv">1000</span>);</span>
<span id="cb33-14"><a href="#cb33-14"></a>  <span class="kw">target +=</span> bernoulli_logit_glm_lpmf(y | X, alpha, beta);</span>
<span id="cb33-15"><a href="#cb33-15"></a>}</span>
<span id="cb33-16"><a href="#cb33-16"></a><span class="kw">generated quantities</span> {</span>
<span id="cb33-17"><a href="#cb33-17"></a>  <span class="dt">vector</span>[n] log_lik;</span>
<span id="cb33-18"><a href="#cb33-18"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span> : n) {</span>
<span id="cb33-19"><a href="#cb33-19"></a>    log_lik[i] = bernoulli_logit_lpmf(y[i] | alpha + X[i] * beta);</span>
<span id="cb33-20"><a href="#cb33-20"></a>  }</span>
<span id="cb33-21"><a href="#cb33-21"></a>}</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>mod_logit_normal <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(</span>
<span id="cb34-2"><a href="#cb34-2"></a>  <span class="at">stan_file =</span> <span class="st">"code/bernoulli_logit_glm_normal.stan"</span>,</span>
<span id="cb34-3"><a href="#cb34-3"></a>  <span class="at">compile =</span> <span class="cn">TRUE</span>, <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">TRUE</span>)</span>
<span id="cb34-4"><a href="#cb34-4"></a>)</span>
<span id="cb34-5"><a href="#cb34-5"></a></span>
<span id="cb34-6"><a href="#cb34-6"></a>fit_logit_normal <span class="ot">&lt;-</span> mod_logit_normal<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb34-7"><a href="#cb34-7"></a>  <span class="at">data =</span> mdata,</span>
<span id="cb34-8"><a href="#cb34-8"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb34-9"><a href="#cb34-9"></a>  <span class="at">parallel_chains =</span> <span class="dv">2</span>,</span>
<span id="cb34-10"><a href="#cb34-10"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>, </span>
<span id="cb34-11"><a href="#cb34-11"></a>  <span class="at">iter_sampling =</span> <span class="dv">1000</span>, </span>
<span id="cb34-12"><a href="#cb34-12"></a>  <span class="at">threads_per_chain =</span> <span class="dv">2</span>, </span>
<span id="cb34-13"><a href="#cb34-13"></a>  <span class="at">seed =</span> <span class="dv">20232023</span>,</span>
<span id="cb34-14"><a href="#cb34-14"></a>  <span class="at">show_messages =</span> <span class="cn">FALSE</span>,</span>
<span id="cb34-15"><a href="#cb34-15"></a>  <span class="at">refresh =</span> <span class="dv">0</span></span>
<span id="cb34-16"><a href="#cb34-16"></a>)</span>
<span id="cb34-17"><a href="#cb34-17"></a></span>
<span id="cb34-18"><a href="#cb34-18"></a><span class="co"># 输出结果</span></span>
<span id="cb34-19"><a href="#cb34-19"></a>fit_logit_normal<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"lp__"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 12 × 10
#&gt;    variable      mean    median     sd    mad         q5      q95  rhat ess_bulk
#&gt;    &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
#&gt;  1 alpha       1.02      1.02   0.0715 0.0728    0.899    1.13e+0 1.00     3082.
#&gt;  2 beta[1]     3.14      3.13   0.133  0.135     2.93     3.36e+0 1.00     2103.
#&gt;  3 beta[2]    -2.02     -2.02   0.0985 0.0999   -2.19    -1.86e+0 1.00     2192.
#&gt;  4 beta[3]     0.0590    0.0586 0.0641 0.0644   -0.0456   1.65e-1 1.00     4654.
#&gt;  5 beta[4]    -0.0270   -0.0252 0.0669 0.0640   -0.140    8.03e-2 1.00     4460.
#&gt;  6 beta[5]     0.0122    0.0130 0.0682 0.0691   -0.100    1.25e-1 1.00     4532.
#&gt;  7 beta[6]     0.0220    0.0205 0.0697 0.0683   -0.0938   1.36e-1 1.00     4304.
#&gt;  8 beta[7]     0.103     0.102  0.0629 0.0619    0.00356  2.06e-1 0.999    4095.
#&gt;  9 beta[8]    -0.0297   -0.0303 0.0667 0.0663   -0.143    7.91e-2 1.00     3671.
#&gt; 10 beta[9]    -0.0870   -0.0856 0.0635 0.0615   -0.193    1.54e-2 1.00     4099.
#&gt; 11 beta[10]    0.0818    0.0831 0.0639 0.0679   -0.0239   1.86e-1 1.00     4417.
#&gt; 12 lp__     -843.     -842.     2.41   2.23   -847.      -8.39e+2 1.00      760.
#&gt; # ℹ 1 more variable: ess_tail &lt;dbl&gt;</code></pre>
</div>
</div>
</section><section id="sec-prior-lasso" class="level3" data-number="33.3.2"><h3 data-number="33.3.2" class="anchored" data-anchor-id="sec-prior-lasso">
<span class="header-section-number">33.3.2</span> Lasso 先验</h3>
<p>指定回归系数 <span class="math inline">\(\alpha,\beta\)</span> 的先验分布如下</p>
<p><span class="math display">\[
\begin{aligned}
\lambda &amp;\sim \mathrm{Half\_Cauchy}(0,0.01) \\
\alpha  &amp;\sim \mathrm{Double\_exponential}(0, \lambda) \\
\beta   &amp;\sim \mathrm{Double\_exponential}(0, \lambda)
\end{aligned}
\]</span></p>
<p>其中， <span class="math inline">\(\alpha,\beta\)</span> 服从双指数分布，惩罚因子 <span class="math inline">\(\lambda\)</span> 服从柯西分布。顺便一提，若把双指数分布改为正态分布，则 Lasso 先验变为岭先验。相比于岭先验，Lasso 先验有意将回归系数往 0 上收缩，这非常类似于频率派中的岭回归与 Lasso 回归的关系 <span class="citation" data-cites="Bhadra2019">(<a href="references.html#ref-Bhadra2019" role="doc-biblioref">Bhadra 等 2019</a>)</span>。</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb36-1"><a href="#cb36-1"></a><span class="kw">data</span> {</span>
<span id="cb36-2"><a href="#cb36-2"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; k;</span>
<span id="cb36-3"><a href="#cb36-3"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; n;</span>
<span id="cb36-4"><a href="#cb36-4"></a>  <span class="dt">matrix</span>[n, k] X;</span>
<span id="cb36-5"><a href="#cb36-5"></a>  <span class="dt">array</span>[n] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>, <span class="kw">upper</span>=<span class="dv">1</span>&gt; y;</span>
<span id="cb36-6"><a href="#cb36-6"></a>}</span>
<span id="cb36-7"><a href="#cb36-7"></a><span class="kw">parameters</span> {</span>
<span id="cb36-8"><a href="#cb36-8"></a>  <span class="dt">vector</span>[k] beta;</span>
<span id="cb36-9"><a href="#cb36-9"></a>  <span class="dt">real</span> alpha;</span>
<span id="cb36-10"><a href="#cb36-10"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; lambda;</span>
<span id="cb36-11"><a href="#cb36-11"></a>}</span>
<span id="cb36-12"><a href="#cb36-12"></a><span class="kw">model</span> {</span>
<span id="cb36-13"><a href="#cb36-13"></a>  <span class="kw">target +=</span> double_exponential_lpdf(beta | <span class="dv">0</span>, lambda);</span>
<span id="cb36-14"><a href="#cb36-14"></a>  <span class="kw">target +=</span> double_exponential_lpdf(alpha | <span class="dv">0</span>, lambda);</span>
<span id="cb36-15"><a href="#cb36-15"></a>  <span class="kw">target +=</span> cauchy_lpdf(lambda | <span class="dv">0</span>, <span class="fl">0.01</span>);</span>
<span id="cb36-16"><a href="#cb36-16"></a>  <span class="kw">target +=</span> bernoulli_logit_glm_lpmf(y | X, alpha, beta);</span>
<span id="cb36-17"><a href="#cb36-17"></a>}</span>
<span id="cb36-18"><a href="#cb36-18"></a><span class="kw">generated quantities</span> {</span>
<span id="cb36-19"><a href="#cb36-19"></a>  <span class="dt">vector</span>[n] log_lik;</span>
<span id="cb36-20"><a href="#cb36-20"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span> : n) {</span>
<span id="cb36-21"><a href="#cb36-21"></a>    log_lik[i] = bernoulli_logit_lpmf(y[i] | alpha + X[i] * beta);</span>
<span id="cb36-22"><a href="#cb36-22"></a>  }</span>
<span id="cb36-23"><a href="#cb36-23"></a>}</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>mod_logit_lasso <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(</span>
<span id="cb37-2"><a href="#cb37-2"></a>  <span class="at">stan_file =</span> <span class="st">"code/bernoulli_logit_glm_lasso.stan"</span>,</span>
<span id="cb37-3"><a href="#cb37-3"></a>  <span class="at">compile =</span> <span class="cn">TRUE</span>, <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">TRUE</span>)</span>
<span id="cb37-4"><a href="#cb37-4"></a>)</span>
<span id="cb37-5"><a href="#cb37-5"></a></span>
<span id="cb37-6"><a href="#cb37-6"></a>fit_logit_lasso <span class="ot">&lt;-</span> mod_logit_lasso<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb37-7"><a href="#cb37-7"></a>  <span class="at">data =</span> mdata,</span>
<span id="cb37-8"><a href="#cb37-8"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb37-9"><a href="#cb37-9"></a>  <span class="at">parallel_chains =</span> <span class="dv">2</span>,</span>
<span id="cb37-10"><a href="#cb37-10"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>, </span>
<span id="cb37-11"><a href="#cb37-11"></a>  <span class="at">iter_sampling =</span> <span class="dv">1000</span>, </span>
<span id="cb37-12"><a href="#cb37-12"></a>  <span class="at">threads_per_chain =</span> <span class="dv">2</span>, </span>
<span id="cb37-13"><a href="#cb37-13"></a>  <span class="at">seed =</span> <span class="dv">20232023</span>,</span>
<span id="cb37-14"><a href="#cb37-14"></a>  <span class="at">show_messages =</span> <span class="cn">FALSE</span>,</span>
<span id="cb37-15"><a href="#cb37-15"></a>  <span class="at">refresh =</span> <span class="dv">0</span></span>
<span id="cb37-16"><a href="#cb37-16"></a>)</span>
<span id="cb37-17"><a href="#cb37-17"></a></span>
<span id="cb37-18"><a href="#cb37-18"></a><span class="co"># 输出结果</span></span>
<span id="cb37-19"><a href="#cb37-19"></a>fit_logit_lasso<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"lambda"</span>, <span class="st">"lp__"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 13 × 10
#&gt;    variable      mean    median     sd    mad         q5      q95  rhat ess_bulk
#&gt;    &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
#&gt;  1 alpha       0.993     0.989  0.0738 0.0741    0.873    1.12e+0  1.00    2427.
#&gt;  2 beta[1]     3.08      3.08   0.137  0.133     2.86     3.31e+0  1.00    1707.
#&gt;  3 beta[2]    -1.99     -1.98   0.100  0.102    -2.15    -1.82e+0  1.00    2014.
#&gt;  4 beta[3]     0.0533    0.0517 0.0614 0.0586   -0.0463   1.60e-1  1.00    4035.
#&gt;  5 beta[4]    -0.0232   -0.0222 0.0600 0.0571   -0.121    7.16e-2  1.00    4184.
#&gt;  6 beta[5]     0.0118    0.0128 0.0628 0.0602   -0.0959   1.15e-1  1.00    5750.
#&gt;  7 beta[6]     0.0180    0.0163 0.0612 0.0603   -0.0810   1.23e-1  1.00    4271.
#&gt;  8 beta[7]     0.0942    0.0940 0.0615 0.0607   -0.00725  1.95e-1  1.00    3869.
#&gt;  9 beta[8]    -0.0268   -0.0252 0.0607 0.0612   -0.125    7.30e-2  1.00    3632.
#&gt; 10 beta[9]    -0.0815   -0.0817 0.0603 0.0589   -0.182    1.73e-2  1.00    3377.
#&gt; 11 beta[10]    0.0747    0.0742 0.0637 0.0605   -0.0305   1.80e-1  1.00    3815.
#&gt; 12 lambda      0.598     0.566  0.189  0.153     0.361    9.32e-1  1.00    3142.
#&gt; 13 lp__     -775.     -775.     2.58   2.42   -780.      -7.71e+2  1.00     829.
#&gt; # ℹ 1 more variable: ess_tail &lt;dbl&gt;</code></pre>
</div>
</div>
<p>计算 LOO-CV 比较正态先验和 Lasso 先验</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a>fit_logit_normal_loo <span class="ot">&lt;-</span> fit_logit_normal<span class="sc">$</span><span class="fu">loo</span>(<span class="at">variables =</span> <span class="st">"log_lik"</span>, <span class="at">cores =</span> <span class="dv">1</span>)</span>
<span id="cb39-2"><a href="#cb39-2"></a><span class="fu">print</span>(fit_logit_normal_loo)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Computed from 2000 by 2500 log-likelihood matrix
#&gt; 
#&gt;          Estimate   SE
#&gt; elpd_loo   -762.3 27.2
#&gt; p_loo        11.3  0.5
#&gt; looic      1524.6 54.5
#&gt; ------
#&gt; Monte Carlo SE of elpd_loo is 0.1.
#&gt; 
#&gt; All Pareto k estimates are good (k &lt; 0.5).
#&gt; See help('pareto-k-diagnostic') for details.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>fit_logit_lasso_loo <span class="ot">&lt;-</span> fit_logit_lasso<span class="sc">$</span><span class="fu">loo</span>(<span class="at">variables =</span> <span class="st">"log_lik"</span>, <span class="at">cores =</span> <span class="dv">1</span>)</span>
<span id="cb41-2"><a href="#cb41-2"></a><span class="fu">print</span>(fit_logit_lasso_loo)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Computed from 2000 by 2500 log-likelihood matrix
#&gt; 
#&gt;          Estimate   SE
#&gt; elpd_loo   -761.5 26.8
#&gt; p_loo        10.3  0.5
#&gt; looic      1522.9 53.6
#&gt; ------
#&gt; Monte Carlo SE of elpd_loo is 0.1.
#&gt; 
#&gt; All Pareto k estimates are good (k &lt; 0.5).
#&gt; See help('pareto-k-diagnostic') for details.</code></pre>
</div>
</div>
<p>loo 包的函数 <code>loo_compare()</code> 比较两个模型</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>loo<span class="sc">::</span><span class="fu">loo_compare</span>(<span class="fu">list</span>(<span class="at">model0 =</span> fit_logit_normal_loo, </span>
<span id="cb43-2"><a href="#cb43-2"></a>                      <span class="at">model1 =</span> fit_logit_lasso_loo))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;        elpd_diff se_diff
#&gt; model1  0.0       0.0   
#&gt; model0 -0.9       0.5</code></pre>
</div>
</div>
<p>输出结果中最好的模型放在第一行。LOOIC 越小越好，所以，Lasso 先验更好。</p>
</section><section id="sec-prior-horseshoe" class="level3" data-number="33.3.3"><h3 data-number="33.3.3" class="anchored" data-anchor-id="sec-prior-horseshoe">
<span class="header-section-number">33.3.3</span> Horseshoe 先验</h3>
<p>Horseshoe 先验（Horse shoe）<span class="citation" data-cites="Piironen2017a">(<a href="references.html#ref-Piironen2017a" role="doc-biblioref">Piironen 和 Vehtari 2017b</a>)</span> 指定回归系数 <span class="math inline">\(\alpha,\bm{\beta}\)</span> 的先验分布如下</p>
<p><span class="math display">\[
\begin{aligned}
\lambda_i &amp;\sim \mathrm{Half\_Cauchy}(0,1) \\
\alpha | \lambda_0,\tau  &amp;\sim \mathcal{N}(0, \tau^2\lambda_0^2) \\
\beta_i | \lambda_i,\tau  &amp;\sim \mathcal{N}(0, \tau^2\lambda_i^2),\quad i = 1,2,\cdots,10
\end{aligned}
\]</span></p>
<p>其中，<span class="math inline">\(\tau\)</span> 称之为全局超参数，它将所有的回归系数朝着 0 收缩。而作用在局部超参数 <span class="math inline">\(\lambda_i\)</span> 上的重尾柯西先验允许某些回归系数逃脱收缩。</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb45-1"><a href="#cb45-1"></a><span class="kw">data</span> {</span>
<span id="cb45-2"><a href="#cb45-2"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; k;</span>
<span id="cb45-3"><a href="#cb45-3"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; n;</span>
<span id="cb45-4"><a href="#cb45-4"></a>  <span class="dt">matrix</span>[n, k] X;</span>
<span id="cb45-5"><a href="#cb45-5"></a>  <span class="dt">array</span>[n] <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>, <span class="kw">upper</span>=<span class="dv">1</span>&gt; y;</span>
<span id="cb45-6"><a href="#cb45-6"></a>}</span>
<span id="cb45-7"><a href="#cb45-7"></a><span class="kw">parameters</span> {</span>
<span id="cb45-8"><a href="#cb45-8"></a>  <span class="dt">vector</span>[k] beta_tilde;</span>
<span id="cb45-9"><a href="#cb45-9"></a>  <span class="dt">real</span> alpha;</span>
<span id="cb45-10"><a href="#cb45-10"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt; tau;</span>
<span id="cb45-11"><a href="#cb45-11"></a>  <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt;[k] lambda;</span>
<span id="cb45-12"><a href="#cb45-12"></a>}</span>
<span id="cb45-13"><a href="#cb45-13"></a><span class="kw">transformed parameters</span> {</span>
<span id="cb45-14"><a href="#cb45-14"></a>  <span class="dt">vector</span>[k] beta = beta_tilde .* lambda * tau;</span>
<span id="cb45-15"><a href="#cb45-15"></a>}</span>
<span id="cb45-16"><a href="#cb45-16"></a><span class="kw">model</span> {</span>
<span id="cb45-17"><a href="#cb45-17"></a>  <span class="kw">target +=</span> normal_lpdf(beta_tilde | <span class="dv">0</span>, lambda);</span>
<span id="cb45-18"><a href="#cb45-18"></a>  <span class="kw">target +=</span> normal_lpdf(alpha | <span class="dv">0</span>, lambda);</span>
<span id="cb45-19"><a href="#cb45-19"></a>  <span class="kw">target +=</span> cauchy_lpdf(tau | <span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb45-20"><a href="#cb45-20"></a>  <span class="kw">target +=</span> cauchy_lpdf(lambda | <span class="dv">0</span>, <span class="dv">1</span>);</span>
<span id="cb45-21"><a href="#cb45-21"></a>  <span class="kw">target +=</span> bernoulli_logit_glm_lpmf(y | X, alpha, beta);</span>
<span id="cb45-22"><a href="#cb45-22"></a>}</span>
<span id="cb45-23"><a href="#cb45-23"></a><span class="kw">generated quantities</span> {</span>
<span id="cb45-24"><a href="#cb45-24"></a>  <span class="dt">vector</span>[n] log_lik;</span>
<span id="cb45-25"><a href="#cb45-25"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span> : n) {</span>
<span id="cb45-26"><a href="#cb45-26"></a>    log_lik[i] = bernoulli_logit_lpmf(y[i] | alpha + X[i] * beta);</span>
<span id="cb45-27"><a href="#cb45-27"></a>  }</span>
<span id="cb45-28"><a href="#cb45-28"></a>}</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a><span class="co"># horseshoe 先验</span></span>
<span id="cb46-2"><a href="#cb46-2"></a>mod_logit_horseshoe <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(</span>
<span id="cb46-3"><a href="#cb46-3"></a>  <span class="at">stan_file =</span> <span class="st">"code/bernoulli_logit_glm_horseshoe.stan"</span>,</span>
<span id="cb46-4"><a href="#cb46-4"></a>  <span class="at">compile =</span> <span class="cn">TRUE</span>, <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-5"><a href="#cb46-5"></a>)</span>
<span id="cb46-6"><a href="#cb46-6"></a></span>
<span id="cb46-7"><a href="#cb46-7"></a>fit_logit_horseshoe <span class="ot">&lt;-</span> mod_logit_horseshoe<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb46-8"><a href="#cb46-8"></a>  <span class="at">data =</span> mdata,</span>
<span id="cb46-9"><a href="#cb46-9"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb46-10"><a href="#cb46-10"></a>  <span class="at">parallel_chains =</span> <span class="dv">2</span>,</span>
<span id="cb46-11"><a href="#cb46-11"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>, </span>
<span id="cb46-12"><a href="#cb46-12"></a>  <span class="at">iter_sampling =</span> <span class="dv">1000</span>, </span>
<span id="cb46-13"><a href="#cb46-13"></a>  <span class="at">threads_per_chain =</span> <span class="dv">2</span>, </span>
<span id="cb46-14"><a href="#cb46-14"></a>  <span class="at">seed =</span> <span class="dv">20232023</span>,</span>
<span id="cb46-15"><a href="#cb46-15"></a>  <span class="at">show_messages =</span> <span class="cn">FALSE</span>,</span>
<span id="cb46-16"><a href="#cb46-16"></a>  <span class="at">refresh =</span> <span class="dv">0</span></span>
<span id="cb46-17"><a href="#cb46-17"></a>)</span>
<span id="cb46-18"><a href="#cb46-18"></a></span>
<span id="cb46-19"><a href="#cb46-19"></a>fit_logit_horseshoe<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"tau"</span>, <span class="st">"lambda"</span>, <span class="st">"lp__"</span>)) </span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 23 × 10
#&gt;    variable     mean   median     sd    mad      q5     q95  rhat ess_bulk
#&gt;    &lt;chr&gt;       &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;
#&gt;  1 alpha     0.933    0.932   0.0770 0.0741  0.809   1.07   1.00     1274.
#&gt;  2 beta[1]   3.05     3.05    0.133  0.133   2.83    3.26   1.00     1382.
#&gt;  3 beta[2]  -1.97    -1.96    0.0985 0.0975 -2.13   -1.80   1.00     1875.
#&gt;  4 beta[3]   0.0272   0.0196  0.0485 0.0399 -0.0407  0.119  0.999    1697.
#&gt;  5 beta[4]  -0.0112  -0.00764 0.0453 0.0383 -0.0905  0.0591 1.00     1777.
#&gt;  6 beta[5]   0.00532  0.00429 0.0432 0.0347 -0.0684  0.0838 1.00     1920.
#&gt;  7 beta[6]   0.00861  0.00554 0.0453 0.0386 -0.0625  0.0890 1.00     2330.
#&gt;  8 beta[7]   0.0622   0.0572  0.0557 0.0595 -0.0135  0.164  1.00     1450.
#&gt;  9 beta[8]  -0.0153  -0.0111  0.0455 0.0362 -0.0959  0.0543 1.00     1838.
#&gt; 10 beta[9]  -0.0490  -0.0396  0.0546 0.0549 -0.152   0.0218 1.00     1638.
#&gt; # ℹ 13 more rows
#&gt; # ℹ 1 more variable: ess_tail &lt;dbl&gt;</code></pre>
</div>
</div>
<p>可以看到回归系数小的压缩效果很明显，而回归系数大的几乎没有压缩。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a>fit_logit_horseshoe_loo <span class="ot">&lt;-</span> fit_logit_horseshoe<span class="sc">$</span><span class="fu">loo</span>(<span class="at">variables =</span> <span class="st">"log_lik"</span>, <span class="at">cores =</span> <span class="dv">1</span>)</span>
<span id="cb48-2"><a href="#cb48-2"></a><span class="fu">print</span>(fit_logit_horseshoe_loo)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Computed from 2000 by 2500 log-likelihood matrix
#&gt; 
#&gt;          Estimate   SE
#&gt; elpd_loo   -760.0 26.5
#&gt; p_loo         7.6  0.3
#&gt; looic      1519.9 53.1
#&gt; ------
#&gt; Monte Carlo SE of elpd_loo is 0.1.
#&gt; 
#&gt; All Pareto k estimates are good (k &lt; 0.5).
#&gt; See help('pareto-k-diagnostic') for details.</code></pre>
</div>
</div>
<p>LOOIC 比之 Lasso 先验的情况更小了。</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
注释
</div>
</div>
<div class="callout-body-container callout-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a><span class="fu">library</span>(rstanarm)</span>
<span id="cb50-2"><a href="#cb50-2"></a><span class="co"># set up the prior, use hyperprior tau ∼ half-Cauchy(0,tau0^2) </span></span>
<span id="cb50-3"><a href="#cb50-3"></a>D <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X) <span class="co"># 10 变量</span></span>
<span id="cb50-4"><a href="#cb50-4"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X) <span class="co"># 2500 样本量</span></span>
<span id="cb50-5"><a href="#cb50-5"></a>p0 <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="co"># prior guess for the number of relevant variables </span></span>
<span id="cb50-6"><a href="#cb50-6"></a>sigma <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>(y)<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span><span class="fu">mean</span>(y))) <span class="co"># pseudo sigma</span></span>
<span id="cb50-7"><a href="#cb50-7"></a>tau0 <span class="ot">&lt;-</span> p0 <span class="sc">/</span> (D <span class="sc">-</span> p0) <span class="sc">*</span> sigma <span class="sc">/</span> <span class="fu">sqrt</span>(n)</span>
<span id="cb50-8"><a href="#cb50-8"></a><span class="co"># hs() 函数指定层次收缩先验 Hierarchical shrinkage</span></span>
<span id="cb50-9"><a href="#cb50-9"></a><span class="co"># 拟合模型</span></span>
<span id="cb50-10"><a href="#cb50-10"></a>fit <span class="ot">&lt;-</span> <span class="fu">stan_glm</span>(</span>
<span id="cb50-11"><a href="#cb50-11"></a>  y <span class="sc">~</span> X, <span class="at">family =</span> <span class="fu">binomial</span>(), <span class="at">data =</span> <span class="fu">data.frame</span>(<span class="fu">I</span>(X), y), </span>
<span id="cb50-12"><a href="#cb50-12"></a>  <span class="co"># horseshoe 先验</span></span>
<span id="cb50-13"><a href="#cb50-13"></a>  <span class="at">prior =</span> <span class="fu">hs</span>(<span class="at">df =</span> <span class="dv">1</span>, <span class="at">global_df =</span> <span class="dv">1</span>, <span class="at">global_scale =</span> tau0)</span>
<span id="cb50-14"><a href="#cb50-14"></a>)</span>
<span id="cb50-15"><a href="#cb50-15"></a><span class="co"># 输出结果</span></span>
<span id="cb50-16"><a href="#cb50-16"></a><span class="fu">summary</span>(fit, <span class="at">digits =</span> <span class="dv">4</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>模型输出如下：</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb51-1"><a href="#cb51-1"></a><span class="an">Model Info:</span></span>
<span id="cb51-2"><a href="#cb51-2"></a> function:     stan_glm</span>
<span id="cb51-3"><a href="#cb51-3"></a> family:       binomial <span class="co">[</span><span class="ot">logit</span><span class="co">]</span></span>
<span id="cb51-4"><a href="#cb51-4"></a> formula:      y ~ X</span>
<span id="cb51-5"><a href="#cb51-5"></a> algorithm:    sampling</span>
<span id="cb51-6"><a href="#cb51-6"></a> sample:       4000 (posterior sample size)</span>
<span id="cb51-7"><a href="#cb51-7"></a> priors:       see help('prior_summary')</span>
<span id="cb51-8"><a href="#cb51-8"></a> observations: 2500</span>
<span id="cb51-9"><a href="#cb51-9"></a> predictors:   11</span>
<span id="cb51-10"><a href="#cb51-10"></a></span>
<span id="cb51-11"><a href="#cb51-11"></a>Estimates:</span>
<span id="cb51-12"><a href="#cb51-12"></a>              mean    sd      10%     50%     90%  </span>
<span id="cb51-13"><a href="#cb51-13"></a>(Intercept)  1.0016  0.0732  0.9080  1.0007  1.0947</span>
<span id="cb51-14"><a href="#cb51-14"></a>X1           3.0921  0.1343  2.9219  3.0888  3.2660</span>
<span id="cb51-15"><a href="#cb51-15"></a>X2          -1.9907  0.1002 -2.1200 -1.9903 -1.8631</span>
<span id="cb51-16"><a href="#cb51-16"></a>X3           0.0205  0.0429 -0.0180  0.0084  0.0804</span>
<span id="cb51-17"><a href="#cb51-17"></a>X4          -0.0069  0.0364 -0.0534 -0.0018  0.0297</span>
<span id="cb51-18"><a href="#cb51-18"></a>X5           0.0045  0.0367 -0.0336  0.0008  0.0474</span>
<span id="cb51-19"><a href="#cb51-19"></a>X6           0.0062  0.0364 -0.0323  0.0014  0.0519</span>
<span id="cb51-20"><a href="#cb51-20"></a>X7           0.0469  0.0559 -0.0068  0.0327  0.1258</span>
<span id="cb51-21"><a href="#cb51-21"></a>X8          -0.0082  0.0376 -0.0545 -0.0021  0.0296</span>
<span id="cb51-22"><a href="#cb51-22"></a>X9          -0.0342  0.0492 -0.1042 -0.0196  0.0109</span>
<span id="cb51-23"><a href="#cb51-23"></a>X10          0.0310  0.0472 -0.0125  0.0180  0.0971</span>
<span id="cb51-24"><a href="#cb51-24"></a></span>
<span id="cb51-25"><a href="#cb51-25"></a>Fit Diagnostics:</span>
<span id="cb51-26"><a href="#cb51-26"></a>           mean   sd     10%    50%    90% </span>
<span id="cb51-27"><a href="#cb51-27"></a>mean_PPD 0.5915 0.0087 0.5804 0.5916 0.6028</span>
<span id="cb51-28"><a href="#cb51-28"></a></span>
<span id="cb51-29"><a href="#cb51-29"></a>The mean_ppd is the sample average posterior predictive distribution of the outcome variable (for details see help('summary.stanreg')).</span>
<span id="cb51-30"><a href="#cb51-30"></a></span>
<span id="cb51-31"><a href="#cb51-31"></a>MCMC diagnostics</span>
<span id="cb51-32"><a href="#cb51-32"></a>              mcse   Rhat   n_eff</span>
<span id="cb51-33"><a href="#cb51-33"></a>(Intercept)   0.0010 0.9994 5422 </span>
<span id="cb51-34"><a href="#cb51-34"></a>X1            0.0021 0.9996 3994 </span>
<span id="cb51-35"><a href="#cb51-35"></a>X2            0.0016 1.0000 3817 </span>
<span id="cb51-36"><a href="#cb51-36"></a>X3            0.0006 0.9997 4531 </span>
<span id="cb51-37"><a href="#cb51-37"></a>X4            0.0005 0.9998 4652 </span>
<span id="cb51-38"><a href="#cb51-38"></a>X5            0.0005 0.9993 5052 </span>
<span id="cb51-39"><a href="#cb51-39"></a>X6            0.0005 0.9994 4795 </span>
<span id="cb51-40"><a href="#cb51-40"></a>X7            0.0010 1.0002 3045 </span>
<span id="cb51-41"><a href="#cb51-41"></a>X8            0.0006 1.0000 4397 </span>
<span id="cb51-42"><a href="#cb51-42"></a>X9            0.0009 1.0002 3034 </span>
<span id="cb51-43"><a href="#cb51-43"></a>X10           0.0008 1.0003 3292 </span>
<span id="cb51-44"><a href="#cb51-44"></a>mean_PPD      0.0001 0.9994 4742 </span>
<span id="cb51-45"><a href="#cb51-45"></a>log-posterior 0.1367 1.0012 1206 </span>
<span id="cb51-46"><a href="#cb51-46"></a></span>
<span id="cb51-47"><a href="#cb51-47"></a>For each parameter, mcse is Monte Carlo standard error, n_eff is a crude measure of effective sample size, and Rhat is the potential scale reduction factor on split chains (at convergence Rhat=1).</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>rstanarm</strong> 包可以获得与前面一致的结果，甚至收缩效果比手写的 Stan 代码好一点点。</p>
</div>
</div>
</section><section id="sec-prior-spikeslab" class="level3" data-number="33.3.4"><h3 data-number="33.3.4" class="anchored" data-anchor-id="sec-prior-spikeslab">
<span class="header-section-number">33.3.4</span> SpikeSlab 先验</h3>
<p>SpikeSlab 先验（Spike Slab）放在非 0 协变量的个数上，是离散的先验。回归系数的先验分布的有限混合，常用有限混合多元正态分布。参考文章 <a href="https://betanalpha.github.io/assets/case_studies/modeling_sparsity.html#221_Discrete_Mixture_Models">Discrete Mixture Models</a></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
注释
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>BoomSpikeSlab</strong> 包是 <strong>Boom</strong> 包的扩展，提供基于 SpikeSlab 先验的贝叶斯变量选择功能。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a><span class="fu">set.seed</span>(<span class="dv">2023</span>)</span>
<span id="cb52-2"><a href="#cb52-2"></a>n <span class="ot">&lt;-</span> <span class="dv">2500</span></span>
<span id="cb52-3"><a href="#cb52-3"></a>k <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb52-4"><a href="#cb52-4"></a>X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(n <span class="sc">*</span> k), <span class="at">ncol =</span> k)</span>
<span id="cb52-5"><a href="#cb52-5"></a>y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fu">plogis</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="dv">3</span> <span class="sc">*</span> X[, <span class="dv">1</span>] <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> X[, <span class="dv">2</span>]))</span>
<span id="cb52-6"><a href="#cb52-6"></a><span class="co"># 加载 BoomSpikeSlab</span></span>
<span id="cb52-7"><a href="#cb52-7"></a><span class="fu">library</span>(BoomSpikeSlab)</span>
<span id="cb52-8"><a href="#cb52-8"></a>fit_logit_spike <span class="ot">&lt;-</span> <span class="fu">logit.spike</span>(y <span class="sc">~</span> X, <span class="at">niter =</span> <span class="dv">500</span>)</span>
<span id="cb52-9"><a href="#cb52-9"></a><span class="co"># 模型输出</span></span>
<span id="cb52-10"><a href="#cb52-10"></a><span class="fu">summary</span>(fit_logit_spike)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb53"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb53-1"><a href="#cb53-1"></a></span>
<span id="cb53-2"><a href="#cb53-2"></a>null log likelihood:            -1690.677 </span>
<span id="cb53-3"><a href="#cb53-3"></a>posterior mean log likelihood:  -766.5283 </span>
<span id="cb53-4"><a href="#cb53-4"></a>posterior max log likelihood:   -754.8686 </span>
<span id="cb53-5"><a href="#cb53-5"></a>mean deviance R-sq:             0.5466147 </span>
<span id="cb53-6"><a href="#cb53-6"></a></span>
<span id="cb53-7"><a href="#cb53-7"></a>predicted vs observed success rates, by decile:</span>
<span id="cb53-8"><a href="#cb53-8"></a>                  predicted    observed</span>
<span id="cb53-9"><a href="#cb53-9"></a>(0.00596,0.0279] 0.01388670 0.008032129</span>
<span id="cb53-10"><a href="#cb53-10"></a>(0.0279,0.108]   0.06371528 0.060000000</span>
<span id="cb53-11"><a href="#cb53-11"></a>(0.108,0.273]    0.17839881 0.176000000</span>
<span id="cb53-12"><a href="#cb53-12"></a>(0.273,0.496]    0.39146661 0.404000000</span>
<span id="cb53-13"><a href="#cb53-13"></a>(0.496,0.734]    0.61807048 0.608000000</span>
<span id="cb53-14"><a href="#cb53-14"></a>(0.734,0.865]    0.80694458 0.764000000</span>
<span id="cb53-15"><a href="#cb53-15"></a>(0.865,0.942]    0.90690322 0.928000000</span>
<span id="cb53-16"><a href="#cb53-16"></a>(0.942,0.979]    0.96436544 0.976000000</span>
<span id="cb53-17"><a href="#cb53-17"></a>(0.979,0.992]    0.98636201 0.992000000</span>
<span id="cb53-18"><a href="#cb53-18"></a>(0.992,0.996]    0.99441504 1.000000000</span>
<span id="cb53-19"><a href="#cb53-19"></a></span>
<span id="cb53-20"><a href="#cb53-20"></a>summary of coefficients:</span>
<span id="cb53-21"><a href="#cb53-21"></a>             mean    sd mean.inc sd.inc inc.prob</span>
<span id="cb53-22"><a href="#cb53-22"></a>(Intercept)  1.02 0.105     1.02  0.105     1.00</span>
<span id="cb53-23"><a href="#cb53-23"></a>X2          -2.00 0.232    -2.02  0.118     0.99</span>
<span id="cb53-24"><a href="#cb53-24"></a>X1           3.10 0.354     3.13  0.170     0.99</span>
<span id="cb53-25"><a href="#cb53-25"></a>X10          0.00 0.000     0.00  0.000     0.00</span>
<span id="cb53-26"><a href="#cb53-26"></a>X9           0.00 0.000     0.00  0.000     0.00</span>
<span id="cb53-27"><a href="#cb53-27"></a>X8           0.00 0.000     0.00  0.000     0.00</span>
<span id="cb53-28"><a href="#cb53-28"></a>X7           0.00 0.000     0.00  0.000     0.00</span>
<span id="cb53-29"><a href="#cb53-29"></a>X6           0.00 0.000     0.00  0.000     0.00</span>
<span id="cb53-30"><a href="#cb53-30"></a>X5           0.00 0.000     0.00  0.000     0.00</span>
<span id="cb53-31"><a href="#cb53-31"></a>X4           0.00 0.000     0.00  0.000     0.00</span>
<span id="cb53-32"><a href="#cb53-32"></a>X3           0.00 0.000     0.00  0.000     0.00</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section></section><section id="sec-choose-inference" class="level2" data-number="33.4"><h2 data-number="33.4" class="anchored" data-anchor-id="sec-choose-inference">
<span class="header-section-number">33.4</span> 推理算法</h2>
<p>开篇提及 Stan 内置了多种推理算法，不同的算法获得的结果是存在差异的。</p>
<ul>
<li>full Bayesian statistical inference with MCMC sampling (NUTS, HMC)</li>
<li>approximate Bayesian inference with variational inference (ADVI)</li>
<li>penalized maximum likelihood estimation with optimization (L-BFGS)</li>
</ul>
<section id="sec-optimization-algorithms" class="level3" data-number="33.4.1"><h3 data-number="33.4.1" class="anchored" data-anchor-id="sec-optimization-algorithms">
<span class="header-section-number">33.4.1</span> 惩罚极大似然算法</h3>
<p>L-BFGS 算法拟合模型，速度非常快。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a><span class="co"># L-BFGS 算法拟合模型</span></span>
<span id="cb54-2"><a href="#cb54-2"></a>fit_optim_logit <span class="ot">&lt;-</span> mod_logit_lasso<span class="sc">$</span><span class="fu">optimize</span>(</span>
<span id="cb54-3"><a href="#cb54-3"></a>  <span class="at">data =</span> mdata, <span class="co"># 观测数据</span></span>
<span id="cb54-4"><a href="#cb54-4"></a>  <span class="at">init =</span> <span class="dv">0</span>,     <span class="co"># 所有参数初值设为 0</span></span>
<span id="cb54-5"><a href="#cb54-5"></a>  <span class="at">refresh =</span> <span class="dv">0</span>,  <span class="co"># 不显示迭代进程</span></span>
<span id="cb54-6"><a href="#cb54-6"></a>  <span class="at">algorithm =</span> <span class="st">"lbfgs"</span>, <span class="co"># 优化器</span></span>
<span id="cb54-7"><a href="#cb54-7"></a>  <span class="at">threads =</span> <span class="dv">1</span>,    <span class="co"># 单线程</span></span>
<span id="cb54-8"><a href="#cb54-8"></a>  <span class="at">seed =</span> <span class="dv">20232023</span> <span class="co"># 随机数种子</span></span>
<span id="cb54-9"><a href="#cb54-9"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Finished in  0.2 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a>fit_optim_logit<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"lambda"</span>, <span class="st">"lp__"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 13 × 2
#&gt;    variable   estimate
#&gt;    &lt;chr&gt;         &lt;dbl&gt;
#&gt;  1 alpha       0.981  
#&gt;  2 beta[1]     3.05   
#&gt;  3 beta[2]    -1.96   
#&gt;  4 beta[3]     0.0488 
#&gt;  5 beta[4]    -0.0166 
#&gt;  6 beta[5]     0.00528
#&gt;  7 beta[6]     0.0126 
#&gt;  8 beta[7]     0.0923 
#&gt;  9 beta[8]    -0.0204 
#&gt; 10 beta[9]    -0.0777 
#&gt; 11 beta[10]    0.0721 
#&gt; 12 lambda      0.488  
#&gt; 13 lp__     -768.</code></pre>
</div>
</div>
</section><section id="sec-variational-approximation-algorithms" class="level3" data-number="33.4.2"><h3 data-number="33.4.2" class="anchored" data-anchor-id="sec-variational-approximation-algorithms">
<span class="header-section-number">33.4.2</span> 变分近似推断算法</h3>
<p>ADVI 算法拟合模型，可选的优化器有 <code>meanfield</code> 和 <code>fullrank</code> ，相比于 L-BFGS 稍慢</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a><span class="co"># ADVI 算法拟合模型</span></span>
<span id="cb58-2"><a href="#cb58-2"></a>fit_advi_logit <span class="ot">&lt;-</span> mod_logit_lasso<span class="sc">$</span><span class="fu">variational</span>(</span>
<span id="cb58-3"><a href="#cb58-3"></a>  <span class="at">data =</span> mdata, <span class="co"># 观测数据</span></span>
<span id="cb58-4"><a href="#cb58-4"></a>  <span class="at">init =</span> <span class="dv">0</span>,     <span class="co"># 所有参数初值设为 0</span></span>
<span id="cb58-5"><a href="#cb58-5"></a>  <span class="at">refresh =</span> <span class="dv">0</span>,  <span class="co"># 不显示迭代进程</span></span>
<span id="cb58-6"><a href="#cb58-6"></a>  <span class="at">algorithm =</span> <span class="st">"meanfield"</span>, <span class="co"># 优化器</span></span>
<span id="cb58-7"><a href="#cb58-7"></a>  <span class="at">threads =</span> <span class="dv">1</span>,    <span class="co"># 单线程</span></span>
<span id="cb58-8"><a href="#cb58-8"></a>  <span class="at">seed =</span> <span class="dv">20232023</span> <span class="co"># 随机数种子</span></span>
<span id="cb58-9"><a href="#cb58-9"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Finished in  1.8 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a>fit_advi_logit<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"lambda"</span>, <span class="st">"lp__"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 13 × 7
#&gt;    variable       mean     median     sd    mad         q5       q95
#&gt;    &lt;chr&gt;         &lt;dbl&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;
#&gt;  1 alpha       1.02       1.02    0.0615 0.0630    0.914      1.11  
#&gt;  2 beta[1]     3.07       3.07    0.0899 0.0870    2.93       3.22  
#&gt;  3 beta[2]    -1.98      -1.98    0.0675 0.0666   -2.08      -1.86  
#&gt;  4 beta[3]     0.0161     0.0159  0.0678 0.0670   -0.0945     0.129 
#&gt;  5 beta[4]    -0.0199    -0.0221  0.0639 0.0621   -0.121      0.0857
#&gt;  6 beta[5]    -0.00128   -0.00202 0.0722 0.0713   -0.116      0.121 
#&gt;  7 beta[6]    -0.0423    -0.0446  0.0705 0.0689   -0.156      0.0754
#&gt;  8 beta[7]     0.0760     0.0750  0.0490 0.0489   -0.00517    0.152 
#&gt;  9 beta[8]    -0.0742    -0.0752  0.0659 0.0637   -0.181      0.0347
#&gt; 10 beta[9]    -0.0495    -0.0501  0.0802 0.0818   -0.185      0.0805
#&gt; 11 beta[10]    0.0444     0.0440  0.0520 0.0522   -0.0444     0.128 
#&gt; 12 lambda      0.698      0.662   0.243  0.228     0.379      1.13  
#&gt; 13 lp__     -777.      -777.      3.39   3.22   -783.      -773.</code></pre>
</div>
</div>
</section><section id="sec-laplace-approximation-algorithms" class="level3" data-number="33.4.3"><h3 data-number="33.4.3" class="anchored" data-anchor-id="sec-laplace-approximation-algorithms">
<span class="header-section-number">33.4.3</span> 拉普拉斯近似算法</h3>
<p>Stan 内置的 Laplace 近似算法是对后验分布的 Laplace 正态近似，再从近似的后验分布中采样获得样本，最后，对样本进行统计分析获得参数的后验估计。详见 Stan 语言参考手册的<a href="https://mc-stan.org/docs/reference-manual/laplace-approximation.html">Laplace Approximation 一章</a>。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1"></a><span class="co"># Laplace 算法</span></span>
<span id="cb62-2"><a href="#cb62-2"></a>fit_laplace_logit <span class="ot">&lt;-</span> mod_logit_lasso<span class="sc">$</span><span class="fu">laplace</span>(</span>
<span id="cb62-3"><a href="#cb62-3"></a>  <span class="at">data =</span> mdata, <span class="co"># 观测数据</span></span>
<span id="cb62-4"><a href="#cb62-4"></a>  <span class="at">init =</span> <span class="dv">0</span>,     <span class="co"># 所有参数初值设为 0</span></span>
<span id="cb62-5"><a href="#cb62-5"></a>  <span class="at">refresh =</span> <span class="dv">0</span>,  <span class="co"># 不显示迭代进程</span></span>
<span id="cb62-6"><a href="#cb62-6"></a>  <span class="at">threads =</span> <span class="dv">1</span>,    <span class="co"># 单线程</span></span>
<span id="cb62-7"><a href="#cb62-7"></a>  <span class="at">seed =</span> <span class="dv">20232023</span> <span class="co"># 随机数种子</span></span>
<span id="cb62-8"><a href="#cb62-8"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Finished in  0.1 seconds.
#&gt; Finished in  1.6 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1"></a>fit_laplace_logit<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"lambda"</span>, <span class="st">"lp__"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 13 × 7
#&gt;    variable       mean     median     sd    mad        q5       q95
#&gt;    &lt;chr&gt;         &lt;dbl&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
#&gt;  1 alpha       0.983      0.981   0.0701 0.0719    0.874     1.10  
#&gt;  2 beta[1]     3.05       3.05    0.131  0.129     2.84      3.28  
#&gt;  3 beta[2]    -1.97      -1.97    0.0960 0.0977   -2.12     -1.80  
#&gt;  4 beta[3]     0.0516     0.0493  0.0620 0.0605   -0.0432    0.150 
#&gt;  5 beta[4]    -0.0200    -0.0216  0.0647 0.0602   -0.121     0.0904
#&gt;  6 beta[5]     0.00546    0.00505 0.0639 0.0645   -0.0971    0.110 
#&gt;  7 beta[6]     0.0135     0.0138  0.0642 0.0629   -0.0929    0.116 
#&gt;  8 beta[7]     0.0920     0.0917  0.0638 0.0659   -0.0179    0.195 
#&gt;  9 beta[8]    -0.0231    -0.0217  0.0641 0.0669   -0.128     0.0867
#&gt; 10 beta[9]    -0.0810    -0.0798  0.0646 0.0640   -0.194     0.0212
#&gt; 11 beta[10]    0.0732     0.0745  0.0639 0.0614   -0.0328    0.176 
#&gt; 12 lambda      0.562      0.536   0.168  0.154     0.333     0.866 
#&gt; 13 lp__     -775.      -775.      2.63   2.46   -780.     -772.</code></pre>
</div>
</div>
</section><section id="sec-pathfinder-algorithms" class="level3" data-number="33.4.4"><h3 data-number="33.4.4" class="anchored" data-anchor-id="sec-pathfinder-algorithms">
<span class="header-section-number">33.4.4</span> 探路者变分算法</h3>
<p>探路者算法 Pathfinder 属于变分法，针对可微的对数目标密度函数，沿着逆牛顿优化算法的迭代路径，获得目标密度函数的正态近似。正态近似中的局部协方差的估计采用 LBFGS 计算的负逆 Hessian 矩阵。探路者算法的优势是可以极大地减少对数密度函数和梯度的计算次数，缓解迭代陷入局部最优点和鞍点（何为鞍点，一个可视化示例详见 <a href="optimization-problems.html#sec-gaussian-process-regression" class="quarto-xref"><span>章节&nbsp;32.3</span></a> ）。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1"></a><span class="co"># Pathfinder 算法</span></span>
<span id="cb66-2"><a href="#cb66-2"></a>fit_pathfinder_logit <span class="ot">&lt;-</span> mod_logit_lasso<span class="sc">$</span><span class="fu">pathfinder</span>(</span>
<span id="cb66-3"><a href="#cb66-3"></a>  <span class="at">data =</span> mdata, <span class="co"># 观测数据</span></span>
<span id="cb66-4"><a href="#cb66-4"></a>  <span class="at">init =</span> <span class="dv">0</span>,     <span class="co"># 所有参数初值设为 0</span></span>
<span id="cb66-5"><a href="#cb66-5"></a>  <span class="at">refresh =</span> <span class="dv">0</span>,  <span class="co"># 不显示迭代进程</span></span>
<span id="cb66-6"><a href="#cb66-6"></a>  <span class="at">num_threads =</span> <span class="dv">1</span>,    <span class="co"># 单线程</span></span>
<span id="cb66-7"><a href="#cb66-7"></a>  <span class="at">seed =</span> <span class="dv">20232023</span> <span class="co"># 随机数种子</span></span>
<span id="cb66-8"><a href="#cb66-8"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; Finished in  3.8 seconds.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1"></a>fit_pathfinder_logit<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"alpha"</span>, <span class="st">"beta"</span>, <span class="st">"lambda"</span>, <span class="st">"lp__"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; # A tibble: 13 × 7
#&gt;    variable       mean     median     sd    mad        q5       q95
#&gt;    &lt;chr&gt;         &lt;dbl&gt;      &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
#&gt;  1 alpha       0.986      0.985   0.0758 0.0779    0.866     1.11  
#&gt;  2 beta[1]     3.05       3.05    0.117  0.117     2.86      3.24  
#&gt;  3 beta[2]    -1.97      -1.97    0.108  0.105    -2.15     -1.78  
#&gt;  4 beta[3]     0.0471     0.0481  0.0666 0.0672   -0.0652    0.156 
#&gt;  5 beta[4]    -0.0154    -0.0134  0.0590 0.0606   -0.114     0.0766
#&gt;  6 beta[5]     0.00769    0.00787 0.0591 0.0575   -0.0902    0.108 
#&gt;  7 beta[6]     0.0127     0.0143  0.0686 0.0725   -0.103     0.125 
#&gt;  8 beta[7]     0.0931     0.0943  0.0616 0.0622   -0.0108    0.194 
#&gt;  9 beta[8]    -0.0221    -0.0237  0.0693 0.0659   -0.139     0.0938
#&gt; 10 beta[9]    -0.0776    -0.0785  0.0661 0.0668   -0.189     0.0311
#&gt; 11 beta[10]    0.0749     0.0749  0.0611 0.0584   -0.0264    0.170 
#&gt; 12 lambda      0.549      0.535   0.158  0.145     0.323     0.832 
#&gt; 13 lp__     -776.      -775.      3.06   2.89   -781.     -772.</code></pre>
</div>
</div>
</section></section><section id="习题" class="level2" data-number="33.5"><h2 data-number="33.5" class="anchored" data-anchor-id="习题">
<span class="header-section-number">33.5</span> 习题</h2>
<ol type="1">
<li>
<p>在 <a href="#sec-choose-prior" class="quarto-xref"><span>章节&nbsp;33.3</span></a> 的基础上，比较 Stan 实现的贝叶斯 Lasso 和 R 包 <strong>glmnet</strong> 的结果，发现 <strong>glmnet</strong> 包是很有竞争力的。在选择 Lasso 先验的情况下，收缩效果比 Stan 还好，运行速度也很快。Stan 的优势在于不限于先验分布的选取，当选择 Horseshoe 先验时，Stan 的收缩又比 <strong>glmnet</strong> 包更好。Stan 的优势还在于不限于 <strong>glmnet</strong> 包支持的常见分布族，如高斯、二项、泊松、多项、Cox 等。本质上，这两点都是 Stan 作为一门概率编程语言的优势，只要知道概率分布的数学表达式，总是可以用 Stan 编码出来的。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb70-2"><a href="#cb70-2"></a><span class="co"># 10 折交叉验证 Lasso 回归</span></span>
<span id="cb70-3"><a href="#cb70-3"></a>fit_lasso <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(<span class="at">x =</span> X, <span class="at">y =</span> y, <span class="at">family =</span> <span class="st">"binomial"</span>, <span class="at">alpha =</span> <span class="dv">1</span>, <span class="at">nfolds =</span> <span class="dv">10</span>)</span>
<span id="cb70-4"><a href="#cb70-4"></a><span class="co"># 回归系数</span></span>
<span id="cb70-5"><a href="#cb70-5"></a><span class="fu">coef</span>(fit_lasso, <span class="at">s =</span> fit_lasso<span class="sc">$</span>lambda.min)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 11 x 1 sparse Matrix of class "dgCMatrix"
#&gt;                       s1
#&gt; (Intercept)  0.961804699
#&gt; V1           2.946738407
#&gt; V2          -1.893722753
#&gt; V3           0.031133192
#&gt; V4           .          
#&gt; V5           .          
#&gt; V6           .          
#&gt; V7           0.072368017
#&gt; V8          -0.001820643
#&gt; V9          -0.060774992
#&gt; V10          0.054115506</code></pre>
</div>
</div>
</li>
<li>
<p>基于德国信用卡评分数据，建立逻辑回归模型，分析 20 个协变量对响应变量的贡献，采用合适的先验分布选择适当的变量数。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1"></a>german_credit_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">"data/german_credit_data.rds"</span>)</span>
<span id="cb72-2"><a href="#cb72-2"></a><span class="fu">str</span>(german_credit_data)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 'data.frame':    1000 obs. of  21 variables:
#&gt;  $ checking: Factor w/ 4 levels "A11","A12","A13",..: 1 2 4 1 1 4 4 2 4 2 ...
#&gt;  $ duration: num  6 48 12 42 24 36 24 36 12 30 ...
#&gt;  $ history : Factor w/ 5 levels "A30","A31","A32",..: 5 3 5 3 4 3 3 3 3 5 ...
#&gt;  $ purpose : Factor w/ 10 levels "A40","A41","A410",..: 5 5 8 4 1 8 4 2 5 1 ...
#&gt;  $ amount  : num  1169 5951 2096 7882 4870 ...
#&gt;  $ savings : Factor w/ 5 levels "A61","A62","A63",..: 5 1 1 1 1 5 3 1 4 1 ...
#&gt;  $ employed: Factor w/ 5 levels "A71","A72","A73",..: 5 3 4 4 3 3 5 3 4 1 ...
#&gt;  $ installp: Factor w/ 4 levels "1","2","3","4": 4 2 2 2 3 2 3 2 2 4 ...
#&gt;  $ marital : Factor w/ 4 levels "A91","A92","A93",..: 3 2 3 3 3 3 3 3 1 4 ...
#&gt;  $ coapp   : Factor w/ 3 levels "A101","A102",..: 1 1 1 3 1 1 1 1 1 1 ...
#&gt;  $ resident: Factor w/ 4 levels "1","2","3","4": 4 2 3 4 4 4 4 2 4 2 ...
#&gt;  $ property: Factor w/ 4 levels "A121","A122",..: 1 1 1 2 4 4 2 3 1 3 ...
#&gt;  $ age     : num  67 22 49 45 53 35 53 35 61 28 ...
#&gt;  $ other   : Factor w/ 3 levels "A141","A142",..: 3 3 3 3 3 3 3 3 3 3 ...
#&gt;  $ housing : Factor w/ 3 levels "A151","A152",..: 2 2 2 3 3 3 2 1 2 2 ...
#&gt;  $ existcr : num  2 1 1 1 2 1 1 1 1 2 ...
#&gt;  $ job     : Factor w/ 4 levels "A171","A172",..: 3 3 2 3 3 2 3 4 2 4 ...
#&gt;  $ depends : num  1 1 2 2 2 2 1 1 1 1 ...
#&gt;  $ telephon: Factor w/ 2 levels "A191","A192": 2 1 1 1 1 2 1 2 1 1 ...
#&gt;  $ foreign : Factor w/ 2 levels "A201","A202": 1 1 1 1 1 1 1 1 1 1 ...
#&gt;  $ good_bad: Factor w/ 2 levels "1","2": 1 2 1 1 2 1 1 1 1 2 ...</code></pre>
</div>
</div>
</li>
<li>
<p>下图是美国黄石公园老忠实间歇泉喷发时间和等待时间的分布规律，请建立合适的正态混合模型，用 Stan 拟合模型，并对结果做出说明。（提示：参考 Stan 用户手册的<a href="https://mc-stan.org/docs/stan-users-guide/mixture-modeling.html">有限混合章节</a>）</p>
<div class="cell">
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb74"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> faithful, <span class="fu">aes</span>(<span class="at">x =</span> eruptions)) <span class="sc">+</span></span>
<span id="cb74-2"><a href="#cb74-2"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), </span>
<span id="cb74-3"><a href="#cb74-3"></a>                 <span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb74-4"><a href="#cb74-4"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb74-5"><a href="#cb74-5"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb74-6"><a href="#cb74-6"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"喷发时间"</span>, <span class="at">y =</span> <span class="st">"概率密度值"</span>)</span>
<span id="cb74-7"><a href="#cb74-7"></a></span>
<span id="cb74-8"><a href="#cb74-8"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> faithful, <span class="fu">aes</span>(<span class="at">x =</span> waiting)) <span class="sc">+</span></span>
<span id="cb74-9"><a href="#cb74-9"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">after_stat</span>(density)), </span>
<span id="cb74-10"><a href="#cb74-10"></a>                 <span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb74-11"><a href="#cb74-11"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb74-12"><a href="#cb74-12"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb74-13"><a href="#cb74-13"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"等待时间"</span>, <span class="at">y =</span> <span class="st">"概率密度值"</span>)</span>
<span id="cb74-14"><a href="#cb74-14"></a></span>
<span id="cb74-15"><a href="#cb74-15"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb74-16"><a href="#cb74-16"></a>p1 <span class="sc">|</span> p2</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div id="fig-faithful-mixture" class="quarto-figure quarto-figure-center anchored" width="672">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-faithful-mixture-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="probabilistic-reasoning-framework_files/figure-html/fig-faithful-mixture-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-faithful-mixture-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
图&nbsp;33.4: 黄石公园老忠实间歇泉
</figcaption></figure>
</div>
</div>
</div>
<div class="sourceCode" id="cb75"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb75-1"><a href="#cb75-1"></a><span class="kw">data</span> {</span>
<span id="cb75-2"><a href="#cb75-2"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; K;          <span class="co">// number of mixture components</span></span>
<span id="cb75-3"><a href="#cb75-3"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; N;          <span class="co">// number of data points</span></span>
<span id="cb75-4"><a href="#cb75-4"></a>  <span class="dt">array</span>[N] <span class="dt">real</span> y;         <span class="co">// observations</span></span>
<span id="cb75-5"><a href="#cb75-5"></a>}</span>
<span id="cb75-6"><a href="#cb75-6"></a><span class="kw">parameters</span> {</span>
<span id="cb75-7"><a href="#cb75-7"></a>  <span class="dt">simplex</span>[K] theta;          <span class="co">// mixing proportions</span></span>
<span id="cb75-8"><a href="#cb75-8"></a>  <span class="dt">ordered</span>[K] mu;             <span class="co">// locations of mixture components</span></span>
<span id="cb75-9"><a href="#cb75-9"></a>  <span class="dt">vector</span>&lt;<span class="kw">lower</span>=<span class="dv">0</span>&gt;[K] sigma;  <span class="co">// scales of mixture components</span></span>
<span id="cb75-10"><a href="#cb75-10"></a>}</span>
<span id="cb75-11"><a href="#cb75-11"></a><span class="kw">model</span> {</span>
<span id="cb75-12"><a href="#cb75-12"></a>  <span class="dt">vector</span>[K] log_theta = log(theta);  <span class="co">// cache log calculation</span></span>
<span id="cb75-13"><a href="#cb75-13"></a>  sigma ~ lognormal(<span class="dv">0</span>, <span class="dv">2</span>);</span>
<span id="cb75-14"><a href="#cb75-14"></a>  mu ~ normal(<span class="dv">0</span>, <span class="dv">10</span>);</span>
<span id="cb75-15"><a href="#cb75-15"></a>  <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb75-16"><a href="#cb75-16"></a>    <span class="dt">vector</span>[K] lps = log_theta;</span>
<span id="cb75-17"><a href="#cb75-17"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span>:K) {</span>
<span id="cb75-18"><a href="#cb75-18"></a>      lps[k] += normal_lpdf(y[n] | mu[k], sigma[k]);</span>
<span id="cb75-19"><a href="#cb75-19"></a>    }</span>
<span id="cb75-20"><a href="#cb75-20"></a>    <span class="kw">target +=</span> log_sum_exp(lps);</span>
<span id="cb75-21"><a href="#cb75-21"></a>  }</span>
<span id="cb75-22"><a href="#cb75-22"></a>}</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb76"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb76-2"><a href="#cb76-2"></a></span>
<span id="cb76-3"><a href="#cb76-3"></a>faithful_d <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb76-4"><a href="#cb76-4"></a>  <span class="at">K =</span> <span class="dv">2</span>, <span class="co"># 几个正态分布混合</span></span>
<span id="cb76-5"><a href="#cb76-5"></a>  <span class="at">N =</span> <span class="dv">272</span>, <span class="co"># 样本量</span></span>
<span id="cb76-6"><a href="#cb76-6"></a>  <span class="co"># y = faithful$waiting,</span></span>
<span id="cb76-7"><a href="#cb76-7"></a>  <span class="at">y =</span> faithful<span class="sc">$</span>eruptions</span>
<span id="cb76-8"><a href="#cb76-8"></a>)</span>
<span id="cb76-9"><a href="#cb76-9"></a></span>
<span id="cb76-10"><a href="#cb76-10"></a>mod_faithful_normal <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(</span>
<span id="cb76-11"><a href="#cb76-11"></a>  <span class="at">stan_file =</span> <span class="st">"code/faithful_finite_mixtures.stan"</span>,</span>
<span id="cb76-12"><a href="#cb76-12"></a>  <span class="at">compile =</span> <span class="cn">TRUE</span>, <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">TRUE</span>)</span>
<span id="cb76-13"><a href="#cb76-13"></a>)</span>
<span id="cb76-14"><a href="#cb76-14"></a></span>
<span id="cb76-15"><a href="#cb76-15"></a>fit_faithful_normal <span class="ot">&lt;-</span> mod_faithful_normal<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb76-16"><a href="#cb76-16"></a>  <span class="at">data =</span> faithful_d,</span>
<span id="cb76-17"><a href="#cb76-17"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb76-18"><a href="#cb76-18"></a>  <span class="at">parallel_chains =</span> <span class="dv">2</span>,</span>
<span id="cb76-19"><a href="#cb76-19"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>, </span>
<span id="cb76-20"><a href="#cb76-20"></a>  <span class="at">iter_sampling =</span> <span class="dv">1000</span>, </span>
<span id="cb76-21"><a href="#cb76-21"></a>  <span class="at">threads_per_chain =</span> <span class="dv">2</span>, </span>
<span id="cb76-22"><a href="#cb76-22"></a>  <span class="at">seed =</span> <span class="dv">20232023</span>,</span>
<span id="cb76-23"><a href="#cb76-23"></a>  <span class="at">show_messages =</span> <span class="cn">FALSE</span>,</span>
<span id="cb76-24"><a href="#cb76-24"></a>  <span class="at">refresh =</span> <span class="dv">0</span></span>
<span id="cb76-25"><a href="#cb76-25"></a>)</span>
<span id="cb76-26"><a href="#cb76-26"></a></span>
<span id="cb76-27"><a href="#cb76-27"></a><span class="co"># 输出结果</span></span>
<span id="cb76-28"><a href="#cb76-28"></a>fit_faithful_normal<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"theta"</span>, <span class="st">"mu"</span>, <span class="st">"sigma"</span>, <span class="st">"lp__"</span>))</span>
<span id="cb76-29"><a href="#cb76-29"></a><span class="co"># theta[1] = 0.350 混合比例</span></span>
<span id="cb76-30"><a href="#cb76-30"></a><span class="co"># theta[2] = 0.650</span></span>
<span id="cb76-31"><a href="#cb76-31"></a><span class="co"># mu[1] = 2.02 均值</span></span>
<span id="cb76-32"><a href="#cb76-32"></a><span class="co"># mu[2] = 4.27</span></span>
<span id="cb76-33"><a href="#cb76-33"></a><span class="co"># sigma[1] = 0.243 标准差</span></span>
<span id="cb76-34"><a href="#cb76-34"></a><span class="co"># sigma[2] = 0.437</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</li>
<li>
<p>在 <a href="visualization-practice.html" class="quarto-xref"><span>章节&nbsp;12</span></a> 的探索分析基础上，对美国黄石公园的老忠实泉喷发规律，建立二项分布和二维正态分布的混合模型，请用 Stan 编码估计模型中的参数。</p>
<p><span class="math display">\[
f(\bm{x};p,\bm{\mu_1},\Sigma_1,\bm{\mu_2},\Sigma_2) = p\mathcal{N}(\bm{x};\bm{\mu_1},\Sigma_1) + (1-p) \mathcal{N}(\bm{x};\bm{\mu_2},\Sigma_2)
\]</span></p>
<p>其中，参数 <span class="math inline">\(p\)</span> 是一个介于 0 到 1 之间的常数，参数 <span class="math inline">\(\bm{\mu_1} = (\mu_{11},\mu_{12})^\top,\bm{\mu_2}=(\mu_{21},\mu_{22})^\top\)</span> 是二维的列向量，参数 <span class="math inline">\(\Sigma_1 = (\sigma_{ij}),\Sigma_2 = (\delta_{ij}),i=1,2,j=1,2\)</span> 是二阶的协方差矩阵。（提示：因有限混合模型存在可识别性问题，简单起见，考虑各个多元正态分布的协方差矩阵相同的情况。）</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode numberSource stan number-lines code-with-copy"><code class="sourceCode stan"><span id="cb77-1"><a href="#cb77-1"></a><span class="kw">data</span> {</span>
<span id="cb77-2"><a href="#cb77-2"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; K;  <span class="co">// number of mixture components</span></span>
<span id="cb77-3"><a href="#cb77-3"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; N;  <span class="co">// number of observations</span></span>
<span id="cb77-4"><a href="#cb77-4"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span>=<span class="dv">1</span>&gt; D;  <span class="co">// dimension of observations</span></span>
<span id="cb77-5"><a href="#cb77-5"></a>  <span class="dt">array</span>[N] <span class="dt">vector</span>[D] y; <span class="co">// observations: a list of N vectors (each has D elements)</span></span>
<span id="cb77-6"><a href="#cb77-6"></a>}</span>
<span id="cb77-7"><a href="#cb77-7"></a><span class="kw">transformed data</span> {</span>
<span id="cb77-8"><a href="#cb77-8"></a>  <span class="dt">vector</span>[D] mu0 = rep_vector(<span class="dv">0</span>, D);</span>
<span id="cb77-9"><a href="#cb77-9"></a>  <span class="dt">matrix</span>[D, D] Sigma0 = diag_matrix(rep_vector(<span class="dv">1</span>, D));</span>
<span id="cb77-10"><a href="#cb77-10"></a>}</span>
<span id="cb77-11"><a href="#cb77-11"></a><span class="kw">parameters</span> {</span>
<span id="cb77-12"><a href="#cb77-12"></a>  <span class="dt">simplex</span>[K] theta;       <span class="co">// mixing proportions</span></span>
<span id="cb77-13"><a href="#cb77-13"></a>  <span class="dt">array</span>[K] <span class="dt">positive_ordered</span>[D] mu; <span class="co">// locations of mixture components</span></span>
<span id="cb77-14"><a href="#cb77-14"></a>  <span class="co">// scales of mixture components</span></span>
<span id="cb77-15"><a href="#cb77-15"></a>  <span class="dt">array</span>[K] <span class="dt">cholesky_factor_corr</span>[D] Lcorr; <span class="co">// cholesky factor (L_u matrix for R)</span></span>
<span id="cb77-16"><a href="#cb77-16"></a>}</span>
<span id="cb77-17"><a href="#cb77-17"></a><span class="kw">model</span> {</span>
<span id="cb77-18"><a href="#cb77-18"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span>:K){</span>
<span id="cb77-19"><a href="#cb77-19"></a>    mu[i] ~ multi_normal(mu0, Sigma0); <span class="co">// prior for mu</span></span>
<span id="cb77-20"><a href="#cb77-20"></a>    Lcorr[i] ~ lkj_corr_cholesky(<span class="fl">2.0</span>); <span class="co">// prior for cholesky factor of a correlation matrix</span></span>
<span id="cb77-21"><a href="#cb77-21"></a>  }</span>
<span id="cb77-22"><a href="#cb77-22"></a></span>
<span id="cb77-23"><a href="#cb77-23"></a>  <span class="dt">vector</span>[K] log_theta = log(theta);  <span class="co">// cache log calculation</span></span>
<span id="cb77-24"><a href="#cb77-24"></a></span>
<span id="cb77-25"><a href="#cb77-25"></a>  <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span>:N) {</span>
<span id="cb77-26"><a href="#cb77-26"></a>    <span class="dt">vector</span>[K] lps = log_theta;</span>
<span id="cb77-27"><a href="#cb77-27"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span>:K) {</span>
<span id="cb77-28"><a href="#cb77-28"></a>      lps[k] += multi_normal_cholesky_lpdf(y[n] | mu[k], Lcorr[k]);</span>
<span id="cb77-29"><a href="#cb77-29"></a>    }</span>
<span id="cb77-30"><a href="#cb77-30"></a>    <span class="kw">target +=</span> log_sum_exp(lps);</span>
<span id="cb77-31"><a href="#cb77-31"></a>  }</span>
<span id="cb77-32"><a href="#cb77-32"></a>}</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<details class="code-fold"><summary>代码</summary><div class="sourceCode cell-code" id="cb78"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1"></a><span class="fu">data</span>(<span class="st">"faithful"</span>)</span>
<span id="cb78-2"><a href="#cb78-2"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb78-3"><a href="#cb78-3"></a><span class="co"># 准备数据</span></span>
<span id="cb78-4"><a href="#cb78-4"></a>faithful_2d <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb78-5"><a href="#cb78-5"></a>  <span class="at">K =</span> <span class="dv">2</span>,    <span class="co"># 2 个分布混合</span></span>
<span id="cb78-6"><a href="#cb78-6"></a>  <span class="at">N =</span> <span class="dv">272</span>,  <span class="co"># 样本量 nrow(faithful)</span></span>
<span id="cb78-7"><a href="#cb78-7"></a>  <span class="at">D =</span> <span class="dv">2</span>,    <span class="co"># 二维正态分布</span></span>
<span id="cb78-8"><a href="#cb78-8"></a>  <span class="at">y =</span> faithful <span class="co"># 数据集</span></span>
<span id="cb78-9"><a href="#cb78-9"></a>)</span>
<span id="cb78-10"><a href="#cb78-10"></a><span class="co"># 编译模型</span></span>
<span id="cb78-11"><a href="#cb78-11"></a>mod_faithful_normal_2d <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(</span>
<span id="cb78-12"><a href="#cb78-12"></a>  <span class="at">stan_file =</span> <span class="st">"code/faithful_2d_finite_mixtures.stan"</span>,</span>
<span id="cb78-13"><a href="#cb78-13"></a>  <span class="at">compile =</span> <span class="cn">TRUE</span>, <span class="at">cpp_options =</span> <span class="fu">list</span>(<span class="at">stan_threads =</span> <span class="cn">TRUE</span>)</span>
<span id="cb78-14"><a href="#cb78-14"></a>)</span>
<span id="cb78-15"><a href="#cb78-15"></a><span class="co"># 采样</span></span>
<span id="cb78-16"><a href="#cb78-16"></a>fit_faithful_normal_2d <span class="ot">&lt;-</span> mod_faithful_normal_2d<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb78-17"><a href="#cb78-17"></a>  <span class="at">data =</span> faithful_2d,</span>
<span id="cb78-18"><a href="#cb78-18"></a>  <span class="at">chains =</span> <span class="dv">2</span>,</span>
<span id="cb78-19"><a href="#cb78-19"></a>  <span class="at">parallel_chains =</span> <span class="dv">2</span>,</span>
<span id="cb78-20"><a href="#cb78-20"></a>  <span class="at">iter_warmup =</span> <span class="dv">1000</span>, </span>
<span id="cb78-21"><a href="#cb78-21"></a>  <span class="at">iter_sampling =</span> <span class="dv">1000</span>, </span>
<span id="cb78-22"><a href="#cb78-22"></a>  <span class="at">threads_per_chain =</span> <span class="dv">2</span>, </span>
<span id="cb78-23"><a href="#cb78-23"></a>  <span class="at">seed =</span> <span class="dv">20232023</span>,</span>
<span id="cb78-24"><a href="#cb78-24"></a>  <span class="at">show_messages =</span> <span class="cn">FALSE</span>,</span>
<span id="cb78-25"><a href="#cb78-25"></a>  <span class="at">refresh =</span> <span class="dv">0</span></span>
<span id="cb78-26"><a href="#cb78-26"></a>)</span>
<span id="cb78-27"><a href="#cb78-27"></a><span class="co"># 输出结果</span></span>
<span id="cb78-28"><a href="#cb78-28"></a>fit_faithful_normal_2d<span class="sc">$</span><span class="fu">summary</span>(<span class="fu">c</span>(<span class="st">"theta"</span>, <span class="st">"mu"</span>, <span class="st">"lp__"</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</li>
</ol>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-pymc2023" class="csl-entry" role="listitem">
Abril-Pla O, Carroll C, Andreani V. 2023. <span>《<span>PyMC</span>: a modern, and comprehensive probabilistic programming framework in Python》</span>. <em>PeerJ Computer Science</em> 9 (e1516). <a href="https://doi.org/10.7717/peerj-cs.1516">https://doi.org/10.7717/peerj-cs.1516</a>.
</div>
<div id="ref-RcppParallel2023" class="csl-entry" role="listitem">
Allaire, JJ, Romain Francois, Kevin Ushey, Gregory Vandenbrouck, Marcus Geelnard, 和 Intel. 2023. <em><span>RcppParallel</span>: Parallel Programming Tools for <span>Rcpp</span></em>. <a href="https://CRAN.R-project.org/package=RcppParallel">https://CRAN.R-project.org/package=RcppParallel</a>.
</div>
<div id="ref-Bates2013" class="csl-entry" role="listitem">
Bates, Douglas, 和 Dirk Eddelbuettel. 2013. <span>《Fast and Elegant Numerical Linear Algebra Using the <span>RcppEigen</span> Package》</span>. <em>Journal of Statistical Software</em> 52 (5): 1–24. <a href="https://doi.org/10.18637/jss.v052.i05">https://doi.org/10.18637/jss.v052.i05</a>.
</div>
<div id="ref-Bhadra2019" class="csl-entry" role="listitem">
Bhadra, Anindya, Jyotishka Datta, Nicholas G. Polson, 和 Brandon Willard. 2019. <span>《<span>Lasso Meets Horseshoe: A Survey</span>》</span>. <em>Statistical Science</em> 34 (3): 405–27. <a href="https://doi.org/10.1214/19-STS700">https://doi.org/10.1214/19-STS700</a>.
</div>
<div id="ref-brms2017" class="csl-entry" role="listitem">
Bürkner, Paul-Christian. 2017. <span>《<span>brms</span>: An <span>R</span> Package for <span>Bayesian</span> Multilevel Models Using <span>Stan</span>》</span>. <em>Journal of Statistical Software</em> 80 (1): 1–28. <a href="https://doi.org/10.18637/jss.v080.i01">https://doi.org/10.18637/jss.v080.i01</a>.
</div>
<div id="ref-Carpenter2017" class="csl-entry" role="listitem">
Carpenter, Bob, Andrew Gelman, Matthew Hoffman, Daniel Lee, Ben Goodrich, Michael Betancourt, Marcus Brubaker, Jiqiang Guo, Peter Li, 和 Allen Riddell. 2017. <span>《<span>Stan</span>: A Probabilistic Programming Language》</span>. <em>Journal of Statistical Software</em> 76 (1): 1–32. <a href="https://doi.org/10.18637/jss.v076.i01">https://doi.org/10.18637/jss.v076.i01</a>.
</div>
<div id="ref-Carpenter2015" class="csl-entry" role="listitem">
Carpenter, Bob, Matthew D. Hoffman, Marcus Brubaker, Daniel Lee, Peter Li, 和 Michael Betancourt. 2015. <span>《The Stan Math Library: Reverse-Mode Automatic Differentiation in C++》</span>. <a href="https://arxiv.org/abs/1509.07164">https://arxiv.org/abs/1509.07164</a>.
</div>
<div id="ref-Rcpp2018" class="csl-entry" role="listitem">
Eddelbuettel, Dirk, 和 James Joseph Balamuta. 2018. <span>《<span>Extending <span>R</span> with <span>C++</span>: A Brief Introduction to <span>Rcpp</span></span>》</span>. <em>The American Statistician</em> 72 (1): 28–36. <a href="https://doi.org/10.1080/00031305.2017.1375990">https://doi.org/10.1080/00031305.2017.1375990</a>.
</div>
<div id="ref-BH2023" class="csl-entry" role="listitem">
Eddelbuettel, Dirk, John W. Emerson, 和 Michael J. Kane. 2023. <em><span>BH</span>: Boost C++ Header Files</em>. <a href="https://CRAN.R-project.org/package=BH">https://CRAN.R-project.org/package=BH</a>.
</div>
<div id="ref-Rcpp2011" class="csl-entry" role="listitem">
Eddelbuettel, Dirk, 和 Romain François. 2011. <span>《<span>Rcpp</span>: Seamless <span>R</span> and <span>C++</span> Integration》</span>. <em>Journal of Statistical Software</em> 40 (8): 1–18. <a href="https://doi.org/10.18637/jss.v040.i08">https://doi.org/10.18637/jss.v040.i08</a>.
</div>
<div id="ref-Gabry2023" class="csl-entry" role="listitem">
Gabry, Jonah, Rok Češnovar, 和 Andrew Johnson. 2023. <em><span>cmdstanr</span>: R Interface to <span>CmdStan</span></em>. <a href="https://mc-stan.org/cmdstanr/">https://mc-stan.org/cmdstanr/</a>.
</div>
<div id="ref-Gabry2019" class="csl-entry" role="listitem">
Gabry, Jonah, Daniel Simpson, Aki Vehtari, Michael Betancourt, 和 Andrew Gelman. 2019. <span>《Visualization in Bayesian workflow》</span>. <em>Journal of the Royal Statistical Society Series A: Statistics in Society</em> 182: 389–402. <a href="https://doi.org/10.1111/rssa.12378">https://doi.org/10.1111/rssa.12378</a>.
</div>
<div id="ref-Gelman2015" class="csl-entry" role="listitem">
Gelman, Andrew, Daniel Lee, 和 Jiqiang Guo. 2015. <span>《Stan: A Probabilistic Programming Language for Bayesian Inference and Optimization》</span>. <em>Journal of Educational and Behavioral Statistics</em> 40 (5): 530–43. <a href="https://doi.org/10.3102/1076998615606113">https://doi.org/10.3102/1076998615606113</a>.
</div>
<div id="ref-Goodrich2023" class="csl-entry" role="listitem">
Goodrich, Ben, Jonah Gabry, Imad Ali, 和 Sam Brilleman. 2023. <span>《<span>rstanarm</span>: <span>Bayesian</span> applied regression modeling via <span>Stan</span>.》</span> <a href="https://mc-stan.org/rstanarm/">https://mc-stan.org/rstanarm/</a>.
</div>
<div id="ref-Dillon2017" class="csl-entry" role="listitem">
Joshua V. Dillon, Dustin Tran, Ian Langmore. 2017. <span>《<span>TensorFlow</span> Distributions》</span>. <a href="https://arxiv.org/abs/1711.10604">https://arxiv.org/abs/1711.10604</a>.
</div>
<div id="ref-Piironen2020" class="csl-entry" role="listitem">
Piironen, Juho, Markus Paasiniemi, 和 Aki Vehtari. 2020. <span>《Projective Inference in High-Dimensional Problems: <span>Prediction</span> and Feature Selection》</span>. <em>Electronic Journal of Statistics</em> 14 (1): 2155–97. <a href="https://doi.org/10.1214/20-EJS1711">https://doi.org/10.1214/20-EJS1711</a>.
</div>
<div id="ref-Piironen2017b" class="csl-entry" role="listitem">
Piironen, Juho, 和 Aki Vehtari. 2017a. <span>《Comparison of <span>Bayesian</span> Predictive Methods for Model Selection》</span>. <em>Statistics and Computing</em> 27 (3): 711–35. <a href="https://doi.org/10.1007/s11222-016-9649-y">https://doi.org/10.1007/s11222-016-9649-y</a>.
</div>
<div id="ref-Piironen2017a" class="csl-entry" role="listitem">
———. 2017b. <span>《Sparsity information and regularization in the horseshoe and other shrinkage priors》</span>. <em>Electronic Journal of Statistics</em> 11 (2): 5018–51. <a href="https://doi.org/10.1214/17-EJS1337SI">https://doi.org/10.1214/17-EJS1337SI</a>.
</div>
<div id="ref-RStan2023" class="csl-entry" role="listitem">
Stan Development Team. 2023a. <span>《<span>RStan</span>: the <span>R</span> interface to <span>Stan</span>》</span>. <a href="https://mc-stan.org/">https://mc-stan.org/</a>.
</div>
<div id="ref-StanHeaders2023" class="csl-entry" role="listitem">
———. 2023b. <span>《<span>StanHeaders</span>: Headers for the <span>R</span> interface to <span>Stan</span>》</span>. <a href="https://mc-stan.org/">https://mc-stan.org/</a>.
</div>
<div id="ref-Vehtari2017" class="csl-entry" role="listitem">
Vehtari, Aki, Andrew Gelman, 和 Jonah Gabry. 2017. <span>《Practical Bayesian model evaluation using leave-one-out cross-validation and WAIC》</span>. <em>Statistics and Computing</em> 27: 1413–32. <a href="https://doi.org/10.1007/s11222-016-9696-4">https://doi.org/10.1007/s11222-016-9696-4</a>.
</div>
<div id="ref-Vehtari2021" class="csl-entry" role="listitem">
Vehtari, Aki, Andrew Gelman, Daniel Simpson, Bob Carpenter, 和 Paul-Christian Bürkner. 2021. <span>《<span>Rank-Normalization, Folding, and Localization: An Improved <span class="math inline">\(\widehat{R}\)</span> for Assessing Convergence of MCMC (with Discussion)</span>》</span>. <em>Bayesian Analysis</em> 16 (2): 667–718. <a href="https://doi.org/10.1214/20-BA1221">https://doi.org/10.1214/20-BA1221</a>.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "已复制");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "已复制");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./optimization-problems.html" class="pagination-link  aria-label=">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">优化问题</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./generalized-linear-models.html" class="pagination-link" aria-label="<span class='chapter-number'>34</span>&nbsp; <span class='chapter-title'>广义线性模型</span>">
        <span class="nav-page-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">广义线性模型</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/XiangyunHuang/data-analysis-in-action/blob/main/probabilistic-reasoning-framework.qmd" class="toc-action"><i class="bi bi-github"></i>查看代码</a></li></ul></div></div></div></footer></body></html>